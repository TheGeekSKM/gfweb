(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return t=>{for(var n=t.length,r=new Uint8Array((n-(t[n-1]==`=`)-(t[n-2]==`=`))*3/4|0),i=0,a=0;i<n;){var o=e[t.charCodeAt(i++)],s=e[t.charCodeAt(i++)],c=e[t.charCodeAt(i++)],l=e[t.charCodeAt(i++)];r[a++]=o<<2|s>>4,r[a++]=s<<4|c>>2,r[a++]=c<<6|l}return r}})(),t={name:`kaplay`,description:`KAPLAY is a JavaScript & TypeScript game library that helps you make games fast and fun! (formerly known as Kaboom.js)`,version:`3001.0.19`,license:`MIT`,homepage:`https://kaplayjs.com/`,bugs:{url:`https://github.com/kaplayjs/kaplay/issues`},funding:{type:`opencollective`,url:`https://opencollective.com/kaplay`},repository:{type:`git`,url:`git+https://github.com/kaplayjs/kaplay.git`},type:`module`,main:`./dist/kaplay.cjs`,module:`./dist/kaplay.mjs`,types:`./dist/doc.d.ts`,readme:`./README.md`,exports:{".":{import:{types:`./dist/doc.d.ts`,default:`./dist/kaplay.mjs`},require:{types:`./dist/doc.d.ts`,default:`./dist/kaplay.cjs`}},"./global":`./dist/declaration/global.js`},typesVersions:{"*":{global:[`./dist/declaration/global.d.ts`]}},keywords:[`game development`,`javascript`,`typescript`,`game engine`,`2d games`,`physics engine`,`webgl`,`canvas`,`game library`,`kaplay`,`kaboom`,`kaboomjs`,`kaboom.js`],files:[`dist/`,`kaplay.webp`,`CHANGELOG.md`],scripts:{dev:`NODE_ENV=development node scripts/dev.js`,"win:dev":`set NODE_ENV=development && node scripts/dev.js`,build:`node scripts/generateIndex.js && npm run doc-dts && node scripts/build.js`,"build:fast":`node scripts/buildFast.js`,check:`tsc`,fmt:`dprint fmt`,test:`node scripts/test.js`,"doc-dts":`dts-bundle-generator -o dist/doc.d.ts src/index.ts`,"test:vite":`vitest --typecheck`,desktop:`tauri dev`,prepare:`npm run build`,"publish:next":`npm publish --tag next`},devDependencies:{"@kaplayjs/dprint-config":`^1.2.0`,"@types/jest":`^29.5.14`,dprint:`^0.49.1`,"dts-bundle-generator":`^9.5.1`,ejs:`^3.1.10`,esbuild:`^0.25.2`,express:`^5.1.0`,puppeteer:`^22.15.0`,"tar-fs":`3.0.8`,typescript:`5.6.3`,vite:`5.4.16`,vitest:`^3.1.1`,"vitest-environment-puppeteer":`^11.0.3`,"vitest-puppeteer":`^11.0.3`},engines:{node:`>=20.0.0`},packageManager:`pnpm@9.9.0+sha512.60c18acd138bff695d339be6ad13f7e936eea6745660d4cc4a776d5247c540d0edee1a563695c183a66eb917ef88f2b4feb1fc25f32a7adcadc7aaf3438e99c1`};function n(e,t,r){return t>r?n(e,r,t):Math.min(Math.max(e,t),r)}var r=class e{r=255;g=255;b=255;constructor(e,t,r){this.r=n(e,0,255),this.g=n(t,0,255),this.b=n(r,0,255)}static fromArray(t){return new e(t[0],t[1],t[2])}static fromHex(t){if(typeof t==`number`)return new e(t>>16&255,t>>8&255,t>>0&255);if(typeof t==`string`){let n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!n)throw Error(`Invalid hex color format`);return new e(parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16))}else throw Error(`Invalid hex color format`)}static fromHSL(t,n,r){if(n==0)return new e(255*r,255*r,255*r);let i=(e,t,n)=>(n<0&&(n+=1),n>1&&--n,n<1/6?e+(t-e)*6*n:n<1/2?t:n<2/3?e+(t-e)*(2/3-n)*6:e),a=r<.5?r*(1+n):r+n-r*n,o=2*r-a,s=i(o,a,t+1/3),c=i(o,a,t),l=i(o,a,t-1/3);return new e(Math.round(s*255),Math.round(c*255),Math.round(l*255))}static RED=new e(255,0,0);static GREEN=new e(0,255,0);static BLUE=new e(0,0,255);static YELLOW=new e(255,255,0);static MAGENTA=new e(255,0,255);static CYAN=new e(0,255,255);static WHITE=new e(255,255,255);static BLACK=new e(0,0,0);clone(){return new e(this.r,this.g,this.b)}lighten(t){return new e(this.r+t,this.g+t,this.b+t)}darken(e){return this.lighten(-e)}invert(){return new e(255-this.r,255-this.g,255-this.b)}mult(t){return new e(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,n){return new e(c(this.r,t.r,n),c(this.g,t.g,n),c(this.b,t.b,n))}toHSL(){let e=this.r/255,t=this.g/255,n=this.b/255,r=Math.max(e,t,n),i=Math.min(e,t,n),a=(r+i)/2,o=a,s=a;if(r==i)a=o=0;else{let c=r-i;switch(o=s>.5?c/(2-r-i):c/(r+i),r){case e:a=(t-n)/c+(t<n?6:0);break;case t:a=(n-e)/c+2;break;case n:a=(e-t)/c+4;break}a/=6}return[a,o,s]}eq(e){return this.r===e.r&&this.g===e.g&&this.b===e.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return`#`+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function i(...e){if(e.length===0)return new r(255,255,255);if(e.length===1){if(e[0]instanceof r)return e[0].clone();if(typeof e[0]==`string`)return r.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return r.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof r)return e[0].clone()}else if(e.length===3||e.length===4)return new r(e[0],e[1],e[2]);throw Error(`Invalid color arguments`)}var a=(e,t,n)=>r.fromHSL(e,t,n);function o(e){return e*Math.PI/180}function s(e){return e*180/Math.PI}function c(e,t,n){if(typeof e==`number`&&typeof t==`number`)return e+(t-e)*n;if(e instanceof d&&t instanceof d||e instanceof r&&t instanceof r)return e.lerp(t,n);throw Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function l(e,t,n,r,i){return r+(e-t)/(n-t)*(i-r)}function u(e,t,r,i,a){return n(l(e,t,r,i,a),i,a)}var d=class e{x=0;y=0;constructor(e=0,t=e){this.x=e,this.y=t}static fromAngle(t){let n=o(t);return new e(Math.cos(n),Math.sin(n))}static fromArray(t){return new e(t[0],t[1])}static ZERO=new e(0,0);static ONE=new e(1,1);static LEFT=new e(-1,0);static RIGHT=new e(1,0);static UP=new e(0,-1);static DOWN=new e(0,1);clone(){return new e(this.x,this.y)}add(...t){let n=f(...t);return new e(this.x+n.x,this.y+n.y)}sub(...t){let n=f(...t);return new e(this.x-n.x,this.y-n.y)}scale(...t){let n=f(...t);return new e(this.x*n.x,this.y*n.y)}dist(...e){let t=f(...e);return this.sub(t).len()}sdist(...e){let t=f(...e);return this.sub(t).slen()}static sdist(e,t){let n=e.x-t.x,r=e.y-t.y;return n*n+r*r}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new e(0):this.scale(1/t)}normal(){return new e(this.y,-this.x)}reflect(e){return this.sub(e.scale(2*this.dot(e)))}project(e){return e.scale(e.dot(this)/e.len())}reject(e){return this.sub(this.project(e))}dot(e){return this.x*e.x+this.y*e.y}static dot(e,t){return e.x*t.x+e.y*t.y}cross(e){return this.x*e.y-this.y*e.x}static cross(e,t){return e.x*t.y-e.y*t.x}angle(...e){let t=f(...e);return s(Math.atan2(this.y-t.y,this.x-t.x))}angleBetween(...e){let t=f(...e);return s(Math.atan2(this.cross(t),this.dot(t)))}lerp(t,n){return new e(c(this.x,t.x,n),c(this.y,t.y,n))}slerp(e,t){let n=this.dot(e),r=this.cross(e),i=Math.atan2(r,n);return this.scale(Math.sin((1-t)*i)).add(e.scale(Math.sin(t*i))).scale(1/r)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new e(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(e){return e.multVec2(this)}eq(e){return this.x===e.x&&this.y===e.y}bbox(){return new B(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function f(...e){if(e.length===1){if(e[0]instanceof d)return new d(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new d(...e[0])}return new d(...e)}var p=class e{x=0;y=0;w=1;h=1;constructor(e,t,n,r){this.x=e,this.y=t,this.w=n,this.h=r}scale(t){return new e(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new d(this.x,this.y)}clone(){return new e(this.x,this.y,this.w,this.h)}eq(e){return this.x===e.x&&this.y===e.y&&this.w===e.w&&this.h===e.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function m(e,t,n,r){return new p(e,t,n,r)}var h=class e{a;b;c;d;constructor(e,t,n,r){this.a=e,this.b=t,this.c=n,this.d=r}mul(t){return new e(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(e){return f(this.a*e.x+this.b*e.y,this.c*e.x+this.d*e.y)}get inverse(){let t=this.det;return new e(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new e(this.a,this.c,this.b,this.d)}get eigenvalues(){let e=this.trace/2,t=this.det,n=e+Math.sqrt(e*e-t),r=e-Math.sqrt(e*e-t);return[n,r]}eigenvectors(e,t){return this.c==0?this.b==0?Math.abs(this.transform(f(1,0)).x-e)<2**-52?[[1,0],[0,1]]:[[0,1],[1,0]]:[[this.b,e-this.a],[this.b,t-this.a]]:[[e-this.d,this.c],[t-this.d,this.c]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let n=Math.cos(t),r=Math.sin(t);return new e(n,r,-r,n)}static scale(t,n){return new e(t,0,0,n)}},g=class e{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(e,t,n,r,i,a,o,s,c){this.m11=e,this.m12=t,this.m13=n,this.m21=r,this.m22=i,this.m23=a,this.m31=o,this.m32=s,this.m33=c}static fromMat2(t){return new e(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new h(this.m11,this.m12,this.m21,this.m22)}mul(t){return new e(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(e){let t=Math.cos(e),n=Math.sin(e),r=this.m11,i=this.m12;return this.m11=t*this.m11+n*this.m21,this.m12=t*this.m12+n*this.m22,this.m21=t*this.m21-n*r,this.m22=t*this.m22-n*i,this}scale(e,t){return this.m11*=e,this.m12*=e,this.m21*=t,this.m22*=t,this}get inverse(){let t=this.det;return new e((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new e(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},_=class e{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(e){e&&(this.m=e)}static translate(t){return new e([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new e([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=o(-t);let n=Math.cos(t),r=Math.sin(t);return new e([1,0,0,0,0,n,-r,0,0,r,n,0,0,0,0,1])}static rotateY(t){t=o(-t);let n=Math.cos(t),r=Math.sin(t);return new e([n,0,r,0,0,1,0,0,-r,0,n,0,0,0,0,1])}static rotateZ(t){t=o(-t);let n=Math.cos(t),r=Math.sin(t);return new e([n,-r,0,0,r,n,0,0,0,0,1,0,0,0,0,1])}translate(e){return this.m[12]+=this.m[0]*e.x+this.m[4]*e.y,this.m[13]+=this.m[1]*e.x+this.m[5]*e.y,this.m[14]+=this.m[2]*e.x+this.m[6]*e.y,this.m[15]+=this.m[3]*e.x+this.m[7]*e.y,this}scale(e){return this.m[0]*=e.x,this.m[4]*=e.y,this.m[1]*=e.x,this.m[5]*=e.y,this.m[2]*=e.x,this.m[6]*=e.y,this.m[3]*=e.x,this.m[7]*=e.y,this}rotate(e){e=o(-e);let t=Math.cos(e),n=Math.sin(e),r=this.m[0],i=this.m[1],a=this.m[4],s=this.m[5];return this.m[0]=r*t+i*n,this.m[1]=-r*n+i*t,this.m[4]=a*t+s*n,this.m[5]=-a*n+s*t,this}mult(t){let n=[];for(let e=0;e<4;e++)for(let r=0;r<4;r++)n[e*4+r]=this.m[0+r]*t.m[e*4+0]+this.m[4+r]*t.m[e*4+1]+this.m[8+r]*t.m[e*4+2]+this.m[12+r]*t.m[e*4+3];return new e(n)}multVec2(e){return new d(e.x*this.m[0]+e.y*this.m[4]+this.m[12],e.x*this.m[1]+e.y*this.m[5]+this.m[13])}getTranslation(){return new d(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let e=this.m[0]*this.m[5]-this.m[1]*this.m[4],t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new d(t,e/t)}else if(this.m[4]!=0||this.m[5]!=0){let e=this.m[0]*this.m[5]-this.m[1]*this.m[4],t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new d(e/t,t)}else return new d(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let e=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return s(this.m[1]>0?Math.acos(this.m[0]/e):-Math.acos(this.m[0]/e))}else if(this.m[4]!=0||this.m[5]!=0){let e=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return s(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/e):-Math.acos(this.m[4]/e)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let e=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new d(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(e*e),0)}else if(this.m[4]!=0||this.m[5]!=0){let e=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new d(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(e*e))}else return new d(0,0)}invert(){let t=[],n=this.m[10]*this.m[15]-this.m[14]*this.m[11],r=this.m[9]*this.m[15]-this.m[13]*this.m[11],i=this.m[9]*this.m[14]-this.m[13]*this.m[10],a=this.m[8]*this.m[15]-this.m[12]*this.m[11],o=this.m[8]*this.m[14]-this.m[12]*this.m[10],s=this.m[8]*this.m[13]-this.m[12]*this.m[9],c=this.m[6]*this.m[15]-this.m[14]*this.m[7],l=this.m[5]*this.m[15]-this.m[13]*this.m[7],u=this.m[5]*this.m[14]-this.m[13]*this.m[6],d=this.m[4]*this.m[15]-this.m[12]*this.m[7],f=this.m[4]*this.m[14]-this.m[12]*this.m[6],p=this.m[5]*this.m[15]-this.m[13]*this.m[7],m=this.m[4]*this.m[13]-this.m[12]*this.m[5],h=this.m[6]*this.m[11]-this.m[10]*this.m[7],g=this.m[5]*this.m[11]-this.m[9]*this.m[7],_=this.m[5]*this.m[10]-this.m[9]*this.m[6],v=this.m[4]*this.m[11]-this.m[8]*this.m[7],y=this.m[4]*this.m[10]-this.m[8]*this.m[6],b=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*n-this.m[6]*r+this.m[7]*i,t[4]=-(this.m[4]*n-this.m[6]*a+this.m[7]*o),t[8]=this.m[4]*r-this.m[5]*a+this.m[7]*s,t[12]=-(this.m[4]*i-this.m[5]*o+this.m[6]*s),t[1]=-(this.m[1]*n-this.m[2]*r+this.m[3]*i),t[5]=this.m[0]*n-this.m[2]*a+this.m[3]*o,t[9]=-(this.m[0]*r-this.m[1]*a+this.m[3]*s),t[13]=this.m[0]*i-this.m[1]*o+this.m[2]*s,t[2]=this.m[1]*c-this.m[2]*l+this.m[3]*u,t[6]=-(this.m[0]*c-this.m[2]*d+this.m[3]*f),t[10]=this.m[0]*p-this.m[1]*d+this.m[3]*m,t[14]=-(this.m[0]*u-this.m[1]*f+this.m[2]*m),t[3]=-(this.m[1]*h-this.m[2]*g+this.m[3]*_),t[7]=this.m[0]*h-this.m[2]*v+this.m[3]*y,t[11]=-(this.m[0]*g-this.m[1]*v+this.m[3]*b),t[15]=this.m[0]*_-this.m[1]*y+this.m[2]*b;let x=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let e=0;e<4;e++)for(let n=0;n<4;n++)t[e*4+n]*=1/x;return new e(t)}clone(){return new e([...this.m])}toString(){return this.m.toString()}};function v(e,t,n,r=e=>-Math.cos(e)){return e+(r(n)+1)/2*(t-e)}var y=1103515245,b=12345,x=2147483648,S=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(y*this.seed+b)%x,this.seed/x}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new d(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new r(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]==`number`)return this.genNumber(0,e[0]);if(e[0]instanceof d)return this.genVec2(f(0,0),e[0]);if(e[0]instanceof r)return this.genColor(i(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]==`number`&&typeof e[1]==`number`)return this.genNumber(e[0],e[1]);if(e[0]instanceof d&&e[1]instanceof d)return this.genVec2(e[0],e[1]);if(e[0]instanceof r&&e[1]instanceof r)return this.genColor(e[0],e[1])}throw Error(`More than 2 arguments not supported`)}},C=new S(Date.now());function w(e){return e!=null&&(C.seed=e),C.seed}function T(...e){return C.genAny(...e)}function E(...e){return Math.floor(T(...e.length>0?e:[2]))}function D(e){return T()<=e}function O(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function ee(e,t){return e.length<=t?e.slice():O(e.slice()).slice(0,t)}function te(e){return e[E(e.length)]}function ne(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function k(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let n=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(n===0)return null;let r=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/n,i=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/n;return r<0||r>1||i<0||i>1?null:r}function re(e,t){let n=k(e,t);return n?f(e.p1.x+n*(e.p2.x-e.p1.x),e.p1.y+n*(e.p2.y-e.p1.y)):null}function A(e,t){let n=t.p2.sub(t.p1),r=-1/0,i=1/0;if(n.x!=0){let a=(e.pos.x-t.p1.x)/n.x,o=(e.pos.x+e.width-t.p1.x)/n.x;r=Math.max(r,Math.min(a,o)),i=Math.min(i,Math.max(a,o))}if(n.y!=0){let a=(e.pos.y-t.p1.y)/n.y,o=(e.pos.y+e.height-t.p1.y)/n.y;r=Math.max(r,Math.min(a,o)),i=Math.min(i,Math.max(a,o))}return i>=r&&i>=0&&r<=1}function j(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function ie(e,t){let n=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),r=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return f(n,r).sdist(t.center)<=t.radius*t.radius}function M(e,t){return se(t,new H(e.points()))}function N(e,t){let n=t.sub(e.p1),r=e.p2.sub(e.p1);if(Math.abs(n.cross(r))>2**-52)return!1;let i=n.dot(r)/r.dot(r);return i>=0&&i<=1}function P(e,t){let n=e.p2.sub(e.p1),r=n.dot(n),i=e.p1.sub(t.center),a=2*n.dot(i),o=i.dot(i)-t.radius*t.radius,s=a*a-4*r*o;if(r<=2**-52||s<0)return!1;if(s==0){let e=-a/(2*r);if(e>=0&&e<=1)return!0}else{let e=(-a+Math.sqrt(s))/(2*r),t=(-a-Math.sqrt(s))/(2*r);if(e>=0&&e<=1||t>=0&&t<=1)return!0}return ae(t,e.p1)}function F(e,t){if(L(t,e.p1)||L(t,e.p2))return!0;for(let n=0;n<t.pts.length;n++){let r=t.pts[n],i=t.pts[(n+1)%t.pts.length];if(re(e,new z(r,i)))return!0}return!1}function ae(e,t){return e.center.sdist(t)<e.radius*e.radius}function I(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function oe(e,t){let n=t.pts[t.pts.length-1];for(let r of t.pts){if(P(new z(n,r),e))return!0;n=r}return ae(e,t.pts[0])?!0:L(t,e.center)}function se(e,t){for(let n=0;n<e.pts.length;n++)if(F(new z(e.pts[n],e.pts[(n+1)%e.pts.length]),t))return!0;return!!(e.pts.some(e=>L(t,e))||t.pts.some(t=>L(e,t)))}function L(e,t){let n=!1,r=e.pts;for(let e=0,i=r.length-1;e<r.length;i=e++)r[e].y>t.y!=r[i].y>t.y&&t.x<(r[i].x-r[e].x)*(t.y-r[e].y)/(r[i].y-r[e].y)+r[e].x&&(n=!n);return n}function R(e,t){t=t.sub(e.center);let n=o(e.angle),r=Math.cos(n),i=Math.sin(n),a=t.x*r+t.y*i,s=-t.x*i+t.y*r;return a*a/(e.radiusX*e.radiusX)+s*s/(e.radiusY*e.radiusY)<1}function ce(e,t){let n=t.center.sub(e.center),r=o(e.angle),i=Math.cos(r),a=Math.sin(r),s=n.x*i+n.y*a,c=-n.x*a+n.y*i;return R(new De(f(),e.radiusX+t.radius,e.radiusY+t.radius,0),f(s,c))}function le(e,t){let n=e.toMat2().inverse;return t=new z(n.transform(t.p1.sub(e.center)),n.transform(t.p2.sub(e.center))),P(t,new V(f(),1))}function ue(e,t){if(e.radiusX===e.radiusY)return ce(t,new V(e.center,e.radiusX));if(t.radiusX===t.radiusY)return ce(e,new V(t.center,t.radiusX));let n=new g(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),r=new g(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),i=e.center.x,a=e.center.y,s=t.center.x,c=t.center.y,l=o(e.angle),u=o(t.angle),d=new g(Math.cos(l),-Math.sin(l),i,Math.sin(l),Math.cos(l),a,0,0,1),f=new g(Math.cos(u),-Math.sin(u),s,Math.sin(u),Math.cos(u),c,0,0,1),p=d.inverse,m=f.inverse,h=p.transpose.mul(n).mul(p),_=m.transpose.mul(r).mul(m),v=h.m11,y=h.m12,b=h.m13,x=h.m21,S=h.m22,C=h.m23,w=h.m31,T=h.m32,E=h.m33,D=_.m11,O=_.m12,ee=_.m13,te=_.m21,ne=_.m22,k=_.m23,re=_.m31,A=_.m32,j=_.m33,ie=v*S*E-v*C*T-y*x*E+y*C*w+b*x*T-b*S*w,M=(v*S*j-v*C*A-v*T*k+v*E*ne-y*x*j+y*C*re+y*w*k-y*E*te+b*x*A-b*S*re-b*w*ne+b*T*te+x*T*ee-x*E*O-S*w*ee+S*E*D+C*w*O-C*T*D)/ie,N=(v*ne*j-v*k*A-y*te*j+y*k*re+b*te*A-b*ne*re-x*O*j+x*ee*A+S*D*j-S*ee*re-C*D*A+C*O*re+w*O*k-w*ee*ne-T*D*k+T*ee*te+E*D*ne-E*O*te)/ie,P=(D*ne*j-D*k*A-O*te*j+O*k*re+ee*te*A-ee*ne*re)/ie;if(M>=0){let e=-3*N+M**2,t=3*M*P+N*M**2-4*N**2,n=-27*P**2+18*P*M*N+M**2*N**2-4*M**3*P-4*N**3;return!(e>0&&t<0&&n>0)}else{let e=-3*N+M**2,t=-27*P**2+18*P*M*N+M**2*N**2-4*M**3*P-4*N**3;return!(e>0&&t>0)}}function de(e,t){return fe(e,new H(t.points()))}function fe(e,t){let n=e.toMat2().inverse;return t=new H(t.pts.map(t=>n.transform(t.sub(e.center)))),oe(new V(f(),1),t)}function pe(e,t){return e.x===t.x&&e.y===t.y}function me(e,t){return t instanceof d?pe(t,e.pt):t instanceof V?ae(t,e.pt):t instanceof z?N(t,e.pt):t instanceof B?j(t,e.pt):t instanceof H?L(t,e.pt):t instanceof De?R(t,e.pt):!1}function he(e,t){return t instanceof d?N(e,t):t instanceof V?P(e,t):t instanceof z?re(e,t)!=null:t instanceof B?A(t,e):t instanceof H?F(e,t):t instanceof De?le(t,e):!1}function ge(e,t){return t instanceof d?ae(e,t):t instanceof V?I(e,t):t instanceof z?P(t,e):t instanceof B?ie(t,e):t instanceof H?oe(e,t):t instanceof De?ce(t,e):!1}function _e(e,t){return t instanceof d?j(e,t):t instanceof V?ie(e,t):t instanceof z?A(e,t):t instanceof B?ne(e,t):t instanceof H?M(e,t):t instanceof De?de(t,e):!1}function ve(e,t){return t instanceof d?L(e,t):t instanceof V?oe(t,e):t instanceof z?F(t,e):t instanceof B?M(t,e):t instanceof H?se(t,e):t instanceof De?fe(t,e):!1}function ye(e,t){return t instanceof d?R(e,t):t instanceof V?ce(e,t):t instanceof z?le(e,t):t instanceof B?de(e,t):t instanceof H?fe(e,t):t instanceof De?ue(t,e):!1}function be(e,t,n){let r=e,i=n.p1,a=n.p2,o=t,s=a.sub(i),c=o.cross(s);if(Math.abs(c)<2**-52)return null;let l=i.sub(r),u=l.cross(s)/c;if(u<=0||u>=1)return null;let d=l.cross(o)/c;if(d<=0||d>=1)return null;let f=s.normal().unit();return t.dot(f)>0&&(f.x*=-1,f.y*=-1),{point:r.add(o.scale(u)),normal:f,fraction:u}}function xe(e,t,n){let r=-1/0,i=1/0,a;if(e.x!=0){let o=(n.pos.x-e.x)/t.x,s=(n.pos.x+n.width-e.x)/t.x;a=f(-Math.sign(t.x),0),r=Math.max(r,Math.min(o,s)),i=Math.min(i,Math.max(o,s))}if(e.y!=0){let o=(n.pos.y-e.y)/t.y,s=(n.pos.y+n.height-e.y)/t.y;Math.min(o,s)>r&&(a=f(0,-Math.sign(t.y))),r=Math.max(r,Math.min(o,s)),i=Math.min(i,Math.max(o,s))}return i>=r&&r>=0&&r<=1?{point:e.add(t.scale(r)),normal:a,fraction:r}:null}function Se(e,t,n){let r=e,i=n.center,a=t,o=a.dot(a),s=r.sub(i),c=2*a.dot(s),l=s.dot(s)-n.radius*n.radius,u=c*c-4*o*l;if(o<=2**-52||u<0)return null;if(u==0){let e=-c/(2*o);if(e>=0&&e<=1){let t=r.add(a.scale(e));return{point:t,normal:t.sub(i),fraction:e}}}else{let e=(-c+Math.sqrt(u))/(2*o),t=(-c-Math.sqrt(u))/(2*o),n=null;if(e>=0&&e<=1&&(n=e),t>=0&&t<=1&&(n=Math.min(t,n??t)),n!=null){let e=r.add(a.scale(n));return{point:e,normal:e.sub(i).unit(),fraction:n}}}return null}function Ce(e,t,n){let r=n.pts,i=null,a=r[r.length-1];for(let n=0;n<r.length;n++){let o=r[n],s=be(e,t,new z(a,o));s&&(!i||i.fraction>s.fraction)&&(i=s),a=o}return i}function we(e,t,n){let r=n.toMat2(),i=r.inverse,a=i.transform(e.sub(n.center)),s=i.transform(t),c=Se(a,s,new V(f(),1));if(c){let i=h.rotation(o(-n.angle)),a=h.scale(n.radiusX,n.radiusY).transform(c.point),s=r.transform(c.point).add(n.center),l=s.dist(e)/t.len();return{point:s,normal:i.transform(f(n.radiusY**2*a.x,n.radiusX**2*a.y)).unit(),fraction:l}}return c}function Te(e,t,n,r=64){let i=e,a=t.len(),o=t.scale(1/a),s=0,c=f(Math.floor(e.x),Math.floor(e.y)),l=f(o.x>0?1:-1,o.y>0?1:-1),u=f(Math.abs(1/o.x),Math.abs(1/o.y)),d=f(l.x>0?c.x+1-e.x:e.x-c.x,l.y>0?c.y+1-e.y:e.y-c.y),p=f(u.x<1/0?u.x*d.x:1/0,u.y<1/0?u.y*d.y:1/0),m=-1;for(;s<=r;){let e=n(c);if(e===!0)return{point:i.add(o.scale(s)),normal:f(m===0?-l.x:0,m===1?-l.y:0),fraction:s/a,gridPos:c};if(e)return e;p.x<p.y?(c.x+=l.x,s=p.x,p.x+=u.x,m=0):(c.y+=l.y,s=p.y,p.y+=u.y,m=1)}return null}var Ee=class e{pt;constructor(e){this.pt=e.clone()}transform(t){return new e(t.multVec2(this.pt))}bbox(){return new B(this.pt,0,0)}area(){return 0}clone(){return new e(this.pt)}collides(e){return me(this,e)}contains(e){return this.pt.eq(e)}raycast(e,t){return null}random(){return this.pt.clone()}},z=class e{p1;p2;constructor(e,t){this.p1=e.clone(),this.p2=t.clone()}transform(t){return new e(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return B.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new e(this.p1,this.p2)}collides(e){return he(this,e)}contains(e){return this.collides(e)}raycast(e,t){return be(e,t,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(T(1)))}},B=class e{pos;width;height;constructor(e,t,n){this.pos=e.clone(),this.width=t,this.height=n}static fromPoints(t,n){return new e(t.clone(),n.x-t.x,n.y-t.y)}center(){return new d(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(e){return new H(this.points().map(t=>e.multVec2(t)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new e(this.pos.clone(),this.width,this.height)}distToPoint(e){return Math.sqrt(this.sdistToPoint(e))}sdistToPoint(e){let t=this.pos,n=this.pos.add(this.width,this.height),r=Math.max(t.x-e.x,0,e.x-n.x),i=Math.max(t.y-e.y,0,e.y-n.y);return r*r+i*i}collides(e){return _e(this,e)}contains(e){return this.collides(e)}raycast(e,t){return xe(e,t,this)}random(){return this.pos.add(T(this.width),T(this.height))}},V=class e{center;radius;constructor(e,t){this.center=e.clone(),this.radius=t}transform(e){return new De(this.center,this.radius,this.radius).transform(e)}bbox(){return B.fromPoints(this.center.sub(f(this.radius)),this.center.add(f(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new e(this.center,this.radius)}collides(e){return ge(this,e)}contains(e){return this.collides(e)}raycast(e,t){return Se(e,t,this)}random(){return this.center.add(d.fromAngle(T(360)).scale(T(this.radius)))}},De=class e{center;radiusX;radiusY;angle;constructor(e,t,n,r=0){this.center=e.clone(),this.radiusX=t,this.radiusY=n,this.angle=r}static fromMat2(t){let n=t.inverse,r=n.transpose.mul(n),[i,a]=r.eigenvalues,[o,c]=r.eigenvectors(i,a),[l,u]=[1/Math.sqrt(i),1/Math.sqrt(a)];return l>u?new e(f(),l,u,s(Math.atan2(-o[1],o[0]))):new e(f(),u,l,s(Math.atan2(-c[1],c[0])))}toMat2(){let e=o(this.angle),t=Math.cos(e),n=Math.sin(e);return new h(t*this.radiusX,-n*this.radiusY,n*this.radiusX,t*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new e(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let n=this.toMat2(),r=t.getRotation(),i=t.getScale();n=g.fromMat2(n).scale(i.x,i.y).rotate(r).toMat2();let a=e.fromMat2(n);return a.center=t.multVec2(this.center),a}}bbox(){if(this.angle==0)return B.fromPoints(this.center.sub(f(this.radiusX,this.radiusY)),this.center.add(f(this.radiusX,this.radiusY)));{let e=o(this.angle),t=Math.cos(e),n=Math.sin(e),r=this.radiusX*t,i=this.radiusX*n,a=this.radiusY*n,s=this.radiusY*t,c=Math.sqrt(r*r+a*a),l=Math.sqrt(i*i+s*s);return B.fromPoints(this.center.sub(f(c,l)),this.center.add(f(c,l)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new e(this.center,this.radiusX,this.radiusY,this.angle)}collides(e){return ye(this,e)}contains(e){e=e.sub(this.center);let t=o(this.angle),n=Math.cos(t),r=Math.sin(t),i=e.x*n+e.y*r,a=-e.x*r+e.y*n;return i*i/(this.radiusX*this.radiusX)+a*a/(this.radiusY*this.radiusY)<1}raycast(e,t){return we(e,t,this)}random(){return this.center}};function Oe(e,t,n,r){let i=t.sub(e),a=r.sub(n),o=i.cross(a);return o<1e-5&&o>-1e-5||(o=n.sub(e).cross(a)/o,o<0||o>1)?null:e.add(i.scale(o))}var H=class e{pts;constructor(e){if(e.length<3)throw Error(`Polygons should have at least 3 vertices`);this.pts=e}transform(t){return new e(this.pts.map(e=>t.multVec2(e)))}bbox(){let e=f(Number.MAX_VALUE),t=f(-Number.MAX_VALUE);for(let n of this.pts)e.x=Math.min(e.x,n.x),t.x=Math.max(t.x,n.x),e.y=Math.min(e.y,n.y),t.y=Math.max(t.y,n.y);return B.fromPoints(e,t)}area(){let e=0,t=this.pts.length;for(let n=0;n<t;n++){let r=this.pts[n],i=this.pts[(n+1)%t];e+=r.x*i.y*.5,e-=i.x*r.y*.5}return Math.abs(e)}clone(){return new e(this.pts.map(e=>e.clone()))}collides(e){return ve(this,e)}contains(e){return this.collides(e)}raycast(e,t){return Ce(e,t,this)}random(){return f()}cut(t,n){new z(t,n);let r=[],i=[],a=n.sub(t),o=this.pts[this.pts.length-1],s=o.sub(t),c=a.cross(s)>0;return this.pts.forEach(e=>{s=e.sub(t);let l=a.cross(s)>0;if(c!=l){let a=Oe(o,e,t,n);r.push(a),i.push(a),c=l}(l?r:i).push(e),o=e}),[r.length?new e(r):null,i.length?new e(i):null]}};function ke(e,t,n,r){let i=r*r,a=1-r,o=a*a;return e.scale(o).add(t.scale(2*a*r)).add(n.scale(i))}function Ae(e,t,n,r){let i=1-r;return t.sub(e).scale(2*i).add(n.sub(t).scale(2*r))}function je(e,t,n,r){return n.sub(t.scale(2)).add(e).scale(2)}function Me(e,t,n,r,i){let a=i*i,o=a*i,s=1-i,c=s*s,l=c*s;return e.scale(l).add(t.scale(3*c*i)).add(n.scale(3*s*a)).add(r.scale(o))}function Ne(e,t,n,r,i){let a=i*i,o=1-i,s=o*o;return t.sub(e).scale(3*s).add(n.sub(t).scale(6*o*i)).add(r.sub(n).scale(3*a))}function U(e,t,n,r,i){let a=1-i;return n.sub(t.scale(2)).add(e).scale(6*a).add(r.sub(n.scale(2)).add(t).scale(6*i))}function Pe(e,t,n,r,i){let a=.5*(((-i+2)*i-1)*i),o=.5*((3*i-5)*i*i+2),s=.5*(((-3*i+4)*i+1)*i),c=.5*((i-1)*i*i);return e.scale(a).add(t.scale(o)).add(n.scale(s)).add(r.scale(c))}function Fe(e,t,n,r,i){let a=.5*((-3*i+4)*i-1),o=.5*((9*i-10)*i),s=.5*((-9*i+8)*i+1),c=.5*((3*i-2)*i);return e.scale(a).add(t.scale(o)).add(n.scale(s)).add(r.scale(c))}function Ie(e){let t=Le(e),n=t(1);return r=>{let i=r*n,a=t(i,!0);return e(a)}}function Le(e,t=10,n=10){let r=[0],i=[0],a=1/(t-1)/n,o=0,s=e(0),c=0;for(let l=1;l<t;l++){for(let t=0;t<n;t++){c+=a;let t=e(c),n=t.dist(s);o+=n,s=t}r[l]=o,i[l]=c}return i[t-1]=1,(e,n=!1)=>{if(n){let t=e;if(t<=0)return 0;if(t>=o)return 1;let n=0;for(;r[n+1]<t;)n++;let a=i[n],s=i[n+1],c=r[n],l=r[n+1],u=(t-c)/(l-c);return a+(s-a)*u}else{if(e<=0)return 0;if(e>=1)return r[t-1];let n=0;for(;i[n+1]<e;)n++;let a=i[n],o=i[n+1],s=r[n],c=r[n+1],l=(e-a)/(o-a);return s+(c-s)*l}}}function Re(e,t,n,r){let i=2*e+t-2*r+n,a=-3*e+3*r-2*t-n,o=t,s=e;return e=>{let t=e*e,n=t*e;return i*n+a*t+o*e+s}}function ze(e,t,n,r,i,a=Re){let o=a(t.x,(1-i)*(n.x-e.x),(1-i)*(r.x-t.x),n.x),s=a(t.y,(1-i)*(n.y-e.y),(1-i)*(r.y-t.y),n.y);return e=>new d(o(e),s(e))}function Be(e,t,n,r,i=Re){return ze(e,t,n,r,.5,i)}function Ve(e,t,n,r,i=Re){return Be(r.add(e.sub(t).scale(6)),e,r,e.add(r.sub(n).scale(6)),i)}function He(e,t,n,r,i,a,o,s=Re){let c=s(t.x,.5*(1-i)*(1+o)*(1+a)*(t.x-e.x)+.5*(1-i)*(1-o)*(1-a)*(n.x-t.x),.5*(1-i)*(1+o)*(1-a)*(n.x-t.x)+.5*(1-i)*(1-o)*(1+a)*(r.x-n.x),n.x),l=s(t.y,.5*(1-i)*(1+o)*(1+a)*(t.y-e.y)+.5*(1-i)*(1-o)*(1-a)*(n.y-t.y),.5*(1-i)*(1+o)*(1-a)*(n.y-t.y)+.5*(1-i)*(1-o)*(1+a)*(r.y-n.y),n.y);return e=>new d(c(e),l(e))}function Ue(e,t,n,r){let i=2*e+t-2*r+n,a=-3*e+3*r-2*t+n,o=t;return e=>{let t=e*e;return 3*i*t+2*a*e+o}}function We(e){return 0<=e&&e<=1}function Ge(e,t){return Math.abs(e-t)<=2**-52}function Ke(e){return e<0?-((-e)**(1/3)):e**(1/3)}function qe(e,t,n,r){let i=3*e-6*t+3*n,a=-3*e+3*t,o=e,s=-e+3*t-3*n+r;if(Ge(s,0)){if(Ge(i,0))return Ge(a,0)?[]:[-o/a].filter(We);let e=Math.sqrt(a*a-4*i*o),t=2*i;return[(e-a)/t,(-a-e)/t].filter(We)}i/=s,a/=s,o/=s;let c=(3*a-i*i)/3,l=c/3,u=(2*i*i*i-9*i*a+27*o)/27,d=u/2,f=d*d+l*l*l;if(f<0){let e=-c/3,t=e*e*e,n=Math.sqrt(t),r=-u/(2*n),a=r<-1?-1:r>1?1:r,o=Math.acos(a),s=2*Ke(n),l=s*Math.cos(o/3)-i/3,d=s*Math.cos((o+2*Math.PI)/3)-i/3,f=s*Math.cos((o+4*Math.PI)/3)-i/3;return[l,d,f].filter(We)}if(f===0){let e=d<0?Ke(-d):-Ke(d),t=2*e-i/3,n=-e-i/3;return[t,n].filter(We)}let p=Math.sqrt(f),m=Ke(p-d),h=Ke(p+d);return[m-h-i/3].filter(We)}function Je(e,t,n,r,i){let a=qe(e.x-i,t.x-i,n.x-i,r.x-i);return a.length>0?Me(e,t,n,r,a[0]).y:NaN}function Ye(e){if(!e||e.length==0)throw Error(`Need at least one point for easingLinear.`);let t=e.length;return n=>{if(n<=0||e.length==1||n<=e[0].x)return e[0].y;for(let r=0;r<t;r++)if(e[r].x>=n)return l(n,e[r-1].x,e[r].x,e[r-1].y,e[r].y);return e[e.length-1].y}}function Xe(e,t){return n=>Je(f(0,0),e,t,f(1,1),n)}function Ze(e,t=`jump-end`){let n=1/e,r=t==`jump-start`||t==`jump-both`,i=1/(e+(t==`jump-end`||t==`jump-both`?1:0)),a=r?i:0;return e=>{let t=Math.floor(e/n);return a+t*i}}function Qe(e,t){let n=Number.MAX_VALUE,r={normal:f(0),distance:0};for(let i of[e,t])for(let a=0;a<i.pts.length;a++){let o=i.pts[a],s=i.pts[(a+1)%i.pts.length].sub(o).normal().unit(),c=Number.MAX_VALUE,l=-Number.MAX_VALUE;for(let t=0;t<e.pts.length;t++){let n=e.pts[t].dot(s);c=Math.min(c,n),l=Math.max(l,n)}let u=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let e=0;e<t.pts.length;e++){let n=t.pts[e].dot(s);u=Math.min(u,n),d=Math.max(d,n)}let f=Math.min(l,d)-Math.max(c,u);if(f<0)return null;if(f<Math.abs(n)){let e=d-c,t=u-l;n=Math.abs(e)<Math.abs(t)?e:t,r.normal=s,r.distance=n}}return r}function $e(e,t,n){return(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x)>=0}function et(e){let t=0,n=e[e.length-1];for(let r=0;r<e.length;r++)t+=(e[r].x-n.x)*(e[r].y+n.y),n=e[r];return t<0}function tt(e,t,n,r){let i=r.x-n.x,a=r.y-n.y,o=i*(e.y-n.y)-a*(e.x-n.x),s=i*(t.y-n.y)-a*(t.x-n.x);return o*s>=0}function nt(e,t,n,r){return tt(e,t,n,r)&&tt(e,n,t,r)&&tt(e,r,t,n)}function rt(e,t,n,r){for(let i of e)if(i!==t&&i!==n&&i!==r&&nt(i,t,n,r))return!0;return!1}function it(e,t,n,r){return $e(e,t,n)&&!rt(r,e,t,n)}function at(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],n=[],r=0;for(let i=0;i<e.length;i++){let a=e[r],o=e[i];(o.x<a.x||o.x==a.x&&o.y<a.y)&&(r=r),t[i]=i+1,n[i]=i-1}t[t.length-1]=0,n[0]=n.length-1,et(e)||([t,n]=[n,t]);let i=[];for(let r=0;r<e.length;++r)$e(e[n[r]],e[r],e[t[r]])||i.push(e[r]);let a=[],o=e.length,s=1,c=0,l,u;for(;o>3;){l=t[s],u=n[s];let r=e[u],d=e[s],f=e[l];if(it(r,d,f,i))a.push([r,d,f]),t[u]=l,n[l]=u,i.splice(i.indexOf(d),1),--o,c=0;else if(++c>o)return[];s=l}return l=t[s],u=n[s],a.push([e[u],e[s],e[l]]),a}function ot(e){if(e.length<3)return!1;let t=e.length-2,n=e.length-1,r=0,i=e[n].sub(e[t]),a=e[r].sub(e[n]),o=i.cross(a);for(;r+1<e.length;)if(t=n,n=r,r++,i=e[n].sub(e[t]),a=e[r].sub(e[n]),i.cross(a)*o<0)return!1;return!0}var st=` !"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_\`abcdefghijklmnopqrstuvwxyz{|}~`,ct=`topleft`,lt=`monospace`,ut=`monospace`,dt=`linear`,ft=[{name:`a_pos`,size:2},{name:`a_uv`,size:2},{name:`a_color`,size:4}],pt=ft.reduce((e,t)=>e+t.size,0),mt=2048,ht=mt*4*pt,gt=mt*6,_t=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,vt=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,yt=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,bt=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,xt=new Set([`id`,`require`]),St=new Set([`add`,`fixedUpdate`,`update`,`draw`,`destroy`,`inspect`,`drawInspect`]),Ct=200,wt=640,Tt=65536,Et=Symbol.for(`kaplay.cancel`),Dt=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},Ot=class e{paused=!1;cancel;constructor(e){this.cancel=e}static join(t){let n=new e(()=>t.forEach(e=>e.cancel()));return Object.defineProperty(n,`paused`,{get:()=>t[0].paused,set:e=>t.forEach(t=>t.paused=e)}),n.paused=!1,n}static replace(e,t){return e.cancel=()=>t.cancel(),t.paused=e.paused,Object.defineProperty(e,`paused`,{get:()=>t.paused,set:e=>t.paused=e}),e}},W=class{cancellers=new WeakMap;handlers=new Dt;add(e){function t(...t){if(!r.paused)return e(...t)}let n=this.handlers.pushd(t),r=new Ot(n);return this.cancellers.set(t,n),r}addOnce(e){let t=this.add((...n)=>{t.cancel(),e(...n)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let n=t(...e),r;n===Et&&(r=this.cancellers.get(t))&&r()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},kt=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new W),this.handlers[e].add(t)}onOnce(e,t){let n=this.on(e,(...e)=>{n.cancel(),t(...e)});return n}next(e){return new Promise(t=>{this.onOnce(e,(...e)=>t(e[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},At=e=>e[0]instanceof r,jt=e=>e[0]instanceof d,Mt=e=>typeof e[0]==`number`,Nt=class{_items;_compareFn;constructor(e=(e,t)=>e<t){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function Pt(e){let t=window.atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r.buffer}function Ft(e){return Pt(e.split(`,`)[1])}function It(e,t){let n=document.createElement(`a`);n.href=t,n.download=e,n.click()}function Lt(e,t){It(e,`data:text/plain;charset=utf-8,`+t)}function Rt(e,t){Lt(e,JSON.stringify(t))}function zt(e,t){let n=URL.createObjectURL(t);It(e,n),URL.revokeObjectURL(n)}var Bt=e=>e.match(/^data:\w+\/\w+;base64,.+/),Vt=e=>e.split(`.`).slice(0,-1).join(`.`);function Ht(e,t){if(e===t)return!0;let n=typeof e,r=typeof t;if(n!==r)return!1;if(n===`object`&&r===`object`&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(let r of n){let n=e[r],i=t[r];if(!Ht(n,i))return!1}return!0}return!1}var Ut=new Set,Wt=e=>e instanceof Error?e.message:String(e);function Gt(e){Ut.has(e)||(Ut.add(e),console.warn(e))}function Kt(e,t){Gt(`${e} is deprecated. Use ${t} instead.`)}function qt(e,t){return Number(e.toFixed(t))}function G(e,t){return(...n)=>{let r=n.length;if(r===e.length)return e(...n);if(r===t.length)return t(...n)}}var Jt=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function Yt(e){if(typeof e!=`string`)throw TypeError(`string cannot be undefined or null`);let t=[],n=0,r=0;for(;n<e.length;){if(r+=Xt(n+r,e),an(e[n+r])&&r++,tn(e[n+r])&&r++,nn(e[n+r])&&r++,on(e[n+r])){r++;continue}t.push(e.substring(n,n+r)),n+=r,r=0}return t}function Xt(e,t){let n=t[e];if(!Zt(n)||e===t.length-1)return 1;let r=n+t[e+1],i=t.substring(e+2,e+5);return Qt(r)&&Qt(i)?4:$t(r)&&rn(i)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:en(i)?4:2}function Zt(e){return e&&cn(e[0].charCodeAt(0),55296,56319)}function Qt(e){return cn(sn(e),127462,127487)}function $t(e){return cn(sn(e),127988,127988)}function en(e){return cn(sn(e),127995,127999)}function tn(e){return typeof e==`string`&&cn(e.charCodeAt(0),65024,65039)}function nn(e){return typeof e==`string`&&cn(e.charCodeAt(0),8400,8447)}function rn(e){let t=e.codePointAt(0);return typeof e==`string`&&typeof t==`number`&&cn(t,917504,917631)}function an(e){return typeof e==`string`&&Jt.includes(e.charCodeAt(0))}function on(e){return typeof e==`string`&&e.charCodeAt(0)===8205}function sn(e){let t=e.charCodeAt(0)-55296,n=e.charCodeAt(1)-56320;return(t<<10)+n+65536}function cn(e,t,n){return e>=t&&e<=n}var ln=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,un=(e,t)=>Array.isArray(t)?t.some(t=>e.has(t)):e.has(t),dn=(e,t,n)=>{e.has(t)?e.get(t)?.push(n):e.set(t,[n])},fn=(()=>{let e=0;return()=>e++})(),pn={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:`south`,1:`east`,2:`west`,3:`north`,4:`lshoulder`,5:`rshoulder`,6:`ltrigger`,7:`rtrigger`,8:`select`,9:`start`,10:`lstick`,11:`rstick`,12:`dpad-up`,13:`dpad-down`,14:`dpad-left`,15:`dpad-right`,16:`home`,17:`capture`},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:`south`,1:`east`,2:`west`,3:`north`,4:`lshoulder`,5:`rshoulder`,9:`select`,10:`lstick`,16:`start`},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:`south`,1:`east`,2:`west`,3:`north`,4:`lshoulder`,5:`rshoulder`,9:`start`,10:`lstick`,16:`select`},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:`south`,1:`east`,2:`west`,3:`north`,4:`lshoulder`,5:`rshoulder`,6:`ltrigger`,7:`rtrigger`,8:`select`,9:`start`,10:`lstick`,11:`rstick`,12:`dpad-up`,13:`dpad-down`,14:`dpad-left`,15:`dpad-right`,16:`home`,17:`capture`},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:`south`,1:`east`,2:`west`,3:`north`,4:`lshoulder`,5:`rshoulder`,6:`ltrigger`,7:`rtrigger`,8:`select`,9:`start`,10:`lstick`,11:`rstick`,12:`dpad-up`,13:`dpad-down`,14:`dpad-left`,15:`dpad-right`,16:`home`},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function mn(){let e=Q.globalOpt.pixelDensity??1,t=Q.globalOpt.width,n=Q.globalOpt.height,r=Q.gfx.ggl.gl.drawingBufferWidth,i=Q.gfx.ggl.gl.drawingBufferHeight,a=r/e,o=i/e,s=0,c=0,l=a,u=o;if(Q.globalOpt.letterbox){if(!t||!n)throw Error(`Letterboxing requires width and height defined.`);let e=a/o,r=t/n;if(e>r){let e=o*r;s=(a-e)/2,l=e}else{let e=a/r;u=e,c=(o-e)/2}}if(Q.globalOpt.stretch&&(!Q.globalOpt.width||!Q.globalOpt.height))throw Error(`Stretching requires width and height defined.`);Q.gfx.viewport={x:s,y:c,width:l,height:u,scale:(Q.gfx.viewport.width+Q.gfx.viewport.height)/(Q.gfx.width+Q.gfx.height)}}function hn(e){return new d(e.x*Q.gfx.viewport.width/Q.gfx.width,e.y*Q.gfx.viewport.height/Q.gfx.height)}function gn(e){return new d((e.x-Q.gfx.viewport.x)*Q.gfx.width/Q.gfx.viewport.width,(e.y-Q.gfx.viewport.y)*Q.gfx.height/Q.gfx.viewport.height)}var _n=()=>Sn.lastInputDevice,vn=()=>{let e=Sn.buttons;for(let t in e){let n=e[t].keyboard&&[e[t].keyboard].flat(),r=e[t].keyboardCode&&[e[t].keyboardCode].flat(),i=e[t].gamepad&&[e[t].gamepad].flat(),a=e[t].mouse&&[e[t].mouse].flat();n&&n.forEach(e=>{dn(Sn.buttonsByKey,e,t)}),r&&r.forEach(e=>{dn(Sn.buttonsByKeyCode,e,t)}),i&&i.forEach(e=>{dn(Sn.buttonsByGamepad,e,t)}),a&&a.forEach(e=>{dn(Sn.buttonsByMouse,e,t)})}},yn=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},bn=class{buttonState=new yn;stickState=new Map},xn=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((e,t)=>e+t)/this.dts.length)),this.dts=[])}},Sn,Cn=pn,wn=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new xn,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new d(0),mouseDeltaPos:new d(0),keyState:new yn,mouseState:new yn,mergedGamepadState:new bn,gamepadStates:new Map,lastInputDevice:null,buttonState:new yn,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new kt}},Tn=e=>{if(!e.canvas)throw Error(`Please provide a canvas`);let t=wn(e);Sn=t,vn();function n(){return t.dt*t.timeScale}function r(){return t.fixedDt*t.timeScale}function i(){return t.restDt*t.timeScale}function a(){return t.isHidden}function o(){return t.time}function s(){return t.fpsCounter.fps}function c(){return t.numFrames}function u(){return t.canvas.toDataURL()}function p(e){t.canvas.style.cursor=e}function m(){return t.canvas.style.cursor}function h(e){if(e)try{let e=t.canvas.requestPointerLock();e?.catch&&e.catch(e=>console.error(e))}catch(e){console.error(e)}else document.exitPointerLock()}function g(){return!!document.pointerLockElement}function _(e){e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}function v(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function y(e=!0){e?_(t.canvas):v()}function b(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function x(){t.stopped=!0;let e=Object.entries(U),n=Object.entries(Pe),r=Object.entries(Fe);for(let[n,r]of e)t.canvas.removeEventListener(n,r);for(let[e,t]of n)document.removeEventListener(e,t);for(let[e,t]of r)window.removeEventListener(e,t);Be.disconnect()}function S(r,i){t.loopID!==null&&cancelAnimationFrame(t.loopID);let a=0,o=0,s=c=>{if(t.stopped)return;if(document.visibilityState!==`visible`){t.loopID=requestAnimationFrame(s);return}let l=c/1e3,u=Math.min(l-t.realTime,.25),d=e.maxFPS?1/e.maxFPS:0;if(t.realTime=l,o+=u,o>d){if(!t.skipTime){for(a+=o,t.dt=t.fixedDt,t.restDt=0;a>t.fixedDt;)a-=t.fixedDt,a<t.fixedDt&&(t.restDt=a),r();t.restDt=a,t.dt=o,t.time+=n(),t.fpsCounter.tick(t.dt)}o=0,t.skipTime=!1,t.numFrames++,i(ke,Ae)}t.loopID=requestAnimationFrame(s)};s(0)}function C(){return`ontouchstart`in window||navigator.maxTouchPoints>0}function w(){return t.mousePos.clone()}function T(){return t.mouseDeltaPos.clone()}function E(e=`left`){return t.mouseState.pressed.has(e)}function D(e=`left`){return t.mouseState.down.has(e)}function O(e=`left`){return t.mouseState.released.has(e)}function ee(){return t.isMouseMoved}function te(e){return e===void 0?t.keyState.pressed.size>0:un(t.keyState.pressed,e)}function ne(e){return e===void 0?t.keyState.pressedRepeat.size>0:un(t.keyState.pressedRepeat,e)}function k(e){return e===void 0?t.keyState.down.size>0:un(t.keyState.down,e)}function re(e){return e===void 0?t.keyState.released.size>0:un(t.keyState.released,e)}function A(e){return e===void 0?t.mergedGamepadState.buttonState.pressed.size>0:un(t.mergedGamepadState.buttonState.pressed,e)}function j(e){return e===void 0?t.mergedGamepadState.buttonState.down.size>0:un(t.mergedGamepadState.buttonState.down,e)}function ie(e){return e===void 0?t.mergedGamepadState.buttonState.released.size>0:un(t.mergedGamepadState.buttonState.released,e)}function M(e){return e===void 0?t.buttonState.pressed.size>0:un(t.buttonState.pressed,e)}function N(e){return e===void 0?t.buttonState.down.size>0:un(t.buttonState.down,e)}function P(e){return e===void 0?t.buttonState.released.size>0:un(t.buttonState.released,e)}function F(e){return t.buttons?.[e]}function ae(e,n){t.buttons[e]={...t.buttons[e],...n}}function I(e){t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}function oe(e){t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}function se(e){return t.events.on(`resize`,e)}let L=G(e=>t.events.on(`keyDown`,e),(e,n)=>t.events.on(`keyDown`,t=>ln(e,t)&&n(t))),R=G(e=>t.events.on(`keyPress`,t=>e(t)),(e,n)=>t.events.on(`keyPress`,t=>ln(e,t)&&n(t))),ce=G(e=>t.events.on(`keyPressRepeat`,e),(e,n)=>t.events.on(`keyPressRepeat`,t=>ln(e,t)&&n(t))),le=G(e=>t.events.on(`keyRelease`,e),(e,n)=>t.events.on(`keyRelease`,t=>ln(e,t)&&n(t))),ue=G(e=>t.events.on(`mouseDown`,t=>e(t)),(e,n)=>t.events.on(`mouseDown`,t=>ln(e,t)&&n(t))),de=G(e=>t.events.on(`mousePress`,t=>e(t)),(e,n)=>t.events.on(`mousePress`,t=>ln(e,t)&&n(t))),fe=G(e=>t.events.on(`mouseRelease`,t=>e(t)),(e,n)=>t.events.on(`mouseRelease`,t=>t===e&&n(t)));function pe(e){return t.events.on(`mouseMove`,()=>e(w(),T()))}function me(e){return t.events.on(`charInput`,e)}function he(e){return t.events.on(`touchStart`,e)}function ge(e){return t.events.on(`touchMove`,e)}function _e(e){return t.events.on(`touchEnd`,e)}function ve(e){return t.events.on(`scroll`,e)}function ye(e){return t.events.on(`hide`,e)}function be(e){return t.events.on(`show`,e)}let xe=G(e=>t.events.on(`gamepadButtonPress`,(t,n)=>e(t,n)),(e,n)=>t.events.on(`gamepadButtonPress`,(t,r)=>ln(e,t)&&n(t,r))),Se=G(e=>t.events.on(`gamepadButtonDown`,(t,n)=>e(t,n)),(e,n)=>t.events.on(`gamepadButtonDown`,(t,r)=>ln(e,t)&&n(t,r))),Ce=G(e=>t.events.on(`gamepadButtonRelease`,(t,n)=>e(t,n)),(e,n)=>t.events.on(`gamepadButtonRelease`,(t,r)=>ln(e,t)&&n(t,r)));function we(e,n){return t.events.on(`gamepadStick`,(t,r,i)=>t===e&&n(r,i))}function Te(e){t.events.on(`gamepadConnect`,e)}function Ee(e){t.events.on(`gamepadDisconnect`,e)}function z(e){return t.mergedGamepadState.stickState.get(e)||new d(0)}function B(){return[...t.charInputted]}function V(){return[...t.gamepads]}let De=G(e=>t.events.on(`buttonPress`,t=>e(t)),(e,n)=>t.events.on(`buttonPress`,t=>ln(e,t)&&n(t))),Oe=G(e=>t.events.on(`buttonDown`,t=>e(t)),(e,n)=>t.events.on(`buttonDown`,t=>ln(e,t)&&n(t))),H=G(e=>t.events.on(`buttonRelease`,t=>e(t)),(e,n)=>t.events.on(`buttonRelease`,t=>ln(e,t)&&n(t)));function ke(){t.events.trigger(`input`),t.keyState.down.forEach(e=>t.events.trigger(`keyDown`,e)),t.mouseState.down.forEach(e=>t.events.trigger(`mouseDown`,e)),t.buttonState.down.forEach(e=>{t.events.trigger(`buttonDown`,e)}),Ne()}function Ae(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((e,n)=>{t.mergedGamepadState.stickState.set(n,new d(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new d(0),t.gamepadStates.forEach(e=>{e.buttonState.update(),e.stickState.forEach((t,n)=>{e.stickState.set(n,new d(0))})})}function je(e){let n={index:e.index,isPressed:n=>t.gamepadStates.get(e.index)?.buttonState.pressed.has(n)||!1,isDown:n=>t.gamepadStates.get(e.index)?.buttonState.down.has(n)||!1,isReleased:n=>t.gamepadStates.get(e.index)?.buttonState.released.has(n)||!1,getStick:n=>t.gamepadStates.get(e.index)?.stickState.get(n)||f()};return t.gamepads.push(n),t.gamepadStates.set(e.index,{buttonState:new yn,stickState:new Map([[`left`,new d(0)],[`right`,new d(0)]])}),n}function Me(e){t.gamepads=t.gamepads.filter(t=>t.index!==e.index),t.gamepadStates.delete(e.index)}function Ne(){for(let e of navigator.getGamepads())e&&!t.gamepadStates.has(e.index)&&je(e);for(let n of t.gamepads){let r=navigator.getGamepads()[n.index];if(!r)continue;let i=(e.gamepads??{})[r.id]||Cn[r.id]||Cn.default,a=t.gamepadStates.get(n.index);if(a){for(let e=0;e<r.buttons.length;e++){let o=i.buttons[e],s=r.buttons[e],c=t.buttonsByGamepad.has(o);if(s.pressed){if(a.buttonState.down.has(o)){t.events.trigger(`gamepadButtonDown`,o,n);continue}t.lastInputDevice=`gamepad`,c&&t.buttonsByGamepad.get(o)?.forEach(e=>{t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}),t.mergedGamepadState.buttonState.press(o),a.buttonState.press(o),t.events.trigger(`gamepadButtonPress`,o,n)}else a.buttonState.down.has(o)&&(c&&t.buttonsByGamepad.get(o)?.forEach(e=>{t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}),t.mergedGamepadState.buttonState.release(o),a.buttonState.release(o),t.events.trigger(`gamepadButtonRelease`,o,n))}for(let e in i.sticks){let o=i.sticks[e];if(!o)continue;let s=new d(r.axes[o.x],r.axes[o.y]);a.stickState.set(e,s),t.mergedGamepadState.stickState.set(e,s),t.events.trigger(`gamepadStick`,e,s,n)}}}}let U={},Pe={},Fe={},Ie=e.pixelDensity||1;U.mousemove=e=>{let n=gn(new d(e.offsetX,e.offsetY)),r=new d(e.movementX,e.movementY);if(b()){let r=t.canvas.width/Ie,i=t.canvas.height/Ie,a=window.innerWidth,o=window.innerHeight,s=a/o,c=r/i;if(s>c){let t=o/i,s=(a-r*t)/2;n.x=l(e.offsetX-s,0,r*t,0,r),n.y=l(e.offsetY,0,i*t,0,i)}else{let t=a/r,s=(o-i*t)/2;n.x=l(e.offsetX,0,r*t,0,r),n.y=l(e.offsetY-s,0,i*t,0,i)}}t.events.onOnce(`input`,()=>{t.isMouseMoved=!0,t.mousePos=n,t.mouseDeltaPos=r,t.events.trigger(`mouseMove`)})};let Le=[`left`,`middle`,`right`,`back`,`forward`];U.mousedown=e=>{t.events.onOnce(`input`,()=>{let n=Le[e.button];n&&(t.lastInputDevice=`mouse`,t.buttonsByMouse.has(n)&&t.buttonsByMouse.get(n)?.forEach(e=>{t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}),t.mouseState.press(n),t.events.trigger(`mousePress`,n))})},U.mouseup=e=>{t.events.onOnce(`input`,()=>{let n=Le[e.button];n&&(t.buttonsByMouse.has(n)&&t.buttonsByMouse.get(n)?.forEach(e=>{t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}),t.mouseState.release(n),t.events.trigger(`mouseRelease`,n))})};let Re=new Set([` `,`ArrowLeft`,`ArrowRight`,`ArrowUp`,`ArrowDown`,`Tab`]),ze={ArrowLeft:`left`,ArrowRight:`right`,ArrowUp:`up`,ArrowDown:`down`," ":`space`};U.keydown=e=>{Re.has(e.key)&&e.preventDefault(),t.events.onOnce(`input`,()=>{let n=ze[e.key]||e.key.toLowerCase(),r=e.code;if(n===void 0)throw Error(`Unknown key: ${e.key}`);n.length===1?(t.events.trigger(`charInput`,n),t.charInputted.push(n)):n===`space`&&(t.events.trigger(`charInput`,` `),t.charInputted.push(` `)),e.repeat?(t.keyState.pressRepeat(n),t.events.trigger(`keyPressRepeat`,n)):(t.lastInputDevice=`keyboard`,t.buttonsByKey.has(n)&&t.buttonsByKey.get(n)?.forEach(e=>{t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}),t.buttonsByKeyCode.has(r)&&t.buttonsByKeyCode.get(r)?.forEach(e=>{t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}),t.keyState.press(n),t.events.trigger(`keyPressRepeat`,n),t.events.trigger(`keyPress`,n))})},U.keyup=e=>{t.events.onOnce(`input`,()=>{let n=ze[e.key]||e.key.toLowerCase(),r=e.code;t.buttonsByKey.has(n)&&t.buttonsByKey.get(n)?.forEach(e=>{t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}),t.buttonsByKeyCode.has(r)&&t.buttonsByKeyCode.get(r)?.forEach(e=>{t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}),t.keyState.release(n),t.events.trigger(`keyRelease`,n)})},U.touchstart=n=>{n.preventDefault(),t.events.onOnce(`input`,()=>{let r=[...n.changedTouches],i=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=gn(new d(r[0].clientX-i.x,r[0].clientY-i.y)),t.lastInputDevice=`mouse`,t.buttonsByMouse.has(`left`)&&t.buttonsByMouse.get(`left`)?.forEach(e=>{t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}),t.mouseState.press(`left`),t.events.trigger(`mousePress`,`left`)),r.forEach(e=>{t.events.trigger(`touchStart`,gn(new d(e.clientX-i.x,e.clientY-i.y)),e)})})},U.touchmove=n=>{n.preventDefault(),t.events.onOnce(`input`,()=>{let r=[...n.changedTouches],i=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let e=t.mousePos;t.mousePos=gn(new d(r[0].clientX-i.x,r[0].clientY-i.y)),t.mouseDeltaPos=t.mousePos.sub(e),t.events.trigger(`mouseMove`)}r.forEach(e=>{t.events.trigger(`touchMove`,gn(new d(e.clientX-i.x,e.clientY-i.y)),e)})})},U.touchend=n=>{t.events.onOnce(`input`,()=>{let r=[...n.changedTouches],i=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=gn(new d(r[0].clientX-i.x,r[0].clientY-i.y)),t.mouseDeltaPos=new d(0,0),t.buttonsByMouse.has(`left`)&&t.buttonsByMouse.get(`left`)?.forEach(e=>{t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}),t.mouseState.release(`left`),t.events.trigger(`mouseRelease`,`left`)),r.forEach(e=>{t.events.trigger(`touchEnd`,gn(new d(e.clientX-i.x,e.clientY-i.y)),e)})})},U.touchcancel=n=>{t.events.onOnce(`input`,()=>{let r=[...n.changedTouches],i=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=gn(new d(r[0].clientX-i.x,r[0].clientY-i.y)),t.mouseState.release(`left`),t.events.trigger(`mouseRelease`,`left`)),r.forEach(e=>{t.events.trigger(`touchEnd`,gn(new d(e.clientX-i.x,e.clientY-i.y)),e)})})},U.wheel=e=>{e.preventDefault(),t.events.onOnce(`input`,()=>{t.events.trigger(`scroll`,new d(e.deltaX,e.deltaY))})},U.contextmenu=e=>e.preventDefault(),Pe.visibilitychange=()=>{document.visibilityState===`visible`?(t.skipTime=!0,t.isHidden=!1,t.events.trigger(`show`)):(t.isHidden=!0,t.events.trigger(`hide`))},Fe.gamepadconnected=e=>{let n=je(e.gamepad);t.events.onOnce(`input`,()=>{t.events.trigger(`gamepadConnect`,n)})},Fe.gamepaddisconnected=e=>{let n=V().filter(t=>t.index===e.gamepad.index)[0];Me(e.gamepad),t.events.onOnce(`input`,()=>{t.events.trigger(`gamepadDisconnect`,n)})};for(let[e,n]of Object.entries(U))t.canvas.addEventListener(e,n);for(let[e,t]of Object.entries(Pe))document.addEventListener(e,t);for(let[e,t]of Object.entries(Fe))window.addEventListener(e,t);let Be=new ResizeObserver(e=>{for(let n of e)if(n.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce(`input`,()=>{t.events.trigger(`resize`)})}});return Be.observe(t.canvas),{state:t,dt:n,fixedDt:r,restDt:i,time:o,run:S,canvas:t.canvas,fps:s,numFrames:c,quit:x,isHidden:a,setFullscreen:y,isFullscreen:b,setCursor:p,screenshot:u,getGamepads:V,getCursor:m,setCursorLocked:h,isCursorLocked:g,isTouchscreen:C,mousePos:w,mouseDeltaPos:T,isKeyDown:k,isKeyPressed:te,isKeyPressedRepeat:ne,isKeyReleased:re,isMouseDown:D,isMousePressed:E,isMouseReleased:O,isMouseMoved:ee,isGamepadButtonPressed:A,isGamepadButtonDown:j,isGamepadButtonReleased:ie,getGamepadStick:z,isButtonPressed:M,isButtonDown:N,isButtonReleased:P,setButton:ae,getButton:F,pressButton:I,releaseButton:oe,charInputted:B,onResize:se,onKeyDown:L,onKeyPress:R,onKeyPressRepeat:ce,onKeyRelease:le,onMouseDown:ue,onMousePress:de,onMouseRelease:fe,onMouseMove:pe,onCharInput:me,onTouchStart:he,onTouchMove:ge,onTouchEnd:_e,onScroll:ve,onHide:ye,onShow:be,onGamepadButtonDown:Se,onGamepadButtonPress:xe,onGamepadButtonRelease:Ce,onGamepadStick:we,onGamepadConnect:Te,onGamepadDisconnect:Ee,onButtonPress:De,onButtonDown:Oe,onButtonRelease:H,getLastInputDeviceType:_n,events:t.events}};function K(){return Q.app.dt()}function En(){return Q.app.fixedDt()}function Dn(){return Q.app.restDt()}var On=new d(-1,-1),kn=new d(0,-1),An=new d(1,-1),jn=new d(-1,0),Mn=new d(0,0),Nn=new d(1,0),Pn=new d(-1,1),Fn=new d(0,1),In=new d(1,1);function Ln(e){switch(e){case`topleft`:return On;case`top`:return kn;case`topright`:return An;case`left`:return jn;case`center`:return Mn;case`right`:return Nn;case`botleft`:return Pn;case`bot`:return Fn;case`botright`:return In;default:return e}}function Rn(e){switch(e){case`left`:return 0;case`center`:return .5;case`right`:return 1;default:return 0}}function zn(e){return e.createBuffer(1,1,44100)}var Bn=2.5949095,Vn=2.70158,Hn=2*Math.PI/3,Un=2*Math.PI/4.5,Wn={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-(-2*e+2)**2/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-(1-e)**3,easeInOutCubic:e=>e<.5?4*e*e*e:1-(-2*e+2)**3/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-(1-e)**4,easeInOutQuart:e=>e<.5?8*e*e*e*e:1-(-2*e+2)**4/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-(1-e)**5,easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-(-2*e+2)**5/2,easeInExpo:e=>e===0?0:2**(10*e-10),easeOutExpo:e=>e===1?1:1-2**(-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?2**(20*e-10)/2:(2-2**(-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-e**2),easeOutCirc:e=>Math.sqrt(1-(e-1)**2),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-(2*e)**2))/2:(Math.sqrt(1-(-2*e+2)**2)+1)/2,easeInBack:e=>Vn*e*e*e-1.70158*e*e,easeOutBack:e=>1+Vn*(e-1)**3+1.70158*(e-1)**2,easeInOutBack:e=>e<.5?(2*e)**2*((Bn+1)*2*e-Bn)/2:((2*e-2)**2*((Bn+1)*(e*2-2)+Bn)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-(2**(10*e-10))*Math.sin((e*10-10.75)*Hn),easeOutElastic:e=>e===0?0:e===1?1:2**(-10*e)*Math.sin((e*10-.75)*Hn)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(2**(20*e-10)*Math.sin((20*e-11.125)*Un))/2:2**(-20*e+10)*Math.sin((20*e-11.125)*Un)/2+1,easeInBounce:e=>1-Wn.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-Wn.easeOutBounce(1-2*e))/2:(1+Wn.easeOutBounce(2*e-1))/2},Gn=Wn;function Kn(e,t,n){let r=[],i=t;for(r.push(i);i!==e;){if(i=n.get(i),i==null)return null;r.push(i)}return r.reverse()}function qn(e,t,n){let r=new Nt((e,t)=>e.cost<t.cost);r.insert({cost:0,node:t});let i=new Map;i.set(t,t);let a=new Map;for(a.set(t,0);r.length!==0;){let t=r.remove()?.node;if(t===n)break;let o=e.getNeighbours(t);for(let s of o){let o=(a.get(t)||0)+e.getCost(t,s)+e.getHeuristic(s,n);(!a.has(s)||o<a.get(s))&&(a.set(s,o),r.insert({cost:o,node:s}),i.set(s,t))}}return Kn(t,n,i)}var Jn=class{a;b;polygon;constructor(e,t,n){this.a=e,this.b=t,this.polygon=new WeakRef(n)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},Yn=class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,n=0,r=0;for(let e of this._edges){e.polygon=new WeakRef(this);let i=e.a.x*e.b.y-e.a.y*e.b.x;t+=(e.a.x+e.b.x)*i,n+=(e.a.y+e.b.y)*i,r+=i}r/=2,this._centroid=f(t/(6*r),n/(6*r))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let n of this.edges)n.b.y>e.y!=n.a.y>e.y&&e.x<(n.a.x-n.b.x)*(e.y-n.b.y)/(n.a.y-n.b.y)+n.b.x&&(t=!t);return t}},Xn=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let n=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[n]}_findCommonEdge(e,t){for(let n of e.edges){let e=this._findEdge(n.b,n.a);if(e&&e.polygon.deref().id===t.id)return e}return null}addPolygon(e){let t=new Yn(this._polygons.length);t.edges=e.map((n,r)=>new Jn(n,e[(r+1)%e.length],t)),this._polygons.push(t);for(let e of t.edges)this._addEdge(e);return t}addRect(e,t){let n=this._addPoint(e),r=this._addPoint(e.add(t.x,0)),i=this._addPoint(e.add(t)),a=this._addPoint(e.add(0,t.y));return this.addPolygon([n,r,i,a])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let n of this._polygons[e].edges){let e=this._findEdge(n.b,n.a);if(e){let n=e.polygon.deref();n&&t.push(n.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let n=this._polygons[e],r=this._polygons[t],i=n.centroid.x-r.centroid.x,a=n.centroid.y-r.centroid.y;return Math.sqrt(i*i+a*a)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:qn(this,e,t)}getWaypointPath(e,t,n){let r=n?.type||`centroids`,i=this._getLocation(e),a=this._getLocation(t);if(i===void 0||a===void 0)return[];let o=this.getPath(i.id,a.id);if(!o)return[];if(r===`edges`){let n=[];for(let e=1;e<o.length;e++){let t=this._polygons[o[e-1]],r=this._polygons[o[e]],i=this._findCommonEdge(t,r);n.push(i.middle.add(r.centroid.sub(i.middle).unit().scale(4)))}return[e,...n,t]}else return[e,...o.slice(1,-1).map(e=>this._polygons[e].centroid),t]}};function Zn(e){let t=new _;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function Qn(e){return new d(e.x/Y()*2-1,-e.y/X()*2+1)}function $n(e,t,n,r,i,a=1){r=o(r%360),i=o(i%360),i<=r&&(i+=Math.PI*2);let s=[],c=Math.ceil((i-r)/o(8)*a),l=(i-r)/c,u=f(Math.cos(r),Math.sin(r)),d=f(Math.cos(l),Math.sin(l));for(let r=0;r<=c;r++)s.push(e.add(t*u.x,n*u.y)),u=f(u.x*d.x-u.y*d.y,u.x*d.y+u.y*d.x);return s}function er(...e){let t=i(...e),n=e[3]??1;Q.gfx.bgColor=t,Q.gfx.bgAlpha=n,Q.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,n)}function tr(){return Q.gfx.bgColor?.clone?.()??null}function q(...e){if(e[0]===void 0)return;let t=f(...e);t.x===0&&t.y===0||Q.gfx.transform.translate(t)}function nr(){Q.gfx.transformStack.push(Q.gfx.transform.clone())}function rr(e){Q.gfx.transform=e.clone()}function ir(...e){if(e[0]===void 0)return;let t=f(...e);t.x===1&&t.y===1||Q.gfx.transform.scale(t)}function ar(e){e&&Q.gfx.transform.rotate(e)}function J(){Q.gfx.transformStack.length>0&&(Q.gfx.transform=Q.gfx.transformStack.pop())}function or(){Q.gfx.renderer.flush()}function Y(){return Q.gfx.width}function X(){return Q.gfx.height}function sr(){return(Q.gfx.viewport.width+Q.gfx.viewport.height)/(Q.gfx.width+Q.gfx.height)}function cr(){return f(Y()/2,X()/2)}var lr=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,n,r){this.gfx=e,this.canvas=document.createElement(`canvas`),this.canvas.width=t,this.canvas.height=n,this.textures=[di.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=r;let i=this.canvas.getContext(`2d`);if(!i)throw Error(`Failed to get 2d context`);this.c2d=i}addSingle(e){let t=di.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new p(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,n=e.height+this.padding*2;if(t>this.canvas.width||n>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+n>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(di.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let r=this.textures[this.textures.length-1],i=new d(this.x+this.padding,this.y+this.padding);return this.x+=t,n>this.curHeight&&(this.curHeight=n),e instanceof ImageData?this.c2d.putImageData(e,i.x,i.y):this.c2d.drawImage(e,i.x,i.y),r.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:i,size:new d(e.width,e.height),texture:r}),this.lastTextureId++,[r,new p(i.x/this.canvas.width,i.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function ur(e){return typeof e!=`string`||Bt(e)?e:Q.assets.urlPrefix+e}var dr=class e{loaded=!1;data=null;error=null;onLoadEvents=new W;onErrorEvents=new W;onFinishEvents=new W;constructor(e){e.then(e=>{this.loaded=!0,this.data=e,this.onLoadEvents.trigger(e)}).catch(e=>{if(this.error=e,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(e);else throw e}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let n=new e(Promise.resolve(t));return n.data=t,n.loaded=!0,n}onLoad(e){return this.loaded&&this.data?e(this.data):this.onLoadEvents.add(e),this}onError(e){return this.loaded&&this.error?e(this.error):this.onErrorEvents.add(e),this}onFinish(e){return this.loaded?e():this.onFinishEvents.add(e),this}then(e){return this.onLoad(e)}catch(e){return this.onError(e)}finally(e){return this.onFinish(e)}},fr=class{assets=new Map;lastUID=0;add(e,t){let n=e??this.lastUID+++``,r=new dr(t);return this.assets.set(n,r),r}addLoaded(e,t){let n=e??this.lastUID+++``,r=dr.loaded(t);return this.assets.set(n,r),r}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function pr(e){return fetch(e).then(t=>{if(!t.ok)throw Error(`Failed to fetch "${e}"`);return t})}function mr(e){return pr(e).then(e=>e.json())}function hr(e){return pr(e).then(e=>e.text())}function gr(e){return pr(e).then(e=>e.arrayBuffer())}function _r(e){return e!==void 0&&(Q.assets.urlPrefix=e),Q.assets.urlPrefix}function vr(e,t){return Q.assets.custom.add(e,mr(ur(t)))}function yr(e){let t=new Image;return t.crossOrigin=`anonymous`,t.src=e,new Promise((n,r)=>{t.onload=()=>n(t),t.onerror=()=>r(Error(`Failed to load image from "${e}"`))})}function br(){let e=[Q.assets.sprites,Q.assets.sounds,Q.assets.shaders,Q.assets.fonts,Q.assets.bitmapFonts,Q.assets.custom];return e.reduce((e,t)=>e+t.progress(),0)/e.length}function xr(){return[Q.assets.sprites,Q.assets.sounds,Q.assets.shaders,Q.assets.fonts,Q.assets.bitmapFonts,Q.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function Sr(e){return Q.assets.custom.get(e)??null}function Cr(e){return Q.assets.custom.add(null,e)}var wr=(e,t)=>({urlPrefix:``,sprites:new fr,fonts:new fr,bitmapFonts:new fr,sounds:new fr,shaders:new fr,custom:new fr,music:{},packer:new lr(e,2048,2048,t),loaded:!1}),Tr=`data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==`,Er=class e{tex;frames=[new p(0,0,1,1)];anims={};slice9=null;constructor(e,t,n={},r=null){this.tex=e,t&&(this.frames=t),this.anims=n,this.slice9=r}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,n={}){return typeof t==`string`?e.fromURL(t,n):Promise.resolve(e.fromImage(t,n))}static fromImage(t,n={}){let[r,i]=n.singular?Q.assets.packer.addSingle(t):Q.assets.packer.add(t),a=n.frames?n.frames.map(e=>new p(i.x+e.x*i.w,i.y+e.y*i.h,e.w*i.w,e.h*i.h)):Ar(n.sliceX||1,n.sliceY||1,i.x,i.y,i.w,i.h);return new e(r,a,n.anims,n.slice9)}static fromURL(t,n={}){return yr(t).then(t=>e.fromImage(t,n))}};function Dr(e){if(typeof e==`string`){let t=Or(e);if(t)return t;if(br()<1)return null;throw Error(`Sprite not found: ${e}`)}else{if(e instanceof Er)return dr.loaded(e);if(e instanceof dr)return e;throw Error(`Invalid sprite: ${e}`)}}function Or(e){return Q.assets.sprites.get(e)??null}function kr(e,t,n={sliceX:1,sliceY:1,anims:{}}){return t=ur(t),Array.isArray(t)?t.some(e=>typeof e==`string`)?Q.assets.sprites.add(e,Promise.all(t.map(e=>typeof e==`string`?yr(e):Promise.resolve(e))).then(e=>jr(e,n))):Q.assets.sprites.addLoaded(e,jr(t,n)):typeof t==`string`?Q.assets.sprites.add(e,Er.from(t,n)):Q.assets.sprites.addLoaded(e,Er.fromImage(t,n))}function Ar(e=1,t=1,n=0,r=0,i=1,a=1){let o=[],s=i/e,c=a/t;for(let i=0;i<t;i++)for(let t=0;t<e;t++)o.push(new p(n+t*s,r+i*c,s,c));return o}function jr(e,t={}){let n=document.createElement(`canvas`),r=e[0].width,i=e[0].height;n.width=r*e.length,n.height=i;let a=n.getContext(`2d`);if(!a)throw Error(`Failed to create canvas context`);e.forEach((e,t)=>{e instanceof ImageData?a.putImageData(e,t*r,0):a.drawImage(e,t*r,0)});let o=a.getImageData(0,0,e.length*r,i);return Er.fromImage(o,{...t,sliceX:e.length,sliceY:1})}function Mr(e=`bean`){return kr(e,Tr)}function Nr(e,t,n){t=ur(t),n=ur(n),typeof t==`string`&&!n&&(n=Vt(t)+`.json`);let r=typeof n==`string`?mr(n):Promise.resolve(n);return Q.assets.sprites.add(e,r.then(e=>{let n=e.meta.size,r=e.frames.map(e=>new p(e.frame.x/n.w,e.frame.y/n.h,e.frame.w/n.w,e.frame.h/n.h)),i={};for(let t of e.meta.frameTags)t.from===t.to?i[t.name]=t.from:i[t.name]={from:t.from,to:t.to,speed:10,loop:!0,pingpong:t.direction===`pingpong`};return Er.from(t,{frames:r,anims:i})}))}var Pr=class{fontface;filter=dt;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??dt,this.size=t.size??64,this.size>256)throw Error(`Max font size: 256`);t.outline&&(this.outline={width:1,color:i(0,0,0)},typeof t.outline==`number`?this.outline.width=t.outline:typeof t.outline==`object`&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function Fr(e){if(!e)return Fr(Q.globalOpt.font??lt);if(typeof e==`string`){let t=zr(e),n=Ir(e);if(t)return t.data??t;if(n)return n.data??n;if(document.fonts.check(`64px ${e}`))return e;if(br()<1)return null;throw Error(`Font not found: ${e}`)}else if(e instanceof dr)return e.data?e.data:e;return e}function Ir(e){return Q.assets.fonts.get(e)??null}function Lr(e,t,n={}){let r=ur(t),i=new FontFace(e,typeof t==`string`?`url(${r})`:r);return document.fonts.add(i),Q.assets.fonts.add(e,i.load().catch(e=>{throw Error(`Failed to load font from "${r}": ${e}`)}).then(e=>new Pr(e,n)))}function Rr(e,t,n,r){let i=e.width/t,a={},o=r.split(``).entries();for(let[e,r]of o)a[r]=new p(e%i*t,Math.floor(e/i)*n,t,n);return{tex:e,map:a,size:n}}function zr(e){return Q.assets.bitmapFonts.get(e)??null}function Br(e,t,n,r,i={}){let a=ur(t);return Q.assets.bitmapFonts.add(e,yr(a).then(e=>Rr(di.fromImage(Q.gfx.ggl,e,i),n,r,i.chars??st)))}function Vr(e,t){return t=ur(t),Q.assets.sprites.add(e,new Promise(async e=>{let n=typeof t==`string`?await mr(t):t,r=await Promise.all(n.frames.map(yr)),i=document.createElement(`canvas`);i.width=n.width,i.height=n.height*n.frames.length;let a=i.getContext(`2d`);if(!a)throw Error(`Failed to create canvas context`);r.forEach((e,t)=>{a.drawImage(e,0,t*n.height)});let o=await kr(null,i,{sliceY:n.frames.length,anims:n.anims});e(o)}))}var Hr=class{ctx;glProgram;constructor(e,t,n,r){this.ctx=e,e.onDestroy(()=>this.free());let i=e.gl,a=i.createShader(i.VERTEX_SHADER),o=i.createShader(i.FRAGMENT_SHADER);if(!a||!o)throw Error(`Failed to create shader`);i.shaderSource(a,t),i.shaderSource(o,n),i.compileShader(a),i.compileShader(o);let s=i.createProgram();if(this.glProgram=s,i.attachShader(s,a),i.attachShader(s,o),r.forEach((e,t)=>i.bindAttribLocation(s,t,e)),i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS)){let e=i.getShaderInfoLog(a);if(e)throw Error(`VERTEX SHADER `+e);let t=i.getShaderInfoLog(o);if(t)throw Error(`FRAGMENT SHADER `+t)}i.deleteShader(a),i.deleteShader(o)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let n in e){let i=e[n],a=t.getUniformLocation(this.glProgram,n);if(typeof i==`number`)t.uniform1f(a,i);else if(i instanceof _)t.uniformMatrix4fv(a,!1,new Float32Array(i.m));else if(i instanceof r)t.uniform3f(a,i.r,i.g,i.b);else if(i instanceof d)t.uniform2f(a,i.x,i.y);else if(Array.isArray(i))i[0],Mt(i)?t.uniform1fv(a,i):jt(i)?t.uniform2fv(a,i.map(e=>[e.x,e.y]).flat()):At(i)&&t.uniform3fv(a,i.map(e=>[e.r,e.g,e.b]).flat());else throw Error(`Unsupported uniform data type`)}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function Ur(e,t=yt,n=bt){let r=_t.replace(`{{user}}`,t??yt),i=vt.replace(`{{user}}`,n??bt);try{return new Hr(e,r,i,ft.map(e=>e.name))}catch(e){let t=Wt(e).match(/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/);if(!t?.groups)throw e;let n=Number(t.groups.line)-14,r=t.groups.msg.trim(),i=t.groups.type.toLowerCase();throw Error(`${i} shader line ${n}: ${r}`)}}function Wr(e){if(!e)return Q.gfx.defShader;if(typeof e==`string`){let t=Gr(e);if(t)return t.data??t;if(br()<1)return null;throw Error(`Shader not found: ${e}`)}else if(e instanceof dr)return e.data?e.data:e;return e}function Gr(e){return Q.assets.shaders.get(e)??null}function Kr(e,t,n){return Q.assets.shaders.addLoaded(e,Ur(Q.gfx.ggl,t,n))}function qr(e,t,n){t=ur(t),n=ur(n);let r=e=>e?hr(e):Promise.resolve(null),i=Promise.all([r(t),r(n)]).then(([e,t])=>Ur(Q.gfx.ggl,e,t));return Q.assets.shaders.add(e,i)}var Jr=class e{buf;constructor(e){this.buf=e}static fromArrayBuffer(t){return new Promise((e,n)=>Q.audio.ctx.decodeAudioData(t,e,n)).then(t=>new e(t))}static fromURL(t){return Bt(t)?e.fromArrayBuffer(Ft(t)):gr(t).then(t=>e.fromArrayBuffer(t))}};function Yr(e){if(typeof e==`string`){let t=Xr(e);if(t)return t;if(br()<1)return null;throw Error(`Sound not found: ${e}`)}else{if(e instanceof Jr)return dr.loaded(e);if(e instanceof dr)return e;throw Error(`Invalid sound: ${e}`)}}function Xr(e){return Q.assets.sounds.get(e)??null}function Zr(e,t){return t=ur(t),Q.assets.sounds.add(e,typeof t==`string`?Jr.fromURL(t):Jr.fromArrayBuffer(t))}function Qr(e,t){let n=ur(t),r=new Audio(n);return r.preload=`auto`,Q.assets.music[e]=n}function $r(e,t){return e=ur(e),Cr(typeof t==`string`?new Promise((n,r)=>{mr(t).then(t=>{$r(e,t).then(n).catch(r)})}):Er.from(e).then(e=>{let n={};for(let r in t){let i=t[r],a=e.frames[0],o=2048*a.w,s=2048*a.h,c=i.frames?i.frames.map(e=>new p(a.x+(i.x+e.x)/o*a.w,a.y+(i.y+e.y)/s*a.h,e.w/o*a.w,e.h/s*a.h)):Ar(i.sliceX||1,i.sliceY||1,a.x+i.x/o*a.w,a.y+i.y/s*a.h,i.width/o*a.w,i.height/s*a.h),l=new Er(e.tex,c,i.anims);Q.assets.sprites.addLoaded(r,l),n[r]=l}return n}))}function ei(e,t,n=!1,r,i,a={}){let o=r??Q.gfx.defTex,s=i??Q.gfx.defShader,c=Wr(s);if(!c||c instanceof dr)return;let l=Q.gfx.fixed||n?Q.gfx.transform:Q.game.cam.transform.mult(Q.gfx.transform),u=[];for(let t of e){let e=Qn(l.multVec2(t.pos));u.push(e.x,e.y,t.uv.x,t.uv.y,t.color.r/255,t.color.g/255,t.color.b/255,t.opacity)}Q.gfx.renderer.push(Q.gfx.ggl.gl.TRIANGLES,u,t,c,o,a)}function ti(e){if(!e.pts)throw Error(`drawPolygon() requires property "pts".`);let t=e.pts.length;if(!(t<3)){if(nr(),q(e.pos),ir(e.scale),ar(e.angle),q(e.offset),e.fill!==!1){let n=e.color??r.WHITE,i=e.pts.map((t,r)=>({pos:new d(t.x,t.y),uv:e.uv?e.uv[r]:new d(0,0),color:e.colors&&e.colors[r]?e.colors[r].mult(n):n,opacity:e.opacity??1})),a;a=e.triangulate?at(e.pts).map(t=>t.map(t=>e.pts.indexOf(t))).flat():[...Array(t-2).keys()].map(e=>[0,e+1,e+2]).flat(),ei(i,e.indices??a,e.fixed,e.uv?e.tex:Q.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&ci({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),J()}}function ni(e){if(e.radiusX===void 0||e.radiusY===void 0)throw Error(`drawEllipse() requires properties "radiusX" and "radiusY".`);if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,n=e.end??360,r=Ln(e.anchor??`center`).scale(new d(-e.radiusX,-e.radiusY)),i=$n(r,e.radiusX,e.radiusY,t,n,e.resolution);i.unshift(r);let a=Object.assign({},e,{pts:i,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(i.length-1).fill(e.gradient[1])]}:{}});if(n-t>=360&&e.outline){e.fill!==!1&&ti(Object.assign({},a,{outline:null})),ti(Object.assign({},a,{pts:i.slice(1),fill:!1}));return}ti(a)}function ri(e){if(typeof e.radius!=`number`)throw Error(`drawCircle() requires property "radius".`);e.radius!==0&&ni(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function ii(e){let{p1:t,p2:n}=e;if(!t||!n)throw Error(`drawLine() requires properties "p1" and "p2".`);let i=e.width||1,a=n.sub(t).unit().normal().scale(i*.5),o=[t.sub(a),t.add(a),n.add(a),n.sub(a)].map(t=>({pos:new d(t.x,t.y),uv:new d(0),color:e.color??r.WHITE,opacity:e.opacity??1}));ei(o,[0,1,3,1,2,3],e.fixed,Q.gfx.defTex,e.shader,e.uniform??void 0)}function ai(e){let t=e.pts,n=[],i=(e.width||1)*.5,a=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),o=e.pos||f(0,0),s;s=a?t[0].sub(t[t.length-2]):t[1].sub(t[0]);let c=s.len(),l=s.normal().scale(-i/c),u,d=t[0];if(!a)switch(e.cap){case`square`:{let e=s.scale(-i/c);n.push(d.add(e).add(l)),n.push(d.add(e).sub(l));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=l.scale(-1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)n.push(d),n.push(d.sub(r)),r=f(r.x*a-r.y*o,r.x*o+r.y*a)}}for(let e=1;e<t.length;e++){if(d===t[e]||d.eq(t[e]))continue;u=d,d=t[e];let r=d.sub(u),a=r.len(),o=r.normal().scale(-i/a),f=s.cross(r);if(Math.abs(f)/(c*a)<.05){n.push(u.add(l)),n.push(u.sub(l)),s.dot(r)<0&&(n.push(u.sub(l)),n.push(u.add(l))),s=r,c=a,l=o;continue}let p=o.sub(l).cross(r)/f,m=l.add(s.scale(p));f>0?(n.push(u.add(m)),n.push(u.sub(l)),n.push(u.add(m)),n.push(u.sub(o))):(n.push(u.add(l)),n.push(u.sub(m)),n.push(u.add(o)),n.push(u.sub(m))),s=r,c=a,l=o}if(!a)switch(n.push(d.add(l)),n.push(d.sub(l)),e.cap){case`square`:{let e=s.scale(i/c);n.push(d.add(e).add(l)),n.push(d.add(e).sub(l));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=l.scale(1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)r=f(r.x*a-r.y*o,r.x*o+r.y*a),n.push(d),n.push(d.sub(r))}}if(n.length<4)return;let p=n.map(t=>({pos:o.add(t),uv:f(),color:e.color||r.WHITE,opacity:e.opacity??1})),m=[],h=0;for(let e=0;e<n.length-2;e+=2)m[h++]=e+1,m[h++]=e,m[h++]=e+2,m[h++]=e+2,m[h++]=e+3,m[h++]=e+1;a&&(m[h++]=n.length-1,m[h++]=n.length-2,m[h++]=0,m[h++]=0,m[h++]=1,m[h++]=n.length-1),ei(p,m,e.fixed,Q.gfx.defTex,e.shader,e.uniform??void 0)}function oi(e){let t=e.pts,n=[],i=(e.width||1)*.5,a=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),s=e.pos||f(0,0),c;c=a?t[0].sub(t[t.length-2]):t[1].sub(t[0]);let l=c.len(),u=c.normal().scale(-i/l),d,p=t[0];if(!a)switch(e.cap){case`square`:{let e=c.scale(-i/l);n.push(p.add(e).add(u)),n.push(p.add(e).sub(u));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=u.scale(-1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)n.push(p),n.push(p.sub(r)),r=f(r.x*a-r.y*o,r.x*o+r.y*a)}}for(let e=1;e<t.length;e++){if(p===t[e]||p.eq(t[e]))continue;d=p,p=t[e];let r=p.sub(d),a=r.len(),s=r.normal().scale(-i/a),m=c.cross(r);if(Math.abs(m)/(l*a)<.05){n.push(d.add(u)),n.push(d.sub(u)),c.dot(r)<0&&(n.push(d.sub(u)),n.push(d.add(u))),c=r,l=a,u=s;continue}let h=s.sub(u).cross(r)/m,g=u.add(c.scale(h));if(m>0){let e=d.add(g),t=Math.max(i,10),r=o(u.angleBetween(s)/t),a=u,c=Math.cos(r),l=Math.sin(r);for(let r=0;r<t;r++)n.push(e),n.push(d.sub(a)),a=f(a.x*c-a.y*l,a.x*l+a.y*c)}else{let e=d.sub(g),t=Math.max(i,10),r=o(u.angleBetween(s)/t),a=u,c=Math.cos(r),l=Math.sin(r);for(let r=0;r<t;r++)n.push(d.add(a)),n.push(e),a=f(a.x*c-a.y*l,a.x*l+a.y*c)}c=r,l=a,u=s}if(!a)switch(n.push(p.add(u)),n.push(p.sub(u)),e.cap){case`square`:{let e=c.scale(i/l);n.push(p.add(e).add(u)),n.push(p.add(e).sub(u));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=u.scale(1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)r=f(r.x*a-r.y*o,r.x*o+r.y*a),n.push(p),n.push(p.sub(r))}}if(n.length<4)return;let m=n.map(t=>({pos:s.add(t),uv:f(),color:e.color||r.WHITE,opacity:e.opacity??1})),h=[],g=0;for(let e=0;e<n.length-2;e+=2)h[g++]=e+1,h[g++]=e,h[g++]=e+2,h[g++]=e+2,h[g++]=e+3,h[g++]=e+1;a&&(h[g++]=n.length-1,h[g++]=n.length-2,h[g++]=0,h[g++]=0,h[g++]=1,h[g++]=n.length-1),ei(m,h,e.fixed,Q.gfx.defTex,e.shader,e.uniform??void 0)}function si(e){let t=e.pts,n=[],i=(e.width||1)*.5,a=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),o=e.pos||f(0,0),s;s=a?t[0].sub(t[t.length-2]):t[1].sub(t[0]);let c=s.len(),l=s.normal().scale(-i/c),u,d=t[0];if(!a)switch(e.cap){case`square`:{let e=s.scale(-i/c);n.push(d.add(e).add(l)),n.push(d.add(e).sub(l));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=l.scale(-1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)n.push(d),n.push(d.sub(r)),r=f(r.x*a-r.y*o,r.x*o+r.y*a)}}for(let e=1;e<t.length;e++){if(d===t[e]||d.eq(t[e]))continue;u=d,d=t[e];let r=d.sub(u),a=r.len(),o=r.normal().scale(-i/a),f=s.cross(r);if(Math.abs(f)/(c*a)<.05){n.push(u.add(l)),n.push(u.sub(l)),s.dot(r)<0&&(n.push(u.sub(l)),n.push(u.add(l))),s=r,c=a,l=o;continue}let p=o.sub(l).cross(r)/f,m=l.add(s.scale(p));n.push(u.add(m)),n.push(u.sub(m)),s=r,c=a,l=o}if(!a)switch(n.push(d.add(l)),n.push(d.sub(l)),e.cap){case`square`:{let e=s.scale(i/c);n.push(d.add(e).add(l)),n.push(d.add(e).sub(l));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=l.scale(1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)r=f(r.x*a-r.y*o,r.x*o+r.y*a),n.push(d),n.push(d.sub(r))}}if(n.length<4)return;let p=n.map(t=>({pos:o.add(t),uv:f(),color:e.color||r.WHITE,opacity:e.opacity??1})),m=[],h=0;for(let e=0;e<n.length-2;e+=2)m[h++]=e+1,m[h++]=e,m[h++]=e+2,m[h++]=e+2,m[h++]=e+3,m[h++]=e+1;a&&(m[h++]=n.length-1,m[h++]=n.length-2,m[h++]=0,m[h++]=0,m[h++]=1,m[h++]=n.length-1),ei(p,m,e.fixed,Q.gfx.defTex,e.shader,e.uniform??void 0)}function ci(e){let t=e.pts,n=e.width??1;if(!t)throw Error(`drawLines() requires property "pts".`);if(!(t.length<2)){if(t.length>2)switch(e.join){case`bevel`:return ai(e);case`round`:return oi(e);case`miter`:return si(e)}if(e.radius&&t.length>=3){ii(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let n=1;n<t.length-2;n++){let r=t[n],i=t[n+1];ii(Object.assign({},e,{p1:r,p2:i}))}ii(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let r=0;r<t.length-1;r++)ii(Object.assign({},e,{p1:t[r],p2:t[r+1]})),e.join!==`none`&&ri(Object.assign({},e,{pos:t[r],radius:n/2}))}}function li(e,t){let n=t.segments??16,r=[];for(let t=0;t<=n;t++)r.push(e(t/n));ci({pts:r,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function ui(e){li(t=>Me(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var di=class e{ctx;src=null;glTex;width;height;constructor(e,t,n,r={}){this.ctx=e;let i=e.gl,a=e.gl.createTexture();if(!a)throw Error(`Failed to create texture`);this.glTex=a,e.onDestroy(()=>this.free()),this.width=t,this.height=n;let o={linear:i.LINEAR,nearest:i.NEAREST}[r.filter??e.opts.texFilter??`nearest`],s={repeat:i.REPEAT,clampToEdge:i.CLAMP_TO_EDGE}[r.wrap??`clampToEdge`];this.bind(),t&&n&&i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,n,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,o),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,o),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,s),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,n,r={}){let i=new e(t,n.width,n.height,r);return i.update(n),i.src=n,i}update(e,t=0,n=0){let r=this.ctx.gl;this.bind(),r.texSubImage2D(r.TEXTURE_2D,0,t,n,r.RGBA,r.UNSIGNED_BYTE,e),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},fi=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,n,r={}){this.ctx=e;let i=e.gl;e.onDestroy(()=>this.free()),this.tex=new di(e,t,n,r);let a=i.createFramebuffer(),o=i.createRenderbuffer();if(!a||!o)throw Error(`Failed to create framebuffer`);this.glFramebuffer=a,this.glRenderbuffer=o,this.bind(),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,t,n),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.tex.glTex,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let n=this.width*4,r=new Uint8Array(n);for(let e=0;e<(this.height/2|0);e++){let i=e*n,a=(this.height-e-1)*n;r.set(t.subarray(i,i+n)),t.copyWithin(i,a,a+n),t.set(r,a)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement(`canvas`),t=e.getContext(`2d`);if(e.width=this.width,e.height=this.height,!t)throw Error(`Failed to get 2d context`);return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},pi=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,n,r){let i=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((e,t)=>e+t.size,0),this.maxVertices=n,this.maxIndices=r;let a=i.createBuffer();if(!a)throw Error(`Failed to create vertex buffer`);this.glVBuf=a,e.pushArrayBuffer(this.glVBuf),i.bufferData(i.ARRAY_BUFFER,n*4,i.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=i.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),i.bufferData(i.ELEMENT_ARRAY_BUFFER,r*4,i.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,n,r,i=null,a={}){(e!==this.curPrimitive||i!==this.curTex||r!==this.curShader||!Ht(this.curUniform,a)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+n.length>this.maxIndices)&&this.flush();let o=this.vqueue.length/this.stride;for(let e of t)this.vqueue.push(e);for(let e of n)this.iqueue.push(e+o);this.curPrimitive=e,this.curShader=r,this.curTex=i,this.curUniform=a}flush(){if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function mi(e){let t=[],n=n=>{t.push(n),e(n)},r=()=>{t.pop(),e(i()??null)},i=()=>t[t.length-1];return[n,r,i]}function hi(e,t={}){let n=[];function r(e){n.push(e)}function i(){n.forEach(e=>e());let t=e.getExtension(`WEBGL_lose_context`);t&&t.loseContext()}let a=null;function o(t){if(Ht(t,a))return;a=t;let n=t.reduce((e,t)=>e+t.size,0);t.reduce((t,r,i)=>(e.vertexAttribPointer(i,r.size,e.FLOAT,!1,n*4,t),e.enableVertexAttribArray(i),t+r.size*4),0)}let[s,c]=mi(t=>e.bindTexture(e.TEXTURE_2D,t)),[l,u]=mi(t=>e.bindBuffer(e.ARRAY_BUFFER,t)),[d,f]=mi(t=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t)),[p,m]=mi(t=>e.bindFramebuffer(e.FRAMEBUFFER,t)),[h,g]=mi(t=>e.bindRenderbuffer(e.RENDERBUFFER,t)),[_,v]=mi(t=>{if(!t)return;let{x:n,y:r,w:i,h:a}=t;e.viewport(n,r,i,a)}),[y,b]=mi(t=>e.useProgram(t));return _({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:r,destroy:i,pushTexture2D:s,popTexture2D:c,pushArrayBuffer:l,popArrayBuffer:u,pushElementArrayBuffer:d,popElementArrayBuffer:f,pushFramebuffer:p,popFramebuffer:m,pushRenderbuffer:h,popRenderbuffer:g,pushViewport:_,popViewport:v,pushProgram:y,popProgram:b,setVertexFormat:o}}var gi={};function _i(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(f(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function vi(e){let t={},n=``,r=[],i=String(e),a=e=>{r.length>0&&(t[n.length]=r.slice()),n+=e};for(;i!==``;){if(i[0]===`\\`){if(i.length===1)throw Error(`Styled text error: \\ at end of string`);a(i[1]),i=i.slice(2);continue}if(i[0]===`[`){let e=/^\[(\/)?(\w+?)\]/.exec(i);if(!e){a(i[0]),i=i.slice(1);continue}let[t,n,o]=e;if(n!==void 0){let e=r.pop();if(e!==o)throw e===void 0?Error(`Styled text error: stray end tag [/${o}]`):Error(`Styled text error: mismatched tags. Expected [/${e}], got [/${o}]`)}else r.push(o);i=i.slice(t.length);continue}a(i[0]),i=i.slice(1)}if(r.length>0)throw Error(`Styled text error: unclosed tags ${r}`);return{charStyleMap:t,text:n}}function yi(e){if(e.text===void 0)throw Error(`formatText() requires property "text".`);let t=Fr(e.font);if(!e.text||e.text===``||t instanceof dr||!t)return{width:0,height:0,chars:[],opt:e,renderedText:``};let{charStyleMap:n,text:i}=vi(e.text+``),a=Yt(i);if(t instanceof Pr||typeof t==`string`){let e=t instanceof Pr?t.fontface.family:t,n=t instanceof Pr?{outline:t.outline,filter:t.filter}:{outline:null,filter:dt},r=gi[e]??{font:{tex:new di(Q.gfx.ggl,2048,2048,{filter:n.filter}),map:{},size:64},cursor:new d(0),maxHeight:0,outline:n.outline};gi[e]||(gi[e]=r),t=r.font;for(let n of a)if(!r.font.map[n]){let i=Q.fontCacheC2d;if(!i)throw Error(`fontCacheC2d is not defined.`);if(!Q.fontCacheCanvas)throw Error(`fontCacheCanvas is not defined.`);i.clearRect(0,0,Q.fontCacheCanvas.width,Q.fontCacheCanvas.height),i.font=`${t.size}px ${e}`,i.textBaseline=`top`,i.textAlign=`left`,i.fillStyle=`#ffffff`;let a=i.measureText(n),o=Math.ceil(a.width);if(!o)continue;let s=Math.ceil(Math.abs(a.actualBoundingBoxAscent))+Math.ceil(Math.abs(a.actualBoundingBoxDescent));r.outline&&r.outline.width&&r.outline.color&&(i.lineJoin=`round`,i.lineWidth=r.outline.width*2,i.strokeStyle=r.outline.color.toHex(),i.strokeText(n,r.outline.width,r.outline.width),o+=r.outline.width*2,s+=r.outline.width*3),i.fillText(n,r.outline?.width??0,r.outline?.width??0);let c=i.getImageData(0,0,o,s);if(r.cursor.x+o>2048&&(r.cursor.x=0,r.cursor.y+=r.maxHeight,r.maxHeight=0,r.cursor.y>2048))throw Error(`Font atlas exceeds character limit`);t.tex.update(c,r.cursor.x,r.cursor.y),t.map[n]=new p(r.cursor.x,r.cursor.y,o,s),r.cursor.x+=o+1,r.maxHeight=Math.max(r.maxHeight,s)}}let o=e.size||t.size,s=f(e.scale??1).scale(o/t.size),c=e.lineSpacing??0,l=e.letterSpacing??0,u=0,m=0,h=0,g=[],_=[],v=0,y=null,b=0,x;for(;v<a.length;){let n=a[v];if(n===`
`)h+=o+c,g.push({width:u-l,chars:_}),y=null,b=0,u=0,_=[],x=void 0;else{let i=t.map[n];if(i){let S=i.w*s.x;e.width&&u+S>e.width&&(h+=o+c,y!=null&&(v-=_.length-y,n=a[v],i=t.map[n],S=i.w*s.x,_=_.slice(0,y-1),u=b),y=null,b=0,g.push({width:u-l,chars:_}),u=x??0,_=[]),_.push({tex:t.tex,width:i.w,height:i.h,quad:new p(i.x/t.tex.width,i.y/t.tex.height,i.w/t.tex.width,i.h/t.tex.height),ch:n,pos:new d(u,h),opacity:e.opacity??1,color:e.color??r.WHITE,scale:f(s),angle:0}),n===` `&&(y=_.length,b=u),e.indentAll&&x===void 0&&/\S/.test(n)&&(x=u),u+=S,m=Math.max(m,u),u+=l}}v++}g.push({width:u-l,chars:_}),h+=o,e.width&&(m=e.width);let S=[];for(let r=0;r<g.length;r++){let i=(m-g[r].width)*Rn(e.align??`left`);for(let a of g[r].chars){let o=t.map[a.ch],c=S.length+r;if(a.pos=a.pos.add(i,0).add(o.w*s.x*.5,o.h*s.y*.5),e.transform){let t=typeof e.transform==`function`?e.transform(c,a.ch):e.transform;t&&_i(a,t)}if(n[c]){let t=n[c];for(let n of t){let t=e.styles?.[n],r=typeof t==`function`?t(c,a.ch):t;r&&_i(a,r)}}S.push(a)}}return{width:m,height:h,chars:S,opt:e,renderedText:i}}function bi(e){if(e.width===void 0||e.height===void 0)throw Error(`drawUVQuad() requires property "width" and "height".`);if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,r=Ln(e.anchor||ct).scale(new d(t,n).scale(-.5)),a=e.quad||new p(0,0,1,1),o=e.color||i(255,255,255),s=e.opacity??1,c=e.tex?.1/e.tex.width:0,l=e.tex?.1/e.tex.height:0,u=a.x+c,f=a.y+l,m=a.w-c*2,h=a.h-l*2;nr(),q(e.pos),ar(e.angle),ir(e.scale),q(r),ei([{pos:new d(-t/2,n/2),uv:new d(e.flipX?u+m:u,e.flipY?f:f+h),color:o,opacity:s},{pos:new d(-t/2,-n/2),uv:new d(e.flipX?u+m:u,e.flipY?f+h:f),color:o,opacity:s},{pos:new d(t/2,-n/2),uv:new d(e.flipX?u:u+m,e.flipY?f+h:f),color:o,opacity:s},{pos:new d(t/2,n/2),uv:new d(e.flipX?u:u+m,e.flipY?f:f+h),color:o,opacity:s}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),J()}function xi(e){nr(),q(e.opt.pos),ar(e.opt.angle),q(Ln(e.opt.anchor??`topleft`).add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{bi({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:`center`,uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),J()}function Si(e){if(e.width===void 0||e.height===void 0)throw Error(`drawRect() requires property "width" and "height".`);if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,r=Ln(e.anchor||ct).add(1,1).scale(new d(t,n).scale(-.5)),i=[new d(0,0),new d(t,0),new d(t,n),new d(0,n)];if(e.radius){let r=Math.min(t,n)/2,a=Array.isArray(e.radius)?e.radius.map(e=>Math.min(r,e)):[,,,,].fill(Math.min(r,e.radius));i=[new d(a[0],0),...a[1]?$n(new d(t-a[1],a[1]),a[1],a[1],270,360):[f(t,0)],...a[2]?$n(new d(t-a[2],n-a[2]),a[2],a[2],0,90):[f(t,n)],...a[3]?$n(new d(a[3],n-a[3]),a[3],a[3],90,180):[f(0,n)],...a[0]?$n(new d(a[0],a[0]),a[0],a[0],180,270):[]]}ti(Object.assign({},e,{offset:r,pts:i,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function Ci(e){or();let t=Q.gfx.width,n=Q.gfx.height;Q.gfx.width=Q.gfx.viewport.width,Q.gfx.height=Q.gfx.viewport.height,e(),or(),Q.gfx.width=t,Q.gfx.height=n}function wi(e,t){Ci(()=>{let n=f(8);nr(),q(e);let r=yi({text:t,font:ut,size:16,pos:n,color:i(255,255,255),fixed:!0}),a=r.width+n.x*2,o=r.height+n.x*2;e.x+a>=Y()&&q(f(-a,0)),e.y+o>=X()&&q(f(0,-o)),Si({width:a,height:o,color:i(0,0,0),radius:4,opacity:.8,fixed:!0}),xi(r),J()})}function Ti(e){if(!e.p1||!e.p2||!e.p3)throw Error(`drawTriangle() requires properties "p1", "p2" and "p3".`);return ti(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function Ei(){if(Q.debug.inspect){let e=null;for(let t of Q.game.root.get(`*`,{recursive:!0}))if(t.has(`area`)&&t.isHovering()){e=t;break}if(Q.game.root.drawInspect(),e){let t=[],n=e.inspect();for(let e in n)n[e]?t.push(`${n[e]}`):t.push(`${e}`);wi(hn(Q.k.mousePos()),t.join(`
`))}wi(f(8),`FPS: ${Q.debug.fps()}`)}Q.debug.paused&&Ci(()=>{nr(),q(Y(),0),q(-8,8),Si({width:32,height:32,anchor:`topright`,color:i(0,0,0),opacity:.8,radius:4,fixed:!0});for(let e=1;e<=2;e++)Si({width:4,height:32*.6,anchor:`center`,pos:f(-32/3*e,32*.5),color:i(255,255,255),radius:2,fixed:!0});J()}),Q.debug.timeScale!==1&&Ci(()=>{nr(),q(Y(),X()),q(-8,-8);let e=yi({text:Q.debug.timeScale.toFixed(1),font:ut,size:16,color:i(255,255,255),pos:f(-8),anchor:`botright`,fixed:!0});Si({width:e.width+16+32,height:e.height+16,anchor:`botright`,color:i(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=0;t<2;t++){let n=Q.debug.timeScale<1;Ti({p1:f(-e.width-8*(n?2:3.5),-8),p2:f(-e.width-8*(n?2:3.5),-8-e.height),p3:f(-e.width-8*(n?3.5:2),-8-e.height/2),pos:f(-t*8*1+(n?-8*.5:0),0),color:i(255,255,255),fixed:!0})}xi(e),J()}),Q.debug.curRecording&&Ci(()=>{nr(),q(0,X()),q(24,-24),ri({radius:12,color:i(255,0,0),opacity:v(0,1,Q.app.time()*4),fixed:!0}),J()}),Q.debug.showLog&&Q.game.logs.length>0&&Ci(()=>{nr(),q(0,X()),q(8,-8);let e=[];for(let t of Q.game.logs){let n=``,r=t.msg instanceof Error?`error`:`info`;n+=`[time]${t.time.toFixed(2)}[/time]`,n+=` `,n+=`[${r}]${Di(t.msg)}[/${r}]`,e.push(n)}Q.game.logs=Q.game.logs.filter(e=>Q.app.time()-e.time<(Q.globalOpt.logTime||4));let t=yi({text:e.join(`
`),font:ut,pos:f(8,-8),anchor:`botleft`,size:16,width:Y()*.6,lineSpacing:8/2,fixed:!0,styles:{time:{color:i(127,127,127)},info:{color:i(255,255,255)},error:{color:i(255,0,127)}}});Si({width:t.width+16,height:t.height+16,anchor:`botleft`,color:i(0,0,0),radius:4,opacity:.8,fixed:!0}),xi(t),J()})}function Di(e,t=!1,n=new Set){if(n.has(e))return`<recursive>`;var r=``,i;return t&&typeof e==`string`&&(e=JSON.stringify(e)),Array.isArray(e)&&(r=[`[`,e.map(t=>Di(t,!0,n.union(new Set([e])))).join(`, `),`]`].join(``),e=r),e===null?`null`:(typeof e==`object`&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(r+=e.constructor.name+` `),r+=[`{`,(i=Object.getOwnPropertyNames(e).map(t=>`${/^\w+$/.test(t)?t:JSON.stringify(t)}: ${Di(e[t],!0,n.union(new Set([e])))}`).join(`, `))?` ${i} `:``,`}`].join(``),e=r),String(e).replaceAll(/(?<!\\)\[/g,`\\[`))}function Oi(){let e=Q.game.cam,t=d.fromAngle(T(0,360)).scale(e.shake);e.shake=c(e.shake,0,5*K()),e.transform=new _().translate(cr()).scale(e.scale).rotate(e.angle).translate((e.pos??cr()).scale(-1).add(t)),Q.game.root.draw(),or()}function ki(){let e=br();Q.game.events.numListeners(`loading`)>0?Q.game.events.trigger(`loading`,e):Ci(()=>{let t=Y()/2,n=f(Y()/2,X()/2).sub(f(t/2,24/2));Si({pos:f(0),width:Y(),height:X(),color:i(0,0,0)}),Si({pos:n,width:t,height:24,fill:!1,outline:{width:4}}),Si({pos:n,width:t*e,height:24})})}function Ai(e,t,n){let r=Q.gfx.ggl.gl;or(),r.clear(r.STENCIL_BUFFER_BIT),r.enable(r.STENCIL_TEST),r.stencilFunc(r.NEVER,1,255),r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),t(),or(),r.stencilFunc(n,1,255),r.stencilOp(r.KEEP,r.KEEP,r.KEEP),e(),or(),r.disable(r.STENCIL_TEST)}function ji(e,t){let n=Q.gfx.ggl.gl;Ai(e,t,n.EQUAL)}function Mi(e){if(!e.tex)throw Error(`drawTexture() requires property "tex".`);let t=e.quad??new p(0,0,1,1),n=e.tex.width*t.w,i=e.tex.height*t.h,a=new d(1);if(e.tiled){let a=Ln(e.anchor||ct);(e.pos?.x||0)-(a.x+1)*.5*(e.width||n),(e.pos?.y||0)-(a.y+1)*.5*(e.height||i);let o=(e.width||n)/n,s=(e.height||i)/i,c=Math.floor(o),l=Math.floor(s),u=o-c,f=s-l,m=(c+u?1:0)*(l+f?1:0),h=Array(m*6),g=Array(m*4),_=0,v=(t,n,i,o,s)=>{h[_*6+0]=_*4+0,h[_*6+1]=_*4+1,h[_*6+2]=_*4+3,h[_*6+3]=_*4+1,h[_*6+4]=_*4+2,h[_*6+5]=_*4+3,g[_*4+0]={pos:new d(t-a.x,n-a.y),uv:new d(s.x,s.y),color:e.color||r.WHITE,opacity:e.opacity||1},g[_*4+1]={pos:new d(t+i-a.x,n-a.y),uv:new d(s.x+s.w,s.y),color:e.color||r.WHITE,opacity:e.opacity||1},g[_*4+2]={pos:new d(t+i-a.x,n+o-a.y),uv:new d(s.x+s.w,s.y+s.h),color:e.color||r.WHITE,opacity:e.opacity||1},g[_*4+3]={pos:new d(t-a.x,n+o-a.y),uv:new d(s.x,s.y+s.h),color:e.color||r.WHITE,opacity:e.opacity||1},_++};for(let e=0;e<l;e++){for(let r=0;r<c;r++)v(r*n,e*i,n,i,t);u&&v(c*n,e*i,n*u,i,new p(t.x,t.y,t.w*u,t.h))}if(f){for(let e=0;e<c;e++)v(e*n,l*i,n,i*f,new p(t.x,t.y,t.w,t.h*f));u&&v(c*n,l*i,n*u,i*f,new p(t.x,t.y,t.w*u,t.h*f))}ei(g,h,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(a.x=e.width/n,a.y=e.height/i):e.width?(a.x=e.width/n,a.y=a.x):e.height&&(a.y=e.height/i,a.x=a.y),bi(Object.assign({},e,{scale:a.scale(e.scale||new d(1)),tex:e.tex,quad:t,width:n,height:i}))}function Ni(e){if(!e.sprite)throw Error(`drawSprite() requires property "sprite"`);let t=Dr(e.sprite);if(!t||!t.data)return;let n=t.data.frames[e.frame??0];if(!n)throw Error(`Frame not found: ${e.frame??0}`);Mi(Object.assign({},e,{tex:t.data.tex,quad:n.scale(e.quad??new p(0,0,1,1))}))}function Pi(e,t){let n=Q.gfx.ggl.gl;Ai(e,t,n.NOTEQUAL)}function Fi(e){xi(yi(e))}var Ii=(e,t)=>{let n=Ur(t,yt,bt),r=e.pixelDensity??1,a=e.scale??1,{gl:o}=t,s=di.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),c=e.width&&e.height?new fi(t,e.width*r*a,e.height*r*a):new fi(t,o.drawingBufferWidth,o.drawingBufferHeight),l=null,u=1;e.background&&(typeof e.background==`string`?l=i(e.background):(l=i(...e.background),u=e.background[3]??1),o.clearColor(l.r/255,l.g/255,l.b/255,u??1)),o.enable(o.BLEND),o.blendFuncSeparate(o.ONE,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA);let d=new pi(t,ft,ht,gt),f=di.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:`repeat`,filter:`nearest`});return{lastDrawCalls:0,ggl:t,defShader:n,defTex:s,frameBuffer:c,postShader:null,postShaderUniform:null,renderer:d,transform:new _,transformStack:[],bgTex:f,bgColor:l,bgAlpha:u,width:e.width??o.drawingBufferWidth/r/a,height:e.height??o.drawingBufferHeight/r/a,viewport:{x:0,y:0,width:o.drawingBufferWidth,height:o.drawingBufferHeight,scale:1},fixed:!1}};function Li(e){return e.fixed?!0:e.parent?Li(e.parent):!1}function Ri(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function zi(e,t={}){return{id:`circle`,radius:e,draw(){ri(Object.assign(Ri(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new B(new d(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function Bi(...e){return{id:`color`,color:i(...e),inspect(){return`color: ${this.color.toString()}`}}}function Vi(e){return{add(){this.canvas=e}}}function Hi(e=1){let t,n=0,r=!1;return{require:[`opacity`],add(){t=this.opacity,this.opacity=0},update(){r||(n+=K(),this.opacity=l(n,0,e,0,t),n>=e&&(this.opacity=t,r=!0))}}}function Ui(e=`intersect`){return{id:`mask`,mask:e}}function Wi(e){return{id:`opacity`,opacity:e??1,fadeIn(e=1,t=Q.k.easings.linear){return Q.game.root.tween(0,this.opacity,e,e=>this.opacity=e,t)},fadeOut(e=1,t=Q.k.easings.linear){return Q.game.root.tween(this.opacity,0,e,e=>this.opacity=e,t)},inspect(){return`opacity: ${qt(this.opacity,1)}`}}}function Gi(e=1,t=i(0,0,0),n=1,r=`miter`,a=10,o=`butt`){return{id:`outline`,outline:{width:e,color:t,opacity:n,join:r,miterLimit:a,cap:o},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var Ki=class{pos=f(0);vel=f(0);acc=f(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function qi(e,t){let n=t.lifetime,a=[],o=e.colors||[r.WHITE],s=e.opacities||[1],u=e.quads||[new p(0,0,1,1)],m=e.scales||[1],h=e.lifeTime,g=t.direction,_=t.spread,v=e.speed||[0,0],y=e.angle||[0,0],b=e.angularVelocity||[0,0],x=e.acceleration||[f(0),f(0)],S=e.damping||[0,0],C=[],w=Array(e.max),E=0,D=0;for(let t=0;t<e.max;t++){C[t*6+0]=t*4+0,C[t*6+1]=t*4+1,C[t*6+2]=t*4+3,C[t*6+3]=t*4+1,C[t*6+4]=t*4+2,C[t*6+5]=t*4+3;for(let e=0;e<4;e++)w[t*4+e]={pos:new d(0,0),uv:new d(0,0),color:i(255,255,255),opacity:1};a[t]=new Ki}let O=new W;function ee(t=0){for(;t<e.max;){if(a[t].gc)return t;t++}return null}return{id:`particles`,emit(e){let n=0;for(let r=0;r<e;r++){if(n=ee(n),n==null)return;let e=T(g-_,g+_),r=d.fromAngle(e).scale(T(v[0],v[1])),i=T(y[0],y[1]),o=T(b[0],b[1]),s=f(T(x[0].x,x[1].x),T(x[0].y,x[1].y)),c=T(S[0],S[1]),l=h?T(h[0],h[1]):null,u=t.shape?t.shape.random():f(),p=a[n];p.lt=l,p.pos=u,p.vel=r,p.acc=s,p.angle=i,p.angularVelocity=o,p.damping=c,p.angularVelocity=o,p.gc=!1}E+=e},update(){if(n!==void 0&&n<=0)return;let r=K();for(let e of a)if(!e.gc){if(e.t+=r,e.lt&&e.t>=e.lt){e.gc=!0,E--;continue}e.vel=e.vel.add(e.acc.scale(r)).scale(1-e.damping*r),e.pos=e.pos.add(e.vel.scale(r)),e.angle+=e.angularVelocity*r}for(n!==void 0&&(n-=r,n<=0&&O.trigger()),D+=r;E<e.max&&t.rate&&D>t.rate;)this.emit(1),E++,D-=t.rate},draw(){if(!(n!==void 0&&n<=0)){for(let t=0;t<a.length;t++){let n=a[t];if(n.gc)continue;let r=n.progress,i=Math.floor(n.progress*o.length),d=i<o.length-1?c(o[i],o[i+1],l(r,i/o.length,(i+1)/o.length,0,1)):o[i],f=Math.floor(n.progress*s.length),p=f<s.length-1?c(s[f],s[f+1],l(r,f/s.length,(f+1)/s.length,0,1)):s[f],h=Math.floor(n.progress*u.length),g=u[h],_=Math.floor(n.progress*m.length),v=m[_],y=Math.cos(n.angle*Math.PI/180),b=Math.sin(n.angle*Math.PI/180),x=(e.texture?e.texture.width:10)*g.w/2,S=(e.texture?e.texture.height:10)*g.h/2,C=t*4,T=w[C];T.pos.x=n.pos.x+-x*v*y- -S*v*b,T.pos.y=n.pos.y+-x*v*b+-S*v*y,T.uv.x=g.x,T.uv.y=g.y,T.color.r=d.r,T.color.g=d.g,T.color.b=d.b,T.opacity=p,T=w[C+1],T.pos.x=n.pos.x+x*v*y- -S*v*b,T.pos.y=n.pos.y+x*v*b+-S*v*y,T.uv.x=g.x+g.w,T.uv.y=g.y,T.color.r=d.r,T.color.g=d.g,T.color.b=d.b,T.opacity=p,T=w[C+2],T.pos.x=n.pos.x+x*v*y-S*v*b,T.pos.y=n.pos.y+x*v*b+S*v*y,T.uv.x=g.x+g.w,T.uv.y=g.y+g.h,T.color.r=d.r,T.color.g=d.g,T.color.b=d.b,T.opacity=p,T=w[C+3],T.pos.x=n.pos.x+-x*v*y-S*v*b,T.pos.y=n.pos.y+-x*v*b+S*v*y,T.uv.x=g.x,T.uv.y=g.y+g.h,T.color.r=d.r,T.color.g=d.g,T.color.b=d.b,T.opacity=p}ei(w,C,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(e){return O.add(e)},inspect(){return`count: ${E}/${e.max}`}}}function Ji(e,t={}){if(e.length<3)throw Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:`polygon`,pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){ti(Object.assign(Ri(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new H(this.pts)},inspect(){return`polygon: ${this.pts.map(e=>`[${e.x},${e.y}]`).join(`,`)}`}}}function Yi(e,t,n){let r;return Q.game.root.get(`area`).forEach(i=>{if(n&&n.some(e=>i.is(e)))return;let a=i.worldArea().raycast(e,t);a&&(r?a.fraction<r.fraction&&(r=a,r.object=i):(r=a,r.object=i))}),r}function Xi(e,t,n={}){return{id:`rect`,width:e,height:t,radius:n.radius||0,draw(){Si(Object.assign(Ri(this),{width:this.width,height:this.height,radius:this.radius,fill:n.fill}))},renderArea(){return new B(f(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function Zi(e,t){return{id:`shader`,shader:e,...typeof t==`function`?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function Qi(e,t){if(!t.tileWidth||!t.tileHeight)throw Error(`Must provide tileWidth and tileHeight.`);let n=Q.game.root.add([Zo(t.pos??f(0))]),r=e.length,i=0,a=null,o=null,s=null,c=null,l=e=>e.x+e.y*i,u=e=>f(Math.floor(e%i),Math.floor(e/i)),d=()=>{a=[];for(let e of n.children)p(e)},p=e=>{let t=l(e.tilePos);a[t]?a[t].push(e):a[t]=[e]},m=e=>{let t=l(e.tilePos);if(a[t]){let n=a[t].indexOf(e);n>=0&&a[t].splice(n,1)}},h=()=>{let e=!1;for(let t of n.children){let r=n.pos2Tile(t.pos);(t.tilePos.x!=r.x||t.tilePos.y!=r.y)&&(e=!0,m(t),t.tilePos.x=r.x,t.tilePos.y=r.y,p(t))}e&&n.trigger(`spatialMapChanged`)},g=()=>{let e=n.getSpatialMap(),t=n.numRows()*n.numColumns();o?o.length=t:o=Array(t),o.fill(1,0,t);for(let t=0;t<e.length;t++){let n=e[t];if(n){let e=0;for(let t of n)if(t.isObstacle){e=1/0;break}else e+=t.cost;o[t]=e||1}}},_=()=>{let e=n.getSpatialMap(),t=n.numRows()*n.numColumns();s?s.length=t:s=Array(t),s.fill(15,0,t);for(let t=0;t<e.length;t++){let n=e[t];if(n){let e=n.length,r=15;for(let t=0;t<e;t++)r|=n[t].edgeMask;s[t]=r}}},v=()=>{let e=n.numRows()*n.numColumns(),t=(e,t)=>{let n=[];for(n.push(e);n.length>0;){let e=n.pop();x(e).forEach(e=>{c[e]<0&&(c[e]=t,n.push(e))})}};c?c.length=e:c=Array(e),c.fill(-1,0,e);let r=0;for(let e=0;e<o.length;e++){if(c[e]>=0){r++;continue}t(e,r),r++}},y=(e,t)=>o[t],b=(e,t)=>{let n=u(e),r=u(t);return n.dist(r)},x=(e,t)=>{let n=[],a=Math.floor(e%i),c=a>0&&s[e]&1&&o[e-1]!==1/0,l=e>=i&&s[e]&2&&o[e-i]!==1/0,u=a<i-1&&s[e]&4&&o[e+1]!==1/0,d=e<i*r-i-1&&s[e]&8&&o[e+i]!==1/0;return t?(c&&(l&&n.push(e-i-1),n.push(e-1),d&&n.push(e+i-1)),l&&n.push(e-i),u&&(l&&n.push(e-i+1),n.push(e+1),d&&n.push(e+i+1)),d&&n.push(e+i)):(c&&n.push(e-1),l&&n.push(e-i),u&&n.push(e+1),d&&n.push(e+i)),n},S={id:`level`,tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(e,...r){let i=f(...r),o=(()=>{if(typeof e==`string`){if(t.tiles[e]){if(typeof t.tiles[e]!=`function`)throw Error(`Level symbol def must be a function returning a component list`);return t.tiles[e](i)}else if(t.wildcardTile)return t.wildcardTile(e,i)}else{if(Array.isArray(e))return e;throw Error(`Expected a symbol or a component list`)}})();if(!o)return null;let s=!1,c=!1;for(let e of o)e.id===`tile`&&(c=!0),e.id===`pos`&&(s=!0);s||o.push(Zo(this.tile2Pos(i))),c||o.push(vo());let l=n.add(o);return s&&(l.tilePosOffset=l.pos.clone()),l.tilePos=i,l.transform=Zn(l),a&&(p(l),this.trigger(`spatialMapChanged`),this.trigger(`navigationMapInvalid`)),l},numColumns(){return i},numRows(){return r},levelWidth(){return i*this.tileWidth()},levelHeight(){return r*this.tileHeight()},tile2Pos(...e){return f(...e).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...e){let t=f(...e);return f(Math.floor(t.x/this.tileWidth()),Math.floor(t.y/this.tileHeight()))},getSpatialMap(){return a||d(),a},removeFromSpatialMap:m,insertIntoSpatialMap:p,onSpatialMapChanged(e){return this.on(`spatialMapChanged`,e)},onNavigationMapInvalid(e){return this.on(`navigationMapInvalid`,e)},getAt(e){a||d();let t=l(e);return a[t]||[]},raycast(e,t){let n=this.toWorld(e),r=this.toWorld(e.add(t)).sub(n),i=1/this.tileWidth(),a=e.scale(i),o=Te(a,t,e=>{let t=this.getAt(e);if(t.some(e=>e.isObstacle))return!0;let a=null;for(let e of t)if(e.has(`area`)){let t=e.worldArea().raycast(n,r);t&&(a?t.fraction<a.fraction&&(a=t,a.object=e):(a=t,a.object=e))}return a&&(a.point=this.fromWorld(a.point).scale(i)),a||!1},64);return o&&(o.point=o.point.scale(this.tileWidth())),o},update(){a&&h()},invalidateNavigationMap(){o=null,s=null,c=null},onNavigationMapChanged(e){return this.on(`navigationMapChanged`,e)},getTilePath(e,t,n={}){if(o||g(),s||_(),c||v(),e.x<0||e.x>=i||e.y<0||e.y>=r||t.x<0||t.x>=i||t.y<0||t.y>=r)return null;let a=l(e),d=l(t);if(o[d]===1/0)return null;if(a===d)return[];if(c[a]!=-1&&c[a]!==c[d])return null;let f=new Nt((e,t)=>e.cost<t.cost);f.insert({cost:0,node:a});let p=new Map;p.set(a,a);let m=new Map;for(m.set(a,0);f.length!==0;){let e=f.remove()?.node;if(e===d)break;let t=x(e,n.allowDiagonals);for(let n of t){let t=(m.get(e)||0)+y(e,n)+b(n,d);(!m.has(n)||t<m.get(n))&&(m.set(n,t),f.insert({cost:t,node:n}),p.set(n,e))}}let h=[],S=d,C=u(S);for(h.push(C);S!==a;){let e=p.get(S);if(e===void 0)throw Error(`Bug in pathfinding algorithm`);S=e;let t=u(S);h.push(t)}return h.reverse()},getPath(e,t,n={}){let r=this.tileWidth(),i=this.tileHeight(),a=this.getTilePath(this.pos2Tile(e),this.pos2Tile(t),n);return a?[e,...a.slice(1,-1).map(e=>e.scale(r,i).add(r/2,i/2)),t]:null}};return n.use(S),n.onNavigationMapInvalid(()=>{n.invalidateNavigationMap(),n.trigger(`navigationMapChanged`)}),e.forEach((e,t)=>{let r=e.split(``);i=Math.max(r.length,i),r.forEach((e,r)=>{n.spawn(e,f(r,t))})}),n}function Z(e,t,n){return Q.game.objEvents.registers[e]||(Q.game.objEvents.registers[e]=new Dt),Q.game.objEvents.on(e,(e,...r)=>{e.is(t)&&n(e,...r)})}var $i=(e,t,...n)=>{for(let r of Q.game.root.children)r.is(t)&&r.trigger(e,n)},ea=G(e=>{let t=Q.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(e){t.paused=e},cancel:()=>t.destroy()}},(e,t)=>Z(`fixedUpdate`,e,t)),ta=G(e=>{let t=Q.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(e){t.paused=e},cancel:()=>t.destroy()}},(e,t)=>Z(`update`,e,t)),na=G(e=>{let t=Q.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(e){t.hidden=e},cancel:()=>t.destroy()}},(e,t)=>Z(`draw`,e,t)),ra=G(e=>Q.game.events.on(`add`,e),(e,t)=>Z(`add`,e,t)),ia=G(e=>Q.game.events.on(`destroy`,e),(e,t)=>Z(`destroy`,e,t)),aa=G(e=>Q.game.events.on(`use`,e),(e,t)=>Z(`use`,e,t)),oa=G(e=>Q.game.events.on(`unuse`,e),(e,t)=>Z(`unuse`,e,t)),sa=G(e=>Q.game.events.on(`tag`,e),(e,t)=>Z(`tag`,e,t)),ca=G(e=>Q.game.events.on(`untag`,e),(e,t)=>Z(`untag`,e,t));function la(e,t,n){return Z(`collide`,e,(e,r,i)=>r.is(t)&&n(e,r,i))}function ua(e,t,n){return Z(`collideUpdate`,e,(e,r,i)=>r.is(t)&&n(e,r,i))}function da(e,t,n){return Z(`collideEnd`,e,(e,r,i)=>r.is(t)&&n(e,r,i))}function fa(e,t){Q.game.root.get(e,{recursive:!0}).forEach(t),ra(e,t),sa((n,r)=>{r===e&&t(n)})}var pa=G(e=>Q.app.onMousePress(e),(e,t)=>{let n=[];return fa(e,e=>{if(!e.area)throw Error(`onClick() requires the object to have area() component`);n.push(e.onClick(()=>t(e)))}),Ot.join(n)});function ma(e,t){let n=[];return fa(e,e=>{if(!e.area)throw Error(`onHover() requires the object to have area() component`);n.push(e.onHover(()=>t(e)))}),Ot.join(n)}function ha(e,t){let n=[];return fa(e,e=>{if(!e.area)throw Error(`onHoverUpdate() requires the object to have area() component`);n.push(e.onHoverUpdate(()=>t(e)))}),Ot.join(n)}function ga(e,t){let n=[];return fa(e,e=>{if(!e.area)throw Error(`onHoverEnd() requires the object to have area() component`);n.push(e.onHoverEnd(()=>t(e)))}),Ot.join(n)}function _a(e){Q.game.events.on(`loading`,e)}function va(e){Q.app.onResize(e)}function ya(e){Q.game.events.on(`error`,e)}function ba(e){Q.assets.loaded?e():Q.game.events.on(`load`,e)}function xa(e){if(Q.assets.loaded)xr().forEach(t=>e(...t));else return Q.game.events.on(`loadError`,e)}function Sa(...e){Q.game.cam.pos=f(...e)}function Ca(){return Q.game.cam.pos?Q.game.cam.pos.clone():cr()}function wa(...e){Q.game.cam.scale=f(...e)}function Ta(){return Q.game.cam.scale.clone()}function Ea(e){Q.game.cam.angle=e}function Da(){return Q.game.cam.angle}function Oa(){return Q.game.cam.transform.clone()}function ka(e=i(255,255,255),t=1){let n=Q.game.root.add([Xi(Y(),X()),Bi(e),Wi(1),Ko()]),r=n.fadeOut(t);return r.onEnd(()=>io(n)),r}function Aa(){return Q.game.cam.transform.clone()}function ja(e=12){Q.game.cam.shake+=e}function Ma(e){return Q.game.cam.transform.multVec2(e)}function Na(e){return Q.game.cam.transform.invert().multVec2(e)}function Pa(...e){return Kt(`camPos`,`setCamPos / getCamPos`),e.length>0&&Sa(...e),Ca()}function Fa(...e){return Kt(`camScale`,`setCamScale / getCamScale`),e.length>0&&wa(...e),Ta()}function Ia(e){return Kt(`camRot`,`setCamRot / getCamRot`),e!==void 0&&Ea(e),Da()}function La(e=i(255,255,255),t=1){return Kt(`camFlash`,`flash`),ka(e,t)}function Ra(e=[]){let t=new Map,n=[],r={},i=new kt,a=[],o=new Set(`*`),s=Q.globalOpt.tagsAsComponents,c=null,l=!1,u={id:fn(),hidden:!1,transform:new _,children:[],parent:null,set paused(e){if(e!==l){l=e;for(let t of a)t.paused=e}},get paused(){return l},get tags(){return Array.from(o)},add(e){let t=Array.isArray(e)?Ra(e):e;if(t.parent)throw Error(`Cannot add a game obj that already has a parent.`);return t.parent=this,t.transform=Zn(t),this.children.push(t),t.trigger(`add`,t),Q.game.events.trigger(`add`,t),t},readd(e){let t=this.children.indexOf(e);return t!==-1&&(this.children.splice(t,1),this.children.push(e)),e},remove(e){let t=this.children.indexOf(e);if(t!==-1){e.parent=null,this.children.splice(t,1);let n=e=>{e.trigger(`destroy`),Q.game.events.trigger(`destroy`,e),e.children.forEach(e=>n(e))};n(e)}},removeAll(e){if(e)this.get(e).forEach(e=>this.remove(e));else for(let e of[...this.children])this.remove(e)},fixedUpdate(){this.paused||(this.children.forEach(e=>e.fixedUpdate()),this.trigger(`fixedUpdate`))},update(){this.paused||(this.children.forEach(e=>e.update()),this.trigger(`update`))},draw(){if(this.hidden)return;this.canvas&&(or(),this.canvas.bind());let e=Q.gfx.fixed;this.fixed&&(Q.gfx.fixed=!0),nr(),q(this.pos),ir(this.scale),ar(this.angle);let t=this.children.sort((e,t)=>{let n=e.layerIndex??Q.game.defaultLayerIndex,r=t.layerIndex??Q.game.defaultLayerIndex;return n-r||(e.z??0)-(t.z??0)});if(this.mask){let e={intersect:Q.k.drawMasked,subtract:Q.k.drawSubtracted}[this.mask];if(!e)throw Error(`Invalid mask func: "${this.mask}"`);e(()=>{t.forEach(e=>e.draw())},()=>{this.trigger(`draw`)})}else this.trigger(`draw`),t.forEach(e=>e.draw());J(),Q.gfx.fixed=e,this.canvas&&(or(),this.canvas.unbind())},drawInspect(){this.hidden||(nr(),q(this.pos),ir(this.scale),ar(this.angle),this.children.forEach(e=>e.drawInspect()),this.trigger(`drawInspect`),J())},use(e){if(typeof e==`string`)return o.add(e);if(!e||typeof e!=`object`)throw Error(`You can only pass a component or a string to .use(), you passed a "${typeof e}"`);let i=[];for(let a in e.id?(this.unuse(e.id),r[e.id]=[],i=r[e.id],t.set(e.id,e),s&&o.add(e.id)):n.push(e),e){if(xt.has(a))continue;let n=Object.getOwnPropertyDescriptor(e,a);if(n)if(typeof n.value==`function`&&(e[a]=e[a].bind(this)),n.set&&Object.defineProperty(e,a,{set:n.set.bind(this)}),n.get&&Object.defineProperty(e,a,{get:n.get.bind(this)}),St.has(a)){let t=a===`add`?()=>{c=e=>i.push(e),e[a]?.(),c=null}:e[a];i.push(this.on(a,t).cancel)}else if(this[a]===void 0)Object.defineProperty(this,a,{get:()=>e[a],set:t=>e[a]=t,configurable:!0,enumerable:!0}),i.push(()=>delete this[a]);else{let n=t.values().find(e=>e[a]!==void 0)?.id;throw Error(`Duplicate component property: "${a}" while adding component "${e.id}"`+(n?` (originally added by "${n}")`:``))}}let a=()=>{if(e.require){for(let t of e.require)if(!this.c(t))throw Error(`Component "${e.id}" requires component "${t}"`)}};e.destroy&&i.push(e.destroy.bind(this)),this.exists()?(a(),e.add&&(c=e=>i.push(e),e.add.call(this),c=null),e.id&&(this.trigger(`use`,e.id),Q.game.events.trigger(`use`,this,e.id))):e.require&&i.push(this.on(`add`,a).cancel)},unuse(e){if(t.has(e)){for(let n of t.values())if(n.require&&n.require.includes(e))throw Error(`Can't unuse. Component "${n.id}" requires component "${e}"`);t.delete(e),this.trigger(`unuse`,e),Q.game.events.trigger(`unuse`,this,e)}else s&&o.has(e)&&o.delete(e);r[e]&&(r[e].forEach(e=>e()),delete r[e])},c(e){return t.get(e)??null},get(e,t={}){let n=(e,n)=>t.only===`comps`?e.has(n):t.only===`tags`?e.is(n):e.is(n)||e.has(n),r=t.recursive?this.children.flatMap(function e(t){return[t,...t.children.flatMap(e)]}):this.children;if(r=r.filter(t=>e?n(t,e):!0),t.liveUpdate){let i=e=>t.recursive?this.isAncestorOf(e):e.parent===this,a=[];a.push(Q.k.onAdd(t=>{i(t)&&n(t,e)&&r.push(t)})),a.push(Q.k.onDestroy(t=>{if(i(t)&&n(t,e)){let e=r.findIndex(e=>e.id===t.id);e!==-1&&r.splice(e,1)}})),this.onDestroy(()=>{for(let e of a)e.cancel()})}return r},query(e){let t=e.hierarchy||`children`,n=e.include,r=e.exclude,i=[];switch(t){case`children`:i=this.children;break;case`siblings`:i=this.parent?this.parent.children.filter(e=>e!==this):[];break;case`ancestors`:let e=this.parent;for(;e;)i.push(e),e=e.parent;break;case`descendants`:i=this.children.flatMap(function e(t){return[t,...t.children.flatMap(e)]});break}if(n&&(i=(e.includeOp||`and`)===`and`||!Array.isArray(e.include)?i.filter(e=>e.is(n)):i.filter(t=>e.include.some(e=>t.is(e)))),r&&(i=(e.includeOp||`and`)===`and`||!Array.isArray(e.include)?i.filter(e=>!e.is(r)):i.filter(t=>!e.exclude.some(e=>t.is(e)))),e.visible===!0&&(i=i.filter(e=>e.visible)),e.distance){if(!this.pos)throw Error(`Can't do a distance query from an object without pos`);let t=e.distanceOp||`near`,n=e.distance*e.distance;i=t===`near`?i.filter(e=>e.pos&&this.pos.sdist(e.pos)<=n):i.filter(e=>e.pos&&this.pos.sdist(e.pos)>n)}return e.name&&(i=i.filter(t=>t.name===e.name)),i},isAncestorOf(e){return e.parent?e.parent===this||this.isAncestorOf(e.parent):!1},exists(){return Q.game.root.isAncestorOf(this)},is(e,t=`and`){return Array.isArray(e)?t===`and`?e.every(e=>o.has(e)):e.some(e=>o.has(e)):o.has(e)},tag(e){if(Array.isArray(e))for(let t of e)o.add(t),this.trigger(`tag`,t),Q.game.events.trigger(`tag`,this,t);else o.add(e),this.trigger(`tag`,e),Q.game.events.trigger(`tag`,this,e)},untag(e){if(Array.isArray(e))for(let t of e)o.delete(t),this.trigger(`untag`,t),Q.game.events.trigger(`untag`,this,t);else o.delete(e),this.trigger(`untag`,e),Q.game.events.trigger(`untag`,this,e)},has(e,n=`and`){return Array.isArray(e)?n===`and`?e.every(e=>t.has(e)):e.some(e=>t.has(e)):t.has(e)},on(e,t){let n=i.on(e,t.bind(this));return c&&c(()=>n.cancel()),n},trigger(e,...t){i.trigger(e,...t),Q.game.objEvents.trigger(e,this,...t)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let e={};for(let[n,r]of t)e[n]=r.inspect?.()??null;for(let[t,r]of n.entries()){if(r.inspect){e[t]=r.inspect();continue}for(let[t,n]of Object.entries(r))typeof n!=`function`&&(e[t]=`${t}: ${n}`)}return e},onAdd(e){return this.on(`add`,e)},onFixedUpdate(e){return this.on(`fixedUpdate`,e)},onUpdate(e){return this.on(`update`,e)},onDraw(e){return this.on(`draw`,e)},onDestroy(e){return this.on(`destroy`,e)},onUse(e){return this.on(`use`,e)},onUnuse(e){return this.on(`unuse`,e)},clearEvents(){i.clear()}};for(let e of[`onKeyPress`,`onKeyPressRepeat`,`onKeyDown`,`onKeyRelease`,`onMousePress`,`onMouseDown`,`onMouseRelease`,`onMouseMove`,`onCharInput`,`onMouseMove`,`onTouchStart`,`onTouchMove`,`onTouchEnd`,`onScroll`,`onGamepadButtonPress`,`onGamepadButtonDown`,`onGamepadButtonRelease`,`onGamepadStick`,`onButtonPress`,`onButtonDown`,`onButtonRelease`])u[e]=(...t)=>{let n=Q.app[e]?.(...t);return a.push(n),u.onDestroy(()=>n.cancel()),u.on(`sceneEnter`,()=>{a.splice(a.indexOf(n),1);let r=Q.app[e]?.(...t);Ot.replace(n,r),a.push(n)}),n};for(let t of e)u.use(t);return u}var za=()=>({events:new kt,objEvents:new kt,root:Ra([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new d(1),angle:0,shake:0,transform:new _}});function Ba(e){Q.game.gravity=e?(Q.game.gravity||f(0,1)).unit().scale(e):null}function Va(){return Q.game.gravity?Q.game.gravity.len():0}function Ha(e){Q.game.gravity=e.unit().scale(Q.game.gravity?Q.game.gravity.len():1)}function Ua(){return Q.game.gravity?Q.game.gravity.unit():f(0,1)}var Wa=e(`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`),Ga=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let n=new Jr(zn(e));return e.decodeAudioData(Wa.buffer.slice(0)).then(e=>{n.buf=e}).catch(e=>{console.error(`Failed to load burp: `,e)}),{ctx:e,masterNode:t,burpSnd:n}})();function Ka(e,t={}){let r=new W,i=new Audio(e);i.crossOrigin=`anonymous`,i.loop=!!t.loop,Q.audio.ctx.createMediaElementSource(i).connect(Q.audio.masterNode);function a(){Q.debug.paused||Q.app.isHidden()&&!Q.globalOpt.backgroundAudio||Q.audio.ctx.resume()}function o(){a(),i.play()}return t.paused||o(),i.onended=()=>r.trigger(),{play(){o()},seek(e){i.currentTime=e},stop(){i.pause(),this.seek(0)},set loop(e){i.loop=e},get loop(){return i.loop},set paused(e){e?i.pause():o()},get paused(){return i.paused},time(){return i.currentTime},duration(){return i.duration},set volume(e){i.volume=n(e,0,1)},get volume(){return i.volume},set speed(e){i.playbackRate=Math.max(e,0)},get speed(){return i.playbackRate},set detune(e){},get detune(){return 0},onEnd(e){return r.add(e)},then(e){return this.onEnd(e)}}}function qa(e,t={}){if(typeof e==`string`&&Q.assets.music[e])return Ka(Q.assets.music[e],t);let n=Q.audio.ctx,r=t.paused??!1,i=n.createBufferSource(),a=new W,o=n.createGain(),s=n.createStereoPanner(),c=t.seek??0,l=0,u=0,d=!1;i.loop=!!t.loop,i.detune.value=t.detune??0,i.playbackRate.value=t.speed??1,i.connect(s),i.onended=()=>{m()>=(i.buffer?.duration??1/0)&&a.trigger()},s.pan.value=t.pan??0,s.connect(o),o.connect(Q.audio.masterNode),o.gain.value=t.volume??1;let f=e=>{i.buffer=e.buf,r||(l=n.currentTime,i.start(0,c),d=!0)},p=Yr(e);p instanceof dr&&p.onLoad(f);let m=()=>{if(!i.buffer)return 0;let e=r?u-l:n.currentTime-l,t=i.buffer.duration;return i.loop?e%t:Math.min(e,t)},h=e=>{let t=n.createBufferSource();return t.buffer=e.buffer,t.loop=e.loop,t.playbackRate.value=e.playbackRate.value,t.detune.value=e.detune.value,t.onended=e.onended,t.connect(s),t};return{stop(){this.paused=!0,this.seek(0)},set paused(e){if(r!==e)if(r=e,e)d&&=(i.stop(),!1),u=n.currentTime;else{i=h(i);let e=u-l;i.start(0,e),d=!0,l=n.currentTime-e,u=0}},get paused(){return r},play(e=0){this.seek(e),this.paused=!1},seek(e){i.buffer?.duration&&(e>i.buffer.duration||(r?(i=h(i),l=u-e):(i.stop(),i=h(i),l=n.currentTime-e,i.start(0,e),d=!0,u=0)))},set speed(e){i.playbackRate.value=e},get speed(){return i.playbackRate.value},set detune(e){i.detune.value=e},get detune(){return i.detune.value},set volume(e){o.gain.value=Math.max(e,0)},get volume(){return o.gain.value},set pan(e){s.pan.value=e},get pan(){return s.pan.value},set loop(e){i.loop=e},get loop(){return i.loop},duration(){return i.buffer?.duration??0},time(){return m()%this.duration()},onEnd(e){return a.add(e)},then(e){return this.onEnd(e)}}}function Ja(e){return Q.k.play(Q.audio.burpSnd,e)}function Ya(e){Q.audio.masterNode.gain.value=e}function Xa(){return Q.audio.masterNode.gain.value}function Za(e){return Kt(`volume`,`setVolume / getVolume`),e!==void 0&&Ya(e),Xa()}function Qa(){Q.app.onHide(()=>{Q.globalOpt.backgroundAudio||Q.audio.ctx.suspend()}),Q.app.onShow(()=>{!Q.globalOpt.backgroundAudio&&!Q.debug.paused&&Q.audio.ctx.resume()}),Q.app.onResize(()=>{if(Q.app.isFullscreen())return;let e=Q.globalOpt.width&&Q.globalOpt.height;e&&!Q.globalOpt.stretch&&!Q.globalOpt.letterbox||(Q.canvas.width=Q.canvas.offsetWidth*Q.pixelDensity,Q.canvas.height=Q.canvas.offsetHeight*Q.pixelDensity,mn(),e||(Q.gfx.frameBuffer.free(),Q.gfx.frameBuffer=new fi(Q.gfx.ggl,Q.gfx.ggl.gl.drawingBufferWidth,Q.gfx.ggl.gl.drawingBufferHeight),Q.gfx.width=Q.gfx.ggl.gl.drawingBufferWidth/Q.pixelDensity/Q.gscale,Q.gfx.height=Q.gfx.ggl.gl.drawingBufferHeight/Q.pixelDensity/Q.gscale))}),Q.globalOpt.debug!==!1&&(Q.app.onKeyPress(Q.globalOpt.debugKey??`f1`,()=>Q.debug.inspect=!Q.debug.inspect),Q.app.onKeyPress(`f2`,()=>Q.debug.clearLog()),Q.app.onKeyPress(`f8`,()=>Q.debug.paused=!Q.debug.paused),Q.app.onKeyPress(`f7`,()=>{Q.debug.timeScale=qt(n(Q.debug.timeScale-.2,0,2),1)}),Q.app.onKeyPress(`f9`,()=>{Q.debug.timeScale=qt(n(Q.debug.timeScale+.2,0,2),1)}),Q.app.onKeyPress(`f10`,()=>Q.debug.stepFrame())),Q.globalOpt.burp&&Q.app.onKeyPress(`b`,()=>Ja())}function $a(e,t={}){let n=Q.game.root.add([Zo(e),jo()]),r=(t.speed||1)*5,i=t.scale||1;n.add([uo(Q.boomSprite),$o(0),Go(`center`),Eo(r,i),...t.comps??[]]);let a=n.add([uo(Q.kaSprite),$o(0),Go(`center`),No(),...t.comps??[]]);return a.wait(.4/r,()=>a.use(Eo(r,i))),a.onDestroy(()=>n.destroy()),n}function eo(e,t){if(Q.game.layers)throw Error(`Layers can only be assigned once.`);let n=e.indexOf(t);if(n==-1)throw Error(`The default layer name should be present in the layers list.`);Q.game.layers=e,Q.game.defaultLayerIndex=n}function to(){return Q.game.layers}function no(){return Q.game.layers?.[Q.game.defaultLayerIndex]??null}function ro(e,t){Kt(`layers`,`setLayers`),eo(e,t)}function io(e){e.destroy()}function ao(){return Q.game.root}function oo(e,t){Q.game.scenes[e]=t}function so(e,...t){if(!Q.game.scenes[e])throw Error(`Scene not found: ${e}`);Q.game.events.onOnce(`frameEnd`,()=>{Q.game.events.trigger(`sceneLeave`,e),Q.app.events.clear(),Q.game.events.clear(),Q.game.objEvents.clear(),[...Q.game.root.children].forEach(t=>{!t.stay||t.scenesToStay&&!t.scenesToStay.includes(e)?Q.game.root.remove(t):t.trigger(`sceneEnter`,e)}),Q.game.root.clearEvents(),Qa(),Q.game.cam={pos:null,scale:f(1),angle:0,shake:0,transform:new _},Q.game.scenes[e](...t)}),Q.game.currentScene=e}function co(e){return Q.game.events.on(`sceneLeave`,e)}function lo(){return Q.game.currentScene}function uo(e,t={}){let n=null,r=null,i=null,a=new W;if(!e)throw Error(`Please pass the resource name or data to sprite()`);let o=(e,t,n,r)=>{let i=f(1,1);return n&&r?(i.x=n/(e.width*t.w),i.y=r/(e.height*t.h)):n?(i.x=n/(e.width*t.w),i.y=i.x):r&&(i.y=r/(e.height*t.h),i.x=i.y),i},s=(e,r)=>{if(!r)return;let i=r.frames[0].clone();t.quad&&(i=i.scale(t.quad));let s=o(r.tex,i,t.width,t.height);if(e.width=r.tex.width*i.w*s.x,e.height=r.tex.height*i.h*s.y,r.anims)for(let e in r.anims){let t=r.anims[e];typeof t!=`number`&&(t.frames=c(t))}n=r,a.trigger(n),t.anim&&e.play(t.anim)},c=e=>{if(e.frames)return e.frames;let t=[];if(e.from===void 0||e.to===void 0)throw Error(`Sprite anim 'from' and 'to' must be defined if 'frames' is not defined`);let n=Math.abs(e.to-e.from)+1;for(let r=0;r<n;r++)t.push(e.from+r*Math.sign(e.to-e.from));if(e.pingpong)for(let e=n-2;e>0;e--)t.push(t[e]);return t};return{id:`sprite`,width:0,height:0,frame:t.frame||0,quad:t.quad||new p(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(e){let t=Dr(e);t&&t.onLoad(e=>s(this,e))},get animFrame(){if(!n||!r||i===null)return this.frame;let e=n.anims[r.name];return typeof e==`number`?e:e.from===void 0||e.to===void 0?r.frameIndex:this.frame-Math.min(e.from,e.to)},draw(){if(!n)return;let e=n.frames[this.frame??0];if(!e)throw Error(`Frame not found: ${this.frame??0}`);if(n.slice9){let{left:r,right:i,top:a,bottom:o}=n.slice9,s=n.tex.width*e.w,c=n.tex.height*e.h,l=this.width-r-i,u=this.height-a-o,d=r/s,f=i/s,p=1-d-f,h=a/c,g=o/c,_=1-h-g,v=[m(0,0,d,h),m(d,0,p,h),m(d+p,0,f,h),m(0,h,d,_),m(d,h,p,_),m(d+p,h,f,_),m(0,h+_,d,g),m(d,h+_,p,g),m(d+p,h+_,f,g),m(0,0,r,a),m(r,0,l,a),m(r+l,0,i,a),m(0,a,r,u),m(r,a,l,u),m(r+l,a,i,u),m(0,a+u,r,o),m(r,a+u,l,o),m(r+l,a+u,i,o)];for(let r=0;r<9;r++){let i=v[r],a=v[r+9];Mi(Object.assign(Ri(this),{pos:a.pos(),tex:n.tex,quad:e.scale(i),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:a.w,height:a.h}))}}else Mi(Object.assign(Ri(this),{tex:n.tex,quad:e.scale(this.quad??new p(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let t=Dr(e);t?t.onLoad(e=>s(this,e)):ba(()=>s(this,Dr(e).data))},update(){if(!n||!r||i===null)return;let e=n.anims[r.name];if(typeof e==`number`){this.frame=e;return}if(e.speed===0)throw Error(`Sprite anim speed cannot be 0`);if(r.timer+=K()*this.animSpeed,r.timer>=1/r.speed){r.timer=0,r.frameIndex+=i;let t=e.frames;if(r.frameIndex>=t.length)if(r.pingpong&&!e.pingpong)i=-1,r.frameIndex=t.length-2;else if(r.loop)r.frameIndex=0;else{this.frame=t.at(-1),r.onEnd(),this.stop();return}else if(r.frameIndex<0)if(r.pingpong&&r.loop)i=1,r.frameIndex=1;else if(r.loop)r.frameIndex=t.length-1;else{this.frame=t[0],r.onEnd(),this.stop();return}this.frame=t[r.frameIndex]}},play(e,t={}){if(!n){a.add(()=>this.play(e,t));return}let o=n.anims[e];if(o===void 0)throw Error(`Anim not found: ${e}`);r&&this.stop(),r=typeof o==`number`?{name:e,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:e,timer:0,loop:t.loop??o.loop??!1,pingpong:t.pingpong??o.pingpong??!1,speed:t.speed??o.speed??10,frameIndex:0,onEnd:t.onEnd??(()=>{})},i=typeof o==`number`?null:1,this.frame=typeof o==`number`?o:o.frames[0],this.trigger(`animStart`,e)},stop(){if(!r)return;let e=r.name;r=null,this.trigger(`animEnd`,e)},numFrames(){return n?.frames.length??0},getCurAnim(){return r},curAnim(){return r?.name},getAnim(e){return n?.anims[e]??null},hasAnim(e){return!!this.getAnim(e)},onAnimEnd(e){return this.on(`animEnd`,e)},onAnimStart(e){return this.on(`animStart`,e)},renderArea(){return new B(f(0),this.width,this.height)},inspect(){return typeof e==`string`?`sprite: "${e}"`:null}}}function fo(e,t={}){function n(e){let n=yi(Object.assign(Ri(e),{text:e.text+``,size:e.textSize,font:e.font,width:t.width&&e.width,align:e.align,letterSpacing:e.letterSpacing,lineSpacing:e.lineSpacing,transform:e.textTransform,styles:e.textStyles,indentAll:t.indentAll}));return t.width||(e.width=n.width/(e.scale?.x||1)),e.height=n.height/(e.scale?.y||1),n}let r={id:`text`,set text(t){e=t,n(this),this.renderedText=vi(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?vi(e).text:``,add(){ba(()=>n(this))},draw(){xi(n(this))},renderArea(){return new B(f(0),this.width,this.height)}};return n(r),r}function po(e,t){return{id:`rect`,width:e,height:t,draw(){bi(Object.assign(Ri(this),{width:this.width,height:this.height}))},renderArea(){return new B(f(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function mo(e={}){let t=null,n=null,r=null,i=null;return{id:`agent`,require:[`pos`,`tile`],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return n&&r?n[r]:null},getPath(){return n?n.slice():null},getTarget(){return t},isNavigationFinished(){return n?r===null:!0},isTargetReachable(){return n!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(e){t=e,n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),r=n?0:null,n&&r!==null?(i||(i=this.getLevel().onNavigationMapChanged(()=>{t&&n&&r!==null&&(n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),n?(r=0,this.trigger(`navigationNext`,this,n[r])):(r=null,this.trigger(`navigationEnded`,this)))}),this.onDestroy(()=>i?.cancel())),this.trigger(`navigationStarted`,this),this.trigger(`navigationNext`,this,n[r])):this.trigger(`navigationEnded`,this)},update(){if(t&&n&&r!==null){if(this.pos.sdist(n[r])<2)if(r===n.length-1){this.pos=t.clone(),r=null,this.trigger(`navigationEnded`,this),this.trigger(`targetReached`,this);return}else r++,this.trigger(`navigationNext`,this,n[r]);this.moveTo(n[r],this.agentSpeed)}},onNavigationStarted(e){return this.on(`navigationStarted`,e)},onNavigationNext(e){return this.on(`navigationNext`,e)},onNavigationEnded(e){return this.on(`navigationEnded`,e)},onTargetReached(e){return this.on(`targetReached`,e)},inspect(){return`agent: `+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(n)})}}}function ho(e){let t=e.graph;return{id:`pathfinder`,require:[`pos`],navigateTo(t){return this.graph?.getWaypointPath(this.pos,t,e.navigationOpt)},get graph(){if(t)return t;let e=this.parent;for(;e;){if(e.has(`pathfinderMap`))return e.graph;e=e.parent}},set graph(e){t=e}}}function go(e={}){let t=e.waypoints,n=e.speed||100,r=e.endBehavior||`stop`,i=0,a=t!=null;return{id:`patrol`,require:[`pos`],get patrolSpeed(){return n},set patrolSpeed(e){n=e},get waypoints(){return t},set waypoints(e){t=e,i=0,a=!1},get nextLocation(){return t?t[i]:void 0},update(){let e=this.nextLocation;if(!(!t||!e||a)&&(this.moveTo(e,n),this.pos.sdist(e)<9))switch(r){case`loop`:i=(i+1)%t.length;break;case`ping-pong`:i+=1,i==t.length&&(t.reverse(),i=0);break;case`stop`:i<t.length-1?i+=1:a||(a=!0,this.trigger(`patrolFinished`,this));break}},onPatrolFinished(e){return this.on(`patrolFinished`,e)}}}function _o(e,t={}){let n=typeof e==`function`?e:()=>Q.game.root.query(e),r=t.checkFrequency||1,i=typeof t.direction==`number`?d.fromAngle(t.direction):t.direction,a=0;return{id:`sentry`,require:[`pos`],direction:typeof t.direction==`number`?d.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(e){this.direction=e===void 0?void 0:d.fromAngle(e)},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(e,n,r){let a=(typeof n==`number`?d.fromAngle(n):n)||i,o=r||t.fieldOfView;if(!a||!o||o>=360)return!0;let s=o/2;return e.pos&&a.angleBetween(e.pos.sub(this.pos))<=s},hasLineOfSight(e){let n=Yi(this.pos,e.pos.sub(this.pos),t.raycastExclude);return n!=null&&n.object===e},update(){if(a+=K(),a>r){a-=r;let e=n();if(e.length&&i&&this.fieldOfView&&this.fieldOfView<360){let t=this.fieldOfView/2;e=e.filter(e=>e.pos&&i.angleBetween(e.pos.sub(this.pos))<=t)}e.length&&t.lineOfSight&&(e=e.filter(e=>e.pos&&this.hasLineOfSight(e))),e.length>0&&(this.spotted=e,this.trigger(`objectSpotted`,e))}},onObjectsSpotted(e){return this.on(`objectSpotted`,e)}}}function vo(e={}){let t=f(0),n=e.isObstacle??!1,r=e.cost??0,i=e.edges??[],a=()=>{let e={left:1,top:2,right:4,bottom:8};return i.map(t=>e[t]||0).reduce((e,t)=>e|t,0)},o=a();return{id:`tile`,tilePosOffset:e.offset??f(0),set tilePos(e){let n=this.getLevel();t=e.clone(),this.pos=f(this.tilePos.x*n.tileWidth(),this.tilePos.y*n.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(e){n!==e&&(n=e,this.getLevel().invalidateNavigationMap())},get isObstacle(){return n},set cost(e){r!==e&&(r=e,this.getLevel().invalidateNavigationMap())},get cost(){return r},set edges(e){i=e,o=a(),this.getLevel().invalidateNavigationMap()},get edges(){return i},get edgeMask(){return o},getLevel(){return this.parent},tileMove(e){let t=this.getLevel();t.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(e),t.insertIntoSpatialMap(this),t.trigger(`spatialMapChanged`)},moveLeft(){this.tileMove(f(-1,0))},moveRight(){this.tileMove(f(1,0))},moveUp(){this.tileMove(f(0,-1))},moveDown(){this.tileMove(f(0,1))}}}var yo=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,n){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||`forward`,this.easing=t.easing||Gn.linear,this.interpolation=t.interpolation||`linear`,this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=n}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,n){let r=t-1,i=e/this.duration;if(this.loops!==0&&i>=this.loops)return[r,0,!0];let a=Math.trunc(i);if(i-=a,(this.direction==`reverse`||this.direction==`ping-pong`&&a&1)&&(i=1-i),n){let e=0;for(;n[e+1]!==void 0&&n[e+1]<i;)e++;return e>=r?[r,0,!0]:[e,(i-n[e])/(n[e+1]-n[e]),!1]}else{let e=Math.floor((t-1)*i);return[e,(i-e/r)*r,!1]}}setValue(e,t,n){if(this.relative)switch(t){case`pos`:e.pos=e.base.pos.add(n);break;case`angle`:e.angle=e.base.angle+n;break;case`scale`:e.scale=e.base.scale.scale(n);break;case`opacity`:e.opacity=e.base.opacity*n;break;default:e[t]=n}else e[t]=n}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!==`forward`&&(e.direction=this.direction),this.easing!=Gn.linear&&(e.easing=this.easing.name),this.interpolation!==`linear`&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(e=>this.easing.name)),e}};function bo(e,t){return t.add(t.sub(e))}var xo=class extends yo{keys;constructor(e,t,n,r){super(e,n,r),this.keys=t}update(e,t){let[n,r,i]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(r==0||this.interpolation===`none`)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,c(this.keys[n],this.keys[n+1],t(r)))}return i}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},So=class extends yo{keys;curves;dcurves;constructor(e,t,n,r,i){if(super(e,n,r),this.keys=t,this.interpolation===`spline`){this.curves=[],i&&(this.dcurves=[]);for(let e=0;e<this.keys.length-1;e++){let t=this.keys[e],n=e+1,r=this.keys[n],a=e>0?this.keys[e-1]:bo(r,t),o=n<this.keys.length-1?this.keys[n+1]:bo(t,r);this.curves.push(Be(a,t,r,o)),i&&this.dcurves?.push(Be(a,t,r,o,Ue))}}}update(e,t){let[n,r,i]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(r==0||this.interpolation===`none`)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;switch(this.interpolation){case`linear`:this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],t(r)));break;case`slerp`:this.setValue(e,this.name,this.keys[n].slerp(this.keys[n+1],t(r)));break;case`spline`:if(this.curves){this.setValue(e,this.name,this.curves[n](t(r))),this.dcurves&&this.setValue(e,`angle`,this.dcurves[n](t(r)).angle());break}}}return i}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(e=>[e.x,e.y])})}},Co=class extends yo{keys;constructor(e,t,n,r){super(e,n,r),this.keys=t}update(e,t){let[n,r,i]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(r==0||this.interpolation==`none`)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],t(r)))}return i}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function wo(e={}){let t=[],i=0,a=!1;return{id:`animate`,require:e.followMotion?[`rotate`]:void 0,base:{pos:f(0,0),angle:0,scale:f(1,1),opacity:1},animation:{paused:!1,seek(e){i=n(e,0,this.duration),t.forEach(e=>{e.isFinished=!1}),a=!1},get duration(){return t.reduce((e,t)=>Math.max(t.duration,e),0)}},add(){e.relative&&(this.has(`pos`)&&(this.base.pos=this.pos.clone()),this.has(`rotate`)&&(this.base.angle=this.angle),this.has(`scale`)&&(this.base.scale=this.scale),this.has(`opacity`)&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let e=!0,n;i+=K();for(let r of t)n=r.update(this,i),n&&!r.isFinished&&(r.isFinished=!0,this.trigger(`animateChannelFinished`,r.name)),e&&=n;e&&!a&&(a=!0,this.trigger(`animateFinished`))},animate(n,i,o){a=!1,this.unanimate(n),typeof i[0]==`number`?t.push(new xo(n,i,o,e.relative||!1)):i[0]instanceof d?t.push(new So(n,i,o,e.relative||!1,n===`pos`&&(e.followMotion||!1))):i[0]instanceof r&&t.push(new Co(n,i,o,e.relative||!1))},unanimate(e){let n=t.findIndex(t=>t.name===e);n>=0&&t.splice(n,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(e){return this.on(`animateFinished`,e)},onAnimateChannelFinished(e){return this.on(`animateChannelFinished`,e)},serializeAnimationChannels(){return t.reduce((e,t)=>(e[t.name]=t.serialize(),e),{})},serializeAnimationOptions(){let t={};return e.followMotion&&(t.followMotion=!0),e.relative&&(t.relative=!0),t}}}function To(e,t){let n={name:e.name};return e.has(`animate`)&&(n.channels=e.serializeAnimationChannels(),Object.assign(n,e.serializeAnimationOptions())),e.children.length>0&&(n.children=e.children.filter(e=>e.has(`named`)).map(e=>To(e,e.name))),n}function Eo(e=2,t=1){let n=0;return{require:[`scale`],update(){let r=Math.sin(n*e)*t;r<0&&this.destroy(),this.scale=f(r),n+=K()}}}function Do(e,t){if(e==null)throw Error(`health() requires the initial amount of hp`);return{id:`health`,hurt(t=1){this.setHP(e-t),this.trigger(`hurt`,t)},heal(t=1){let n=e;this.setHP(e+t),this.trigger(`heal`,e-n)},hp(){return e},maxHP(){return t??null},setMaxHP(e){t=e},setHP(n){e=t?Math.min(t,n):n,e<=0&&this.trigger(`death`)},onHurt(e){return this.on(`hurt`,e)},onHeal(e){return this.on(`heal`,e)},onDeath(e){return this.on(`death`,e)},inspect(){return`health: ${e}`}}}function Oo(e,t={}){if(e==null)throw Error(`lifespan() requires time`);let n=t.fade??0;return{id:`lifespan`,require:[`opacity`],add(){Q.game.root.wait(e,()=>{this.opacity=this.opacity??1,n>0?Q.game.root.tween(this.opacity,0,n,e=>this.opacity=e,Gn.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function ko(e){return{id:`named`,name:e}}function Ao(e,t,n){if(!e)throw Error(`state() requires an initial state`);let r={};function i(e){r[e]||(r[e]={enter:new W,end:new W,update:new W,draw:new W})}function a(e,t,n){return i(t),r[t][e].add(n)}function o(e,t,...n){i(t),r[t][e].trigger(...n)}let s=!1;return{id:`state`,state:e,enterState(e,...r){if(s=!0,t&&!t.includes(e))throw Error(`State not found: ${e}`);let i=this.state;if(n){if(!n?.[i])return;let t=typeof n[i]==`string`?[n[i]]:n[i];if(!t.includes(e))throw Error(`Cannot transition state from "${i}" to "${e}". Available transitions: ${t.map(e=>`"${e}"`).join(`, `)}`)}o(`end`,i,...r),this.state=e,o(`enter`,e,...r),o(`enter`,`${i} -> ${e}`,...r)},onStateTransition(e,t,n){return a(`enter`,`${e} -> ${t}`,n)},onStateEnter(e,t){return a(`enter`,e,t)},onStateUpdate(e,t){return a(`update`,e,t)},onStateDraw(e,t){return a(`draw`,e,t)},onStateEnd(e,t){return a(`end`,e,t)},update(){s||=(o(`enter`,e),!0),o(`update`,this.state)},draw(){o(`draw`,this.state)},inspect(){return`state: ${this.state}`}}}function jo(e){return{id:`stay`,stay:!0,scenesToStay:e}}function Mo(e=!0,t){let n,r;return{id:`textInput`,hasFocus:e,require:[`text`],typedText:``,add(){let e=()=>{this.text=this.typedText.replace(/([\[\\])/g,`\\$1`)};n=Q.k.onCharInput(n=>{this.hasFocus&&(!t||this.typedText.length<t)&&(Q.k.isKeyDown(`shift`)?this.typedText+=n.toUpperCase():this.typedText+=n,e())}),r=Q.k.onKeyPressRepeat(`backspace`,()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),e())})},destroy(){n.cancel(),r.cancel()}}}function No(e=1e3){return{id:`timer`,maxLoopsPerFrame:e,loop(e,t,n=1/0,r=!1){let i=r?0:e,a=new W,o=this.onUpdate(()=>{i+=Q.app.state.dt;for(let r=0;i>=e&&r<this.maxLoopsPerFrame;r++)if(n--,t(),i-=e,n<=0){o.cancel(),a.trigger();return}});return{get paused(){return o.paused},set paused(e){o.paused=e},cancel:o.cancel,onEnd(e){a.add(e)},then(e){return a.add(e),this}}},wait(e,t){return this.loop(e,t??(()=>{}),1,!0)},tween(e,t,n,r,i=Gn.linear){let a=0,o=[],s=this.onUpdate(()=>{a+=Q.app.state.dt;let l=Math.min(a/n,1);r(c(e,t,i(l))),l===1&&(s.cancel(),r(t),o.forEach(e=>e()))});return{get paused(){return s.paused},set paused(e){s.paused=e},onEnd(e){o.push(e)},then(e){return this.onEnd(e),this},cancel(){s.cancel()},finish(){s.cancel(),r(t),o.forEach(e=>e())}}}}}var Po=0;function Fo(){return Po>0}function Io(e={}){let t={},n=new Set,r=[];return{id:`area`,collisionIgnore:e.collisionIgnore??[],add(){Po++,this.area.cursor&&r.push(this.onHover(()=>Q.app.setCursor(this.area.cursor))),r.push(this.onCollideUpdate((e,r)=>{if(!e.id)throw Error(`area() requires the object to have an id`);t[e.id]||this.trigger(`collide`,e,r),r&&(t[e.id]=r,n.add(e.id))}))},destroy(){Po--;for(let e of r)e.cancel()},fixedUpdate(){for(let e in t)n.has(Number(e))||(this.trigger(`collideEnd`,t[e].target),delete t[e]);n.clear()},drawInspect(){let e=this.localArea();nr(),q(this.area.offset);let t={outline:{width:4/sr(),color:i(0,0,255)},anchor:this.anchor,fill:!1,fixed:Li(this)};e instanceof B?Si({...t,pos:e.pos,width:e.width*this.area.scale.x,height:e.height*this.area.scale.y}):e instanceof H?ti({...t,pts:e.pts,scale:this.area.scale}):e instanceof V&&ri({...t,pos:e.center,radius:e.radius}),J()},area:{shape:e.shape??null,scale:e.scale?f(e.scale):f(1),offset:e.offset??f(0),cursor:e.cursor??null},isClicked(){return Q.app.isMousePressed()&&this.isHovering()},isHovering(){let e=Li(this)?Q.k.mousePos():Q.k.toWorld(Q.k.mousePos());return this.hasPoint(e)},checkCollision(e){if(!e.id)throw Error(`checkCollision() requires the object to have an id`);return t[e.id]??null},getCollisions(){return Object.values(t)},isColliding(e){if(!e.id)throw Error(`isColliding() requires the object to have an id`);return!!t[e.id]},isOverlapping(e){if(!e.id)throw Error(`isOverlapping() requires the object to have an id`);let n=t[e.id];return n&&n.hasOverlap()},onClick(e,t=`left`){let n=this.onMousePress(t,()=>{this.isHovering()&&e()});return r.push(n),n},onHover(e){let t=!1;return this.onUpdate(()=>{t?t=this.isHovering():this.isHovering()&&(t=!0,e())})},onHoverUpdate(e){return this.onUpdate(()=>{this.isHovering()&&e()})},onHoverEnd(e){let t=!1;return this.onUpdate(()=>{t?this.isHovering()||(t=!1,e()):t=this.isHovering()})},onCollide(e,t){if(typeof e==`function`&&t===void 0)return this.on(`collide`,e);if(typeof e==`string`)return this.onCollide((n,r)=>{n.is(e)&&t?.(n,r)});throw Error(`onCollide() requires either a function or a tag`)},onCollideUpdate(e,t){if(typeof e==`function`&&t===void 0)return this.on(`collideUpdate`,e);if(typeof e==`string`)return this.on(`collideUpdate`,(n,r)=>n.is(e)&&t?.(n,r));throw Error(`onCollideUpdate() requires either a function or a tag`)},onCollideEnd(e,t){if(typeof e==`function`&&t===void 0)return this.on(`collideEnd`,e);if(typeof e==`string`)return this.on(`collideEnd`,n=>n.is(e)&&t?.(n));throw Error(`onCollideEnd() requires either a function or a tag`)},hasPoint(e){return L(this.worldArea(),e)},resolveCollision(e){let t=this.checkCollision(e);t&&!t.resolved&&(this.pos=this.pos.add(t.displacement),t.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let e=this.localArea();if(!(e instanceof H||e instanceof B))throw Error(`Only support polygon and rect shapes for now`);let t=this.transform.clone().translate(this.area.offset).scale(f(this.area.scale??1));if(e instanceof B){let n=Ln(this.anchor||ct).add(1,1).scale(-.5).scale(e.width,e.height);t.translate(n)}return e.transform(t)},screenArea(){let e=this.worldArea();return Li(this)?e:e.transform(Q.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function Lo(e={}){let t=null,n=null,r=!1,i=f(0),a=null,o=null,s;return{id:`body`,require:[`pos`],vel:f(0),drag:e.drag??0,jumpForce:e.jumpForce??wt,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),o=this.pos.clone(),s=this.pos.clone(),this.mass===0)throw Error(`Can't set body mass to 0`);this.has(`area`)&&(this.onCollideUpdate((e,t)=>{if(!t||!e.has(`body`)||t.resolved)return;this.trigger(`beforePhysicsResolve`,t);let n=t.reverse();if(e.trigger(`beforePhysicsResolve`,n),!(t.resolved||n.resolved)&&!(this.isStatic&&e.isStatic)){if(!this.isStatic&&!e.isStatic){let n=this.mass+e.mass;this.pos=this.pos.add(t.displacement.scale(e.mass/n)),e.pos=e.pos.add(t.displacement.scale(-this.mass/n)),this.transform=Zn(this),e.transform=Zn(e)}else{let n=!this.isStatic&&e.isStatic?t:t.reverse();n.source.pos=n.source.pos.add(n.displacement),n.source.transform=Zn(n.source)}t.resolved=!0,this.trigger(`physicsResolve`,t),e.trigger(`physicsResolve`,t.reverse())}}),this.onPhysicsResolve(e=>{if(Q.game.gravity)if(e.isBottom()&&this.isFalling()){this.vel=this.vel.reject(Q.game.gravity.unit());let i=t;t=e.target,i!=t&&(n=e.target.pos),r?r=!1:i||(this.trigger(`ground`,t),e.target.trigger(`land`,this))}else e.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(Q.game.gravity.unit()),this.trigger(`headbutt`,e.target),e.target.trigger(`headbutted`,this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has(`body`)&&(n&&!t.pos.eq(n)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(n)),n=t.pos);let r=Dn();r&&(this.pos.x==s.x&&(this.pos.x=c(a.x,o.x,r/En()),s.x=this.pos.x),this.pos.y==s.y&&(this.pos.y=c(a.y,o.y,r/En()),s.y=this.pos.y))},fixedUpdate(){if(a&&=(this.pos.x==s.x&&(this.pos.x=a.x),this.pos.y==s.y&&(this.pos.y=a.y),null),Q.game.gravity&&!this.isStatic){r&&=(t=null,n=null,this.trigger(`fallOff`),!1),t&&(!this.isColliding(t)||!t.exists()||!t.has(`body`))&&(r=!0);let i=this.vel.clone();this.vel=this.vel.add(Q.game.gravity.scale(this.gravityScale*K()));let a=e.maxVelocity??Tt;this.vel.slen()>a*a&&(this.vel=this.vel.unit().scale(a)),i.dot(Q.game.gravity)<0&&this.vel.dot(Q.game.gravity)>=0&&this.trigger(`fall`)}if(this.vel.x+=i.x*K(),this.vel.y+=i.y*K(),this.vel.x*=1-this.drag*K(),this.vel.y*=1-this.drag*K(),this.move(this.vel),Dn()){a=this.pos.clone();let e=this.vel.add(i.scale(K()));o=this.pos.add(e.scale(K())),s=this.pos.clone()}i.x=0,i.y=0},onPhysicsResolve(e){return this.on(`physicsResolve`,e)},onBeforePhysicsResolve(e){return this.on(`beforePhysicsResolve`,e)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(Ua())>0},isJumping(){return this.vel.dot(Ua())<0},applyImpulse(e){this.isStatic||(this.vel=this.vel.add(e))},addForce(e){this.isStatic||(i.x+=e.x/this.mass,i.y+=e.y/this.mass)},jump(e){this.isStatic||(t=null,n=null,this.vel=Ua().scale(-e||-this.jumpForce))},onGround(e){return this.on(`ground`,e)},onFall(e){return this.on(`fall`,e)},onFallOff(e){return this.on(`fallOff`,e)},onHeadbutt(e){return this.on(`headbutt`,e)},onLand(e){return this.on(`land`,e)},onHeadbutted(e){return this.on(`headbutted`,e)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function Ro(e=2){let t=e;return{id:`doubleJump`,require:[`body`],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(e){t<=0||(t<this.numJumps&&this.trigger(`doubleJump`),t--,this.jump(e))},onDoubleJump(e){return this.on(`doubleJump`,e)},inspect(){return`jumpsLeft: ${t}`}}}function zo(e){return{id:`surfaceEffector`,require:[`area`],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate(`body`,(e,t)=>{let n=t?.normal.normal(),r=e.vel.project(n),i=n?.scale(this.speed)?.sub(r);e.addForce(i?.scale(e.mass*this.forceScale))})}}}function Bo(e){return{id:`areaEffector`,require:[`area`],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate(`body`,(e,t)=>{if(!e.has(`body`))return;let n=d.fromAngle(this.forceAngle).scale(this.forceMagnitude);e.addForce(n),this.linearDrag&&e.addForce(e.vel.scale(-this.linearDrag))})}}}function Vo(e){return{id:`pointEffector`,require:[`area`,`pos`],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||`inverseLinear`,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate(`body`,(e,t)=>{let n=this.pos.sub(e.pos),r=n.len(),i=r*this.distanceScale/10,a=this.forceMode===`constant`?1:this.forceMode===`inverseLinear`?1/i:1/i**2,o=n.scale(this.forceMagnitude*a/r);e.addForce(o),this.linearDrag&&e.addForce(e.vel.scale(-this.linearDrag))})}}}function Ho(e){return{id:`constantForce`,require:[`body`],force:e.force,update(){this.force&&this.addForce(this.force)}}}function Uo(e){return{id:`platformEffector`,require:[`area`,`body`],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(e=>{let t=e.target.vel,n=Ua().scale(-1).angleBetween(t);Math.abs(n)>this.surfaceArc/2&&e.preventResolution()})}}}function Wo(e){return{id:`buoyancyEffector`,require:[`area`],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate(`body`,(e,t)=>{let n=e,[r,i]=n.worldArea().cut(f(-100,this.surfaceLevel),f(100,this.surfaceLevel));r&&(this.applyBuoyancy(n,r),this.applyDrag(n,r)),this.flowMagnitude&&n.addForce(d.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(e,t){let n=this.density*t.area(),r=f(0,1).scale(-n);e.addForce(r)},applyDrag(e,t){let n=e.vel,r=this.density*this.linearDrag,i=n.scale(-r);e.addForce(i)}}}function Go(e){if(!e)throw Error(`Please define an anchor`);return{id:`anchor`,anchor:e,inspect(){return typeof this.anchor==`string`?`anchor: `+this.anchor:`anchor: `+this.anchor.toString()}}}function Ko(){return{id:`fixed`,fixed:!0}}function qo(e,t){return{id:`follow`,require:[`pos`],follow:{obj:e,offset:t??f(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function Jo(e){let t=Q.game.layers?.indexOf(e);return{id:`layer`,get layerIndex(){return t??null},get layer(){return t?Q.game.layers?.[t]??null:null},set layer(e){if(t=Q.game.layers?.indexOf(e),t==-1)throw Error(`Invalid layer name`)},inspect(){return`layer: ${this.layer}`}}}function Yo(e,t){let n=typeof e==`number`?d.fromAngle(e):e.unit();return{id:`move`,require:[`pos`],update(){this.move(n.scale(t))}}}function Xo(e={}){let t=!1,n=new B(f(0),Y(),X()),r=new B(f(0),0,0),i=n=>{n.isOffScreen()?(t||=(n.trigger(`exitView`),!0),e.hide&&(n.hidden=!0),e.pause&&(n.paused=!0),e.destroy&&n.destroy()):(t&&=(n.trigger(`enterView`),!1),e.hide&&(n.hidden=!1),e.pause&&(n.paused=!1))};return{id:`offscreen`,require:[`pos`],offscreenDistance:e.distance??Ct,isOffScreen(){let e=this.screenPos();if(!e)return!1;if(n.width=Y(),n.height=X(),!this.offscreenDistance&&this.width&&this.height)return r.width=this.width,r.height=this.height,r.pos=this.pos,r.collides(n);let t=this.offscreenDistance?this.offscreenDistance:Ct;return!j(n,e)&&n.sdistToPoint(e)>t*t},onExitScreen(e){return this.on(`exitView`,e)},onEnterScreen(e){return this.on(`enterView`,e)},add(){e.pause&&e.unpause?ta(()=>i(this)):this.onUpdate(()=>i(this))}}}function Zo(...e){return{id:`pos`,pos:f(...e),moveBy(...e){this.pos=this.pos.add(f(...e))},move(...e){this.moveBy(f(...e).scale(K()))},moveTo(...e){if(typeof e[0]==`number`&&typeof e[1]==`number`)return this.moveTo(f(e[0],e[1]),e[2]);let t=e[0],n=e[1];if(n===void 0){this.pos=f(t);return}let r=t.sub(this.pos);if(r.len()<=n*K()){this.pos=f(t);return}this.move(r.unit().scale(n))},worldPos(e=null){return e?(this.pos=this.pos.add(this.fromWorld(e)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(e){return this.parent?this.parent.transform.multVec2(this.pos.add(e)):this.pos.add(e)},fromWorld(e){return this.parent?this.parent.transform.invert().multVec2(e).sub(this.pos):e.sub(this.pos)},screenPos(e=null){if(e)return this.pos=this.pos.add(this.fromScreen(e)),null;{let e=this.worldPos();return e?Li(this)?e:Ma(e):null}},toScreen(e){let t=this.toWorld(e);return Li(this)?t:Ma(t)},fromScreen(e){return Li(this)?this.fromWorld(e):this.fromWorld(Na(e))},toOther(e,t){return e.fromWorld(this.toWorld(t))},fromOther(e,t){return e.toOther(this,t)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){ri({color:i(255,0,0),radius:4/sr()})}}}function Qo(e){return{id:`rotate`,angle:e??0,rotateBy(e){this.angle+=e},rotateTo(e){this.angle=e},inspect(){return`angle: ${Math.round(this.angle)}`}}}function $o(...e){if(e.length===0)return $o(1);let t=f(...e);return{id:`scale`,set scale(e){if(!(e instanceof d))throw Error(`The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.`);t=f(e)},get scale(){return t},scaleTo(...e){t=f(...e)},scaleBy(...e){t=t.scale(f(...e))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function es(e){return{id:`z`,z:e,inspect(){return`z: ${this.z}`}}}var ts=`data:image/png;base64,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`,ns=`data:image/png;base64,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`,rs=t.version,Q={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},os=(e={tagsAsComponents:!0})=>{Q.k&&(console.warn(`KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!`),Q.k.quit()),Q.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width=`100%`,document.body.style.height=`100%`,document.body.style.margin=`0px`,document.documentElement.style.width=`100%`,document.documentElement.style.height=`100%`);let h=e.canvas??t.appendChild(document.createElement(`canvas`));Q.canvas=h;let g=e.scale??1;Q.gscale=g;let y=e.width&&e.height&&!e.stretch&&!e.letterbox;y?(h.width=e.width*g,h.height=e.height*g):(h.width=h.parentElement.offsetWidth,h.height=h.parentElement.offsetHeight);let b=[`outline: none`,`cursor: default`];if(y){let e=h.width,t=h.height;b.push(`width: ${e}px`),b.push(`height: ${t}px`)}else b.push(`width: 100%`),b.push(`height: 100%`);e.crisp&&(b.push(`image-rendering: pixelated`),b.push(`image-rendering: crisp-edges`)),h.style.cssText=b.join(`;`);let x=e.pixelDensity||1;Q.pixelDensity=x,h.width*=x,h.height*=x,h.tabIndex=0;let C=document.createElement(`canvas`);C.width=256,C.height=256,Q.fontCacheCanvas=C,Q.fontCacheC2d=C.getContext(`2d`,{willReadFrequently:!0});let k=Tn({canvas:h,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});Q.app=k;let ie=[],M=k.canvas.getContext(`webgl`,{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!M)throw Error(`WebGL not supported`);let F=M,ae=hi(F,{texFilter:e.texFilter}),I=Ii(e,ae);Q.gfx=I;let se=Ga();Q.audio=se;let L=wr(ae,e.spriteAtlasPadding??0);Q.assets=L;let R=za();Q.game=R,R.root.use(No());function ce(e,t){let n=new fi(ae,e,t);return{clear:()=>n.clear(),free:()=>n.free(),toDataURL:()=>n.toDataURL(),toImageData:()=>n.toImageData(),width:n.width,height:n.height,draw:e=>{or(),n.bind(),e(),or(),n.unbind()},get fb(){return n}}}function le(){F.clear(F.COLOR_BUFFER_BIT),I.frameBuffer.bind(),F.clear(F.COLOR_BUFFER_BIT),I.bgColor||Ci(()=>{bi({width:Y(),height:X(),quad:new p(0,0,Y()/64,X()/64),tex:I.bgTex,fixed:!0})}),I.renderer.numDraws=0,I.fixed=!1,I.transformStack.length=0,I.transform=new _}function ue(e,t){I.postShader=e,I.postShaderUniform=t??null}function de(){or(),I.lastDrawCalls=I.renderer.numDraws,I.frameBuffer.unbind(),F.viewport(0,0,F.drawingBufferWidth,F.drawingBufferHeight);let e=I.width,t=I.height;I.width=F.drawingBufferWidth/x,I.height=F.drawingBufferHeight/x,Mi({flipY:!0,tex:I.frameBuffer.tex,pos:new d(I.viewport.x,I.viewport.y),width:I.viewport.width,height:I.viewport.height,shader:I.postShader,uniform:typeof I.postShaderUniform==`function`?I.postShaderUniform():I.postShaderUniform,fixed:!0}),or(),I.width=e,I.height=t}let fe=!1,pe={inspect:!1,set timeScale(e){Q.app.state.timeScale=e},get timeScale(){return Q.app.state.timeScale},showLog:!0,fps:()=>k.fps(),numFrames:()=>k.numFrames(),stepFrame:Ke,drawCalls:()=>I.lastDrawCalls,clearLog:()=>R.logs=[],log:(...t)=>{let n=e.logMax??8,r=t.length>1?t.concat(` `).join(` `):t[0];R.logs.unshift({msg:r,time:k.time()}),R.logs.length>n&&(R.logs=R.logs.slice(0,n))},error:e=>pe.log(Error(e.toString?e.toString():e)),curRecording:null,numObjects:()=>Se(`*`,{recursive:!0}).length,get paused(){return fe},set paused(e){fe=e,e?se.ctx.suspend():se.ctx.resume()}};Q.debug=pe;function me(e,t){try{return JSON.parse(window.localStorage[e])}catch{return t?(he(e,t),t):null}}function he(e,t){window.localStorage[e]=JSON.stringify(t)}function ge(t,...n){let r=t(rt),i;for(let t in i=typeof r==`function`?r(...n)(rt):r,i)rt[t]=i[t],e.global!==!1&&(window[t]=i[t]);return rt}function _e(e){let t=k.canvas.captureStream(e),n=se.ctx.createMediaStreamDestination();se.masterNode.connect(n);let r=new MediaRecorder(t),i=[];return r.ondataavailable=e=>{e.data.size>0&&i.push(e.data)},r.onerror=()=>{se.masterNode.disconnect(n),t.getTracks().forEach(e=>e.stop())},r.start(),{resume(){r.resume()},pause(){r.pause()},stop(){return r.stop(),se.masterNode.disconnect(n),t.getTracks().forEach(e=>e.stop()),new Promise(e=>{r.onstop=()=>{e(new Blob(i,{type:`video/mp4`}))}})},download(e=`kaboom.mp4`){this.stop().then(t=>zt(e,t))}}}function ve(){return document.activeElement===k.canvas}let ye=R.root.add.bind(R.root),be=R.root.readd.bind(R.root),xe=R.root.removeAll.bind(R.root),Se=R.root.get.bind(R.root),Ce=R.root.wait.bind(R.root),we=R.root.loop.bind(R.root),Te=R.root.query.bind(R.root),Oe=R.root.tween.bind(R.root),Ue=kr(null,ns),We=kr(null,ts);Q.kaSprite=Ue,Q.boomSprite=We;function Ge(){R.root.fixedUpdate()}function Ke(){R.root.update()}class qe{source;target;normal;distance;resolved=!1;constructor(e,t,n,r,i=!1){this.source=e,this.target=t,this.normal=n,this.distance=r,this.resolved=i}get displacement(){return this.normal.scale(this.distance)}reverse(){return new qe(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(R.gravity||f(0,1))>0}isRight(){return this.displacement.cross(R.gravity||f(0,1))<0}isTop(){return this.displacement.dot(R.gravity||f(0,1))>0}isBottom(){return this.displacement.dot(R.gravity||f(0,1))<0}preventResolution(){this.resolved=!0}}function Je(){if(!Fo())return;let t={},n=e.hashGridSize||64,r=new _,i=[];function a(e){if(i.push(r.clone()),e.pos&&r.translate(e.pos),e.scale&&r.scale(e.scale),e.angle&&r.rotate(e.angle),e.transform=r.clone(),e.c(`area`)&&!e.paused){let r=e,i=r.worldArea().bbox(),a=Math.floor(i.pos.x/n),o=Math.floor(i.pos.y/n),s=Math.ceil((i.pos.x+i.width)/n),c=Math.ceil((i.pos.y+i.height)/n),l=new Set;for(let e=a;e<=s;e++)for(let n=o;n<=c;n++)if(!t[e])t[e]={},t[e][n]=[r];else if(!t[e][n])t[e][n]=[r];else{let i=t[e][n];e:for(let e of i){if(e.paused||!e.exists()||l.has(e.id))continue;for(let t of r.collisionIgnore)if(e.is(t))continue e;for(let t of e.collisionIgnore)if(r.is(t))continue e;let t=Qe(r.worldArea(),e.worldArea());if(t){let n=new qe(r,e,t.normal,t.distance);r.trigger(`collideUpdate`,e,n);let i=n.reverse();i.resolved=n.resolved,e.trigger(`collideUpdate`,r,i)}l.add(e.id)}i.push(r)}}e.children.forEach(a),r=i.pop()}a(R.root)}function $e(e){console.error(e),se.ctx.suspend();let t=e.message??String(e)??`Unknown error, check console for more info`;k.run(()=>{},()=>{le(),Ci(()=>{let n=Y(),r=X(),a={size:36,width:n-64,letterSpacing:4,lineSpacing:4,font:ut,fixed:!0};Si({width:n,height:r,color:i(0,0,255),fixed:!0});let o=yi({...a,text:`Error`,pos:f(32),color:i(255,128,0),fixed:!0});xi(o),Fi({...a,text:t,pos:f(32,32+o.height+16),fixed:!0}),J(),R.events.trigger(`error`,e)}),de()})}function et(e){ie.push(e)}function tt(){R.events.onOnce(`frameEnd`,()=>{k.quit(),F.clear(F.COLOR_BUFFER_BIT|F.DEPTH_BUFFER_BIT|F.STENCIL_BUFFER_BIT);let e=F.getParameter(F.MAX_TEXTURE_IMAGE_UNITS);for(let t=0;t<e;t++)F.activeTexture(F.TEXTURE0+t),F.bindTexture(F.TEXTURE_2D,null),F.bindTexture(F.TEXTURE_CUBE_MAP,null);F.bindBuffer(F.ARRAY_BUFFER,null),F.bindBuffer(F.ELEMENT_ARRAY_BUFFER,null),F.bindRenderbuffer(F.RENDERBUFFER,null),F.bindFramebuffer(F.FRAMEBUFFER,null),ae.destroy(),ie.forEach(e=>e())})}let nt=!0;k.run(()=>{try{L.loaded&&(pe.paused||Ge(),Je())}catch(e){$e(e)}},(t,n)=>{try{t(),L.loaded||br()===1&&!nt&&(L.loaded=!0,xr().forEach(e=>R.events.trigger(`loadError`,...e)),R.events.trigger(`load`)),!L.loaded&&e.loadingScreen!==!1||nt?(le(),ki(),de()):(pe.paused||Ke(),Je(),le(),Oi(),e.debug!==!1&&Ei(),de()),nt&&=!1,R.events.trigger(`frameEnd`),n()}catch(e){$e(e)}}),mn(),Qa();let rt={_k:Q,VERSION:rs,loadRoot:_r,loadProgress:br,loadSprite:kr,loadSpriteAtlas:$r,loadSound:Zr,loadMusic:Qr,loadBitmapFont:Br,loadFont:Lr,loadShader:Kr,loadShaderURL:qr,loadAseprite:Nr,loadPedit:Vr,loadBean:Mr,loadJSON:vr,load:Cr,getSound:Xr,getFont:Ir,getBitmapFont:zr,getSprite:Or,getShader:Gr,getAsset:Sr,Asset:dr,SpriteData:Er,SoundData:Jr,width:Y,height:X,center:cr,dt:K,fixedDt:En,restDt:Dn,time:k.time,screenshot:k.screenshot,record:_e,isFocused:ve,setCursor:k.setCursor,getCursor:k.getCursor,setCursorLocked:k.setCursorLocked,isCursorLocked:k.isCursorLocked,setFullscreen:k.setFullscreen,isFullscreen:k.isFullscreen,isTouchscreen:k.isTouchscreen,onLoad:ba,onLoadError:xa,onLoading:_a,onResize:va,onGamepadConnect:k.onGamepadConnect,onGamepadDisconnect:k.onGamepadDisconnect,onError:ya,onCleanup:et,flash:ka,setCamPos:Sa,getCamPos:Ca,setCamRot:Ea,getCamRot:Da,setCamScale:wa,getCamScale:Ta,getCamTransform:Oa,camPos:Pa,camScale:Fa,camFlash:La,camRot:Ia,camTransform:Aa,shake:ja,toScreen:Ma,toWorld:Na,setGravity:Ba,getGravity:Va,setGravityDirection:Ha,getGravityDirection:Ua,setBackground:er,getBackground:tr,getGamepads:k.getGamepads,getTreeRoot:ao,add:ye,make:Ra,destroy:io,destroyAll:xe,get:Se,query:Te,readd:be,pos:Zo,scale:$o,rotate:Qo,color:Bi,opacity:Wi,anchor:Go,area:Io,sprite:uo,text:fo,polygon:Ji,rect:Xi,circle:zi,uvquad:po,outline:Gi,particles:qi,body:Lo,platformEffector:Uo,surfaceEffector:zo,areaEffector:Bo,pointEffector:Vo,buoyancyEffector:Wo,constantForce:Ho,doubleJump:Ro,shader:Zi,textInput:Mo,timer:No,fixed:Ko,stay:jo,health:Do,lifespan:Oo,named:ko,state:Ao,z:es,layer:Jo,move:Yo,offscreen:Xo,follow:qo,fadeIn:Hi,mask:Ui,drawon:Vi,raycast:Yi,tile:vo,animate:wo,serializeAnimation:To,agent:mo,sentry:_o,patrol:go,pathfinder:ho,trigger:$i,on:Z,onFixedUpdate:ea,onUpdate:ta,onDraw:na,onAdd:ra,onDestroy:ia,onTag:sa,onUntag:ca,onUse:aa,onUnuse:oa,onClick:pa,onCollide:la,onCollideUpdate:ua,onCollideEnd:da,onHover:ma,onHoverUpdate:ha,onHoverEnd:ga,onKeyDown:k.onKeyDown,onKeyPress:k.onKeyPress,onKeyPressRepeat:k.onKeyPressRepeat,onKeyRelease:k.onKeyRelease,onMouseDown:k.onMouseDown,onMousePress:k.onMousePress,onMouseRelease:k.onMouseRelease,onMouseMove:k.onMouseMove,onCharInput:k.onCharInput,onTouchStart:k.onTouchStart,onTouchMove:k.onTouchMove,onTouchEnd:k.onTouchEnd,onScroll:k.onScroll,onHide:k.onHide,onShow:k.onShow,onGamepadButtonDown:k.onGamepadButtonDown,onGamepadButtonPress:k.onGamepadButtonPress,onGamepadButtonRelease:k.onGamepadButtonRelease,onGamepadStick:k.onGamepadStick,onButtonPress:k.onButtonPress,onButtonDown:k.onButtonDown,onButtonRelease:k.onButtonRelease,mousePos:k.mousePos,mouseDeltaPos:k.mouseDeltaPos,isKeyDown:k.isKeyDown,isKeyPressed:k.isKeyPressed,isKeyPressedRepeat:k.isKeyPressedRepeat,isKeyReleased:k.isKeyReleased,isMouseDown:k.isMouseDown,isMousePressed:k.isMousePressed,isMouseReleased:k.isMouseReleased,isMouseMoved:k.isMouseMoved,isGamepadButtonPressed:k.isGamepadButtonPressed,isGamepadButtonDown:k.isGamepadButtonDown,isGamepadButtonReleased:k.isGamepadButtonReleased,getGamepadStick:k.getGamepadStick,isButtonPressed:k.isButtonPressed,isButtonDown:k.isButtonDown,isButtonReleased:k.isButtonReleased,setButton:k.setButton,getButton:k.getButton,pressButton:k.pressButton,releaseButton:k.releaseButton,getLastInputDeviceType:k.getLastInputDeviceType,charInputted:k.charInputted,loop:we,wait:Ce,play:qa,setVolume:Ya,getVolume:Xa,volume:Za,burp:Ja,audioCtx:se.ctx,Line:z,Rect:B,Circle:V,Ellipse:De,Point:Ee,Polygon:H,Vec2:d,Color:r,Mat4:_,Quad:p,RNG:S,rand:T,randi:E,randSeed:w,vec2:f,rgb:i,hsl2rgb:a,quad:m,choose:te,chooseMultiple:ee,shuffle:O,chance:D,lerp:c,tween:Oe,easings:Gn,map:l,mapc:u,wave:v,deg2rad:o,rad2deg:s,clamp:n,evaluateQuadratic:ke,evaluateQuadraticFirstDerivative:Ae,evaluateQuadraticSecondDerivative:je,evaluateBezier:Me,evaluateBezierFirstDerivative:Ne,evaluateBezierSecondDerivative:U,evaluateCatmullRom:Pe,evaluateCatmullRomFirstDerivative:Fe,curveLengthApproximation:Le,normalizedCurve:Ie,hermite:Re,cardinal:ze,catmullRom:Be,bezier:Ve,kochanekBartels:He,easingSteps:Ze,easingLinear:Ye,easingCubicBezier:Xe,testLineLine:re,testRectRect:ne,testRectLine:A,testRectPoint:j,testCirclePolygon:oe,testLinePoint:N,testLineCircle:P,isConvex:ot,triangulate:at,NavMesh:Xn,drawSprite:Ni,drawText:Fi,formatText:yi,drawRect:Si,drawLine:ii,drawLines:ci,drawTriangle:Ti,drawCircle:ri,drawEllipse:ni,drawUVQuad:bi,drawPolygon:ti,drawCurve:li,drawBezier:ui,drawFormattedText:xi,drawMasked:ji,drawSubtracted:Pi,pushTransform:nr,popTransform:J,pushTranslate:q,pushScale:ir,pushRotate:ar,pushMatrix:rr,usePostEffect:ue,makeCanvas:ce,debug:pe,scene:oo,getSceneName:lo,go:so,onSceneLeave:co,layers:ro,getLayers:to,setLayers:eo,getDefaultLayer:no,addLevel:Qi,getData:me,setData:he,download:It,downloadJSON:Rt,downloadText:Lt,downloadBlob:zt,plug:ge,ASCII_CHARS:st,canvas:k.canvas,addKaboom:$a,LEFT:d.LEFT,RIGHT:d.RIGHT,UP:d.UP,DOWN:d.DOWN,RED:r.RED,GREEN:r.GREEN,BLUE:r.BLUE,YELLOW:r.YELLOW,MAGENTA:r.MAGENTA,CYAN:r.CYAN,WHITE:r.WHITE,BLACK:r.BLACK,quit:tt,KEvent:W,KEventHandler:kt,KEventController:Ot,cancel:()=>Et};Q.k=rt;let it=e.plugins;if(it&&it.forEach(ge),e.global!==!1)for(let e in rt)window[e]=rt[e];return e.focus!==!1&&k.canvas.focus(),rt};const ss=window.innerWidth,cs=window.innerHeight;var $=os({width:ss,height:cs,letterbox:!0,debug:!0,touchToMouse:!0,background:[5,5,5],global:!1,pixelDensity:window.devicePixelRatio,canvas:document.getElementById(`gameCanvas`),crisp:!0});function ls(e){e.loadSprite(`spr_dice`,`/art/spr_dice.png`),e.loadBitmapFont(`monogram`,`font/monogram-bitmap.png`,6,12)}function us(e){e.scene(`mainMenu`,()=>{let t=e.add([e.rect(e.width()-20,e.height()-20,{fill:!1,radius:16}),e.anchor(`center`),e.pos(e.width()/2,e.height()/2),e.outline(5,e.rgb(200,200,200))]);t.add([e.text(`Gamblers Fallacy RPG`,{size:48,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+70),e.anchor(`center`),e.color(e.rgb(200,200,200))]),t.add([e.text(`By Sai Mangipudi`,{size:24,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+150),e.anchor(`center`),e.color(e.rgb(150,150,150))]);let n=t.add([e.rect(250,200,{fill:!1,radius:12}),e.pos(0,0),e.anchor(`center`),e.outline(5,e.rgb(200,200,200))]),r=n.add([e.rect(200,60,{fill:!0,radius:8}),e.pos(0,-40),e.anchor(`center`),e.color(e.rgb(50,150,50)),e.outline(3,e.rgb(150,250,150)),e.area(),e.scale(1)]);r.add([e.text(`Player Mode`,{size:32,font:`monogram`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(150,250,150)),e.area(),e.scale(1)]);let i=n.add([e.rect(200,60,{fill:!0,radius:8}),e.pos(0,40),e.anchor(`center`),e.color(e.rgb(50,50,150)),e.outline(3,e.rgb(150,150,250)),e.area(),e.scale(1)]);i.add([e.text(`GM Mode`,{size:32,font:`monogram`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(150,150,250)),e.area(),e.scale(1)]);let a=!1;r.onMousePress(()=>{r.hasPoint(e.mousePos())&&(a=!0,e.tween(r.scale,e.vec2(1.1),.1,e=>{r.scale=e}))}),r.onMouseRelease(()=>{a&&(e.tween(r.scale,e.vec2(1),.1,e=>{r.scale=e}),e.wait(.1,()=>{e.debug.log(`Switching to Player Mode...`)}))});let o=!1;i.onMouseDown(()=>{i.hasPoint(e.mousePos())&&(o=!0,e.tween(i.scale,e.vec2(1.1),.1,e=>{i.scale=e}))}),i.onMouseRelease(()=>{o&&(e.tween(i.scale,e.vec2(1),.1,e=>{i.scale=e}),e.wait(.1,()=>{e.debug.log(`Switching to GM Mode...`)}))})})}ls($),us($),$.scene(`pLoadCreateChar`,()=>{let e=$.add([$.rect($.width()-20,$.height()-20,{radius:10,fill:!1}),$.anchor(`center`),$.pos($.center()),$.outline(5,$.rgb(94,150,255))]);e.add([$.text(`Load or Create New Character`,{size:48,font:`monogram`,width:$.width()-40,align:`center`}),$.pos(0,-$.height()/2+90),$.anchor(`center`),$.color($.rgb(94,150,255))]);let t=e.add([$.rect($.width()-100,300,{radius:10}),$.pos(0,0),$.anchor(`center`),$.color($.rgb(56,90,153))]),n=t.add([$.rect(t.width,5),$.pos(0,-t.height/2+100),$.anchor(`center`),$.color($.getBackground()??$.rgb(5,5,5))]),r=t.add([$.rect(t.width-40,60,{radius:10}),$.pos(0,-t.height/2+50),$.anchor(`center`),$.color($.getBackground()??$.rgb(5,5,5)),$.outline(5,$.rgb(181,205,255)),$.area(),$.scale(1),$.rotate(0)]);r.add([$.text(`Create A New Character`,{size:24,font:`monogram`,width:r.width-20,align:`center`}),$.pos(0,0),$.anchor(`center`),$.color($.rgb(181,205,255)),$.area(),$.scale(1)]);let i=!1;r.onMousePress(()=>{r.hasPoint($.mousePos())&&(i=!0,$.tween(r.scale,$.vec2(1.1),.1,e=>{r.scale=e}))}),r.onMouseRelease(()=>{i&&($.tween(r.scale,$.vec2(1),.1,e=>{r.scale=e}),$.wait(.1,()=>{$.debug.log(`Creating New Character...`)}))});let a=t.add([$.rect(t.width-40,50,{radius:10}),$.pos(0,n.pos.y+70),$.anchor(`center`),$.color($.rgb(56,90,153))]);a.add([$.text(`Character ID:`,{size:24,font:`monogram`,width:a.width-20,align:`left`}),$.pos(0,-40),$.anchor(`center`),$.color($.rgb(181,205,255))]);let o=t.add([$.rect(t.width-40,60,{radius:10}),$.pos(0,n.pos.y+150),$.anchor(`center`),$.color($.getBackground()??$.rgb(5,5,5)),$.outline(5,$.rgb(181,205,255)),$.area(),$.scale(1),$.rotate(0)]);o.add([$.text(`Load Previous Character`,{size:24,font:`monogram`,width:o.width-20,align:`center`}),$.pos(0,0),$.anchor(`center`),$.color($.rgb(181,205,255)),$.area(),$.scale(1)]);let s=!1;o.onMousePress(()=>{o.hasPoint($.mousePos())&&(s=!0,$.tween(o.scale,$.vec2(1.1),.1,e=>{o.scale=e}))}),o.onMouseRelease(()=>{s&&($.tween(o.scale,$.vec2(1),.1,e=>{o.scale=e}),$.wait(.1,()=>{$.debug.log(`Loading Character...`)}))});let c=document.getElementById(`loadPlayerInput`);c.style.display=`block`,c.style.top=$.center().y+t.pos.y+n.pos.y+70-a.height/2-5+`px`,c.style.width=a.width-20+`px`,c.style.height=a.height-15+`px`,c.style.font=`32px monogram`}),$.go(`pLoadCreateChar`);