(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return t=>{for(var n=t.length,r=new Uint8Array((n-(t[n-1]==`=`)-(t[n-2]==`=`))*3/4|0),i=0,a=0;i<n;){var o=e[t.charCodeAt(i++)],s=e[t.charCodeAt(i++)],c=e[t.charCodeAt(i++)],l=e[t.charCodeAt(i++)];r[a++]=o<<2|s>>4,r[a++]=s<<4|c>>2,r[a++]=c<<6|l}return r}})(),t={name:`kaplay`,description:`KAPLAY is a JavaScript & TypeScript game library that helps you make games fast and fun! (formerly known as Kaboom.js)`,version:`3001.0.19`,license:`MIT`,homepage:`https://kaplayjs.com/`,bugs:{url:`https://github.com/kaplayjs/kaplay/issues`},funding:{type:`opencollective`,url:`https://opencollective.com/kaplay`},repository:{type:`git`,url:`git+https://github.com/kaplayjs/kaplay.git`},type:`module`,main:`./dist/kaplay.cjs`,module:`./dist/kaplay.mjs`,types:`./dist/doc.d.ts`,readme:`./README.md`,exports:{".":{import:{types:`./dist/doc.d.ts`,default:`./dist/kaplay.mjs`},require:{types:`./dist/doc.d.ts`,default:`./dist/kaplay.cjs`}},"./global":`./dist/declaration/global.js`},typesVersions:{"*":{global:[`./dist/declaration/global.d.ts`]}},keywords:[`game development`,`javascript`,`typescript`,`game engine`,`2d games`,`physics engine`,`webgl`,`canvas`,`game library`,`kaplay`,`kaboom`,`kaboomjs`,`kaboom.js`],files:[`dist/`,`kaplay.webp`,`CHANGELOG.md`],scripts:{dev:`NODE_ENV=development node scripts/dev.js`,"win:dev":`set NODE_ENV=development && node scripts/dev.js`,build:`node scripts/generateIndex.js && npm run doc-dts && node scripts/build.js`,"build:fast":`node scripts/buildFast.js`,check:`tsc`,fmt:`dprint fmt`,test:`node scripts/test.js`,"doc-dts":`dts-bundle-generator -o dist/doc.d.ts src/index.ts`,"test:vite":`vitest --typecheck`,desktop:`tauri dev`,prepare:`npm run build`,"publish:next":`npm publish --tag next`},devDependencies:{"@kaplayjs/dprint-config":`^1.2.0`,"@types/jest":`^29.5.14`,dprint:`^0.49.1`,"dts-bundle-generator":`^9.5.1`,ejs:`^3.1.10`,esbuild:`^0.25.2`,express:`^5.1.0`,puppeteer:`^22.15.0`,"tar-fs":`3.0.8`,typescript:`5.6.3`,vite:`5.4.16`,vitest:`^3.1.1`,"vitest-environment-puppeteer":`^11.0.3`,"vitest-puppeteer":`^11.0.3`},engines:{node:`>=20.0.0`},packageManager:`pnpm@9.9.0+sha512.60c18acd138bff695d339be6ad13f7e936eea6745660d4cc4a776d5247c540d0edee1a563695c183a66eb917ef88f2b4feb1fc25f32a7adcadc7aaf3438e99c1`};function n(e,t,r){return t>r?n(e,r,t):Math.min(Math.max(e,t),r)}var r=class e{r=255;g=255;b=255;constructor(e,t,r){this.r=n(e,0,255),this.g=n(t,0,255),this.b=n(r,0,255)}static fromArray(t){return new e(t[0],t[1],t[2])}static fromHex(t){if(typeof t==`number`)return new e(t>>16&255,t>>8&255,t>>0&255);if(typeof t==`string`){let n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!n)throw Error(`Invalid hex color format`);return new e(parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16))}else throw Error(`Invalid hex color format`)}static fromHSL(t,n,r){if(n==0)return new e(255*r,255*r,255*r);let i=(e,t,n)=>(n<0&&(n+=1),n>1&&--n,n<1/6?e+(t-e)*6*n:n<1/2?t:n<2/3?e+(t-e)*(2/3-n)*6:e),a=r<.5?r*(1+n):r+n-r*n,o=2*r-a,s=i(o,a,t+1/3),c=i(o,a,t),l=i(o,a,t-1/3);return new e(Math.round(s*255),Math.round(c*255),Math.round(l*255))}static RED=new e(255,0,0);static GREEN=new e(0,255,0);static BLUE=new e(0,0,255);static YELLOW=new e(255,255,0);static MAGENTA=new e(255,0,255);static CYAN=new e(0,255,255);static WHITE=new e(255,255,255);static BLACK=new e(0,0,0);clone(){return new e(this.r,this.g,this.b)}lighten(t){return new e(this.r+t,this.g+t,this.b+t)}darken(e){return this.lighten(-e)}invert(){return new e(255-this.r,255-this.g,255-this.b)}mult(t){return new e(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,n){return new e(c(this.r,t.r,n),c(this.g,t.g,n),c(this.b,t.b,n))}toHSL(){let e=this.r/255,t=this.g/255,n=this.b/255,r=Math.max(e,t,n),i=Math.min(e,t,n),a=(r+i)/2,o=a,s=a;if(r==i)a=o=0;else{let c=r-i;switch(o=s>.5?c/(2-r-i):c/(r+i),r){case e:a=(t-n)/c+(t<n?6:0);break;case t:a=(n-e)/c+2;break;case n:a=(e-t)/c+4;break}a/=6}return[a,o,s]}eq(e){return this.r===e.r&&this.g===e.g&&this.b===e.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return`#`+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function i(...e){if(e.length===0)return new r(255,255,255);if(e.length===1){if(e[0]instanceof r)return e[0].clone();if(typeof e[0]==`string`)return r.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return r.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof r)return e[0].clone()}else if(e.length===3||e.length===4)return new r(e[0],e[1],e[2]);throw Error(`Invalid color arguments`)}var a=(e,t,n)=>r.fromHSL(e,t,n);function o(e){return e*Math.PI/180}function s(e){return e*180/Math.PI}function c(e,t,n){if(typeof e==`number`&&typeof t==`number`)return e+(t-e)*n;if(e instanceof d&&t instanceof d||e instanceof r&&t instanceof r)return e.lerp(t,n);throw Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function l(e,t,n,r,i){return r+(e-t)/(n-t)*(i-r)}function u(e,t,r,i,a){return n(l(e,t,r,i,a),i,a)}var d=class e{x=0;y=0;constructor(e=0,t=e){this.x=e,this.y=t}static fromAngle(t){let n=o(t);return new e(Math.cos(n),Math.sin(n))}static fromArray(t){return new e(t[0],t[1])}static ZERO=new e(0,0);static ONE=new e(1,1);static LEFT=new e(-1,0);static RIGHT=new e(1,0);static UP=new e(0,-1);static DOWN=new e(0,1);clone(){return new e(this.x,this.y)}add(...t){let n=f(...t);return new e(this.x+n.x,this.y+n.y)}sub(...t){let n=f(...t);return new e(this.x-n.x,this.y-n.y)}scale(...t){let n=f(...t);return new e(this.x*n.x,this.y*n.y)}dist(...e){let t=f(...e);return this.sub(t).len()}sdist(...e){let t=f(...e);return this.sub(t).slen()}static sdist(e,t){let n=e.x-t.x,r=e.y-t.y;return n*n+r*r}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new e(0):this.scale(1/t)}normal(){return new e(this.y,-this.x)}reflect(e){return this.sub(e.scale(2*this.dot(e)))}project(e){return e.scale(e.dot(this)/e.len())}reject(e){return this.sub(this.project(e))}dot(e){return this.x*e.x+this.y*e.y}static dot(e,t){return e.x*t.x+e.y*t.y}cross(e){return this.x*e.y-this.y*e.x}static cross(e,t){return e.x*t.y-e.y*t.x}angle(...e){let t=f(...e);return s(Math.atan2(this.y-t.y,this.x-t.x))}angleBetween(...e){let t=f(...e);return s(Math.atan2(this.cross(t),this.dot(t)))}lerp(t,n){return new e(c(this.x,t.x,n),c(this.y,t.y,n))}slerp(e,t){let n=this.dot(e),r=this.cross(e),i=Math.atan2(r,n);return this.scale(Math.sin((1-t)*i)).add(e.scale(Math.sin(t*i))).scale(1/r)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new e(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(e){return e.multVec2(this)}eq(e){return this.x===e.x&&this.y===e.y}bbox(){return new N(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function f(...e){if(e.length===1){if(e[0]instanceof d)return new d(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new d(...e[0])}return new d(...e)}var p=class e{x=0;y=0;w=1;h=1;constructor(e,t,n,r){this.x=e,this.y=t,this.w=n,this.h=r}scale(t){return new e(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new d(this.x,this.y)}clone(){return new e(this.x,this.y,this.w,this.h)}eq(e){return this.x===e.x&&this.y===e.y&&this.w===e.w&&this.h===e.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function m(e,t,n,r){return new p(e,t,n,r)}var h=class e{a;b;c;d;constructor(e,t,n,r){this.a=e,this.b=t,this.c=n,this.d=r}mul(t){return new e(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(e){return f(this.a*e.x+this.b*e.y,this.c*e.x+this.d*e.y)}get inverse(){let t=this.det;return new e(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new e(this.a,this.c,this.b,this.d)}get eigenvalues(){let e=this.trace/2,t=this.det,n=e+Math.sqrt(e*e-t),r=e-Math.sqrt(e*e-t);return[n,r]}eigenvectors(e,t){return this.c==0?this.b==0?Math.abs(this.transform(f(1,0)).x-e)<2**-52?[[1,0],[0,1]]:[[0,1],[1,0]]:[[this.b,e-this.a],[this.b,t-this.a]]:[[e-this.d,this.c],[t-this.d,this.c]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let n=Math.cos(t),r=Math.sin(t);return new e(n,r,-r,n)}static scale(t,n){return new e(t,0,0,n)}},g=class e{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(e,t,n,r,i,a,o,s,c){this.m11=e,this.m12=t,this.m13=n,this.m21=r,this.m22=i,this.m23=a,this.m31=o,this.m32=s,this.m33=c}static fromMat2(t){return new e(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new h(this.m11,this.m12,this.m21,this.m22)}mul(t){return new e(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(e){let t=Math.cos(e),n=Math.sin(e),r=this.m11,i=this.m12;return this.m11=t*this.m11+n*this.m21,this.m12=t*this.m12+n*this.m22,this.m21=t*this.m21-n*r,this.m22=t*this.m22-n*i,this}scale(e,t){return this.m11*=e,this.m12*=e,this.m21*=t,this.m22*=t,this}get inverse(){let t=this.det;return new e((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new e(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},_=class e{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(e){e&&(this.m=e)}static translate(t){return new e([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new e([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=o(-t);let n=Math.cos(t),r=Math.sin(t);return new e([1,0,0,0,0,n,-r,0,0,r,n,0,0,0,0,1])}static rotateY(t){t=o(-t);let n=Math.cos(t),r=Math.sin(t);return new e([n,0,r,0,0,1,0,0,-r,0,n,0,0,0,0,1])}static rotateZ(t){t=o(-t);let n=Math.cos(t),r=Math.sin(t);return new e([n,-r,0,0,r,n,0,0,0,0,1,0,0,0,0,1])}translate(e){return this.m[12]+=this.m[0]*e.x+this.m[4]*e.y,this.m[13]+=this.m[1]*e.x+this.m[5]*e.y,this.m[14]+=this.m[2]*e.x+this.m[6]*e.y,this.m[15]+=this.m[3]*e.x+this.m[7]*e.y,this}scale(e){return this.m[0]*=e.x,this.m[4]*=e.y,this.m[1]*=e.x,this.m[5]*=e.y,this.m[2]*=e.x,this.m[6]*=e.y,this.m[3]*=e.x,this.m[7]*=e.y,this}rotate(e){e=o(-e);let t=Math.cos(e),n=Math.sin(e),r=this.m[0],i=this.m[1],a=this.m[4],s=this.m[5];return this.m[0]=r*t+i*n,this.m[1]=-r*n+i*t,this.m[4]=a*t+s*n,this.m[5]=-a*n+s*t,this}mult(t){let n=[];for(let e=0;e<4;e++)for(let r=0;r<4;r++)n[e*4+r]=this.m[0+r]*t.m[e*4+0]+this.m[4+r]*t.m[e*4+1]+this.m[8+r]*t.m[e*4+2]+this.m[12+r]*t.m[e*4+3];return new e(n)}multVec2(e){return new d(e.x*this.m[0]+e.y*this.m[4]+this.m[12],e.x*this.m[1]+e.y*this.m[5]+this.m[13])}getTranslation(){return new d(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let e=this.m[0]*this.m[5]-this.m[1]*this.m[4],t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new d(t,e/t)}else if(this.m[4]!=0||this.m[5]!=0){let e=this.m[0]*this.m[5]-this.m[1]*this.m[4],t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new d(e/t,t)}else return new d(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let e=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return s(this.m[1]>0?Math.acos(this.m[0]/e):-Math.acos(this.m[0]/e))}else if(this.m[4]!=0||this.m[5]!=0){let e=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return s(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/e):-Math.acos(this.m[4]/e)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let e=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new d(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(e*e),0)}else if(this.m[4]!=0||this.m[5]!=0){let e=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new d(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(e*e))}else return new d(0,0)}invert(){let t=[],n=this.m[10]*this.m[15]-this.m[14]*this.m[11],r=this.m[9]*this.m[15]-this.m[13]*this.m[11],i=this.m[9]*this.m[14]-this.m[13]*this.m[10],a=this.m[8]*this.m[15]-this.m[12]*this.m[11],o=this.m[8]*this.m[14]-this.m[12]*this.m[10],s=this.m[8]*this.m[13]-this.m[12]*this.m[9],c=this.m[6]*this.m[15]-this.m[14]*this.m[7],l=this.m[5]*this.m[15]-this.m[13]*this.m[7],u=this.m[5]*this.m[14]-this.m[13]*this.m[6],d=this.m[4]*this.m[15]-this.m[12]*this.m[7],f=this.m[4]*this.m[14]-this.m[12]*this.m[6],p=this.m[5]*this.m[15]-this.m[13]*this.m[7],m=this.m[4]*this.m[13]-this.m[12]*this.m[5],h=this.m[6]*this.m[11]-this.m[10]*this.m[7],g=this.m[5]*this.m[11]-this.m[9]*this.m[7],_=this.m[5]*this.m[10]-this.m[9]*this.m[6],v=this.m[4]*this.m[11]-this.m[8]*this.m[7],y=this.m[4]*this.m[10]-this.m[8]*this.m[6],b=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*n-this.m[6]*r+this.m[7]*i,t[4]=-(this.m[4]*n-this.m[6]*a+this.m[7]*o),t[8]=this.m[4]*r-this.m[5]*a+this.m[7]*s,t[12]=-(this.m[4]*i-this.m[5]*o+this.m[6]*s),t[1]=-(this.m[1]*n-this.m[2]*r+this.m[3]*i),t[5]=this.m[0]*n-this.m[2]*a+this.m[3]*o,t[9]=-(this.m[0]*r-this.m[1]*a+this.m[3]*s),t[13]=this.m[0]*i-this.m[1]*o+this.m[2]*s,t[2]=this.m[1]*c-this.m[2]*l+this.m[3]*u,t[6]=-(this.m[0]*c-this.m[2]*d+this.m[3]*f),t[10]=this.m[0]*p-this.m[1]*d+this.m[3]*m,t[14]=-(this.m[0]*u-this.m[1]*f+this.m[2]*m),t[3]=-(this.m[1]*h-this.m[2]*g+this.m[3]*_),t[7]=this.m[0]*h-this.m[2]*v+this.m[3]*y,t[11]=-(this.m[0]*g-this.m[1]*v+this.m[3]*b),t[15]=this.m[0]*_-this.m[1]*y+this.m[2]*b;let x=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let e=0;e<4;e++)for(let n=0;n<4;n++)t[e*4+n]*=1/x;return new e(t)}clone(){return new e([...this.m])}toString(){return this.m.toString()}};function v(e,t,n,r=e=>-Math.cos(e)){return e+(r(n)+1)/2*(t-e)}var y=1103515245,b=12345,x=2147483648,S=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(y*this.seed+b)%x,this.seed/x}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new d(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new r(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]==`number`)return this.genNumber(0,e[0]);if(e[0]instanceof d)return this.genVec2(f(0,0),e[0]);if(e[0]instanceof r)return this.genColor(i(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]==`number`&&typeof e[1]==`number`)return this.genNumber(e[0],e[1]);if(e[0]instanceof d&&e[1]instanceof d)return this.genVec2(e[0],e[1]);if(e[0]instanceof r&&e[1]instanceof r)return this.genColor(e[0],e[1])}throw Error(`More than 2 arguments not supported`)}},C=new S(Date.now());function w(e){return e!=null&&(C.seed=e),C.seed}function T(...e){return C.genAny(...e)}function E(...e){return Math.floor(T(...e.length>0?e:[2]))}function ee(e){return T()<=e}function D(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function te(e,t){return e.length<=t?e.slice():D(e.slice()).slice(0,t)}function ne(e){return e[E(e.length)]}function re(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function O(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let n=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(n===0)return null;let r=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/n,i=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/n;return r<0||r>1||i<0||i>1?null:r}function ie(e,t){let n=O(e,t);return n?f(e.p1.x+n*(e.p2.x-e.p1.x),e.p1.y+n*(e.p2.y-e.p1.y)):null}function ae(e,t){let n=t.p2.sub(t.p1),r=-1/0,i=1/0;if(n.x!=0){let a=(e.pos.x-t.p1.x)/n.x,o=(e.pos.x+e.width-t.p1.x)/n.x;r=Math.max(r,Math.min(a,o)),i=Math.min(i,Math.max(a,o))}if(n.y!=0){let a=(e.pos.y-t.p1.y)/n.y,o=(e.pos.y+e.height-t.p1.y)/n.y;r=Math.max(r,Math.min(a,o)),i=Math.min(i,Math.max(a,o))}return i>=r&&i>=0&&r<=1}function oe(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function se(e,t){let n=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),r=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return f(n,r).sdist(t.center)<=t.radius*t.radius}function k(e,t){return fe(t,new Le(e.points()))}function ce(e,t){let n=t.sub(e.p1),r=e.p2.sub(e.p1);if(Math.abs(n.cross(r))>2**-52)return!1;let i=n.dot(r)/r.dot(r);return i>=0&&i<=1}function le(e,t){let n=e.p2.sub(e.p1),r=n.dot(n),i=e.p1.sub(t.center),a=2*n.dot(i),o=i.dot(i)-t.radius*t.radius,s=a*a-4*r*o;if(r<=2**-52||s<0)return!1;if(s==0){let e=-a/(2*r);if(e>=0&&e<=1)return!0}else{let e=(-a+Math.sqrt(s))/(2*r),t=(-a-Math.sqrt(s))/(2*r);if(e>=0&&e<=1||t>=0&&t<=1)return!0}return ue(t,e.p1)}function A(e,t){if(pe(t,e.p1)||pe(t,e.p2))return!0;for(let n=0;n<t.pts.length;n++){let r=t.pts[n],i=t.pts[(n+1)%t.pts.length];if(ie(e,new Ne(r,i)))return!0}return!1}function ue(e,t){return e.center.sdist(t)<e.radius*e.radius}function j(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function de(e,t){let n=t.pts[t.pts.length-1];for(let r of t.pts){if(le(new Ne(n,r),e))return!0;n=r}return ue(e,t.pts[0])?!0:pe(t,e.center)}function fe(e,t){for(let n=0;n<e.pts.length;n++)if(A(new Ne(e.pts[n],e.pts[(n+1)%e.pts.length]),t))return!0;return!!(e.pts.some(e=>pe(t,e))||t.pts.some(t=>pe(e,t)))}function pe(e,t){let n=!1,r=e.pts;for(let e=0,i=r.length-1;e<r.length;i=e++)r[e].y>t.y!=r[i].y>t.y&&t.x<(r[i].x-r[e].x)*(t.y-r[e].y)/(r[i].y-r[e].y)+r[e].x&&(n=!n);return n}function M(e,t){t=t.sub(e.center);let n=o(e.angle),r=Math.cos(n),i=Math.sin(n),a=t.x*r+t.y*i,s=-t.x*i+t.y*r;return a*a/(e.radiusX*e.radiusX)+s*s/(e.radiusY*e.radiusY)<1}function me(e,t){let n=t.center.sub(e.center),r=o(e.angle),i=Math.cos(r),a=Math.sin(r),s=n.x*i+n.y*a,c=-n.x*a+n.y*i;return M(new Fe(f(),e.radiusX+t.radius,e.radiusY+t.radius,0),f(s,c))}function he(e,t){let n=e.toMat2().inverse;return t=new Ne(n.transform(t.p1.sub(e.center)),n.transform(t.p2.sub(e.center))),le(t,new Pe(f(),1))}function ge(e,t){if(e.radiusX===e.radiusY)return me(t,new Pe(e.center,e.radiusX));if(t.radiusX===t.radiusY)return me(e,new Pe(t.center,t.radiusX));let n=new g(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),r=new g(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),i=e.center.x,a=e.center.y,s=t.center.x,c=t.center.y,l=o(e.angle),u=o(t.angle),d=new g(Math.cos(l),-Math.sin(l),i,Math.sin(l),Math.cos(l),a,0,0,1),f=new g(Math.cos(u),-Math.sin(u),s,Math.sin(u),Math.cos(u),c,0,0,1),p=d.inverse,m=f.inverse,h=p.transpose.mul(n).mul(p),_=m.transpose.mul(r).mul(m),v=h.m11,y=h.m12,b=h.m13,x=h.m21,S=h.m22,C=h.m23,w=h.m31,T=h.m32,E=h.m33,ee=_.m11,D=_.m12,te=_.m13,ne=_.m21,re=_.m22,O=_.m23,ie=_.m31,ae=_.m32,oe=_.m33,se=v*S*E-v*C*T-y*x*E+y*C*w+b*x*T-b*S*w,k=(v*S*oe-v*C*ae-v*T*O+v*E*re-y*x*oe+y*C*ie+y*w*O-y*E*ne+b*x*ae-b*S*ie-b*w*re+b*T*ne+x*T*te-x*E*D-S*w*te+S*E*ee+C*w*D-C*T*ee)/se,ce=(v*re*oe-v*O*ae-y*ne*oe+y*O*ie+b*ne*ae-b*re*ie-x*D*oe+x*te*ae+S*ee*oe-S*te*ie-C*ee*ae+C*D*ie+w*D*O-w*te*re-T*ee*O+T*te*ne+E*ee*re-E*D*ne)/se,le=(ee*re*oe-ee*O*ae-D*ne*oe+D*O*ie+te*ne*ae-te*re*ie)/se;if(k>=0){let e=-3*ce+k**2,t=3*k*le+ce*k**2-4*ce**2,n=-27*le**2+18*le*k*ce+k**2*ce**2-4*k**3*le-4*ce**3;return!(e>0&&t<0&&n>0)}else{let e=-3*ce+k**2,t=-27*le**2+18*le*k*ce+k**2*ce**2-4*k**3*le-4*ce**3;return!(e>0&&t>0)}}function _e(e,t){return ve(e,new Le(t.points()))}function ve(e,t){let n=e.toMat2().inverse;return t=new Le(t.pts.map(t=>n.transform(t.sub(e.center)))),de(new Pe(f(),1),t)}function ye(e,t){return e.x===t.x&&e.y===t.y}function be(e,t){return t instanceof d?ye(t,e.pt):t instanceof Pe?ue(t,e.pt):t instanceof Ne?ce(t,e.pt):t instanceof N?oe(t,e.pt):t instanceof Le?pe(t,e.pt):t instanceof Fe?M(t,e.pt):!1}function xe(e,t){return t instanceof d?ce(e,t):t instanceof Pe?le(e,t):t instanceof Ne?ie(e,t)!=null:t instanceof N?ae(t,e):t instanceof Le?A(e,t):t instanceof Fe?he(t,e):!1}function Se(e,t){return t instanceof d?ue(e,t):t instanceof Pe?j(e,t):t instanceof Ne?le(t,e):t instanceof N?se(t,e):t instanceof Le?de(e,t):t instanceof Fe?me(t,e):!1}function Ce(e,t){return t instanceof d?oe(e,t):t instanceof Pe?se(e,t):t instanceof Ne?ae(e,t):t instanceof N?re(e,t):t instanceof Le?k(e,t):t instanceof Fe?_e(t,e):!1}function we(e,t){return t instanceof d?pe(e,t):t instanceof Pe?de(t,e):t instanceof Ne?A(t,e):t instanceof N?k(t,e):t instanceof Le?fe(t,e):t instanceof Fe?ve(t,e):!1}function Te(e,t){return t instanceof d?M(e,t):t instanceof Pe?me(e,t):t instanceof Ne?he(e,t):t instanceof N?_e(e,t):t instanceof Le?ve(e,t):t instanceof Fe?ge(t,e):!1}function Ee(e,t,n){let r=e,i=n.p1,a=n.p2,o=t,s=a.sub(i),c=o.cross(s);if(Math.abs(c)<2**-52)return null;let l=i.sub(r),u=l.cross(s)/c;if(u<=0||u>=1)return null;let d=l.cross(o)/c;if(d<=0||d>=1)return null;let f=s.normal().unit();return t.dot(f)>0&&(f.x*=-1,f.y*=-1),{point:r.add(o.scale(u)),normal:f,fraction:u}}function De(e,t,n){let r=-1/0,i=1/0,a;if(e.x!=0){let o=(n.pos.x-e.x)/t.x,s=(n.pos.x+n.width-e.x)/t.x;a=f(-Math.sign(t.x),0),r=Math.max(r,Math.min(o,s)),i=Math.min(i,Math.max(o,s))}if(e.y!=0){let o=(n.pos.y-e.y)/t.y,s=(n.pos.y+n.height-e.y)/t.y;Math.min(o,s)>r&&(a=f(0,-Math.sign(t.y))),r=Math.max(r,Math.min(o,s)),i=Math.min(i,Math.max(o,s))}return i>=r&&r>=0&&r<=1?{point:e.add(t.scale(r)),normal:a,fraction:r}:null}function Oe(e,t,n){let r=e,i=n.center,a=t,o=a.dot(a),s=r.sub(i),c=2*a.dot(s),l=s.dot(s)-n.radius*n.radius,u=c*c-4*o*l;if(o<=2**-52||u<0)return null;if(u==0){let e=-c/(2*o);if(e>=0&&e<=1){let t=r.add(a.scale(e));return{point:t,normal:t.sub(i),fraction:e}}}else{let e=(-c+Math.sqrt(u))/(2*o),t=(-c-Math.sqrt(u))/(2*o),n=null;if(e>=0&&e<=1&&(n=e),t>=0&&t<=1&&(n=Math.min(t,n??t)),n!=null){let e=r.add(a.scale(n));return{point:e,normal:e.sub(i).unit(),fraction:n}}}return null}function ke(e,t,n){let r=n.pts,i=null,a=r[r.length-1];for(let n=0;n<r.length;n++){let o=r[n],s=Ee(e,t,new Ne(a,o));s&&(!i||i.fraction>s.fraction)&&(i=s),a=o}return i}function Ae(e,t,n){let r=n.toMat2(),i=r.inverse,a=i.transform(e.sub(n.center)),s=i.transform(t),c=Oe(a,s,new Pe(f(),1));if(c){let i=h.rotation(o(-n.angle)),a=h.scale(n.radiusX,n.radiusY).transform(c.point),s=r.transform(c.point).add(n.center),l=s.dist(e)/t.len();return{point:s,normal:i.transform(f(n.radiusY**2*a.x,n.radiusX**2*a.y)).unit(),fraction:l}}return c}function je(e,t,n,r=64){let i=e,a=t.len(),o=t.scale(1/a),s=0,c=f(Math.floor(e.x),Math.floor(e.y)),l=f(o.x>0?1:-1,o.y>0?1:-1),u=f(Math.abs(1/o.x),Math.abs(1/o.y)),d=f(l.x>0?c.x+1-e.x:e.x-c.x,l.y>0?c.y+1-e.y:e.y-c.y),p=f(u.x<1/0?u.x*d.x:1/0,u.y<1/0?u.y*d.y:1/0),m=-1;for(;s<=r;){let e=n(c);if(e===!0)return{point:i.add(o.scale(s)),normal:f(m===0?-l.x:0,m===1?-l.y:0),fraction:s/a,gridPos:c};if(e)return e;p.x<p.y?(c.x+=l.x,s=p.x,p.x+=u.x,m=0):(c.y+=l.y,s=p.y,p.y+=u.y,m=1)}return null}var Me=class e{pt;constructor(e){this.pt=e.clone()}transform(t){return new e(t.multVec2(this.pt))}bbox(){return new N(this.pt,0,0)}area(){return 0}clone(){return new e(this.pt)}collides(e){return be(this,e)}contains(e){return this.pt.eq(e)}raycast(e,t){return null}random(){return this.pt.clone()}},Ne=class e{p1;p2;constructor(e,t){this.p1=e.clone(),this.p2=t.clone()}transform(t){return new e(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return N.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new e(this.p1,this.p2)}collides(e){return xe(this,e)}contains(e){return this.collides(e)}raycast(e,t){return Ee(e,t,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(T(1)))}},N=class e{pos;width;height;constructor(e,t,n){this.pos=e.clone(),this.width=t,this.height=n}static fromPoints(t,n){return new e(t.clone(),n.x-t.x,n.y-t.y)}center(){return new d(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(e){return new Le(this.points().map(t=>e.multVec2(t)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new e(this.pos.clone(),this.width,this.height)}distToPoint(e){return Math.sqrt(this.sdistToPoint(e))}sdistToPoint(e){let t=this.pos,n=this.pos.add(this.width,this.height),r=Math.max(t.x-e.x,0,e.x-n.x),i=Math.max(t.y-e.y,0,e.y-n.y);return r*r+i*i}collides(e){return Ce(this,e)}contains(e){return this.collides(e)}raycast(e,t){return De(e,t,this)}random(){return this.pos.add(T(this.width),T(this.height))}},Pe=class e{center;radius;constructor(e,t){this.center=e.clone(),this.radius=t}transform(e){return new Fe(this.center,this.radius,this.radius).transform(e)}bbox(){return N.fromPoints(this.center.sub(f(this.radius)),this.center.add(f(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new e(this.center,this.radius)}collides(e){return Se(this,e)}contains(e){return this.collides(e)}raycast(e,t){return Oe(e,t,this)}random(){return this.center.add(d.fromAngle(T(360)).scale(T(this.radius)))}},Fe=class e{center;radiusX;radiusY;angle;constructor(e,t,n,r=0){this.center=e.clone(),this.radiusX=t,this.radiusY=n,this.angle=r}static fromMat2(t){let n=t.inverse,r=n.transpose.mul(n),[i,a]=r.eigenvalues,[o,c]=r.eigenvectors(i,a),[l,u]=[1/Math.sqrt(i),1/Math.sqrt(a)];return l>u?new e(f(),l,u,s(Math.atan2(-o[1],o[0]))):new e(f(),u,l,s(Math.atan2(-c[1],c[0])))}toMat2(){let e=o(this.angle),t=Math.cos(e),n=Math.sin(e);return new h(t*this.radiusX,-n*this.radiusY,n*this.radiusX,t*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new e(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let n=this.toMat2(),r=t.getRotation(),i=t.getScale();n=g.fromMat2(n).scale(i.x,i.y).rotate(r).toMat2();let a=e.fromMat2(n);return a.center=t.multVec2(this.center),a}}bbox(){if(this.angle==0)return N.fromPoints(this.center.sub(f(this.radiusX,this.radiusY)),this.center.add(f(this.radiusX,this.radiusY)));{let e=o(this.angle),t=Math.cos(e),n=Math.sin(e),r=this.radiusX*t,i=this.radiusX*n,a=this.radiusY*n,s=this.radiusY*t,c=Math.sqrt(r*r+a*a),l=Math.sqrt(i*i+s*s);return N.fromPoints(this.center.sub(f(c,l)),this.center.add(f(c,l)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new e(this.center,this.radiusX,this.radiusY,this.angle)}collides(e){return Te(this,e)}contains(e){e=e.sub(this.center);let t=o(this.angle),n=Math.cos(t),r=Math.sin(t),i=e.x*n+e.y*r,a=-e.x*r+e.y*n;return i*i/(this.radiusX*this.radiusX)+a*a/(this.radiusY*this.radiusY)<1}raycast(e,t){return Ae(e,t,this)}random(){return this.center}};function Ie(e,t,n,r){let i=t.sub(e),a=r.sub(n),o=i.cross(a);return o<1e-5&&o>-1e-5||(o=n.sub(e).cross(a)/o,o<0||o>1)?null:e.add(i.scale(o))}var Le=class e{pts;constructor(e){if(e.length<3)throw Error(`Polygons should have at least 3 vertices`);this.pts=e}transform(t){return new e(this.pts.map(e=>t.multVec2(e)))}bbox(){let e=f(Number.MAX_VALUE),t=f(-Number.MAX_VALUE);for(let n of this.pts)e.x=Math.min(e.x,n.x),t.x=Math.max(t.x,n.x),e.y=Math.min(e.y,n.y),t.y=Math.max(t.y,n.y);return N.fromPoints(e,t)}area(){let e=0,t=this.pts.length;for(let n=0;n<t;n++){let r=this.pts[n],i=this.pts[(n+1)%t];e+=r.x*i.y*.5,e-=i.x*r.y*.5}return Math.abs(e)}clone(){return new e(this.pts.map(e=>e.clone()))}collides(e){return we(this,e)}contains(e){return this.collides(e)}raycast(e,t){return ke(e,t,this)}random(){return f()}cut(t,n){new Ne(t,n);let r=[],i=[],a=n.sub(t),o=this.pts[this.pts.length-1],s=o.sub(t),c=a.cross(s)>0;return this.pts.forEach(e=>{s=e.sub(t);let l=a.cross(s)>0;if(c!=l){let a=Ie(o,e,t,n);r.push(a),i.push(a),c=l}(l?r:i).push(e),o=e}),[r.length?new e(r):null,i.length?new e(i):null]}};function Re(e,t,n,r){let i=r*r,a=1-r,o=a*a;return e.scale(o).add(t.scale(2*a*r)).add(n.scale(i))}function ze(e,t,n,r){let i=1-r;return t.sub(e).scale(2*i).add(n.sub(t).scale(2*r))}function Be(e,t,n,r){return n.sub(t.scale(2)).add(e).scale(2)}function Ve(e,t,n,r,i){let a=i*i,o=a*i,s=1-i,c=s*s,l=c*s;return e.scale(l).add(t.scale(3*c*i)).add(n.scale(3*s*a)).add(r.scale(o))}function He(e,t,n,r,i){let a=i*i,o=1-i,s=o*o;return t.sub(e).scale(3*s).add(n.sub(t).scale(6*o*i)).add(r.sub(n).scale(3*a))}function Ue(e,t,n,r,i){let a=1-i;return n.sub(t.scale(2)).add(e).scale(6*a).add(r.sub(n.scale(2)).add(t).scale(6*i))}function We(e,t,n,r,i){let a=.5*(((-i+2)*i-1)*i),o=.5*((3*i-5)*i*i+2),s=.5*(((-3*i+4)*i+1)*i),c=.5*((i-1)*i*i);return e.scale(a).add(t.scale(o)).add(n.scale(s)).add(r.scale(c))}function Ge(e,t,n,r,i){let a=.5*((-3*i+4)*i-1),o=.5*((9*i-10)*i),s=.5*((-9*i+8)*i+1),c=.5*((3*i-2)*i);return e.scale(a).add(t.scale(o)).add(n.scale(s)).add(r.scale(c))}function Ke(e){let t=qe(e),n=t(1);return r=>{let i=r*n,a=t(i,!0);return e(a)}}function qe(e,t=10,n=10){let r=[0],i=[0],a=1/(t-1)/n,o=0,s=e(0),c=0;for(let l=1;l<t;l++){for(let t=0;t<n;t++){c+=a;let t=e(c),n=t.dist(s);o+=n,s=t}r[l]=o,i[l]=c}return i[t-1]=1,(e,n=!1)=>{if(n){let t=e;if(t<=0)return 0;if(t>=o)return 1;let n=0;for(;r[n+1]<t;)n++;let a=i[n],s=i[n+1],c=r[n],l=r[n+1],u=(t-c)/(l-c);return a+(s-a)*u}else{if(e<=0)return 0;if(e>=1)return r[t-1];let n=0;for(;i[n+1]<e;)n++;let a=i[n],o=i[n+1],s=r[n],c=r[n+1],l=(e-a)/(o-a);return s+(c-s)*l}}}function Je(e,t,n,r){let i=2*e+t-2*r+n,a=-3*e+3*r-2*t-n,o=t,s=e;return e=>{let t=e*e,n=t*e;return i*n+a*t+o*e+s}}function Ye(e,t,n,r,i,a=Je){let o=a(t.x,(1-i)*(n.x-e.x),(1-i)*(r.x-t.x),n.x),s=a(t.y,(1-i)*(n.y-e.y),(1-i)*(r.y-t.y),n.y);return e=>new d(o(e),s(e))}function Xe(e,t,n,r,i=Je){return Ye(e,t,n,r,.5,i)}function Ze(e,t,n,r,i=Je){return Xe(r.add(e.sub(t).scale(6)),e,r,e.add(r.sub(n).scale(6)),i)}function Qe(e,t,n,r,i,a,o,s=Je){let c=s(t.x,.5*(1-i)*(1+o)*(1+a)*(t.x-e.x)+.5*(1-i)*(1-o)*(1-a)*(n.x-t.x),.5*(1-i)*(1+o)*(1-a)*(n.x-t.x)+.5*(1-i)*(1-o)*(1+a)*(r.x-n.x),n.x),l=s(t.y,.5*(1-i)*(1+o)*(1+a)*(t.y-e.y)+.5*(1-i)*(1-o)*(1-a)*(n.y-t.y),.5*(1-i)*(1+o)*(1-a)*(n.y-t.y)+.5*(1-i)*(1-o)*(1+a)*(r.y-n.y),n.y);return e=>new d(c(e),l(e))}function $e(e,t,n,r){let i=2*e+t-2*r+n,a=-3*e+3*r-2*t+n,o=t;return e=>{let t=e*e;return 3*i*t+2*a*e+o}}function et(e){return 0<=e&&e<=1}function tt(e,t){return Math.abs(e-t)<=2**-52}function nt(e){return e<0?-((-e)**(1/3)):e**(1/3)}function rt(e,t,n,r){let i=3*e-6*t+3*n,a=-3*e+3*t,o=e,s=-e+3*t-3*n+r;if(tt(s,0)){if(tt(i,0))return tt(a,0)?[]:[-o/a].filter(et);let e=Math.sqrt(a*a-4*i*o),t=2*i;return[(e-a)/t,(-a-e)/t].filter(et)}i/=s,a/=s,o/=s;let c=(3*a-i*i)/3,l=c/3,u=(2*i*i*i-9*i*a+27*o)/27,d=u/2,f=d*d+l*l*l;if(f<0){let e=-c/3,t=e*e*e,n=Math.sqrt(t),r=-u/(2*n),a=r<-1?-1:r>1?1:r,o=Math.acos(a),s=2*nt(n),l=s*Math.cos(o/3)-i/3,d=s*Math.cos((o+2*Math.PI)/3)-i/3,f=s*Math.cos((o+4*Math.PI)/3)-i/3;return[l,d,f].filter(et)}if(f===0){let e=d<0?nt(-d):-nt(d),t=2*e-i/3,n=-e-i/3;return[t,n].filter(et)}let p=Math.sqrt(f),m=nt(p-d),h=nt(p+d);return[m-h-i/3].filter(et)}function it(e,t,n,r,i){let a=rt(e.x-i,t.x-i,n.x-i,r.x-i);return a.length>0?Ve(e,t,n,r,a[0]).y:NaN}function at(e){if(!e||e.length==0)throw Error(`Need at least one point for easingLinear.`);let t=e.length;return n=>{if(n<=0||e.length==1||n<=e[0].x)return e[0].y;for(let r=0;r<t;r++)if(e[r].x>=n)return l(n,e[r-1].x,e[r].x,e[r-1].y,e[r].y);return e[e.length-1].y}}function ot(e,t){return n=>it(f(0,0),e,t,f(1,1),n)}function st(e,t=`jump-end`){let n=1/e,r=t==`jump-start`||t==`jump-both`,i=1/(e+(t==`jump-end`||t==`jump-both`?1:0)),a=r?i:0;return e=>{let t=Math.floor(e/n);return a+t*i}}function ct(e,t){let n=Number.MAX_VALUE,r={normal:f(0),distance:0};for(let i of[e,t])for(let a=0;a<i.pts.length;a++){let o=i.pts[a],s=i.pts[(a+1)%i.pts.length].sub(o).normal().unit(),c=Number.MAX_VALUE,l=-Number.MAX_VALUE;for(let t=0;t<e.pts.length;t++){let n=e.pts[t].dot(s);c=Math.min(c,n),l=Math.max(l,n)}let u=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let e=0;e<t.pts.length;e++){let n=t.pts[e].dot(s);u=Math.min(u,n),d=Math.max(d,n)}let f=Math.min(l,d)-Math.max(c,u);if(f<0)return null;if(f<Math.abs(n)){let e=d-c,t=u-l;n=Math.abs(e)<Math.abs(t)?e:t,r.normal=s,r.distance=n}}return r}function lt(e,t,n){return(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x)>=0}function ut(e){let t=0,n=e[e.length-1];for(let r=0;r<e.length;r++)t+=(e[r].x-n.x)*(e[r].y+n.y),n=e[r];return t<0}function dt(e,t,n,r){let i=r.x-n.x,a=r.y-n.y,o=i*(e.y-n.y)-a*(e.x-n.x),s=i*(t.y-n.y)-a*(t.x-n.x);return o*s>=0}function ft(e,t,n,r){return dt(e,t,n,r)&&dt(e,n,t,r)&&dt(e,r,t,n)}function pt(e,t,n,r){for(let i of e)if(i!==t&&i!==n&&i!==r&&ft(i,t,n,r))return!0;return!1}function mt(e,t,n,r){return lt(e,t,n)&&!pt(r,e,t,n)}function ht(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],n=[],r=0;for(let i=0;i<e.length;i++){let a=e[r],o=e[i];(o.x<a.x||o.x==a.x&&o.y<a.y)&&(r=r),t[i]=i+1,n[i]=i-1}t[t.length-1]=0,n[0]=n.length-1,ut(e)||([t,n]=[n,t]);let i=[];for(let r=0;r<e.length;++r)lt(e[n[r]],e[r],e[t[r]])||i.push(e[r]);let a=[],o=e.length,s=1,c=0,l,u;for(;o>3;){l=t[s],u=n[s];let r=e[u],d=e[s],f=e[l];if(mt(r,d,f,i))a.push([r,d,f]),t[u]=l,n[l]=u,i.splice(i.indexOf(d),1),--o,c=0;else if(++c>o)return[];s=l}return l=t[s],u=n[s],a.push([e[u],e[s],e[l]]),a}function gt(e){if(e.length<3)return!1;let t=e.length-2,n=e.length-1,r=0,i=e[n].sub(e[t]),a=e[r].sub(e[n]),o=i.cross(a);for(;r+1<e.length;)if(t=n,n=r,r++,i=e[n].sub(e[t]),a=e[r].sub(e[n]),i.cross(a)*o<0)return!1;return!0}var _t=` !"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_\`abcdefghijklmnopqrstuvwxyz{|}~`,vt=`topleft`,yt=`monospace`,bt=`monospace`,xt=`linear`,St=[{name:`a_pos`,size:2},{name:`a_uv`,size:2},{name:`a_color`,size:4}],Ct=St.reduce((e,t)=>e+t.size,0),wt=2048,Tt=wt*4*Ct,Et=wt*6,Dt=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,Ot=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,kt=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,At=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,jt=new Set([`id`,`require`]),Mt=new Set([`add`,`fixedUpdate`,`update`,`draw`,`destroy`,`inspect`,`drawInspect`]),Nt=200,Pt=640,Ft=65536,It=Symbol.for(`kaplay.cancel`),Lt=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},Rt=class e{paused=!1;cancel;constructor(e){this.cancel=e}static join(t){let n=new e(()=>t.forEach(e=>e.cancel()));return Object.defineProperty(n,`paused`,{get:()=>t[0].paused,set:e=>t.forEach(t=>t.paused=e)}),n.paused=!1,n}static replace(e,t){return e.cancel=()=>t.cancel(),t.paused=e.paused,Object.defineProperty(e,`paused`,{get:()=>t.paused,set:e=>t.paused=e}),e}},zt=class{cancellers=new WeakMap;handlers=new Lt;add(e){function t(...t){if(!r.paused)return e(...t)}let n=this.handlers.pushd(t),r=new Rt(n);return this.cancellers.set(t,n),r}addOnce(e){let t=this.add((...n)=>{t.cancel(),e(...n)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let n=t(...e),r;n===It&&(r=this.cancellers.get(t))&&r()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},Bt=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new zt),this.handlers[e].add(t)}onOnce(e,t){let n=this.on(e,(...e)=>{n.cancel(),t(...e)});return n}next(e){return new Promise(t=>{this.onOnce(e,(...e)=>t(e[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},Vt=e=>e[0]instanceof r,Ht=e=>e[0]instanceof d,Ut=e=>typeof e[0]==`number`,Wt=class{_items;_compareFn;constructor(e=(e,t)=>e<t){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function Gt(e){let t=window.atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r.buffer}function Kt(e){return Gt(e.split(`,`)[1])}function qt(e,t){let n=document.createElement(`a`);n.href=t,n.download=e,n.click()}function Jt(e,t){qt(e,`data:text/plain;charset=utf-8,`+t)}function Yt(e,t){Jt(e,JSON.stringify(t))}function Xt(e,t){let n=URL.createObjectURL(t);qt(e,n),URL.revokeObjectURL(n)}var Zt=e=>e.match(/^data:\w+\/\w+;base64,.+/),Qt=e=>e.split(`.`).slice(0,-1).join(`.`);function $t(e,t){if(e===t)return!0;let n=typeof e,r=typeof t;if(n!==r)return!1;if(n===`object`&&r===`object`&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(let r of n){let n=e[r],i=t[r];if(!$t(n,i))return!1}return!0}return!1}var en=new Set,tn=e=>e instanceof Error?e.message:String(e);function nn(e){en.has(e)||(en.add(e),console.warn(e))}function rn(e,t){nn(`${e} is deprecated. Use ${t} instead.`)}function an(e,t){return Number(e.toFixed(t))}function P(e,t){return(...n)=>{let r=n.length;if(r===e.length)return e(...n);if(r===t.length)return t(...n)}}var on=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function sn(e){if(typeof e!=`string`)throw TypeError(`string cannot be undefined or null`);let t=[],n=0,r=0;for(;n<e.length;){if(r+=cn(n+r,e),gn(e[n+r])&&r++,pn(e[n+r])&&r++,mn(e[n+r])&&r++,_n(e[n+r])){r++;continue}t.push(e.substring(n,n+r)),n+=r,r=0}return t}function cn(e,t){let n=t[e];if(!ln(n)||e===t.length-1)return 1;let r=n+t[e+1],i=t.substring(e+2,e+5);return un(r)&&un(i)?4:dn(r)&&hn(i)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:fn(i)?4:2}function ln(e){return e&&yn(e[0].charCodeAt(0),55296,56319)}function un(e){return yn(vn(e),127462,127487)}function dn(e){return yn(vn(e),127988,127988)}function fn(e){return yn(vn(e),127995,127999)}function pn(e){return typeof e==`string`&&yn(e.charCodeAt(0),65024,65039)}function mn(e){return typeof e==`string`&&yn(e.charCodeAt(0),8400,8447)}function hn(e){let t=e.codePointAt(0);return typeof e==`string`&&typeof t==`number`&&yn(t,917504,917631)}function gn(e){return typeof e==`string`&&on.includes(e.charCodeAt(0))}function _n(e){return typeof e==`string`&&e.charCodeAt(0)===8205}function vn(e){let t=e.charCodeAt(0)-55296,n=e.charCodeAt(1)-56320;return(t<<10)+n+65536}function yn(e,t,n){return e>=t&&e<=n}var bn=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,xn=(e,t)=>Array.isArray(t)?t.some(t=>e.has(t)):e.has(t),Sn=(e,t,n)=>{e.has(t)?e.get(t)?.push(n):e.set(t,[n])},Cn=(()=>{let e=0;return()=>e++})(),wn={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:`south`,1:`east`,2:`west`,3:`north`,4:`lshoulder`,5:`rshoulder`,6:`ltrigger`,7:`rtrigger`,8:`select`,9:`start`,10:`lstick`,11:`rstick`,12:`dpad-up`,13:`dpad-down`,14:`dpad-left`,15:`dpad-right`,16:`home`,17:`capture`},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:`south`,1:`east`,2:`west`,3:`north`,4:`lshoulder`,5:`rshoulder`,9:`select`,10:`lstick`,16:`start`},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:`south`,1:`east`,2:`west`,3:`north`,4:`lshoulder`,5:`rshoulder`,9:`start`,10:`lstick`,16:`select`},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:`south`,1:`east`,2:`west`,3:`north`,4:`lshoulder`,5:`rshoulder`,6:`ltrigger`,7:`rtrigger`,8:`select`,9:`start`,10:`lstick`,11:`rstick`,12:`dpad-up`,13:`dpad-down`,14:`dpad-left`,15:`dpad-right`,16:`home`,17:`capture`},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:`south`,1:`east`,2:`west`,3:`north`,4:`lshoulder`,5:`rshoulder`,6:`ltrigger`,7:`rtrigger`,8:`select`,9:`start`,10:`lstick`,11:`rstick`,12:`dpad-up`,13:`dpad-down`,14:`dpad-left`,15:`dpad-right`,16:`home`},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function Tn(){let e=R.globalOpt.pixelDensity??1,t=R.globalOpt.width,n=R.globalOpt.height,r=R.gfx.ggl.gl.drawingBufferWidth,i=R.gfx.ggl.gl.drawingBufferHeight,a=r/e,o=i/e,s=0,c=0,l=a,u=o;if(R.globalOpt.letterbox){if(!t||!n)throw Error(`Letterboxing requires width and height defined.`);let e=a/o,r=t/n;if(e>r){let e=o*r;s=(a-e)/2,l=e}else{let e=a/r;u=e,c=(o-e)/2}}if(R.globalOpt.stretch&&(!R.globalOpt.width||!R.globalOpt.height))throw Error(`Stretching requires width and height defined.`);R.gfx.viewport={x:s,y:c,width:l,height:u,scale:(R.gfx.viewport.width+R.gfx.viewport.height)/(R.gfx.width+R.gfx.height)}}function En(e){return new d(e.x*R.gfx.viewport.width/R.gfx.width,e.y*R.gfx.viewport.height/R.gfx.height)}function Dn(e){return new d((e.x-R.gfx.viewport.x)*R.gfx.width/R.gfx.viewport.width,(e.y-R.gfx.viewport.y)*R.gfx.height/R.gfx.viewport.height)}var On=()=>Nn.lastInputDevice,kn=()=>{let e=Nn.buttons;for(let t in e){let n=e[t].keyboard&&[e[t].keyboard].flat(),r=e[t].keyboardCode&&[e[t].keyboardCode].flat(),i=e[t].gamepad&&[e[t].gamepad].flat(),a=e[t].mouse&&[e[t].mouse].flat();n&&n.forEach(e=>{Sn(Nn.buttonsByKey,e,t)}),r&&r.forEach(e=>{Sn(Nn.buttonsByKeyCode,e,t)}),i&&i.forEach(e=>{Sn(Nn.buttonsByGamepad,e,t)}),a&&a.forEach(e=>{Sn(Nn.buttonsByMouse,e,t)})}},An=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},jn=class{buttonState=new An;stickState=new Map},Mn=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((e,t)=>e+t)/this.dts.length)),this.dts=[])}},Nn,Pn=wn,Fn=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new Mn,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new d(0),mouseDeltaPos:new d(0),keyState:new An,mouseState:new An,mergedGamepadState:new jn,gamepadStates:new Map,lastInputDevice:null,buttonState:new An,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new Bt}},In=e=>{if(!e.canvas)throw Error(`Please provide a canvas`);let t=Fn(e);Nn=t,kn();function n(){return t.dt*t.timeScale}function r(){return t.fixedDt*t.timeScale}function i(){return t.restDt*t.timeScale}function a(){return t.isHidden}function o(){return t.time}function s(){return t.fpsCounter.fps}function c(){return t.numFrames}function u(){return t.canvas.toDataURL()}function p(e){t.canvas.style.cursor=e}function m(){return t.canvas.style.cursor}function h(e){if(e)try{let e=t.canvas.requestPointerLock();e?.catch&&e.catch(e=>console.error(e))}catch(e){console.error(e)}else document.exitPointerLock()}function g(){return!!document.pointerLockElement}function _(e){e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}function v(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function y(e=!0){e?_(t.canvas):v()}function b(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function x(){t.stopped=!0;let e=Object.entries(Ue),n=Object.entries(We),r=Object.entries(Ge);for(let[n,r]of e)t.canvas.removeEventListener(n,r);for(let[e,t]of n)document.removeEventListener(e,t);for(let[e,t]of r)window.removeEventListener(e,t);Xe.disconnect()}function S(r,i){t.loopID!==null&&cancelAnimationFrame(t.loopID);let a=0,o=0,s=c=>{if(t.stopped)return;if(document.visibilityState!==`visible`){t.loopID=requestAnimationFrame(s);return}let l=c/1e3,u=Math.min(l-t.realTime,.25),d=e.maxFPS?1/e.maxFPS:0;if(t.realTime=l,o+=u,o>d){if(!t.skipTime){for(a+=o,t.dt=t.fixedDt,t.restDt=0;a>t.fixedDt;)a-=t.fixedDt,a<t.fixedDt&&(t.restDt=a),r();t.restDt=a,t.dt=o,t.time+=n(),t.fpsCounter.tick(t.dt)}o=0,t.skipTime=!1,t.numFrames++,i(Re,ze)}t.loopID=requestAnimationFrame(s)};s(0)}function C(){return`ontouchstart`in window||navigator.maxTouchPoints>0}function w(){return t.mousePos.clone()}function T(){return t.mouseDeltaPos.clone()}function E(e=`left`){return t.mouseState.pressed.has(e)}function ee(e=`left`){return t.mouseState.down.has(e)}function D(e=`left`){return t.mouseState.released.has(e)}function te(){return t.isMouseMoved}function ne(e){return e===void 0?t.keyState.pressed.size>0:xn(t.keyState.pressed,e)}function re(e){return e===void 0?t.keyState.pressedRepeat.size>0:xn(t.keyState.pressedRepeat,e)}function O(e){return e===void 0?t.keyState.down.size>0:xn(t.keyState.down,e)}function ie(e){return e===void 0?t.keyState.released.size>0:xn(t.keyState.released,e)}function ae(e){return e===void 0?t.mergedGamepadState.buttonState.pressed.size>0:xn(t.mergedGamepadState.buttonState.pressed,e)}function oe(e){return e===void 0?t.mergedGamepadState.buttonState.down.size>0:xn(t.mergedGamepadState.buttonState.down,e)}function se(e){return e===void 0?t.mergedGamepadState.buttonState.released.size>0:xn(t.mergedGamepadState.buttonState.released,e)}function k(e){return e===void 0?t.buttonState.pressed.size>0:xn(t.buttonState.pressed,e)}function ce(e){return e===void 0?t.buttonState.down.size>0:xn(t.buttonState.down,e)}function le(e){return e===void 0?t.buttonState.released.size>0:xn(t.buttonState.released,e)}function A(e){return t.buttons?.[e]}function ue(e,n){t.buttons[e]={...t.buttons[e],...n}}function j(e){t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}function de(e){t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}function fe(e){return t.events.on(`resize`,e)}let pe=P(e=>t.events.on(`keyDown`,e),(e,n)=>t.events.on(`keyDown`,t=>bn(e,t)&&n(t))),M=P(e=>t.events.on(`keyPress`,t=>e(t)),(e,n)=>t.events.on(`keyPress`,t=>bn(e,t)&&n(t))),me=P(e=>t.events.on(`keyPressRepeat`,e),(e,n)=>t.events.on(`keyPressRepeat`,t=>bn(e,t)&&n(t))),he=P(e=>t.events.on(`keyRelease`,e),(e,n)=>t.events.on(`keyRelease`,t=>bn(e,t)&&n(t))),ge=P(e=>t.events.on(`mouseDown`,t=>e(t)),(e,n)=>t.events.on(`mouseDown`,t=>bn(e,t)&&n(t))),_e=P(e=>t.events.on(`mousePress`,t=>e(t)),(e,n)=>t.events.on(`mousePress`,t=>bn(e,t)&&n(t))),ve=P(e=>t.events.on(`mouseRelease`,t=>e(t)),(e,n)=>t.events.on(`mouseRelease`,t=>t===e&&n(t)));function ye(e){return t.events.on(`mouseMove`,()=>e(w(),T()))}function be(e){return t.events.on(`charInput`,e)}function xe(e){return t.events.on(`touchStart`,e)}function Se(e){return t.events.on(`touchMove`,e)}function Ce(e){return t.events.on(`touchEnd`,e)}function we(e){return t.events.on(`scroll`,e)}function Te(e){return t.events.on(`hide`,e)}function Ee(e){return t.events.on(`show`,e)}let De=P(e=>t.events.on(`gamepadButtonPress`,(t,n)=>e(t,n)),(e,n)=>t.events.on(`gamepadButtonPress`,(t,r)=>bn(e,t)&&n(t,r))),Oe=P(e=>t.events.on(`gamepadButtonDown`,(t,n)=>e(t,n)),(e,n)=>t.events.on(`gamepadButtonDown`,(t,r)=>bn(e,t)&&n(t,r))),ke=P(e=>t.events.on(`gamepadButtonRelease`,(t,n)=>e(t,n)),(e,n)=>t.events.on(`gamepadButtonRelease`,(t,r)=>bn(e,t)&&n(t,r)));function Ae(e,n){return t.events.on(`gamepadStick`,(t,r,i)=>t===e&&n(r,i))}function je(e){t.events.on(`gamepadConnect`,e)}function Me(e){t.events.on(`gamepadDisconnect`,e)}function Ne(e){return t.mergedGamepadState.stickState.get(e)||new d(0)}function N(){return[...t.charInputted]}function Pe(){return[...t.gamepads]}let Fe=P(e=>t.events.on(`buttonPress`,t=>e(t)),(e,n)=>t.events.on(`buttonPress`,t=>bn(e,t)&&n(t))),Ie=P(e=>t.events.on(`buttonDown`,t=>e(t)),(e,n)=>t.events.on(`buttonDown`,t=>bn(e,t)&&n(t))),Le=P(e=>t.events.on(`buttonRelease`,t=>e(t)),(e,n)=>t.events.on(`buttonRelease`,t=>bn(e,t)&&n(t)));function Re(){t.events.trigger(`input`),t.keyState.down.forEach(e=>t.events.trigger(`keyDown`,e)),t.mouseState.down.forEach(e=>t.events.trigger(`mouseDown`,e)),t.buttonState.down.forEach(e=>{t.events.trigger(`buttonDown`,e)}),He()}function ze(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((e,n)=>{t.mergedGamepadState.stickState.set(n,new d(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new d(0),t.gamepadStates.forEach(e=>{e.buttonState.update(),e.stickState.forEach((t,n)=>{e.stickState.set(n,new d(0))})})}function Be(e){let n={index:e.index,isPressed:n=>t.gamepadStates.get(e.index)?.buttonState.pressed.has(n)||!1,isDown:n=>t.gamepadStates.get(e.index)?.buttonState.down.has(n)||!1,isReleased:n=>t.gamepadStates.get(e.index)?.buttonState.released.has(n)||!1,getStick:n=>t.gamepadStates.get(e.index)?.stickState.get(n)||f()};return t.gamepads.push(n),t.gamepadStates.set(e.index,{buttonState:new An,stickState:new Map([[`left`,new d(0)],[`right`,new d(0)]])}),n}function Ve(e){t.gamepads=t.gamepads.filter(t=>t.index!==e.index),t.gamepadStates.delete(e.index)}function He(){for(let e of navigator.getGamepads())e&&!t.gamepadStates.has(e.index)&&Be(e);for(let n of t.gamepads){let r=navigator.getGamepads()[n.index];if(!r)continue;let i=(e.gamepads??{})[r.id]||Pn[r.id]||Pn.default,a=t.gamepadStates.get(n.index);if(a){for(let e=0;e<r.buttons.length;e++){let o=i.buttons[e],s=r.buttons[e],c=t.buttonsByGamepad.has(o);if(s.pressed){if(a.buttonState.down.has(o)){t.events.trigger(`gamepadButtonDown`,o,n);continue}t.lastInputDevice=`gamepad`,c&&t.buttonsByGamepad.get(o)?.forEach(e=>{t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}),t.mergedGamepadState.buttonState.press(o),a.buttonState.press(o),t.events.trigger(`gamepadButtonPress`,o,n)}else a.buttonState.down.has(o)&&(c&&t.buttonsByGamepad.get(o)?.forEach(e=>{t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}),t.mergedGamepadState.buttonState.release(o),a.buttonState.release(o),t.events.trigger(`gamepadButtonRelease`,o,n))}for(let e in i.sticks){let o=i.sticks[e];if(!o)continue;let s=new d(r.axes[o.x],r.axes[o.y]);a.stickState.set(e,s),t.mergedGamepadState.stickState.set(e,s),t.events.trigger(`gamepadStick`,e,s,n)}}}}let Ue={},We={},Ge={},Ke=e.pixelDensity||1;Ue.mousemove=e=>{let n=Dn(new d(e.offsetX,e.offsetY)),r=new d(e.movementX,e.movementY);if(b()){let r=t.canvas.width/Ke,i=t.canvas.height/Ke,a=window.innerWidth,o=window.innerHeight,s=a/o,c=r/i;if(s>c){let t=o/i,s=(a-r*t)/2;n.x=l(e.offsetX-s,0,r*t,0,r),n.y=l(e.offsetY,0,i*t,0,i)}else{let t=a/r,s=(o-i*t)/2;n.x=l(e.offsetX,0,r*t,0,r),n.y=l(e.offsetY-s,0,i*t,0,i)}}t.events.onOnce(`input`,()=>{t.isMouseMoved=!0,t.mousePos=n,t.mouseDeltaPos=r,t.events.trigger(`mouseMove`)})};let qe=[`left`,`middle`,`right`,`back`,`forward`];Ue.mousedown=e=>{t.events.onOnce(`input`,()=>{let n=qe[e.button];n&&(t.lastInputDevice=`mouse`,t.buttonsByMouse.has(n)&&t.buttonsByMouse.get(n)?.forEach(e=>{t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}),t.mouseState.press(n),t.events.trigger(`mousePress`,n))})},Ue.mouseup=e=>{t.events.onOnce(`input`,()=>{let n=qe[e.button];n&&(t.buttonsByMouse.has(n)&&t.buttonsByMouse.get(n)?.forEach(e=>{t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}),t.mouseState.release(n),t.events.trigger(`mouseRelease`,n))})};let Je=new Set([` `,`ArrowLeft`,`ArrowRight`,`ArrowUp`,`ArrowDown`,`Tab`]),Ye={ArrowLeft:`left`,ArrowRight:`right`,ArrowUp:`up`,ArrowDown:`down`," ":`space`};Ue.keydown=e=>{Je.has(e.key)&&e.preventDefault(),t.events.onOnce(`input`,()=>{let n=Ye[e.key]||e.key.toLowerCase(),r=e.code;if(n===void 0)throw Error(`Unknown key: ${e.key}`);n.length===1?(t.events.trigger(`charInput`,n),t.charInputted.push(n)):n===`space`&&(t.events.trigger(`charInput`,` `),t.charInputted.push(` `)),e.repeat?(t.keyState.pressRepeat(n),t.events.trigger(`keyPressRepeat`,n)):(t.lastInputDevice=`keyboard`,t.buttonsByKey.has(n)&&t.buttonsByKey.get(n)?.forEach(e=>{t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}),t.buttonsByKeyCode.has(r)&&t.buttonsByKeyCode.get(r)?.forEach(e=>{t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}),t.keyState.press(n),t.events.trigger(`keyPressRepeat`,n),t.events.trigger(`keyPress`,n))})},Ue.keyup=e=>{t.events.onOnce(`input`,()=>{let n=Ye[e.key]||e.key.toLowerCase(),r=e.code;t.buttonsByKey.has(n)&&t.buttonsByKey.get(n)?.forEach(e=>{t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}),t.buttonsByKeyCode.has(r)&&t.buttonsByKeyCode.get(r)?.forEach(e=>{t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}),t.keyState.release(n),t.events.trigger(`keyRelease`,n)})},Ue.touchstart=n=>{n.preventDefault(),t.events.onOnce(`input`,()=>{let r=[...n.changedTouches],i=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=Dn(new d(r[0].clientX-i.x,r[0].clientY-i.y)),t.lastInputDevice=`mouse`,t.buttonsByMouse.has(`left`)&&t.buttonsByMouse.get(`left`)?.forEach(e=>{t.buttonState.press(e),t.events.trigger(`buttonPress`,e)}),t.mouseState.press(`left`),t.events.trigger(`mousePress`,`left`)),r.forEach(e=>{t.events.trigger(`touchStart`,Dn(new d(e.clientX-i.x,e.clientY-i.y)),e)})})},Ue.touchmove=n=>{n.preventDefault(),t.events.onOnce(`input`,()=>{let r=[...n.changedTouches],i=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let e=t.mousePos;t.mousePos=Dn(new d(r[0].clientX-i.x,r[0].clientY-i.y)),t.mouseDeltaPos=t.mousePos.sub(e),t.events.trigger(`mouseMove`)}r.forEach(e=>{t.events.trigger(`touchMove`,Dn(new d(e.clientX-i.x,e.clientY-i.y)),e)})})},Ue.touchend=n=>{t.events.onOnce(`input`,()=>{let r=[...n.changedTouches],i=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=Dn(new d(r[0].clientX-i.x,r[0].clientY-i.y)),t.mouseDeltaPos=new d(0,0),t.buttonsByMouse.has(`left`)&&t.buttonsByMouse.get(`left`)?.forEach(e=>{t.buttonState.release(e),t.events.trigger(`buttonRelease`,e)}),t.mouseState.release(`left`),t.events.trigger(`mouseRelease`,`left`)),r.forEach(e=>{t.events.trigger(`touchEnd`,Dn(new d(e.clientX-i.x,e.clientY-i.y)),e)})})},Ue.touchcancel=n=>{t.events.onOnce(`input`,()=>{let r=[...n.changedTouches],i=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=Dn(new d(r[0].clientX-i.x,r[0].clientY-i.y)),t.mouseState.release(`left`),t.events.trigger(`mouseRelease`,`left`)),r.forEach(e=>{t.events.trigger(`touchEnd`,Dn(new d(e.clientX-i.x,e.clientY-i.y)),e)})})},Ue.wheel=e=>{e.preventDefault(),t.events.onOnce(`input`,()=>{t.events.trigger(`scroll`,new d(e.deltaX,e.deltaY))})},Ue.contextmenu=e=>e.preventDefault(),We.visibilitychange=()=>{document.visibilityState===`visible`?(t.skipTime=!0,t.isHidden=!1,t.events.trigger(`show`)):(t.isHidden=!0,t.events.trigger(`hide`))},Ge.gamepadconnected=e=>{let n=Be(e.gamepad);t.events.onOnce(`input`,()=>{t.events.trigger(`gamepadConnect`,n)})},Ge.gamepaddisconnected=e=>{let n=Pe().filter(t=>t.index===e.gamepad.index)[0];Ve(e.gamepad),t.events.onOnce(`input`,()=>{t.events.trigger(`gamepadDisconnect`,n)})};for(let[e,n]of Object.entries(Ue))t.canvas.addEventListener(e,n);for(let[e,t]of Object.entries(We))document.addEventListener(e,t);for(let[e,t]of Object.entries(Ge))window.addEventListener(e,t);let Xe=new ResizeObserver(e=>{for(let n of e)if(n.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce(`input`,()=>{t.events.trigger(`resize`)})}});return Xe.observe(t.canvas),{state:t,dt:n,fixedDt:r,restDt:i,time:o,run:S,canvas:t.canvas,fps:s,numFrames:c,quit:x,isHidden:a,setFullscreen:y,isFullscreen:b,setCursor:p,screenshot:u,getGamepads:Pe,getCursor:m,setCursorLocked:h,isCursorLocked:g,isTouchscreen:C,mousePos:w,mouseDeltaPos:T,isKeyDown:O,isKeyPressed:ne,isKeyPressedRepeat:re,isKeyReleased:ie,isMouseDown:ee,isMousePressed:E,isMouseReleased:D,isMouseMoved:te,isGamepadButtonPressed:ae,isGamepadButtonDown:oe,isGamepadButtonReleased:se,getGamepadStick:Ne,isButtonPressed:k,isButtonDown:ce,isButtonReleased:le,setButton:ue,getButton:A,pressButton:j,releaseButton:de,charInputted:N,onResize:fe,onKeyDown:pe,onKeyPress:M,onKeyPressRepeat:me,onKeyRelease:he,onMouseDown:ge,onMousePress:_e,onMouseRelease:ve,onMouseMove:ye,onCharInput:be,onTouchStart:xe,onTouchMove:Se,onTouchEnd:Ce,onScroll:we,onHide:Te,onShow:Ee,onGamepadButtonDown:Oe,onGamepadButtonPress:De,onGamepadButtonRelease:ke,onGamepadStick:Ae,onGamepadConnect:je,onGamepadDisconnect:Me,onButtonPress:Fe,onButtonDown:Ie,onButtonRelease:Le,getLastInputDeviceType:On,events:t.events}};function F(){return R.app.dt()}function Ln(){return R.app.fixedDt()}function Rn(){return R.app.restDt()}var zn=new d(-1,-1),Bn=new d(0,-1),Vn=new d(1,-1),Hn=new d(-1,0),Un=new d(0,0),Wn=new d(1,0),Gn=new d(-1,1),Kn=new d(0,1),qn=new d(1,1);function Jn(e){switch(e){case`topleft`:return zn;case`top`:return Bn;case`topright`:return Vn;case`left`:return Hn;case`center`:return Un;case`right`:return Wn;case`botleft`:return Gn;case`bot`:return Kn;case`botright`:return qn;default:return e}}function Yn(e){switch(e){case`left`:return 0;case`center`:return .5;case`right`:return 1;default:return 0}}function Xn(e){return e.createBuffer(1,1,44100)}var Zn=2.5949095,Qn=2.70158,$n=2*Math.PI/3,er=2*Math.PI/4.5,tr={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-(-2*e+2)**2/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-(1-e)**3,easeInOutCubic:e=>e<.5?4*e*e*e:1-(-2*e+2)**3/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-(1-e)**4,easeInOutQuart:e=>e<.5?8*e*e*e*e:1-(-2*e+2)**4/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-(1-e)**5,easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-(-2*e+2)**5/2,easeInExpo:e=>e===0?0:2**(10*e-10),easeOutExpo:e=>e===1?1:1-2**(-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?2**(20*e-10)/2:(2-2**(-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-e**2),easeOutCirc:e=>Math.sqrt(1-(e-1)**2),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-(2*e)**2))/2:(Math.sqrt(1-(-2*e+2)**2)+1)/2,easeInBack:e=>Qn*e*e*e-1.70158*e*e,easeOutBack:e=>1+Qn*(e-1)**3+1.70158*(e-1)**2,easeInOutBack:e=>e<.5?(2*e)**2*((Zn+1)*2*e-Zn)/2:((2*e-2)**2*((Zn+1)*(e*2-2)+Zn)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-(2**(10*e-10))*Math.sin((e*10-10.75)*$n),easeOutElastic:e=>e===0?0:e===1?1:2**(-10*e)*Math.sin((e*10-.75)*$n)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(2**(20*e-10)*Math.sin((20*e-11.125)*er))/2:2**(-20*e+10)*Math.sin((20*e-11.125)*er)/2+1,easeInBounce:e=>1-tr.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-tr.easeOutBounce(1-2*e))/2:(1+tr.easeOutBounce(2*e-1))/2},nr=tr;function rr(e,t,n){let r=[],i=t;for(r.push(i);i!==e;){if(i=n.get(i),i==null)return null;r.push(i)}return r.reverse()}function ir(e,t,n){let r=new Wt((e,t)=>e.cost<t.cost);r.insert({cost:0,node:t});let i=new Map;i.set(t,t);let a=new Map;for(a.set(t,0);r.length!==0;){let t=r.remove()?.node;if(t===n)break;let o=e.getNeighbours(t);for(let s of o){let o=(a.get(t)||0)+e.getCost(t,s)+e.getHeuristic(s,n);(!a.has(s)||o<a.get(s))&&(a.set(s,o),r.insert({cost:o,node:s}),i.set(s,t))}}return rr(t,n,i)}var ar=class{a;b;polygon;constructor(e,t,n){this.a=e,this.b=t,this.polygon=new WeakRef(n)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},or=class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,n=0,r=0;for(let e of this._edges){e.polygon=new WeakRef(this);let i=e.a.x*e.b.y-e.a.y*e.b.x;t+=(e.a.x+e.b.x)*i,n+=(e.a.y+e.b.y)*i,r+=i}r/=2,this._centroid=f(t/(6*r),n/(6*r))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let n of this.edges)n.b.y>e.y!=n.a.y>e.y&&e.x<(n.a.x-n.b.x)*(e.y-n.b.y)/(n.a.y-n.b.y)+n.b.x&&(t=!t);return t}},sr=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let n=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[n]}_findCommonEdge(e,t){for(let n of e.edges){let e=this._findEdge(n.b,n.a);if(e&&e.polygon.deref().id===t.id)return e}return null}addPolygon(e){let t=new or(this._polygons.length);t.edges=e.map((n,r)=>new ar(n,e[(r+1)%e.length],t)),this._polygons.push(t);for(let e of t.edges)this._addEdge(e);return t}addRect(e,t){let n=this._addPoint(e),r=this._addPoint(e.add(t.x,0)),i=this._addPoint(e.add(t)),a=this._addPoint(e.add(0,t.y));return this.addPolygon([n,r,i,a])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let n of this._polygons[e].edges){let e=this._findEdge(n.b,n.a);if(e){let n=e.polygon.deref();n&&t.push(n.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let n=this._polygons[e],r=this._polygons[t],i=n.centroid.x-r.centroid.x,a=n.centroid.y-r.centroid.y;return Math.sqrt(i*i+a*a)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:ir(this,e,t)}getWaypointPath(e,t,n){let r=n?.type||`centroids`,i=this._getLocation(e),a=this._getLocation(t);if(i===void 0||a===void 0)return[];let o=this.getPath(i.id,a.id);if(!o)return[];if(r===`edges`){let n=[];for(let e=1;e<o.length;e++){let t=this._polygons[o[e-1]],r=this._polygons[o[e]],i=this._findCommonEdge(t,r);n.push(i.middle.add(r.centroid.sub(i.middle).unit().scale(4)))}return[e,...n,t]}else return[e,...o.slice(1,-1).map(e=>this._polygons[e].centroid),t]}};function cr(e){let t=new _;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function lr(e){return new d(e.x/L()*2-1,-e.y/yr()*2+1)}function ur(e,t,n,r,i,a=1){r=o(r%360),i=o(i%360),i<=r&&(i+=Math.PI*2);let s=[],c=Math.ceil((i-r)/o(8)*a),l=(i-r)/c,u=f(Math.cos(r),Math.sin(r)),d=f(Math.cos(l),Math.sin(l));for(let r=0;r<=c;r++)s.push(e.add(t*u.x,n*u.y)),u=f(u.x*d.x-u.y*d.y,u.x*d.y+u.y*d.x);return s}function dr(...e){let t=i(...e),n=e[3]??1;R.gfx.bgColor=t,R.gfx.bgAlpha=n,R.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,n)}function fr(){return R.gfx.bgColor?.clone?.()??null}function I(...e){if(e[0]===void 0)return;let t=f(...e);t.x===0&&t.y===0||R.gfx.transform.translate(t)}function pr(){R.gfx.transformStack.push(R.gfx.transform.clone())}function mr(e){R.gfx.transform=e.clone()}function hr(...e){if(e[0]===void 0)return;let t=f(...e);t.x===1&&t.y===1||R.gfx.transform.scale(t)}function gr(e){e&&R.gfx.transform.rotate(e)}function _r(){R.gfx.transformStack.length>0&&(R.gfx.transform=R.gfx.transformStack.pop())}function vr(){R.gfx.renderer.flush()}function L(){return R.gfx.width}function yr(){return R.gfx.height}function br(){return(R.gfx.viewport.width+R.gfx.viewport.height)/(R.gfx.width+R.gfx.height)}function xr(){return f(L()/2,yr()/2)}var Sr=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,n,r){this.gfx=e,this.canvas=document.createElement(`canvas`),this.canvas.width=t,this.canvas.height=n,this.textures=[wi.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=r;let i=this.canvas.getContext(`2d`);if(!i)throw Error(`Failed to get 2d context`);this.c2d=i}addSingle(e){let t=wi.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new p(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,n=e.height+this.padding*2;if(t>this.canvas.width||n>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+n>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(wi.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let r=this.textures[this.textures.length-1],i=new d(this.x+this.padding,this.y+this.padding);return this.x+=t,n>this.curHeight&&(this.curHeight=n),e instanceof ImageData?this.c2d.putImageData(e,i.x,i.y):this.c2d.drawImage(e,i.x,i.y),r.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:i,size:new d(e.width,e.height),texture:r}),this.lastTextureId++,[r,new p(i.x/this.canvas.width,i.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function Cr(e){return typeof e!=`string`||Zt(e)?e:R.assets.urlPrefix+e}var wr=class e{loaded=!1;data=null;error=null;onLoadEvents=new zt;onErrorEvents=new zt;onFinishEvents=new zt;constructor(e){e.then(e=>{this.loaded=!0,this.data=e,this.onLoadEvents.trigger(e)}).catch(e=>{if(this.error=e,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(e);else throw e}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let n=new e(Promise.resolve(t));return n.data=t,n.loaded=!0,n}onLoad(e){return this.loaded&&this.data?e(this.data):this.onLoadEvents.add(e),this}onError(e){return this.loaded&&this.error?e(this.error):this.onErrorEvents.add(e),this}onFinish(e){return this.loaded?e():this.onFinishEvents.add(e),this}then(e){return this.onLoad(e)}catch(e){return this.onError(e)}finally(e){return this.onFinish(e)}},Tr=class{assets=new Map;lastUID=0;add(e,t){let n=e??this.lastUID+++``,r=new wr(t);return this.assets.set(n,r),r}addLoaded(e,t){let n=e??this.lastUID+++``,r=wr.loaded(t);return this.assets.set(n,r),r}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function Er(e){return fetch(e).then(t=>{if(!t.ok)throw Error(`Failed to fetch "${e}"`);return t})}function Dr(e){return Er(e).then(e=>e.json())}function Or(e){return Er(e).then(e=>e.text())}function kr(e){return Er(e).then(e=>e.arrayBuffer())}function Ar(e){return e!==void 0&&(R.assets.urlPrefix=e),R.assets.urlPrefix}function jr(e,t){return R.assets.custom.add(e,Dr(Cr(t)))}function Mr(e){let t=new Image;return t.crossOrigin=`anonymous`,t.src=e,new Promise((n,r)=>{t.onload=()=>n(t),t.onerror=()=>r(Error(`Failed to load image from "${e}"`))})}function Nr(){let e=[R.assets.sprites,R.assets.sounds,R.assets.shaders,R.assets.fonts,R.assets.bitmapFonts,R.assets.custom];return e.reduce((e,t)=>e+t.progress(),0)/e.length}function Pr(){return[R.assets.sprites,R.assets.sounds,R.assets.shaders,R.assets.fonts,R.assets.bitmapFonts,R.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function Fr(e){return R.assets.custom.get(e)??null}function Ir(e){return R.assets.custom.add(null,e)}var Lr=(e,t)=>({urlPrefix:``,sprites:new Tr,fonts:new Tr,bitmapFonts:new Tr,sounds:new Tr,shaders:new Tr,custom:new Tr,music:{},packer:new Sr(e,2048,2048,t),loaded:!1}),Rr=`data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==`,zr=class e{tex;frames=[new p(0,0,1,1)];anims={};slice9=null;constructor(e,t,n={},r=null){this.tex=e,t&&(this.frames=t),this.anims=n,this.slice9=r}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,n={}){return typeof t==`string`?e.fromURL(t,n):Promise.resolve(e.fromImage(t,n))}static fromImage(t,n={}){let[r,i]=n.singular?R.assets.packer.addSingle(t):R.assets.packer.add(t),a=n.frames?n.frames.map(e=>new p(i.x+e.x*i.w,i.y+e.y*i.h,e.w*i.w,e.h*i.h)):Ur(n.sliceX||1,n.sliceY||1,i.x,i.y,i.w,i.h);return new e(r,a,n.anims,n.slice9)}static fromURL(t,n={}){return Mr(t).then(t=>e.fromImage(t,n))}};function Br(e){if(typeof e==`string`){let t=Vr(e);if(t)return t;if(Nr()<1)return null;throw Error(`Sprite not found: ${e}`)}else{if(e instanceof zr)return wr.loaded(e);if(e instanceof wr)return e;throw Error(`Invalid sprite: ${e}`)}}function Vr(e){return R.assets.sprites.get(e)??null}function Hr(e,t,n={sliceX:1,sliceY:1,anims:{}}){return t=Cr(t),Array.isArray(t)?t.some(e=>typeof e==`string`)?R.assets.sprites.add(e,Promise.all(t.map(e=>typeof e==`string`?Mr(e):Promise.resolve(e))).then(e=>Wr(e,n))):R.assets.sprites.addLoaded(e,Wr(t,n)):typeof t==`string`?R.assets.sprites.add(e,zr.from(t,n)):R.assets.sprites.addLoaded(e,zr.fromImage(t,n))}function Ur(e=1,t=1,n=0,r=0,i=1,a=1){let o=[],s=i/e,c=a/t;for(let i=0;i<t;i++)for(let t=0;t<e;t++)o.push(new p(n+t*s,r+i*c,s,c));return o}function Wr(e,t={}){let n=document.createElement(`canvas`),r=e[0].width,i=e[0].height;n.width=r*e.length,n.height=i;let a=n.getContext(`2d`);if(!a)throw Error(`Failed to create canvas context`);e.forEach((e,t)=>{e instanceof ImageData?a.putImageData(e,t*r,0):a.drawImage(e,t*r,0)});let o=a.getImageData(0,0,e.length*r,i);return zr.fromImage(o,{...t,sliceX:e.length,sliceY:1})}function Gr(e=`bean`){return Hr(e,Rr)}function Kr(e,t,n){t=Cr(t),n=Cr(n),typeof t==`string`&&!n&&(n=Qt(t)+`.json`);let r=typeof n==`string`?Dr(n):Promise.resolve(n);return R.assets.sprites.add(e,r.then(e=>{let n=e.meta.size,r=e.frames.map(e=>new p(e.frame.x/n.w,e.frame.y/n.h,e.frame.w/n.w,e.frame.h/n.h)),i={};for(let t of e.meta.frameTags)t.from===t.to?i[t.name]=t.from:i[t.name]={from:t.from,to:t.to,speed:10,loop:!0,pingpong:t.direction===`pingpong`};return zr.from(t,{frames:r,anims:i})}))}var qr=class{fontface;filter=xt;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??xt,this.size=t.size??64,this.size>256)throw Error(`Max font size: 256`);t.outline&&(this.outline={width:1,color:i(0,0,0)},typeof t.outline==`number`?this.outline.width=t.outline:typeof t.outline==`object`&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function Jr(e){if(!e)return Jr(R.globalOpt.font??yt);if(typeof e==`string`){let t=Qr(e),n=Yr(e);if(t)return t.data??t;if(n)return n.data??n;if(document.fonts.check(`64px ${e}`))return e;if(Nr()<1)return null;throw Error(`Font not found: ${e}`)}else if(e instanceof wr)return e.data?e.data:e;return e}function Yr(e){return R.assets.fonts.get(e)??null}function Xr(e,t,n={}){let r=Cr(t),i=new FontFace(e,typeof t==`string`?`url(${r})`:r);return document.fonts.add(i),R.assets.fonts.add(e,i.load().catch(e=>{throw Error(`Failed to load font from "${r}": ${e}`)}).then(e=>new qr(e,n)))}function Zr(e,t,n,r){let i=e.width/t,a={},o=r.split(``).entries();for(let[e,r]of o)a[r]=new p(e%i*t,Math.floor(e/i)*n,t,n);return{tex:e,map:a,size:n}}function Qr(e){return R.assets.bitmapFonts.get(e)??null}function $r(e,t,n,r,i={}){let a=Cr(t);return R.assets.bitmapFonts.add(e,Mr(a).then(e=>Zr(wi.fromImage(R.gfx.ggl,e,i),n,r,i.chars??_t)))}function ei(e,t){return t=Cr(t),R.assets.sprites.add(e,new Promise(async e=>{let n=typeof t==`string`?await Dr(t):t,r=await Promise.all(n.frames.map(Mr)),i=document.createElement(`canvas`);i.width=n.width,i.height=n.height*n.frames.length;let a=i.getContext(`2d`);if(!a)throw Error(`Failed to create canvas context`);r.forEach((e,t)=>{a.drawImage(e,0,t*n.height)});let o=await Hr(null,i,{sliceY:n.frames.length,anims:n.anims});e(o)}))}var ti=class{ctx;glProgram;constructor(e,t,n,r){this.ctx=e,e.onDestroy(()=>this.free());let i=e.gl,a=i.createShader(i.VERTEX_SHADER),o=i.createShader(i.FRAGMENT_SHADER);if(!a||!o)throw Error(`Failed to create shader`);i.shaderSource(a,t),i.shaderSource(o,n),i.compileShader(a),i.compileShader(o);let s=i.createProgram();if(this.glProgram=s,i.attachShader(s,a),i.attachShader(s,o),r.forEach((e,t)=>i.bindAttribLocation(s,t,e)),i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS)){let e=i.getShaderInfoLog(a);if(e)throw Error(`VERTEX SHADER `+e);let t=i.getShaderInfoLog(o);if(t)throw Error(`FRAGMENT SHADER `+t)}i.deleteShader(a),i.deleteShader(o)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let n in e){let i=e[n],a=t.getUniformLocation(this.glProgram,n);if(typeof i==`number`)t.uniform1f(a,i);else if(i instanceof _)t.uniformMatrix4fv(a,!1,new Float32Array(i.m));else if(i instanceof r)t.uniform3f(a,i.r,i.g,i.b);else if(i instanceof d)t.uniform2f(a,i.x,i.y);else if(Array.isArray(i))i[0],Ut(i)?t.uniform1fv(a,i):Ht(i)?t.uniform2fv(a,i.map(e=>[e.x,e.y]).flat()):Vt(i)&&t.uniform3fv(a,i.map(e=>[e.r,e.g,e.b]).flat());else throw Error(`Unsupported uniform data type`)}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function ni(e,t=kt,n=At){let r=Dt.replace(`{{user}}`,t??kt),i=Ot.replace(`{{user}}`,n??At);try{return new ti(e,r,i,St.map(e=>e.name))}catch(e){let t=tn(e).match(/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/);if(!t?.groups)throw e;let n=Number(t.groups.line)-14,r=t.groups.msg.trim(),i=t.groups.type.toLowerCase();throw Error(`${i} shader line ${n}: ${r}`)}}function ri(e){if(!e)return R.gfx.defShader;if(typeof e==`string`){let t=ii(e);if(t)return t.data??t;if(Nr()<1)return null;throw Error(`Shader not found: ${e}`)}else if(e instanceof wr)return e.data?e.data:e;return e}function ii(e){return R.assets.shaders.get(e)??null}function ai(e,t,n){return R.assets.shaders.addLoaded(e,ni(R.gfx.ggl,t,n))}function oi(e,t,n){t=Cr(t),n=Cr(n);let r=e=>e?Or(e):Promise.resolve(null),i=Promise.all([r(t),r(n)]).then(([e,t])=>ni(R.gfx.ggl,e,t));return R.assets.shaders.add(e,i)}var si=class e{buf;constructor(e){this.buf=e}static fromArrayBuffer(t){return new Promise((e,n)=>R.audio.ctx.decodeAudioData(t,e,n)).then(t=>new e(t))}static fromURL(t){return Zt(t)?e.fromArrayBuffer(Kt(t)):kr(t).then(t=>e.fromArrayBuffer(t))}};function ci(e){if(typeof e==`string`){let t=li(e);if(t)return t;if(Nr()<1)return null;throw Error(`Sound not found: ${e}`)}else{if(e instanceof si)return wr.loaded(e);if(e instanceof wr)return e;throw Error(`Invalid sound: ${e}`)}}function li(e){return R.assets.sounds.get(e)??null}function ui(e,t){return t=Cr(t),R.assets.sounds.add(e,typeof t==`string`?si.fromURL(t):si.fromArrayBuffer(t))}function di(e,t){let n=Cr(t),r=new Audio(n);return r.preload=`auto`,R.assets.music[e]=n}function fi(e,t){return e=Cr(e),Ir(typeof t==`string`?new Promise((n,r)=>{Dr(t).then(t=>{fi(e,t).then(n).catch(r)})}):zr.from(e).then(e=>{let n={};for(let r in t){let i=t[r],a=e.frames[0],o=2048*a.w,s=2048*a.h,c=i.frames?i.frames.map(e=>new p(a.x+(i.x+e.x)/o*a.w,a.y+(i.y+e.y)/s*a.h,e.w/o*a.w,e.h/s*a.h)):Ur(i.sliceX||1,i.sliceY||1,a.x+i.x/o*a.w,a.y+i.y/s*a.h,i.width/o*a.w,i.height/s*a.h),l=new zr(e.tex,c,i.anims);R.assets.sprites.addLoaded(r,l),n[r]=l}return n}))}function pi(e,t,n=!1,r,i,a={}){let o=r??R.gfx.defTex,s=i??R.gfx.defShader,c=ri(s);if(!c||c instanceof wr)return;let l=R.gfx.fixed||n?R.gfx.transform:R.game.cam.transform.mult(R.gfx.transform),u=[];for(let t of e){let e=lr(l.multVec2(t.pos));u.push(e.x,e.y,t.uv.x,t.uv.y,t.color.r/255,t.color.g/255,t.color.b/255,t.opacity)}R.gfx.renderer.push(R.gfx.ggl.gl.TRIANGLES,u,t,c,o,a)}function mi(e){if(!e.pts)throw Error(`drawPolygon() requires property "pts".`);let t=e.pts.length;if(!(t<3)){if(pr(),I(e.pos),hr(e.scale),gr(e.angle),I(e.offset),e.fill!==!1){let n=e.color??r.WHITE,i=e.pts.map((t,r)=>({pos:new d(t.x,t.y),uv:e.uv?e.uv[r]:new d(0,0),color:e.colors&&e.colors[r]?e.colors[r].mult(n):n,opacity:e.opacity??1})),a;a=e.triangulate?ht(e.pts).map(t=>t.map(t=>e.pts.indexOf(t))).flat():[...Array(t-2).keys()].map(e=>[0,e+1,e+2]).flat(),pi(i,e.indices??a,e.fixed,e.uv?e.tex:R.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&xi({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),_r()}}function hi(e){if(e.radiusX===void 0||e.radiusY===void 0)throw Error(`drawEllipse() requires properties "radiusX" and "radiusY".`);if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,n=e.end??360,r=Jn(e.anchor??`center`).scale(new d(-e.radiusX,-e.radiusY)),i=ur(r,e.radiusX,e.radiusY,t,n,e.resolution);i.unshift(r);let a=Object.assign({},e,{pts:i,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(i.length-1).fill(e.gradient[1])]}:{}});if(n-t>=360&&e.outline){e.fill!==!1&&mi(Object.assign({},a,{outline:null})),mi(Object.assign({},a,{pts:i.slice(1),fill:!1}));return}mi(a)}function gi(e){if(typeof e.radius!=`number`)throw Error(`drawCircle() requires property "radius".`);e.radius!==0&&hi(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function _i(e){let{p1:t,p2:n}=e;if(!t||!n)throw Error(`drawLine() requires properties "p1" and "p2".`);let i=e.width||1,a=n.sub(t).unit().normal().scale(i*.5),o=[t.sub(a),t.add(a),n.add(a),n.sub(a)].map(t=>({pos:new d(t.x,t.y),uv:new d(0),color:e.color??r.WHITE,opacity:e.opacity??1}));pi(o,[0,1,3,1,2,3],e.fixed,R.gfx.defTex,e.shader,e.uniform??void 0)}function vi(e){let t=e.pts,n=[],i=(e.width||1)*.5,a=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),o=e.pos||f(0,0),s;s=a?t[0].sub(t[t.length-2]):t[1].sub(t[0]);let c=s.len(),l=s.normal().scale(-i/c),u,d=t[0];if(!a)switch(e.cap){case`square`:{let e=s.scale(-i/c);n.push(d.add(e).add(l)),n.push(d.add(e).sub(l));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=l.scale(-1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)n.push(d),n.push(d.sub(r)),r=f(r.x*a-r.y*o,r.x*o+r.y*a)}}for(let e=1;e<t.length;e++){if(d===t[e]||d.eq(t[e]))continue;u=d,d=t[e];let r=d.sub(u),a=r.len(),o=r.normal().scale(-i/a),f=s.cross(r);if(Math.abs(f)/(c*a)<.05){n.push(u.add(l)),n.push(u.sub(l)),s.dot(r)<0&&(n.push(u.sub(l)),n.push(u.add(l))),s=r,c=a,l=o;continue}let p=o.sub(l).cross(r)/f,m=l.add(s.scale(p));f>0?(n.push(u.add(m)),n.push(u.sub(l)),n.push(u.add(m)),n.push(u.sub(o))):(n.push(u.add(l)),n.push(u.sub(m)),n.push(u.add(o)),n.push(u.sub(m))),s=r,c=a,l=o}if(!a)switch(n.push(d.add(l)),n.push(d.sub(l)),e.cap){case`square`:{let e=s.scale(i/c);n.push(d.add(e).add(l)),n.push(d.add(e).sub(l));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=l.scale(1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)r=f(r.x*a-r.y*o,r.x*o+r.y*a),n.push(d),n.push(d.sub(r))}}if(n.length<4)return;let p=n.map(t=>({pos:o.add(t),uv:f(),color:e.color||r.WHITE,opacity:e.opacity??1})),m=[],h=0;for(let e=0;e<n.length-2;e+=2)m[h++]=e+1,m[h++]=e,m[h++]=e+2,m[h++]=e+2,m[h++]=e+3,m[h++]=e+1;a&&(m[h++]=n.length-1,m[h++]=n.length-2,m[h++]=0,m[h++]=0,m[h++]=1,m[h++]=n.length-1),pi(p,m,e.fixed,R.gfx.defTex,e.shader,e.uniform??void 0)}function yi(e){let t=e.pts,n=[],i=(e.width||1)*.5,a=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),s=e.pos||f(0,0),c;c=a?t[0].sub(t[t.length-2]):t[1].sub(t[0]);let l=c.len(),u=c.normal().scale(-i/l),d,p=t[0];if(!a)switch(e.cap){case`square`:{let e=c.scale(-i/l);n.push(p.add(e).add(u)),n.push(p.add(e).sub(u));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=u.scale(-1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)n.push(p),n.push(p.sub(r)),r=f(r.x*a-r.y*o,r.x*o+r.y*a)}}for(let e=1;e<t.length;e++){if(p===t[e]||p.eq(t[e]))continue;d=p,p=t[e];let r=p.sub(d),a=r.len(),s=r.normal().scale(-i/a),m=c.cross(r);if(Math.abs(m)/(l*a)<.05){n.push(d.add(u)),n.push(d.sub(u)),c.dot(r)<0&&(n.push(d.sub(u)),n.push(d.add(u))),c=r,l=a,u=s;continue}let h=s.sub(u).cross(r)/m,g=u.add(c.scale(h));if(m>0){let e=d.add(g),t=Math.max(i,10),r=o(u.angleBetween(s)/t),a=u,c=Math.cos(r),l=Math.sin(r);for(let r=0;r<t;r++)n.push(e),n.push(d.sub(a)),a=f(a.x*c-a.y*l,a.x*l+a.y*c)}else{let e=d.sub(g),t=Math.max(i,10),r=o(u.angleBetween(s)/t),a=u,c=Math.cos(r),l=Math.sin(r);for(let r=0;r<t;r++)n.push(d.add(a)),n.push(e),a=f(a.x*c-a.y*l,a.x*l+a.y*c)}c=r,l=a,u=s}if(!a)switch(n.push(p.add(u)),n.push(p.sub(u)),e.cap){case`square`:{let e=c.scale(i/l);n.push(p.add(e).add(u)),n.push(p.add(e).sub(u));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=u.scale(1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)r=f(r.x*a-r.y*o,r.x*o+r.y*a),n.push(p),n.push(p.sub(r))}}if(n.length<4)return;let m=n.map(t=>({pos:s.add(t),uv:f(),color:e.color||r.WHITE,opacity:e.opacity??1})),h=[],g=0;for(let e=0;e<n.length-2;e+=2)h[g++]=e+1,h[g++]=e,h[g++]=e+2,h[g++]=e+2,h[g++]=e+3,h[g++]=e+1;a&&(h[g++]=n.length-1,h[g++]=n.length-2,h[g++]=0,h[g++]=0,h[g++]=1,h[g++]=n.length-1),pi(m,h,e.fixed,R.gfx.defTex,e.shader,e.uniform??void 0)}function bi(e){let t=e.pts,n=[],i=(e.width||1)*.5,a=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),o=e.pos||f(0,0),s;s=a?t[0].sub(t[t.length-2]):t[1].sub(t[0]);let c=s.len(),l=s.normal().scale(-i/c),u,d=t[0];if(!a)switch(e.cap){case`square`:{let e=s.scale(-i/c);n.push(d.add(e).add(l)),n.push(d.add(e).sub(l));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=l.scale(-1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)n.push(d),n.push(d.sub(r)),r=f(r.x*a-r.y*o,r.x*o+r.y*a)}}for(let e=1;e<t.length;e++){if(d===t[e]||d.eq(t[e]))continue;u=d,d=t[e];let r=d.sub(u),a=r.len(),o=r.normal().scale(-i/a),f=s.cross(r);if(Math.abs(f)/(c*a)<.05){n.push(u.add(l)),n.push(u.sub(l)),s.dot(r)<0&&(n.push(u.sub(l)),n.push(u.add(l))),s=r,c=a,l=o;continue}let p=o.sub(l).cross(r)/f,m=l.add(s.scale(p));n.push(u.add(m)),n.push(u.sub(m)),s=r,c=a,l=o}if(!a)switch(n.push(d.add(l)),n.push(d.sub(l)),e.cap){case`square`:{let e=s.scale(i/c);n.push(d.add(e).add(l)),n.push(d.add(e).sub(l));break}case`round`:{let e=Math.max(i,10),t=Math.PI/e,r=l.scale(1),a=Math.cos(t),o=Math.sin(t);for(let t=0;t<e;t++)r=f(r.x*a-r.y*o,r.x*o+r.y*a),n.push(d),n.push(d.sub(r))}}if(n.length<4)return;let p=n.map(t=>({pos:o.add(t),uv:f(),color:e.color||r.WHITE,opacity:e.opacity??1})),m=[],h=0;for(let e=0;e<n.length-2;e+=2)m[h++]=e+1,m[h++]=e,m[h++]=e+2,m[h++]=e+2,m[h++]=e+3,m[h++]=e+1;a&&(m[h++]=n.length-1,m[h++]=n.length-2,m[h++]=0,m[h++]=0,m[h++]=1,m[h++]=n.length-1),pi(p,m,e.fixed,R.gfx.defTex,e.shader,e.uniform??void 0)}function xi(e){let t=e.pts,n=e.width??1;if(!t)throw Error(`drawLines() requires property "pts".`);if(!(t.length<2)){if(t.length>2)switch(e.join){case`bevel`:return vi(e);case`round`:return yi(e);case`miter`:return bi(e)}if(e.radius&&t.length>=3){_i(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let n=1;n<t.length-2;n++){let r=t[n],i=t[n+1];_i(Object.assign({},e,{p1:r,p2:i}))}_i(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let r=0;r<t.length-1;r++)_i(Object.assign({},e,{p1:t[r],p2:t[r+1]})),e.join!==`none`&&gi(Object.assign({},e,{pos:t[r],radius:n/2}))}}function Si(e,t){let n=t.segments??16,r=[];for(let t=0;t<=n;t++)r.push(e(t/n));xi({pts:r,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function Ci(e){Si(t=>Ve(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var wi=class e{ctx;src=null;glTex;width;height;constructor(e,t,n,r={}){this.ctx=e;let i=e.gl,a=e.gl.createTexture();if(!a)throw Error(`Failed to create texture`);this.glTex=a,e.onDestroy(()=>this.free()),this.width=t,this.height=n;let o={linear:i.LINEAR,nearest:i.NEAREST}[r.filter??e.opts.texFilter??`nearest`],s={repeat:i.REPEAT,clampToEdge:i.CLAMP_TO_EDGE}[r.wrap??`clampToEdge`];this.bind(),t&&n&&i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,n,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,o),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,o),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,s),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,n,r={}){let i=new e(t,n.width,n.height,r);return i.update(n),i.src=n,i}update(e,t=0,n=0){let r=this.ctx.gl;this.bind(),r.texSubImage2D(r.TEXTURE_2D,0,t,n,r.RGBA,r.UNSIGNED_BYTE,e),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},Ti=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,n,r={}){this.ctx=e;let i=e.gl;e.onDestroy(()=>this.free()),this.tex=new wi(e,t,n,r);let a=i.createFramebuffer(),o=i.createRenderbuffer();if(!a||!o)throw Error(`Failed to create framebuffer`);this.glFramebuffer=a,this.glRenderbuffer=o,this.bind(),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,t,n),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.tex.glTex,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let n=this.width*4,r=new Uint8Array(n);for(let e=0;e<(this.height/2|0);e++){let i=e*n,a=(this.height-e-1)*n;r.set(t.subarray(i,i+n)),t.copyWithin(i,a,a+n),t.set(r,a)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement(`canvas`),t=e.getContext(`2d`);if(e.width=this.width,e.height=this.height,!t)throw Error(`Failed to get 2d context`);return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},Ei=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,n,r){let i=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((e,t)=>e+t.size,0),this.maxVertices=n,this.maxIndices=r;let a=i.createBuffer();if(!a)throw Error(`Failed to create vertex buffer`);this.glVBuf=a,e.pushArrayBuffer(this.glVBuf),i.bufferData(i.ARRAY_BUFFER,n*4,i.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=i.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),i.bufferData(i.ELEMENT_ARRAY_BUFFER,r*4,i.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,n,r,i=null,a={}){(e!==this.curPrimitive||i!==this.curTex||r!==this.curShader||!$t(this.curUniform,a)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+n.length>this.maxIndices)&&this.flush();let o=this.vqueue.length/this.stride;for(let e of t)this.vqueue.push(e);for(let e of n)this.iqueue.push(e+o);this.curPrimitive=e,this.curShader=r,this.curTex=i,this.curUniform=a}flush(){if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function Di(e){let t=[],n=n=>{t.push(n),e(n)},r=()=>{t.pop(),e(i()??null)},i=()=>t[t.length-1];return[n,r,i]}function Oi(e,t={}){let n=[];function r(e){n.push(e)}function i(){n.forEach(e=>e());let t=e.getExtension(`WEBGL_lose_context`);t&&t.loseContext()}let a=null;function o(t){if($t(t,a))return;a=t;let n=t.reduce((e,t)=>e+t.size,0);t.reduce((t,r,i)=>(e.vertexAttribPointer(i,r.size,e.FLOAT,!1,n*4,t),e.enableVertexAttribArray(i),t+r.size*4),0)}let[s,c]=Di(t=>e.bindTexture(e.TEXTURE_2D,t)),[l,u]=Di(t=>e.bindBuffer(e.ARRAY_BUFFER,t)),[d,f]=Di(t=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t)),[p,m]=Di(t=>e.bindFramebuffer(e.FRAMEBUFFER,t)),[h,g]=Di(t=>e.bindRenderbuffer(e.RENDERBUFFER,t)),[_,v]=Di(t=>{if(!t)return;let{x:n,y:r,w:i,h:a}=t;e.viewport(n,r,i,a)}),[y,b]=Di(t=>e.useProgram(t));return _({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:r,destroy:i,pushTexture2D:s,popTexture2D:c,pushArrayBuffer:l,popArrayBuffer:u,pushElementArrayBuffer:d,popElementArrayBuffer:f,pushFramebuffer:p,popFramebuffer:m,pushRenderbuffer:h,popRenderbuffer:g,pushViewport:_,popViewport:v,pushProgram:y,popProgram:b,setVertexFormat:o}}var ki={};function Ai(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(f(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function ji(e){let t={},n=``,r=[],i=String(e),a=e=>{r.length>0&&(t[n.length]=r.slice()),n+=e};for(;i!==``;){if(i[0]===`\\`){if(i.length===1)throw Error(`Styled text error: \\ at end of string`);a(i[1]),i=i.slice(2);continue}if(i[0]===`[`){let e=/^\[(\/)?(\w+?)\]/.exec(i);if(!e){a(i[0]),i=i.slice(1);continue}let[t,n,o]=e;if(n!==void 0){let e=r.pop();if(e!==o)throw e===void 0?Error(`Styled text error: stray end tag [/${o}]`):Error(`Styled text error: mismatched tags. Expected [/${e}], got [/${o}]`)}else r.push(o);i=i.slice(t.length);continue}a(i[0]),i=i.slice(1)}if(r.length>0)throw Error(`Styled text error: unclosed tags ${r}`);return{charStyleMap:t,text:n}}function Mi(e){if(e.text===void 0)throw Error(`formatText() requires property "text".`);let t=Jr(e.font);if(!e.text||e.text===``||t instanceof wr||!t)return{width:0,height:0,chars:[],opt:e,renderedText:``};let{charStyleMap:n,text:i}=ji(e.text+``),a=sn(i);if(t instanceof qr||typeof t==`string`){let e=t instanceof qr?t.fontface.family:t,n=t instanceof qr?{outline:t.outline,filter:t.filter}:{outline:null,filter:xt},r=ki[e]??{font:{tex:new wi(R.gfx.ggl,2048,2048,{filter:n.filter}),map:{},size:64},cursor:new d(0),maxHeight:0,outline:n.outline};ki[e]||(ki[e]=r),t=r.font;for(let n of a)if(!r.font.map[n]){let i=R.fontCacheC2d;if(!i)throw Error(`fontCacheC2d is not defined.`);if(!R.fontCacheCanvas)throw Error(`fontCacheCanvas is not defined.`);i.clearRect(0,0,R.fontCacheCanvas.width,R.fontCacheCanvas.height),i.font=`${t.size}px ${e}`,i.textBaseline=`top`,i.textAlign=`left`,i.fillStyle=`#ffffff`;let a=i.measureText(n),o=Math.ceil(a.width);if(!o)continue;let s=Math.ceil(Math.abs(a.actualBoundingBoxAscent))+Math.ceil(Math.abs(a.actualBoundingBoxDescent));r.outline&&r.outline.width&&r.outline.color&&(i.lineJoin=`round`,i.lineWidth=r.outline.width*2,i.strokeStyle=r.outline.color.toHex(),i.strokeText(n,r.outline.width,r.outline.width),o+=r.outline.width*2,s+=r.outline.width*3),i.fillText(n,r.outline?.width??0,r.outline?.width??0);let c=i.getImageData(0,0,o,s);if(r.cursor.x+o>2048&&(r.cursor.x=0,r.cursor.y+=r.maxHeight,r.maxHeight=0,r.cursor.y>2048))throw Error(`Font atlas exceeds character limit`);t.tex.update(c,r.cursor.x,r.cursor.y),t.map[n]=new p(r.cursor.x,r.cursor.y,o,s),r.cursor.x+=o+1,r.maxHeight=Math.max(r.maxHeight,s)}}let o=e.size||t.size,s=f(e.scale??1).scale(o/t.size),c=e.lineSpacing??0,l=e.letterSpacing??0,u=0,m=0,h=0,g=[],_=[],v=0,y=null,b=0,x;for(;v<a.length;){let n=a[v];if(n===`
`)h+=o+c,g.push({width:u-l,chars:_}),y=null,b=0,u=0,_=[],x=void 0;else{let i=t.map[n];if(i){let S=i.w*s.x;e.width&&u+S>e.width&&(h+=o+c,y!=null&&(v-=_.length-y,n=a[v],i=t.map[n],S=i.w*s.x,_=_.slice(0,y-1),u=b),y=null,b=0,g.push({width:u-l,chars:_}),u=x??0,_=[]),_.push({tex:t.tex,width:i.w,height:i.h,quad:new p(i.x/t.tex.width,i.y/t.tex.height,i.w/t.tex.width,i.h/t.tex.height),ch:n,pos:new d(u,h),opacity:e.opacity??1,color:e.color??r.WHITE,scale:f(s),angle:0}),n===` `&&(y=_.length,b=u),e.indentAll&&x===void 0&&/\S/.test(n)&&(x=u),u+=S,m=Math.max(m,u),u+=l}}v++}g.push({width:u-l,chars:_}),h+=o,e.width&&(m=e.width);let S=[];for(let r=0;r<g.length;r++){let i=(m-g[r].width)*Yn(e.align??`left`);for(let a of g[r].chars){let o=t.map[a.ch],c=S.length+r;if(a.pos=a.pos.add(i,0).add(o.w*s.x*.5,o.h*s.y*.5),e.transform){let t=typeof e.transform==`function`?e.transform(c,a.ch):e.transform;t&&Ai(a,t)}if(n[c]){let t=n[c];for(let n of t){let t=e.styles?.[n],r=typeof t==`function`?t(c,a.ch):t;r&&Ai(a,r)}}S.push(a)}}return{width:m,height:h,chars:S,opt:e,renderedText:i}}function Ni(e){if(e.width===void 0||e.height===void 0)throw Error(`drawUVQuad() requires property "width" and "height".`);if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,r=Jn(e.anchor||vt).scale(new d(t,n).scale(-.5)),a=e.quad||new p(0,0,1,1),o=e.color||i(255,255,255),s=e.opacity??1,c=e.tex?.1/e.tex.width:0,l=e.tex?.1/e.tex.height:0,u=a.x+c,f=a.y+l,m=a.w-c*2,h=a.h-l*2;pr(),I(e.pos),gr(e.angle),hr(e.scale),I(r),pi([{pos:new d(-t/2,n/2),uv:new d(e.flipX?u+m:u,e.flipY?f:f+h),color:o,opacity:s},{pos:new d(-t/2,-n/2),uv:new d(e.flipX?u+m:u,e.flipY?f+h:f),color:o,opacity:s},{pos:new d(t/2,-n/2),uv:new d(e.flipX?u:u+m,e.flipY?f+h:f),color:o,opacity:s},{pos:new d(t/2,n/2),uv:new d(e.flipX?u:u+m,e.flipY?f:f+h),color:o,opacity:s}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),_r()}function Pi(e){pr(),I(e.opt.pos),gr(e.opt.angle),I(Jn(e.opt.anchor??`topleft`).add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{Ni({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:`center`,uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),_r()}function Fi(e){if(e.width===void 0||e.height===void 0)throw Error(`drawRect() requires property "width" and "height".`);if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,r=Jn(e.anchor||vt).add(1,1).scale(new d(t,n).scale(-.5)),i=[new d(0,0),new d(t,0),new d(t,n),new d(0,n)];if(e.radius){let r=Math.min(t,n)/2,a=Array.isArray(e.radius)?e.radius.map(e=>Math.min(r,e)):[,,,,].fill(Math.min(r,e.radius));i=[new d(a[0],0),...a[1]?ur(new d(t-a[1],a[1]),a[1],a[1],270,360):[f(t,0)],...a[2]?ur(new d(t-a[2],n-a[2]),a[2],a[2],0,90):[f(t,n)],...a[3]?ur(new d(a[3],n-a[3]),a[3],a[3],90,180):[f(0,n)],...a[0]?ur(new d(a[0],a[0]),a[0],a[0],180,270):[]]}mi(Object.assign({},e,{offset:r,pts:i,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function Ii(e){vr();let t=R.gfx.width,n=R.gfx.height;R.gfx.width=R.gfx.viewport.width,R.gfx.height=R.gfx.viewport.height,e(),vr(),R.gfx.width=t,R.gfx.height=n}function Li(e,t){Ii(()=>{let n=f(8);pr(),I(e);let r=Mi({text:t,font:bt,size:16,pos:n,color:i(255,255,255),fixed:!0}),a=r.width+n.x*2,o=r.height+n.x*2;e.x+a>=L()&&I(f(-a,0)),e.y+o>=yr()&&I(f(0,-o)),Fi({width:a,height:o,color:i(0,0,0),radius:4,opacity:.8,fixed:!0}),Pi(r),_r()})}function Ri(e){if(!e.p1||!e.p2||!e.p3)throw Error(`drawTriangle() requires properties "p1", "p2" and "p3".`);return mi(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function zi(){if(R.debug.inspect){let e=null;for(let t of R.game.root.get(`*`,{recursive:!0}))if(t.has(`area`)&&t.isHovering()){e=t;break}if(R.game.root.drawInspect(),e){let t=[],n=e.inspect();for(let e in n)n[e]?t.push(`${n[e]}`):t.push(`${e}`);Li(En(R.k.mousePos()),t.join(`
`))}Li(f(8),`FPS: ${R.debug.fps()}`)}R.debug.paused&&Ii(()=>{pr(),I(L(),0),I(-8,8),Fi({width:32,height:32,anchor:`topright`,color:i(0,0,0),opacity:.8,radius:4,fixed:!0});for(let e=1;e<=2;e++)Fi({width:4,height:32*.6,anchor:`center`,pos:f(-32/3*e,32*.5),color:i(255,255,255),radius:2,fixed:!0});_r()}),R.debug.timeScale!==1&&Ii(()=>{pr(),I(L(),yr()),I(-8,-8);let e=Mi({text:R.debug.timeScale.toFixed(1),font:bt,size:16,color:i(255,255,255),pos:f(-8),anchor:`botright`,fixed:!0});Fi({width:e.width+16+32,height:e.height+16,anchor:`botright`,color:i(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=0;t<2;t++){let n=R.debug.timeScale<1;Ri({p1:f(-e.width-8*(n?2:3.5),-8),p2:f(-e.width-8*(n?2:3.5),-8-e.height),p3:f(-e.width-8*(n?3.5:2),-8-e.height/2),pos:f(-t*8*1+(n?-8*.5:0),0),color:i(255,255,255),fixed:!0})}Pi(e),_r()}),R.debug.curRecording&&Ii(()=>{pr(),I(0,yr()),I(24,-24),gi({radius:12,color:i(255,0,0),opacity:v(0,1,R.app.time()*4),fixed:!0}),_r()}),R.debug.showLog&&R.game.logs.length>0&&Ii(()=>{pr(),I(0,yr()),I(8,-8);let e=[];for(let t of R.game.logs){let n=``,r=t.msg instanceof Error?`error`:`info`;n+=`[time]${t.time.toFixed(2)}[/time]`,n+=` `,n+=`[${r}]${Bi(t.msg)}[/${r}]`,e.push(n)}R.game.logs=R.game.logs.filter(e=>R.app.time()-e.time<(R.globalOpt.logTime||4));let t=Mi({text:e.join(`
`),font:bt,pos:f(8,-8),anchor:`botleft`,size:16,width:L()*.6,lineSpacing:8/2,fixed:!0,styles:{time:{color:i(127,127,127)},info:{color:i(255,255,255)},error:{color:i(255,0,127)}}});Fi({width:t.width+16,height:t.height+16,anchor:`botleft`,color:i(0,0,0),radius:4,opacity:.8,fixed:!0}),Pi(t),_r()})}function Bi(e,t=!1,n=new Set){if(n.has(e))return`<recursive>`;var r=``,i;return t&&typeof e==`string`&&(e=JSON.stringify(e)),Array.isArray(e)&&(r=[`[`,e.map(t=>Bi(t,!0,n.union(new Set([e])))).join(`, `),`]`].join(``),e=r),e===null?`null`:(typeof e==`object`&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(r+=e.constructor.name+` `),r+=[`{`,(i=Object.getOwnPropertyNames(e).map(t=>`${/^\w+$/.test(t)?t:JSON.stringify(t)}: ${Bi(e[t],!0,n.union(new Set([e])))}`).join(`, `))?` ${i} `:``,`}`].join(``),e=r),String(e).replaceAll(/(?<!\\)\[/g,`\\[`))}function Vi(){let e=R.game.cam,t=d.fromAngle(T(0,360)).scale(e.shake);e.shake=c(e.shake,0,5*F()),e.transform=new _().translate(xr()).scale(e.scale).rotate(e.angle).translate((e.pos??xr()).scale(-1).add(t)),R.game.root.draw(),vr()}function Hi(){let e=Nr();R.game.events.numListeners(`loading`)>0?R.game.events.trigger(`loading`,e):Ii(()=>{let t=L()/2,n=f(L()/2,yr()/2).sub(f(t/2,24/2));Fi({pos:f(0),width:L(),height:yr(),color:i(0,0,0)}),Fi({pos:n,width:t,height:24,fill:!1,outline:{width:4}}),Fi({pos:n,width:t*e,height:24})})}function Ui(e,t,n){let r=R.gfx.ggl.gl;vr(),r.clear(r.STENCIL_BUFFER_BIT),r.enable(r.STENCIL_TEST),r.stencilFunc(r.NEVER,1,255),r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),t(),vr(),r.stencilFunc(n,1,255),r.stencilOp(r.KEEP,r.KEEP,r.KEEP),e(),vr(),r.disable(r.STENCIL_TEST)}function Wi(e,t){let n=R.gfx.ggl.gl;Ui(e,t,n.EQUAL)}function Gi(e){if(!e.tex)throw Error(`drawTexture() requires property "tex".`);let t=e.quad??new p(0,0,1,1),n=e.tex.width*t.w,i=e.tex.height*t.h,a=new d(1);if(e.tiled){let a=Jn(e.anchor||vt);(e.pos?.x||0)-(a.x+1)*.5*(e.width||n),(e.pos?.y||0)-(a.y+1)*.5*(e.height||i);let o=(e.width||n)/n,s=(e.height||i)/i,c=Math.floor(o),l=Math.floor(s),u=o-c,f=s-l,m=(c+u?1:0)*(l+f?1:0),h=Array(m*6),g=Array(m*4),_=0,v=(t,n,i,o,s)=>{h[_*6+0]=_*4+0,h[_*6+1]=_*4+1,h[_*6+2]=_*4+3,h[_*6+3]=_*4+1,h[_*6+4]=_*4+2,h[_*6+5]=_*4+3,g[_*4+0]={pos:new d(t-a.x,n-a.y),uv:new d(s.x,s.y),color:e.color||r.WHITE,opacity:e.opacity||1},g[_*4+1]={pos:new d(t+i-a.x,n-a.y),uv:new d(s.x+s.w,s.y),color:e.color||r.WHITE,opacity:e.opacity||1},g[_*4+2]={pos:new d(t+i-a.x,n+o-a.y),uv:new d(s.x+s.w,s.y+s.h),color:e.color||r.WHITE,opacity:e.opacity||1},g[_*4+3]={pos:new d(t-a.x,n+o-a.y),uv:new d(s.x,s.y+s.h),color:e.color||r.WHITE,opacity:e.opacity||1},_++};for(let e=0;e<l;e++){for(let r=0;r<c;r++)v(r*n,e*i,n,i,t);u&&v(c*n,e*i,n*u,i,new p(t.x,t.y,t.w*u,t.h))}if(f){for(let e=0;e<c;e++)v(e*n,l*i,n,i*f,new p(t.x,t.y,t.w,t.h*f));u&&v(c*n,l*i,n*u,i*f,new p(t.x,t.y,t.w*u,t.h*f))}pi(g,h,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(a.x=e.width/n,a.y=e.height/i):e.width?(a.x=e.width/n,a.y=a.x):e.height&&(a.y=e.height/i,a.x=a.y),Ni(Object.assign({},e,{scale:a.scale(e.scale||new d(1)),tex:e.tex,quad:t,width:n,height:i}))}function Ki(e){if(!e.sprite)throw Error(`drawSprite() requires property "sprite"`);let t=Br(e.sprite);if(!t||!t.data)return;let n=t.data.frames[e.frame??0];if(!n)throw Error(`Frame not found: ${e.frame??0}`);Gi(Object.assign({},e,{tex:t.data.tex,quad:n.scale(e.quad??new p(0,0,1,1))}))}function qi(e,t){let n=R.gfx.ggl.gl;Ui(e,t,n.NOTEQUAL)}function Ji(e){Pi(Mi(e))}var Yi=(e,t)=>{let n=ni(t,kt,At),r=e.pixelDensity??1,a=e.scale??1,{gl:o}=t,s=wi.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),c=e.width&&e.height?new Ti(t,e.width*r*a,e.height*r*a):new Ti(t,o.drawingBufferWidth,o.drawingBufferHeight),l=null,u=1;e.background&&(typeof e.background==`string`?l=i(e.background):(l=i(...e.background),u=e.background[3]??1),o.clearColor(l.r/255,l.g/255,l.b/255,u??1)),o.enable(o.BLEND),o.blendFuncSeparate(o.ONE,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA);let d=new Ei(t,St,Tt,Et),f=wi.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:`repeat`,filter:`nearest`});return{lastDrawCalls:0,ggl:t,defShader:n,defTex:s,frameBuffer:c,postShader:null,postShaderUniform:null,renderer:d,transform:new _,transformStack:[],bgTex:f,bgColor:l,bgAlpha:u,width:e.width??o.drawingBufferWidth/r/a,height:e.height??o.drawingBufferHeight/r/a,viewport:{x:0,y:0,width:o.drawingBufferWidth,height:o.drawingBufferHeight,scale:1},fixed:!1}};function Xi(e){return e.fixed?!0:e.parent?Xi(e.parent):!1}function Zi(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function Qi(e,t={}){return{id:`circle`,radius:e,draw(){gi(Object.assign(Zi(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new N(new d(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function $i(...e){return{id:`color`,color:i(...e),inspect(){return`color: ${this.color.toString()}`}}}function ea(e){return{add(){this.canvas=e}}}function ta(e=1){let t,n=0,r=!1;return{require:[`opacity`],add(){t=this.opacity,this.opacity=0},update(){r||(n+=F(),this.opacity=l(n,0,e,0,t),n>=e&&(this.opacity=t,r=!0))}}}function na(e=`intersect`){return{id:`mask`,mask:e}}function ra(e){return{id:`opacity`,opacity:e??1,fadeIn(e=1,t=R.k.easings.linear){return R.game.root.tween(0,this.opacity,e,e=>this.opacity=e,t)},fadeOut(e=1,t=R.k.easings.linear){return R.game.root.tween(this.opacity,0,e,e=>this.opacity=e,t)},inspect(){return`opacity: ${an(this.opacity,1)}`}}}function ia(e=1,t=i(0,0,0),n=1,r=`miter`,a=10,o=`butt`){return{id:`outline`,outline:{width:e,color:t,opacity:n,join:r,miterLimit:a,cap:o},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var aa=class{pos=f(0);vel=f(0);acc=f(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function oa(e,t){let n=t.lifetime,a=[],o=e.colors||[r.WHITE],s=e.opacities||[1],u=e.quads||[new p(0,0,1,1)],m=e.scales||[1],h=e.lifeTime,g=t.direction,_=t.spread,v=e.speed||[0,0],y=e.angle||[0,0],b=e.angularVelocity||[0,0],x=e.acceleration||[f(0),f(0)],S=e.damping||[0,0],C=[],w=Array(e.max),E=0,ee=0;for(let t=0;t<e.max;t++){C[t*6+0]=t*4+0,C[t*6+1]=t*4+1,C[t*6+2]=t*4+3,C[t*6+3]=t*4+1,C[t*6+4]=t*4+2,C[t*6+5]=t*4+3;for(let e=0;e<4;e++)w[t*4+e]={pos:new d(0,0),uv:new d(0,0),color:i(255,255,255),opacity:1};a[t]=new aa}let D=new zt;function te(t=0){for(;t<e.max;){if(a[t].gc)return t;t++}return null}return{id:`particles`,emit(e){let n=0;for(let r=0;r<e;r++){if(n=te(n),n==null)return;let e=T(g-_,g+_),r=d.fromAngle(e).scale(T(v[0],v[1])),i=T(y[0],y[1]),o=T(b[0],b[1]),s=f(T(x[0].x,x[1].x),T(x[0].y,x[1].y)),c=T(S[0],S[1]),l=h?T(h[0],h[1]):null,u=t.shape?t.shape.random():f(),p=a[n];p.lt=l,p.pos=u,p.vel=r,p.acc=s,p.angle=i,p.angularVelocity=o,p.damping=c,p.angularVelocity=o,p.gc=!1}E+=e},update(){if(n!==void 0&&n<=0)return;let r=F();for(let e of a)if(!e.gc){if(e.t+=r,e.lt&&e.t>=e.lt){e.gc=!0,E--;continue}e.vel=e.vel.add(e.acc.scale(r)).scale(1-e.damping*r),e.pos=e.pos.add(e.vel.scale(r)),e.angle+=e.angularVelocity*r}for(n!==void 0&&(n-=r,n<=0&&D.trigger()),ee+=r;E<e.max&&t.rate&&ee>t.rate;)this.emit(1),E++,ee-=t.rate},draw(){if(!(n!==void 0&&n<=0)){for(let t=0;t<a.length;t++){let n=a[t];if(n.gc)continue;let r=n.progress,i=Math.floor(n.progress*o.length),d=i<o.length-1?c(o[i],o[i+1],l(r,i/o.length,(i+1)/o.length,0,1)):o[i],f=Math.floor(n.progress*s.length),p=f<s.length-1?c(s[f],s[f+1],l(r,f/s.length,(f+1)/s.length,0,1)):s[f],h=Math.floor(n.progress*u.length),g=u[h],_=Math.floor(n.progress*m.length),v=m[_],y=Math.cos(n.angle*Math.PI/180),b=Math.sin(n.angle*Math.PI/180),x=(e.texture?e.texture.width:10)*g.w/2,S=(e.texture?e.texture.height:10)*g.h/2,C=t*4,T=w[C];T.pos.x=n.pos.x+-x*v*y- -S*v*b,T.pos.y=n.pos.y+-x*v*b+-S*v*y,T.uv.x=g.x,T.uv.y=g.y,T.color.r=d.r,T.color.g=d.g,T.color.b=d.b,T.opacity=p,T=w[C+1],T.pos.x=n.pos.x+x*v*y- -S*v*b,T.pos.y=n.pos.y+x*v*b+-S*v*y,T.uv.x=g.x+g.w,T.uv.y=g.y,T.color.r=d.r,T.color.g=d.g,T.color.b=d.b,T.opacity=p,T=w[C+2],T.pos.x=n.pos.x+x*v*y-S*v*b,T.pos.y=n.pos.y+x*v*b+S*v*y,T.uv.x=g.x+g.w,T.uv.y=g.y+g.h,T.color.r=d.r,T.color.g=d.g,T.color.b=d.b,T.opacity=p,T=w[C+3],T.pos.x=n.pos.x+-x*v*y-S*v*b,T.pos.y=n.pos.y+-x*v*b+S*v*y,T.uv.x=g.x,T.uv.y=g.y+g.h,T.color.r=d.r,T.color.g=d.g,T.color.b=d.b,T.opacity=p}pi(w,C,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(e){return D.add(e)},inspect(){return`count: ${E}/${e.max}`}}}function sa(e,t={}){if(e.length<3)throw Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:`polygon`,pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){mi(Object.assign(Zi(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new Le(this.pts)},inspect(){return`polygon: ${this.pts.map(e=>`[${e.x},${e.y}]`).join(`,`)}`}}}function ca(e,t,n){let r;return R.game.root.get(`area`).forEach(i=>{if(n&&n.some(e=>i.is(e)))return;let a=i.worldArea().raycast(e,t);a&&(r?a.fraction<r.fraction&&(r=a,r.object=i):(r=a,r.object=i))}),r}function la(e,t,n={}){return{id:`rect`,width:e,height:t,radius:n.radius||0,draw(){Fi(Object.assign(Zi(this),{width:this.width,height:this.height,radius:this.radius,fill:n.fill}))},renderArea(){return new N(f(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function ua(e,t){return{id:`shader`,shader:e,...typeof t==`function`?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function da(e,t){if(!t.tileWidth||!t.tileHeight)throw Error(`Must provide tileWidth and tileHeight.`);let n=R.game.root.add([ps(t.pos??f(0))]),r=e.length,i=0,a=null,o=null,s=null,c=null,l=e=>e.x+e.y*i,u=e=>f(Math.floor(e%i),Math.floor(e/i)),d=()=>{a=[];for(let e of n.children)p(e)},p=e=>{let t=l(e.tilePos);a[t]?a[t].push(e):a[t]=[e]},m=e=>{let t=l(e.tilePos);if(a[t]){let n=a[t].indexOf(e);n>=0&&a[t].splice(n,1)}},h=()=>{let e=!1;for(let t of n.children){let r=n.pos2Tile(t.pos);(t.tilePos.x!=r.x||t.tilePos.y!=r.y)&&(e=!0,m(t),t.tilePos.x=r.x,t.tilePos.y=r.y,p(t))}e&&n.trigger(`spatialMapChanged`)},g=()=>{let e=n.getSpatialMap(),t=n.numRows()*n.numColumns();o?o.length=t:o=Array(t),o.fill(1,0,t);for(let t=0;t<e.length;t++){let n=e[t];if(n){let e=0;for(let t of n)if(t.isObstacle){e=1/0;break}else e+=t.cost;o[t]=e||1}}},_=()=>{let e=n.getSpatialMap(),t=n.numRows()*n.numColumns();s?s.length=t:s=Array(t),s.fill(15,0,t);for(let t=0;t<e.length;t++){let n=e[t];if(n){let e=n.length,r=15;for(let t=0;t<e;t++)r|=n[t].edgeMask;s[t]=r}}},v=()=>{let e=n.numRows()*n.numColumns(),t=(e,t)=>{let n=[];for(n.push(e);n.length>0;){let e=n.pop();x(e).forEach(e=>{c[e]<0&&(c[e]=t,n.push(e))})}};c?c.length=e:c=Array(e),c.fill(-1,0,e);let r=0;for(let e=0;e<o.length;e++){if(c[e]>=0){r++;continue}t(e,r),r++}},y=(e,t)=>o[t],b=(e,t)=>{let n=u(e),r=u(t);return n.dist(r)},x=(e,t)=>{let n=[],a=Math.floor(e%i),c=a>0&&s[e]&1&&o[e-1]!==1/0,l=e>=i&&s[e]&2&&o[e-i]!==1/0,u=a<i-1&&s[e]&4&&o[e+1]!==1/0,d=e<i*r-i-1&&s[e]&8&&o[e+i]!==1/0;return t?(c&&(l&&n.push(e-i-1),n.push(e-1),d&&n.push(e+i-1)),l&&n.push(e-i),u&&(l&&n.push(e-i+1),n.push(e+1),d&&n.push(e+i+1)),d&&n.push(e+i)):(c&&n.push(e-1),l&&n.push(e-i),u&&n.push(e+1),d&&n.push(e+i)),n},S={id:`level`,tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(e,...r){let i=f(...r),o=(()=>{if(typeof e==`string`){if(t.tiles[e]){if(typeof t.tiles[e]!=`function`)throw Error(`Level symbol def must be a function returning a component list`);return t.tiles[e](i)}else if(t.wildcardTile)return t.wildcardTile(e,i)}else{if(Array.isArray(e))return e;throw Error(`Expected a symbol or a component list`)}})();if(!o)return null;let s=!1,c=!1;for(let e of o)e.id===`tile`&&(c=!0),e.id===`pos`&&(s=!0);s||o.push(ps(this.tile2Pos(i))),c||o.push(Mo());let l=n.add(o);return s&&(l.tilePosOffset=l.pos.clone()),l.tilePos=i,l.transform=cr(l),a&&(p(l),this.trigger(`spatialMapChanged`),this.trigger(`navigationMapInvalid`)),l},numColumns(){return i},numRows(){return r},levelWidth(){return i*this.tileWidth()},levelHeight(){return r*this.tileHeight()},tile2Pos(...e){return f(...e).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...e){let t=f(...e);return f(Math.floor(t.x/this.tileWidth()),Math.floor(t.y/this.tileHeight()))},getSpatialMap(){return a||d(),a},removeFromSpatialMap:m,insertIntoSpatialMap:p,onSpatialMapChanged(e){return this.on(`spatialMapChanged`,e)},onNavigationMapInvalid(e){return this.on(`navigationMapInvalid`,e)},getAt(e){a||d();let t=l(e);return a[t]||[]},raycast(e,t){let n=this.toWorld(e),r=this.toWorld(e.add(t)).sub(n),i=1/this.tileWidth(),a=e.scale(i),o=je(a,t,e=>{let t=this.getAt(e);if(t.some(e=>e.isObstacle))return!0;let a=null;for(let e of t)if(e.has(`area`)){let t=e.worldArea().raycast(n,r);t&&(a?t.fraction<a.fraction&&(a=t,a.object=e):(a=t,a.object=e))}return a&&(a.point=this.fromWorld(a.point).scale(i)),a||!1},64);return o&&(o.point=o.point.scale(this.tileWidth())),o},update(){a&&h()},invalidateNavigationMap(){o=null,s=null,c=null},onNavigationMapChanged(e){return this.on(`navigationMapChanged`,e)},getTilePath(e,t,n={}){if(o||g(),s||_(),c||v(),e.x<0||e.x>=i||e.y<0||e.y>=r||t.x<0||t.x>=i||t.y<0||t.y>=r)return null;let a=l(e),d=l(t);if(o[d]===1/0)return null;if(a===d)return[];if(c[a]!=-1&&c[a]!==c[d])return null;let f=new Wt((e,t)=>e.cost<t.cost);f.insert({cost:0,node:a});let p=new Map;p.set(a,a);let m=new Map;for(m.set(a,0);f.length!==0;){let e=f.remove()?.node;if(e===d)break;let t=x(e,n.allowDiagonals);for(let n of t){let t=(m.get(e)||0)+y(e,n)+b(n,d);(!m.has(n)||t<m.get(n))&&(m.set(n,t),f.insert({cost:t,node:n}),p.set(n,e))}}let h=[],S=d,C=u(S);for(h.push(C);S!==a;){let e=p.get(S);if(e===void 0)throw Error(`Bug in pathfinding algorithm`);S=e;let t=u(S);h.push(t)}return h.reverse()},getPath(e,t,n={}){let r=this.tileWidth(),i=this.tileHeight(),a=this.getTilePath(this.pos2Tile(e),this.pos2Tile(t),n);return a?[e,...a.slice(1,-1).map(e=>e.scale(r,i).add(r/2,i/2)),t]:null}};return n.use(S),n.onNavigationMapInvalid(()=>{n.invalidateNavigationMap(),n.trigger(`navigationMapChanged`)}),e.forEach((e,t)=>{let r=e.split(``);i=Math.max(r.length,i),r.forEach((e,r)=>{n.spawn(e,f(r,t))})}),n}function fa(e,t,n){return R.game.objEvents.registers[e]||(R.game.objEvents.registers[e]=new Lt),R.game.objEvents.on(e,(e,...r)=>{e.is(t)&&n(e,...r)})}var pa=(e,t,...n)=>{for(let r of R.game.root.children)r.is(t)&&r.trigger(e,n)},ma=P(e=>{let t=R.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(e){t.paused=e},cancel:()=>t.destroy()}},(e,t)=>fa(`fixedUpdate`,e,t)),ha=P(e=>{let t=R.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(e){t.paused=e},cancel:()=>t.destroy()}},(e,t)=>fa(`update`,e,t)),ga=P(e=>{let t=R.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(e){t.hidden=e},cancel:()=>t.destroy()}},(e,t)=>fa(`draw`,e,t)),_a=P(e=>R.game.events.on(`add`,e),(e,t)=>fa(`add`,e,t)),va=P(e=>R.game.events.on(`destroy`,e),(e,t)=>fa(`destroy`,e,t)),ya=P(e=>R.game.events.on(`use`,e),(e,t)=>fa(`use`,e,t)),ba=P(e=>R.game.events.on(`unuse`,e),(e,t)=>fa(`unuse`,e,t)),xa=P(e=>R.game.events.on(`tag`,e),(e,t)=>fa(`tag`,e,t)),Sa=P(e=>R.game.events.on(`untag`,e),(e,t)=>fa(`untag`,e,t));function Ca(e,t,n){return fa(`collide`,e,(e,r,i)=>r.is(t)&&n(e,r,i))}function wa(e,t,n){return fa(`collideUpdate`,e,(e,r,i)=>r.is(t)&&n(e,r,i))}function Ta(e,t,n){return fa(`collideEnd`,e,(e,r,i)=>r.is(t)&&n(e,r,i))}function Ea(e,t){R.game.root.get(e,{recursive:!0}).forEach(t),_a(e,t),xa((n,r)=>{r===e&&t(n)})}var Da=P(e=>R.app.onMousePress(e),(e,t)=>{let n=[];return Ea(e,e=>{if(!e.area)throw Error(`onClick() requires the object to have area() component`);n.push(e.onClick(()=>t(e)))}),Rt.join(n)});function Oa(e,t){let n=[];return Ea(e,e=>{if(!e.area)throw Error(`onHover() requires the object to have area() component`);n.push(e.onHover(()=>t(e)))}),Rt.join(n)}function ka(e,t){let n=[];return Ea(e,e=>{if(!e.area)throw Error(`onHoverUpdate() requires the object to have area() component`);n.push(e.onHoverUpdate(()=>t(e)))}),Rt.join(n)}function Aa(e,t){let n=[];return Ea(e,e=>{if(!e.area)throw Error(`onHoverEnd() requires the object to have area() component`);n.push(e.onHoverEnd(()=>t(e)))}),Rt.join(n)}function ja(e){R.game.events.on(`loading`,e)}function Ma(e){R.app.onResize(e)}function Na(e){R.game.events.on(`error`,e)}function Pa(e){R.assets.loaded?e():R.game.events.on(`load`,e)}function Fa(e){if(R.assets.loaded)Pr().forEach(t=>e(...t));else return R.game.events.on(`loadError`,e)}function Ia(...e){R.game.cam.pos=f(...e)}function La(){return R.game.cam.pos?R.game.cam.pos.clone():xr()}function Ra(...e){R.game.cam.scale=f(...e)}function za(){return R.game.cam.scale.clone()}function Ba(e){R.game.cam.angle=e}function Va(){return R.game.cam.angle}function Ha(){return R.game.cam.transform.clone()}function Ua(e=i(255,255,255),t=1){let n=R.game.root.add([la(L(),yr()),$i(e),ra(1),cs()]),r=n.fadeOut(t);return r.onEnd(()=>yo(n)),r}function Wa(){return R.game.cam.transform.clone()}function Ga(e=12){R.game.cam.shake+=e}function Ka(e){return R.game.cam.transform.multVec2(e)}function qa(e){return R.game.cam.transform.invert().multVec2(e)}function Ja(...e){return rn(`camPos`,`setCamPos / getCamPos`),e.length>0&&Ia(...e),La()}function Ya(...e){return rn(`camScale`,`setCamScale / getCamScale`),e.length>0&&Ra(...e),za()}function Xa(e){return rn(`camRot`,`setCamRot / getCamRot`),e!==void 0&&Ba(e),Va()}function Za(e=i(255,255,255),t=1){return rn(`camFlash`,`flash`),Ua(e,t)}function Qa(e=[]){let t=new Map,n=[],r={},i=new Bt,a=[],o=new Set(`*`),s=R.globalOpt.tagsAsComponents,c=null,l=!1,u={id:Cn(),hidden:!1,transform:new _,children:[],parent:null,set paused(e){if(e!==l){l=e;for(let t of a)t.paused=e}},get paused(){return l},get tags(){return Array.from(o)},add(e){let t=Array.isArray(e)?Qa(e):e;if(t.parent)throw Error(`Cannot add a game obj that already has a parent.`);return t.parent=this,t.transform=cr(t),this.children.push(t),t.trigger(`add`,t),R.game.events.trigger(`add`,t),t},readd(e){let t=this.children.indexOf(e);return t!==-1&&(this.children.splice(t,1),this.children.push(e)),e},remove(e){let t=this.children.indexOf(e);if(t!==-1){e.parent=null,this.children.splice(t,1);let n=e=>{e.trigger(`destroy`),R.game.events.trigger(`destroy`,e),e.children.forEach(e=>n(e))};n(e)}},removeAll(e){if(e)this.get(e).forEach(e=>this.remove(e));else for(let e of[...this.children])this.remove(e)},fixedUpdate(){this.paused||(this.children.forEach(e=>e.fixedUpdate()),this.trigger(`fixedUpdate`))},update(){this.paused||(this.children.forEach(e=>e.update()),this.trigger(`update`))},draw(){if(this.hidden)return;this.canvas&&(vr(),this.canvas.bind());let e=R.gfx.fixed;this.fixed&&(R.gfx.fixed=!0),pr(),I(this.pos),hr(this.scale),gr(this.angle);let t=this.children.sort((e,t)=>{let n=e.layerIndex??R.game.defaultLayerIndex,r=t.layerIndex??R.game.defaultLayerIndex;return n-r||(e.z??0)-(t.z??0)});if(this.mask){let e={intersect:R.k.drawMasked,subtract:R.k.drawSubtracted}[this.mask];if(!e)throw Error(`Invalid mask func: "${this.mask}"`);e(()=>{t.forEach(e=>e.draw())},()=>{this.trigger(`draw`)})}else this.trigger(`draw`),t.forEach(e=>e.draw());_r(),R.gfx.fixed=e,this.canvas&&(vr(),this.canvas.unbind())},drawInspect(){this.hidden||(pr(),I(this.pos),hr(this.scale),gr(this.angle),this.children.forEach(e=>e.drawInspect()),this.trigger(`drawInspect`),_r())},use(e){if(typeof e==`string`)return o.add(e);if(!e||typeof e!=`object`)throw Error(`You can only pass a component or a string to .use(), you passed a "${typeof e}"`);let i=[];for(let a in e.id?(this.unuse(e.id),r[e.id]=[],i=r[e.id],t.set(e.id,e),s&&o.add(e.id)):n.push(e),e){if(jt.has(a))continue;let n=Object.getOwnPropertyDescriptor(e,a);if(n)if(typeof n.value==`function`&&(e[a]=e[a].bind(this)),n.set&&Object.defineProperty(e,a,{set:n.set.bind(this)}),n.get&&Object.defineProperty(e,a,{get:n.get.bind(this)}),Mt.has(a)){let t=a===`add`?()=>{c=e=>i.push(e),e[a]?.(),c=null}:e[a];i.push(this.on(a,t).cancel)}else if(this[a]===void 0)Object.defineProperty(this,a,{get:()=>e[a],set:t=>e[a]=t,configurable:!0,enumerable:!0}),i.push(()=>delete this[a]);else{let n=t.values().find(e=>e[a]!==void 0)?.id;throw Error(`Duplicate component property: "${a}" while adding component "${e.id}"`+(n?` (originally added by "${n}")`:``))}}let a=()=>{if(e.require){for(let t of e.require)if(!this.c(t))throw Error(`Component "${e.id}" requires component "${t}"`)}};e.destroy&&i.push(e.destroy.bind(this)),this.exists()?(a(),e.add&&(c=e=>i.push(e),e.add.call(this),c=null),e.id&&(this.trigger(`use`,e.id),R.game.events.trigger(`use`,this,e.id))):e.require&&i.push(this.on(`add`,a).cancel)},unuse(e){if(t.has(e)){for(let n of t.values())if(n.require&&n.require.includes(e))throw Error(`Can't unuse. Component "${n.id}" requires component "${e}"`);t.delete(e),this.trigger(`unuse`,e),R.game.events.trigger(`unuse`,this,e)}else s&&o.has(e)&&o.delete(e);r[e]&&(r[e].forEach(e=>e()),delete r[e])},c(e){return t.get(e)??null},get(e,t={}){let n=(e,n)=>t.only===`comps`?e.has(n):t.only===`tags`?e.is(n):e.is(n)||e.has(n),r=t.recursive?this.children.flatMap(function e(t){return[t,...t.children.flatMap(e)]}):this.children;if(r=r.filter(t=>e?n(t,e):!0),t.liveUpdate){let i=e=>t.recursive?this.isAncestorOf(e):e.parent===this,a=[];a.push(R.k.onAdd(t=>{i(t)&&n(t,e)&&r.push(t)})),a.push(R.k.onDestroy(t=>{if(i(t)&&n(t,e)){let e=r.findIndex(e=>e.id===t.id);e!==-1&&r.splice(e,1)}})),this.onDestroy(()=>{for(let e of a)e.cancel()})}return r},query(e){let t=e.hierarchy||`children`,n=e.include,r=e.exclude,i=[];switch(t){case`children`:i=this.children;break;case`siblings`:i=this.parent?this.parent.children.filter(e=>e!==this):[];break;case`ancestors`:let e=this.parent;for(;e;)i.push(e),e=e.parent;break;case`descendants`:i=this.children.flatMap(function e(t){return[t,...t.children.flatMap(e)]});break}if(n&&(i=(e.includeOp||`and`)===`and`||!Array.isArray(e.include)?i.filter(e=>e.is(n)):i.filter(t=>e.include.some(e=>t.is(e)))),r&&(i=(e.includeOp||`and`)===`and`||!Array.isArray(e.include)?i.filter(e=>!e.is(r)):i.filter(t=>!e.exclude.some(e=>t.is(e)))),e.visible===!0&&(i=i.filter(e=>e.visible)),e.distance){if(!this.pos)throw Error(`Can't do a distance query from an object without pos`);let t=e.distanceOp||`near`,n=e.distance*e.distance;i=t===`near`?i.filter(e=>e.pos&&this.pos.sdist(e.pos)<=n):i.filter(e=>e.pos&&this.pos.sdist(e.pos)>n)}return e.name&&(i=i.filter(t=>t.name===e.name)),i},isAncestorOf(e){return e.parent?e.parent===this||this.isAncestorOf(e.parent):!1},exists(){return R.game.root.isAncestorOf(this)},is(e,t=`and`){return Array.isArray(e)?t===`and`?e.every(e=>o.has(e)):e.some(e=>o.has(e)):o.has(e)},tag(e){if(Array.isArray(e))for(let t of e)o.add(t),this.trigger(`tag`,t),R.game.events.trigger(`tag`,this,t);else o.add(e),this.trigger(`tag`,e),R.game.events.trigger(`tag`,this,e)},untag(e){if(Array.isArray(e))for(let t of e)o.delete(t),this.trigger(`untag`,t),R.game.events.trigger(`untag`,this,t);else o.delete(e),this.trigger(`untag`,e),R.game.events.trigger(`untag`,this,e)},has(e,n=`and`){return Array.isArray(e)?n===`and`?e.every(e=>t.has(e)):e.some(e=>t.has(e)):t.has(e)},on(e,t){let n=i.on(e,t.bind(this));return c&&c(()=>n.cancel()),n},trigger(e,...t){i.trigger(e,...t),R.game.objEvents.trigger(e,this,...t)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let e={};for(let[n,r]of t)e[n]=r.inspect?.()??null;for(let[t,r]of n.entries()){if(r.inspect){e[t]=r.inspect();continue}for(let[t,n]of Object.entries(r))typeof n!=`function`&&(e[t]=`${t}: ${n}`)}return e},onAdd(e){return this.on(`add`,e)},onFixedUpdate(e){return this.on(`fixedUpdate`,e)},onUpdate(e){return this.on(`update`,e)},onDraw(e){return this.on(`draw`,e)},onDestroy(e){return this.on(`destroy`,e)},onUse(e){return this.on(`use`,e)},onUnuse(e){return this.on(`unuse`,e)},clearEvents(){i.clear()}};for(let e of[`onKeyPress`,`onKeyPressRepeat`,`onKeyDown`,`onKeyRelease`,`onMousePress`,`onMouseDown`,`onMouseRelease`,`onMouseMove`,`onCharInput`,`onMouseMove`,`onTouchStart`,`onTouchMove`,`onTouchEnd`,`onScroll`,`onGamepadButtonPress`,`onGamepadButtonDown`,`onGamepadButtonRelease`,`onGamepadStick`,`onButtonPress`,`onButtonDown`,`onButtonRelease`])u[e]=(...t)=>{let n=R.app[e]?.(...t);return a.push(n),u.onDestroy(()=>n.cancel()),u.on(`sceneEnter`,()=>{a.splice(a.indexOf(n),1);let r=R.app[e]?.(...t);Rt.replace(n,r),a.push(n)}),n};for(let t of e)u.use(t);return u}var $a=()=>({events:new Bt,objEvents:new Bt,root:Qa([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new d(1),angle:0,shake:0,transform:new _}});function eo(e){R.game.gravity=e?(R.game.gravity||f(0,1)).unit().scale(e):null}function to(){return R.game.gravity?R.game.gravity.len():0}function no(e){R.game.gravity=e.unit().scale(R.game.gravity?R.game.gravity.len():1)}function ro(){return R.game.gravity?R.game.gravity.unit():f(0,1)}var io=e(`//uUBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAATAAAeAAANDQ0NDRoaGhoaKCgoKCg1NTU1NTVDQ0NDQ1BQUFBQXl5eXl5ra2tra2t5eXl5eYaGhoaGlJSUlJShoaGhoaGvr6+vr7y8vLy8ysrKysrX19fX19fl5eXl5fLy8vLy//////8AAAA5TEFNRTMuMTAwAaoAAAAAAAAAABSAJAOPhgAAgAAAHgBaqIlmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uUBAAP8h1kPIABR4BEDGeQAEbkSb2RAACBFMEyMiAAASJw4xjgwAGyRvfIoZT2QKGV5YNw/tKID9+X93qXtBQUFBQ/e+EFKTQUT/dy3f5dK/3d04rkXHpufCClDAaH7jDMgFAQEGfPt+jI352U9vU4GLRpzkUDeeeTQggQe2ggF3d7/3j697DnhCH5iGf38//iNj9oy2Jk71oj+CBAABGNB4RJNMwgCABCB//8//l////1z6XEGd73az07sOkwZD9VYgjzjmQ6j4EMfZM86OJ7GUWwvFw3ZPcdVEtczf9RNf6xMyxLjZZgjMQ7KDkLSU8g2E12UDUWrf//////9LdtFdeeqKwSitW9SJL59VM5pyUGiBNiK0jIGO0j7p3pUpWpaeqi1nTvqP3b43mGmM6HeXFjIlRwiFiIDQRRAGgkDQhxMMv//+f1//6XM/PfMvysJa3993MjDjhaRkrV3cRPXjGptDDGTHtFKUeMHU0K5STvVfMtVX/UXHctt1Z1//uUBB0AgnZkQAAgRTBMzIgAACiqCdB9E1QRgAFuIuGmhjABPZRJRCHi4etY2gcEYRwFw5KFBMMRV/////z6kX2ppnJszEzKbkZKEumm+pBRUDBg9IsgXGXrazn1QhmGjBrLVjT5Xvir0HT7d//HSZh18IZdji2N5JZgbA3DwQAahogSDqUhQuNtpJmBTwAGMY2QP3c/dy4EKsAABoXEJEFmlf/c4TgYtwcAbwfD4gOOoS1QIH7jDnNzYVe1x4mNFyD2jMVaaykjV29ePMARwXcUOgAFr+UjhVz4jhwMDFxPKgYs3cDFpohVgAAYAIO7u8eAAjRNA7hBFAwN3ACDvu7nETkLMrnyIj8v/9fNwhF9vKRfm82P5zPPmLV/WKs9G3d16n/v3rubEN0zgs7RdWrHne9brdv5bI4EwEAM6lj7aVdTKtXQHgLdzCKQ2kcihe4FyMcD1r3nR4TWxuax5EOZJEs3DEQnjyqyB8cSfrI6GEcoJxiHBDEfrTOFYrO1//uUBCgAA406ym5hgAB1R1ktzDwACxDBZzj0gAFhGrA3HoACypAXH9HY4umZan4ZlZKldajczMzMzOTnzMvnb77f/1IuSzHIbnJLJdapWmwUAQBXqWPtqV1OyqVqXhB9abR90OyKEsM51pIJK/nXplbDPtKz2dH+oVWeZSm8z7nvAZ19bneqhk3qeBhrhZiLbCc8sRnXb520RnPFd61/AgSR4f8CVlfWpD/////+N6/jv8v4f/6Ln///06c8YYcQIaGmAJ9VhMHEZYc9Kn0TOOYKv2cibDoZieAaGy4Cd6AfGkxQQr+agomAw+dC7AkjOxklIZEpUgmHxXP7/znl/4qT9Z/8+T2a0WF9/lvpv39if/KZnV6Gp1vQRmN1rYDAADfLGQxVR2d49LQLXdImm5n40smwjQ4aIYKMeKCOEw0OBV5cHA8cFV8mB5LyIIeksHspy79/iTv9SH+v66f2Wn/i+Lt//x9y//5MohgAAXiTCVBil4RUZ7XUvPRCD9Uc//uUBAoAAro3Wzc9AABXRutm56AACrUhc6eYT0FWpC508wnoO35hs9j6x7PQOB0PF0JWIkYwigNPoXUBA0cKA6JwDB7lRKDm/93r/mb6iEqL5lv3Vq//6YgYd1AgECi4xACCYbHyukYAAF4kwlQYpeEVGe11Lz0Qg/VHDt+YbPY+sez0DgdDxdCViJGMIoDT6F1AQNHCgOicAwe5USg5v/d6/5m+ohKi+Zb91av/+mIGHdQIBAouMQAgmGx8rptmoLKSACTuBBUPFsH6RlCz+UhoKeVfJy/eqOspBG4PScFOnOxYJJcf/nVzmyfR42Zwxy//hfSUrPq1SzFnO7q/SzNUzst+GQpnZ/kLwzVZ9xJ2lVa02zUFlJABJ3AgqHi2D9IyhZ/KQ0FPKvk5fvVHWUgjcHpOCnTnYsEkuP/zq5zZPo8bM4Y5f/wvpKVn1apZiznd1fpZmqZ2W/DIUzs/yF4Zqs+4k7SqtaYkWgEGMgppYQlMVdKcos2bWFZbFIJp//uUBAsAAr0wWe1hAABXpgs9rCAACwS5azj0gAFgly1nHpAAVgWmZa3LaUWCcGh5HgOEYkViyQUjrX+G5FUr5Dla1ZhtXDf7ckpazXwzeusqq+zXwUePSw8NYzlZKWfbyzod4dCRItAIMZBTSwhKYq6U5RZs2sKy2KQTSrAtMy1uW0osE4NDyPAcIxIrFkgpHWv8NyKpXyHK1qzDauG/25JS1mvhm9dZVV9mvgo8elh4axnKyUs+3lnQ7w6EkIEIIZFKlBSAGwRMrEIEuM658s5gvyVtFDrQtgTY2YSPlAJcgwlXLmokM8sUQJYJOm3eaW04jWVsoghX+ZBt3SHFZOypVez//VONpL+du6U+4WLXBC79cuhAhBDIpUoKQA2CJlYhAlxnXPlnMF+StoodaFsCbGzCR8oBLkGEq5c1EhnliiBLBJ027zS2nEaytlEEK/zINu6Q4rJ2VKr2f/6pxtJfzt3Sn3Cxa4IXfrl6IGEh4icUSUDRZk/k88VFEmCy//uUBAkAAociWgZh4ABQ5EtAzDwAC6zBXBmXgAF1mCuDMvAART7WmhWQ9QwYJexoKJ+z1bcQqfEFmtDtXH8lUg2omFi2b/4+UhW/j+bHgwAM8SqMAQFxYj9wqAwhlftf//sSQMJDxE4okoGizJ/J54qKJMFkin2tNCsh6hgwS9jQUT9nq24hU+ILNaHauP5KpBtRMLFs3/x8pCt/H82PBgAZ4lUYAgLixH7hUBhDK/a///YmHznKbibgJd0lEi0TfuHXCfhZ0faHA6GL3GuUpLTgTwnd/upcFAbo+BGMfzKxWE9PNg+sbrEwwRLn6uFElWTc/zN8Yvf5V3xV29///8OO/f7j3cT0mgMTPP9uPEwIQ+c5TcTcBLukokWib9w64T8LOj7Q4HQxe41ylJacCeE7v91LgoDdHwIxj+ZWKwnp5sH1jdYmGCJc/Vwokqybn+ZvjF7/Ku+Ku3v///hx37/ce7iek0BiZ5/tx4mBCmI5QXQAgigG+j0P8fdg2Xjs//uUBAiAAqwlWwY94ABVhKtgx7wACoilZ7z0AAFUlOz3noAAii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlGI5QXQAgigG+j0P8fdg2Xjsii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlEBsAgCSkHfwmFY/MMKQyg4tjhHeuR2mpSZWstSwEQAw00wZaogwgZL3PPVWw9vuB51zUXf3Df/ytV917DjxQEGA+0mbu4YYg4TnkRcMGQsxH/Ioc1AbAIAkpB38JhWPzDCkMoOLY4R3rkdpqUmVrLUsBEAMNNMGWqIMIGS9zz1VsPb7gedc1F39w3/8rVfdew48UQIFwus29HKDIAW8tcsSGAOKXK/jHmF1AkIAAC8ZUaEFwTHUylbannoarv7HwxH8//uUBAwEAtAx18sMQuBVJisaYSJeCmhnX6eZLQFZJy208wmidE7zXIRk0ZLYCqc1eg1sKc3HZuweFNeSCHHGg+JyhTcd8RE3/+rJXIdH6UpI2qUdVtHGRCOewEOXGUfKG2/v+RIoA0MAAAByh2gABL0EpLTwNTz0qzjM2ER8SF2lsSRLESGiqG5JXMCauo+aTB1GQKTyJd6SDnG6Iv8rkaoYeRihQbVGzJSSQ4sOghQh7vhkf+T0agMeCYAcAABBO40gsg/gOpfIiHoQgldEIGLVK9EaTFmFH9jkkvLA41VT/4q0XDJLUopJkJmWHAqZyRAPJOvBUS+NYSLC4FFjoJkUfGP/La3XNJCMJPep5CkIaRQCSTuM4ikUepPHAnZLEErtHuqs1EWDizBAvsdVeWBxqqn9aiS9FK24Z0KUhvVkY7ZbylKV/SrKiK0yrKqFkPe3/sZ//8xt6t2dajIDpFMRf6tSU9FIlJJKChTJIgq2hhZlrTlNcpaB/Xv5rDOU//uUBA2AAoQl1lVgwARQxLrKrBgAjCyVTrmngAGFkqnXNPAAg4ANdH9PKxIijn/xmvyjW2ZISnLe5yUtyv2ufSTfVJUGyoFiU6s6Crgyd2PEyn5Ul/85kUElPRSJSSSgoUySIKtoYWZa05TXKWgf17+awzlIOADXR/TxLEiKOf/GZ/KNbZkhKct7nJS3K/a59JN9UlQbKgWJTqzoKuDJ3Y8TKflSX/zmRQSCs10kCQCFAcBJCZCbl2c0bF5RBELfoQBmp3G2m3m3lgZoN0/BmhutukeGPbe/GtGj9jtiXNZdfDjIwYiYvnePS27ebO75y/Edksl4SONB/PlBrg6dNh8h+pW2//lktFhYcFZrpIEgEKA4CSEyE3Ls5o2LyiCIW/QgDNTuNtNvNvLAzQbp+DNDdbdI8Me29+NaNH7HbEuay6+HGRgxExfO8elt282d3zl+I7JZLwkcaD+fKDXB06bD5D9Stt//LJaLCw4AhAEAACKEywIJz0PRwTBn6tS2//uUBAmAAmUjVNdhAABMpGqa7CAACWiNUay8pYEtEao1l5SwsvqET9LUv/TIpAROYdsSHIoHxzccjRUPRZmVQnHLH7FYdB9rF8Q11yOCAKeHZHyIhMO///lWz0JPcAQgCAABFCZYEE56Ho4Jgz9WpbWX1CJ+lqX/pkUgInMO2JDkUD45uORoqHoszKoTjlj9isOg+1i+Ia65HBAFPDsj5EQmHf//yrZ6EnuACgcjEAKT2Dfl0wUuCCDwOHgDLjMYs6OLViO840e/fHfBZmadNu+NYYNVT84fPkYRCJ/K5V3vsq0Gh0H0YgBP+moubbodw+IHr/kgAoHIxACk9g35dMFLggg8Dh4Ay4zGLOji1YjvONHv3x3wWZmnTbvjWGDVU/OHz5GEQifyuVd77KtBodB9GIAT/pqLm26HcPiB6/5KAE6OeESRRgDMViF4jCI2bT5fbThs6iKGQfPTVaYtXdjMROEbiIqKlZk1KJAzpcWEnNs6FapfKXq1jerLEhaS//uUBB+BAmUqVWsMKrhMpUqtYYVXCTSlTzWSgAE0lKp2sFAAqcgRPyRHxKsBPAQVtIgCdHPCJIowBmKxC8RhEbNp8vtpw2dRFDIPnpqtMWruxmInCNxEVFSsyalEgZ0uLCTm2dCtUvlL1axvVliQtJVOQIn5Ij4lWAngIK2kQCHQhVnhkMD1BlLGveBt13z8bjbsI+MtfqdjdaAQiJFeBGV0AQFB2Qr8QDBc8iiATM25R8+fqp/Izn9CHGC7CEg5BTqd6jM4IBoADCiIYSTWAeAwKIoGBRr+EfZ3bjcbhhdDLX6nY3WgEIiRXgRloICoOyFfiA4+RRAJmbco+fP1U/kZz+hDjBdhCQcgp1O9QZnAQAbiCQAm485bonLdZ5NLqAAAEaPfiGAJsDpfUrAhC8wIZFkkEsiX6UBGvscp3FQfN5VNjWCnQ6AGqvk/UqZBbG3rpCt0gR7qtiNBxOfSeTupa6fMjXaMuYTclIn9ZIVayP2pYMiVUajtVYufukCu//uUBDWABAw9Uu5p4AKDx9qdzLwAiiyjShmngAFFlGlDNPAAm9bW7Vct6q61jNa/e6f/0cL33T31CoACacjUkabckdbjkoAAQ2Pe5fJoCshU+EXmCMRGkCbpN6UCNfKFHfcVB8kSOgSgDsuTAAtXyfqVMgtjb10hW6QI91XCQyZP85jl1K90+ZGuz5Ewl0gGT+skKsGAr0weA/JVRqO1Vi5+6QK6b1tbtFct6q61jNa+26fG/RwvfdPeIpm6BswQctcoCeIAYEYf1mWXRGbxQSwlUiCoY91ytUSo4mqDAgHrhQ3Y/4l2ptfeDG/xHfQXlda18S59aW+rZz8/Gtf7vXU0aFeJUKxkREA+tA5tnJGCDlrlATxADAjD+syy6IzeKCWEqkQVDHuuVqiVHE1QYEA9cKG7H/Eu1Nr7wY3+I76C8rrWviXPrS31bOfn41r/d66mjQrxKhWMiIgH1oHNs5Iw4nNwugqcGVUIoOnFryq5YBVMFyLPEAM4rxNXgSVW//uUBA+AAtkszwZtgABapZngzbAACxyZTzmkgAljkynnNJABzA8PYTFvx2VIR78NqPytscLolrRXGbLUv3rfHNp37BGU77n4xv9NNmu7larWfrk294JgJMNJQ9k6Z//3mHE5uF0FTgyqhFB04teVXLAKpguRZ4gBnFeJq8CSq2YHh7CYt+OypCPfhtR+VtjhdEtaK4zZal+9b45tO/YIynfc/GN/pps13crVaz9cm3vBMBJhpKLJ0z//vAA/m9Y8//8wALImAAl3wUQQSnfKuPXkDS5Ql5I8JfOufQG0twDlAxToCFKYarEoVqWFNJ6nNVd9fnX5/O72D/GEfeJf1TBIwjlyh7XHDg+dW/e///9oGG0YAH83rHn//mABZEwAEu+CiCCU75Vx68gaXKEvJHhL51z6A2luAcoGKdAQpTDVYlCtSwppPU5qrvr86/P53ewf4wj7xL+qYJGEcuUPa44cHzq373///tAw2joy5iMKijE5A82dFg4+liKoGBQF//uUBAmAAqobToZt4ABVI2nQzbwAClBrX7j0gBFKDWv3HpACuAcKpXhYKYZtV8OtethxIYxrF3onBiRVg0Z5VNJHjodV8sWdI031RiPzue4vQ9IA5zgUawg6s0J1ixM4H0rkVfR6DLmIwqKMTkDzZ0WDj6WIqgYFAW4BwqleFgphm1Xw6162HEhjGsXeicGJFWDRnlU2I8dDqvlizpGm+qMR+dz3F6HpAHOcCjWEHVmhOsWJnA+lcir6PQCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRCCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRDWAElxIBP/fgA5BRsQaBJEcORBgUrqXzDOmyQ7B8Js0//uUBA+AAnIbz+9swABNA3nq7ZgACYxbKSxpgQEzi6UljTAh0ph0igLRRPKosl/+21oMFkUfTMlPbu5vLWMhsIpBoJlEBWacSYwqxs0adkSycpqwAugFfb4AMMU0BUCAJUc6VBAkwaXzDlPhDsnkNmmlMVAKAOiieBJHkv/22tBkzUfXZJ+37zy1jILgmkGjpRAVmnCVjCrGzRozkSydWoAAhAKsACEHAmDZAyOJvjXlQsCbLAhfALBGnDuUyMsKxSWoyN41Ma1yzl81ldaycS4FmOc/HeG0F0EouNMvOJY8wRknQ2MHFgo50O9wABCAVYAEIOBMGyBkcTfGvKhYE2WBC+AWCNOHcpkZYViktRkbxqY1rlnL5rK61k4lwLMc5+Od4vceyz2aZfD2t6Yf1T8VpbBUmvyf/6WSCIaFJmBQHBBPnChjBCJpALOEZzWEOoXAjEVcJwU6QNMnCQemw5lYr1wP4Yrd7Kh813KsJITdZtDZdO/Nb/EeIEOq6mn9//uUBCMMglwayou4eTBKg1lRdw8mCRxbKCzswxEuGGWdow2oj0ziXaKZIIhoUmYFAcEE+cKGMEImkAs4RnNYQ6hcCMRVwnBTpA0ycJB6bDmVivXA/hit3sqHzXcqwkhN1m0Nl0781v8R4gQ3qup/2PTcl2geDKLS0Dlz62OeezARhAXGxQHQWEYYrFAT3TZw4FCwS4JDTF8AkaliQVaJoBk2ZlkiTQ2GgZmiQ1TzBSo+AA7JnYoKkVD1ZLuX4AtuEAwAFeAsHNMiPlXBIxSunQZU2GQTJoCe6bOHAoWCXBIaYvkUWljkvhpGS5mWFUrqaky+ZUivDyLT+PkTH9Nf5Jc8MPCT5LS5agFKBGvwAEGuOYUBgViPhKwULrvceUN2EYE5cfjEPVa76oYHc8iajBh079LyeBx+8xsatjP5+f/v9moz085O0y92c1/TLeIQBc5iarAMAtQBhIDsHMLAswKiDlZBMLgFd7jyhuwXBjO4/GIeq131ERQsohipJqEF//uUBDuAAl4rSc1swABNpWkWriAAT6S1N7msABH4Fqa3NYACK3Y2lxKnyqWlj4I9evjntWStpWltoH3a1c9wPfBQe51tv4QIRW5JWpHY2wmAQCAA3Ez8JQ0wQP/M2RNaIDhCYutAAONBBkAlvb4j4+qi40CU4Bh3bhxXygTVd/7vSq0iY6iSWWXrsXQ29eVJCqUsoXWy7X/vdWvP1JZg/tBEovFId////7rne699onXkM9DUl/+GAZBQDf8JEQCKo//+ogQCRyuRRuRthMAgEABkJp6CMpiBP+aMybcYnwznWkEqoAuaC5GfvF8HZFWg/FXSa8blglIwmKgd/7XpVaYZFGTZZe5DuQPushJSpXIpuwbX/vdWvL6kswcmPQFF4Ef3////LXO917pQHTyGedqP//DAMgoD3/CREAiqP/2eqv////////3dk90KlpVV3eUWVjHLZSMUp5hxnpOcO1WpXVXu4ijKYTSd3IJ7Kzt6Wp7FWiGQUEGFRgdCgpRM//uUBB8P8lRjwIcAoABJLFgQ4BQASJmNAgAFHEkIsiAAAaegRMowxhYVZBMOCoAh7/////////79CTkvIITTqZkZjVGEMPHvEBE7IZXMpGVFYqsKyOYw5jjmOZkFDdkZLkW+9NjEIZxbiYixXO5QkcoRVQoYBgYPlK+XmRGbwXaEFZGvWIpZLWEizxltQ9uELQV7E73d3HESrONG7w3dTdpF6Skf/zNT3I6rIKxJy1oKCtGGjj5FDxcKB+HpYd/3//i3rZFOT0N05+QpgWZYZ3pi5biJNCj4fRQQwYK8p48BQUTWPDTbNjkPn8+1VXKvJ7dJ5Gb2mESWLjnHOYNH07r6//////////icK81KXqTXuvQEteLGdY0DKwrjQVTIMKbgE0b41Egi1KxtuNwUpf9X+bNqTUlXbDClWgIlS4wMVc1F0QZc3/N/yto/7eUShjGUstRgIUZXKUrFYwU5SgKOxgYE+krfVkf6St/VpnMaYwpwoCjoZwoCZwqFC4LH//uUBD+P4jNjPwAjN8I7THfwAEnqR8mAugCAcQkHsheEERr40LUwj//hIzL//9k/9rJZ9lks+yyVDL/////81YHZUMj//yZZLHIy7/5qwMHHIyZZL/sslQyNWt/I1DBQYRxPYaxS/////5kn///6on0VEVP/6on/7OVFVO5QwUGEOzyhgaoqKhQwMGCUjt////8qaLdr/qTiyzLxaJxpRTt6RBhIhDZMQU1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq`),ao=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let n=new si(Xn(e));return e.decodeAudioData(io.buffer.slice(0)).then(e=>{n.buf=e}).catch(e=>{console.error(`Failed to load burp: `,e)}),{ctx:e,masterNode:t,burpSnd:n}})();function oo(e,t={}){let r=new zt,i=new Audio(e);i.crossOrigin=`anonymous`,i.loop=!!t.loop,R.audio.ctx.createMediaElementSource(i).connect(R.audio.masterNode);function a(){R.debug.paused||R.app.isHidden()&&!R.globalOpt.backgroundAudio||R.audio.ctx.resume()}function o(){a(),i.play()}return t.paused||o(),i.onended=()=>r.trigger(),{play(){o()},seek(e){i.currentTime=e},stop(){i.pause(),this.seek(0)},set loop(e){i.loop=e},get loop(){return i.loop},set paused(e){e?i.pause():o()},get paused(){return i.paused},time(){return i.currentTime},duration(){return i.duration},set volume(e){i.volume=n(e,0,1)},get volume(){return i.volume},set speed(e){i.playbackRate=Math.max(e,0)},get speed(){return i.playbackRate},set detune(e){},get detune(){return 0},onEnd(e){return r.add(e)},then(e){return this.onEnd(e)}}}function so(e,t={}){if(typeof e==`string`&&R.assets.music[e])return oo(R.assets.music[e],t);let n=R.audio.ctx,r=t.paused??!1,i=n.createBufferSource(),a=new zt,o=n.createGain(),s=n.createStereoPanner(),c=t.seek??0,l=0,u=0,d=!1;i.loop=!!t.loop,i.detune.value=t.detune??0,i.playbackRate.value=t.speed??1,i.connect(s),i.onended=()=>{m()>=(i.buffer?.duration??1/0)&&a.trigger()},s.pan.value=t.pan??0,s.connect(o),o.connect(R.audio.masterNode),o.gain.value=t.volume??1;let f=e=>{i.buffer=e.buf,r||(l=n.currentTime,i.start(0,c),d=!0)},p=ci(e);p instanceof wr&&p.onLoad(f);let m=()=>{if(!i.buffer)return 0;let e=r?u-l:n.currentTime-l,t=i.buffer.duration;return i.loop?e%t:Math.min(e,t)},h=e=>{let t=n.createBufferSource();return t.buffer=e.buffer,t.loop=e.loop,t.playbackRate.value=e.playbackRate.value,t.detune.value=e.detune.value,t.onended=e.onended,t.connect(s),t};return{stop(){this.paused=!0,this.seek(0)},set paused(e){if(r!==e)if(r=e,e)d&&=(i.stop(),!1),u=n.currentTime;else{i=h(i);let e=u-l;i.start(0,e),d=!0,l=n.currentTime-e,u=0}},get paused(){return r},play(e=0){this.seek(e),this.paused=!1},seek(e){i.buffer?.duration&&(e>i.buffer.duration||(r?(i=h(i),l=u-e):(i.stop(),i=h(i),l=n.currentTime-e,i.start(0,e),d=!0,u=0)))},set speed(e){i.playbackRate.value=e},get speed(){return i.playbackRate.value},set detune(e){i.detune.value=e},get detune(){return i.detune.value},set volume(e){o.gain.value=Math.max(e,0)},get volume(){return o.gain.value},set pan(e){s.pan.value=e},get pan(){return s.pan.value},set loop(e){i.loop=e},get loop(){return i.loop},duration(){return i.buffer?.duration??0},time(){return m()%this.duration()},onEnd(e){return a.add(e)},then(e){return this.onEnd(e)}}}function co(e){return R.k.play(R.audio.burpSnd,e)}function lo(e){R.audio.masterNode.gain.value=e}function uo(){return R.audio.masterNode.gain.value}function fo(e){return rn(`volume`,`setVolume / getVolume`),e!==void 0&&lo(e),uo()}function po(){R.app.onHide(()=>{R.globalOpt.backgroundAudio||R.audio.ctx.suspend()}),R.app.onShow(()=>{!R.globalOpt.backgroundAudio&&!R.debug.paused&&R.audio.ctx.resume()}),R.app.onResize(()=>{if(R.app.isFullscreen())return;let e=R.globalOpt.width&&R.globalOpt.height;e&&!R.globalOpt.stretch&&!R.globalOpt.letterbox||(R.canvas.width=R.canvas.offsetWidth*R.pixelDensity,R.canvas.height=R.canvas.offsetHeight*R.pixelDensity,Tn(),e||(R.gfx.frameBuffer.free(),R.gfx.frameBuffer=new Ti(R.gfx.ggl,R.gfx.ggl.gl.drawingBufferWidth,R.gfx.ggl.gl.drawingBufferHeight),R.gfx.width=R.gfx.ggl.gl.drawingBufferWidth/R.pixelDensity/R.gscale,R.gfx.height=R.gfx.ggl.gl.drawingBufferHeight/R.pixelDensity/R.gscale))}),R.globalOpt.debug!==!1&&(R.app.onKeyPress(R.globalOpt.debugKey??`f1`,()=>R.debug.inspect=!R.debug.inspect),R.app.onKeyPress(`f2`,()=>R.debug.clearLog()),R.app.onKeyPress(`f8`,()=>R.debug.paused=!R.debug.paused),R.app.onKeyPress(`f7`,()=>{R.debug.timeScale=an(n(R.debug.timeScale-.2,0,2),1)}),R.app.onKeyPress(`f9`,()=>{R.debug.timeScale=an(n(R.debug.timeScale+.2,0,2),1)}),R.app.onKeyPress(`f10`,()=>R.debug.stepFrame())),R.globalOpt.burp&&R.app.onKeyPress(`b`,()=>co())}function mo(e,t={}){let n=R.game.root.add([ps(e),Go()]),r=(t.speed||1)*5,i=t.scale||1;n.add([To(R.boomSprite),hs(0),ss(`center`),Bo(r,i),...t.comps??[]]);let a=n.add([To(R.kaSprite),hs(0),ss(`center`),qo(),...t.comps??[]]);return a.wait(.4/r,()=>a.use(Bo(r,i))),a.onDestroy(()=>n.destroy()),n}function ho(e,t){if(R.game.layers)throw Error(`Layers can only be assigned once.`);let n=e.indexOf(t);if(n==-1)throw Error(`The default layer name should be present in the layers list.`);R.game.layers=e,R.game.defaultLayerIndex=n}function go(){return R.game.layers}function _o(){return R.game.layers?.[R.game.defaultLayerIndex]??null}function vo(e,t){rn(`layers`,`setLayers`),ho(e,t)}function yo(e){e.destroy()}function bo(){return R.game.root}function xo(e,t){R.game.scenes[e]=t}function So(e,...t){if(!R.game.scenes[e])throw Error(`Scene not found: ${e}`);R.game.events.onOnce(`frameEnd`,()=>{R.game.events.trigger(`sceneLeave`,e),R.app.events.clear(),R.game.events.clear(),R.game.objEvents.clear(),[...R.game.root.children].forEach(t=>{!t.stay||t.scenesToStay&&!t.scenesToStay.includes(e)?R.game.root.remove(t):t.trigger(`sceneEnter`,e)}),R.game.root.clearEvents(),po(),R.game.cam={pos:null,scale:f(1),angle:0,shake:0,transform:new _},R.game.scenes[e](...t)}),R.game.currentScene=e}function Co(e){return R.game.events.on(`sceneLeave`,e)}function wo(){return R.game.currentScene}function To(e,t={}){let n=null,r=null,i=null,a=new zt;if(!e)throw Error(`Please pass the resource name or data to sprite()`);let o=(e,t,n,r)=>{let i=f(1,1);return n&&r?(i.x=n/(e.width*t.w),i.y=r/(e.height*t.h)):n?(i.x=n/(e.width*t.w),i.y=i.x):r&&(i.y=r/(e.height*t.h),i.x=i.y),i},s=(e,r)=>{if(!r)return;let i=r.frames[0].clone();t.quad&&(i=i.scale(t.quad));let s=o(r.tex,i,t.width,t.height);if(e.width=r.tex.width*i.w*s.x,e.height=r.tex.height*i.h*s.y,r.anims)for(let e in r.anims){let t=r.anims[e];typeof t!=`number`&&(t.frames=c(t))}n=r,a.trigger(n),t.anim&&e.play(t.anim)},c=e=>{if(e.frames)return e.frames;let t=[];if(e.from===void 0||e.to===void 0)throw Error(`Sprite anim 'from' and 'to' must be defined if 'frames' is not defined`);let n=Math.abs(e.to-e.from)+1;for(let r=0;r<n;r++)t.push(e.from+r*Math.sign(e.to-e.from));if(e.pingpong)for(let e=n-2;e>0;e--)t.push(t[e]);return t};return{id:`sprite`,width:0,height:0,frame:t.frame||0,quad:t.quad||new p(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(e){let t=Br(e);t&&t.onLoad(e=>s(this,e))},get animFrame(){if(!n||!r||i===null)return this.frame;let e=n.anims[r.name];return typeof e==`number`?e:e.from===void 0||e.to===void 0?r.frameIndex:this.frame-Math.min(e.from,e.to)},draw(){if(!n)return;let e=n.frames[this.frame??0];if(!e)throw Error(`Frame not found: ${this.frame??0}`);if(n.slice9){let{left:r,right:i,top:a,bottom:o}=n.slice9,s=n.tex.width*e.w,c=n.tex.height*e.h,l=this.width-r-i,u=this.height-a-o,d=r/s,f=i/s,p=1-d-f,h=a/c,g=o/c,_=1-h-g,v=[m(0,0,d,h),m(d,0,p,h),m(d+p,0,f,h),m(0,h,d,_),m(d,h,p,_),m(d+p,h,f,_),m(0,h+_,d,g),m(d,h+_,p,g),m(d+p,h+_,f,g),m(0,0,r,a),m(r,0,l,a),m(r+l,0,i,a),m(0,a,r,u),m(r,a,l,u),m(r+l,a,i,u),m(0,a+u,r,o),m(r,a+u,l,o),m(r+l,a+u,i,o)];for(let r=0;r<9;r++){let i=v[r],a=v[r+9];Gi(Object.assign(Zi(this),{pos:a.pos(),tex:n.tex,quad:e.scale(i),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:a.w,height:a.h}))}}else Gi(Object.assign(Zi(this),{tex:n.tex,quad:e.scale(this.quad??new p(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let t=Br(e);t?t.onLoad(e=>s(this,e)):Pa(()=>s(this,Br(e).data))},update(){if(!n||!r||i===null)return;let e=n.anims[r.name];if(typeof e==`number`){this.frame=e;return}if(e.speed===0)throw Error(`Sprite anim speed cannot be 0`);if(r.timer+=F()*this.animSpeed,r.timer>=1/r.speed){r.timer=0,r.frameIndex+=i;let t=e.frames;if(r.frameIndex>=t.length)if(r.pingpong&&!e.pingpong)i=-1,r.frameIndex=t.length-2;else if(r.loop)r.frameIndex=0;else{this.frame=t.at(-1),r.onEnd(),this.stop();return}else if(r.frameIndex<0)if(r.pingpong&&r.loop)i=1,r.frameIndex=1;else if(r.loop)r.frameIndex=t.length-1;else{this.frame=t[0],r.onEnd(),this.stop();return}this.frame=t[r.frameIndex]}},play(e,t={}){if(!n){a.add(()=>this.play(e,t));return}let o=n.anims[e];if(o===void 0)throw Error(`Anim not found: ${e}`);r&&this.stop(),r=typeof o==`number`?{name:e,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:e,timer:0,loop:t.loop??o.loop??!1,pingpong:t.pingpong??o.pingpong??!1,speed:t.speed??o.speed??10,frameIndex:0,onEnd:t.onEnd??(()=>{})},i=typeof o==`number`?null:1,this.frame=typeof o==`number`?o:o.frames[0],this.trigger(`animStart`,e)},stop(){if(!r)return;let e=r.name;r=null,this.trigger(`animEnd`,e)},numFrames(){return n?.frames.length??0},getCurAnim(){return r},curAnim(){return r?.name},getAnim(e){return n?.anims[e]??null},hasAnim(e){return!!this.getAnim(e)},onAnimEnd(e){return this.on(`animEnd`,e)},onAnimStart(e){return this.on(`animStart`,e)},renderArea(){return new N(f(0),this.width,this.height)},inspect(){return typeof e==`string`?`sprite: "${e}"`:null}}}function Eo(e,t={}){function n(e){let n=Mi(Object.assign(Zi(e),{text:e.text+``,size:e.textSize,font:e.font,width:t.width&&e.width,align:e.align,letterSpacing:e.letterSpacing,lineSpacing:e.lineSpacing,transform:e.textTransform,styles:e.textStyles,indentAll:t.indentAll}));return t.width||(e.width=n.width/(e.scale?.x||1)),e.height=n.height/(e.scale?.y||1),n}let r={id:`text`,set text(t){e=t,n(this),this.renderedText=ji(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?ji(e).text:``,add(){Pa(()=>n(this))},draw(){Pi(n(this))},renderArea(){return new N(f(0),this.width,this.height)}};return n(r),r}function Do(e,t){return{id:`rect`,width:e,height:t,draw(){Ni(Object.assign(Zi(this),{width:this.width,height:this.height}))},renderArea(){return new N(f(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function Oo(e={}){let t=null,n=null,r=null,i=null;return{id:`agent`,require:[`pos`,`tile`],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return n&&r?n[r]:null},getPath(){return n?n.slice():null},getTarget(){return t},isNavigationFinished(){return n?r===null:!0},isTargetReachable(){return n!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(e){t=e,n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),r=n?0:null,n&&r!==null?(i||(i=this.getLevel().onNavigationMapChanged(()=>{t&&n&&r!==null&&(n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),n?(r=0,this.trigger(`navigationNext`,this,n[r])):(r=null,this.trigger(`navigationEnded`,this)))}),this.onDestroy(()=>i?.cancel())),this.trigger(`navigationStarted`,this),this.trigger(`navigationNext`,this,n[r])):this.trigger(`navigationEnded`,this)},update(){if(t&&n&&r!==null){if(this.pos.sdist(n[r])<2)if(r===n.length-1){this.pos=t.clone(),r=null,this.trigger(`navigationEnded`,this),this.trigger(`targetReached`,this);return}else r++,this.trigger(`navigationNext`,this,n[r]);this.moveTo(n[r],this.agentSpeed)}},onNavigationStarted(e){return this.on(`navigationStarted`,e)},onNavigationNext(e){return this.on(`navigationNext`,e)},onNavigationEnded(e){return this.on(`navigationEnded`,e)},onTargetReached(e){return this.on(`targetReached`,e)},inspect(){return`agent: `+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(n)})}}}function ko(e){let t=e.graph;return{id:`pathfinder`,require:[`pos`],navigateTo(t){return this.graph?.getWaypointPath(this.pos,t,e.navigationOpt)},get graph(){if(t)return t;let e=this.parent;for(;e;){if(e.has(`pathfinderMap`))return e.graph;e=e.parent}},set graph(e){t=e}}}function Ao(e={}){let t=e.waypoints,n=e.speed||100,r=e.endBehavior||`stop`,i=0,a=t!=null;return{id:`patrol`,require:[`pos`],get patrolSpeed(){return n},set patrolSpeed(e){n=e},get waypoints(){return t},set waypoints(e){t=e,i=0,a=!1},get nextLocation(){return t?t[i]:void 0},update(){let e=this.nextLocation;if(!(!t||!e||a)&&(this.moveTo(e,n),this.pos.sdist(e)<9))switch(r){case`loop`:i=(i+1)%t.length;break;case`ping-pong`:i+=1,i==t.length&&(t.reverse(),i=0);break;case`stop`:i<t.length-1?i+=1:a||(a=!0,this.trigger(`patrolFinished`,this));break}},onPatrolFinished(e){return this.on(`patrolFinished`,e)}}}function jo(e,t={}){let n=typeof e==`function`?e:()=>R.game.root.query(e),r=t.checkFrequency||1,i=typeof t.direction==`number`?d.fromAngle(t.direction):t.direction,a=0;return{id:`sentry`,require:[`pos`],direction:typeof t.direction==`number`?d.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(e){this.direction=e===void 0?void 0:d.fromAngle(e)},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(e,n,r){let a=(typeof n==`number`?d.fromAngle(n):n)||i,o=r||t.fieldOfView;if(!a||!o||o>=360)return!0;let s=o/2;return e.pos&&a.angleBetween(e.pos.sub(this.pos))<=s},hasLineOfSight(e){let n=ca(this.pos,e.pos.sub(this.pos),t.raycastExclude);return n!=null&&n.object===e},update(){if(a+=F(),a>r){a-=r;let e=n();if(e.length&&i&&this.fieldOfView&&this.fieldOfView<360){let t=this.fieldOfView/2;e=e.filter(e=>e.pos&&i.angleBetween(e.pos.sub(this.pos))<=t)}e.length&&t.lineOfSight&&(e=e.filter(e=>e.pos&&this.hasLineOfSight(e))),e.length>0&&(this.spotted=e,this.trigger(`objectSpotted`,e))}},onObjectsSpotted(e){return this.on(`objectSpotted`,e)}}}function Mo(e={}){let t=f(0),n=e.isObstacle??!1,r=e.cost??0,i=e.edges??[],a=()=>{let e={left:1,top:2,right:4,bottom:8};return i.map(t=>e[t]||0).reduce((e,t)=>e|t,0)},o=a();return{id:`tile`,tilePosOffset:e.offset??f(0),set tilePos(e){let n=this.getLevel();t=e.clone(),this.pos=f(this.tilePos.x*n.tileWidth(),this.tilePos.y*n.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(e){n!==e&&(n=e,this.getLevel().invalidateNavigationMap())},get isObstacle(){return n},set cost(e){r!==e&&(r=e,this.getLevel().invalidateNavigationMap())},get cost(){return r},set edges(e){i=e,o=a(),this.getLevel().invalidateNavigationMap()},get edges(){return i},get edgeMask(){return o},getLevel(){return this.parent},tileMove(e){let t=this.getLevel();t.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(e),t.insertIntoSpatialMap(this),t.trigger(`spatialMapChanged`)},moveLeft(){this.tileMove(f(-1,0))},moveRight(){this.tileMove(f(1,0))},moveUp(){this.tileMove(f(0,-1))},moveDown(){this.tileMove(f(0,1))}}}var No=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,n){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||`forward`,this.easing=t.easing||nr.linear,this.interpolation=t.interpolation||`linear`,this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=n}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,n){let r=t-1,i=e/this.duration;if(this.loops!==0&&i>=this.loops)return[r,0,!0];let a=Math.trunc(i);if(i-=a,(this.direction==`reverse`||this.direction==`ping-pong`&&a&1)&&(i=1-i),n){let e=0;for(;n[e+1]!==void 0&&n[e+1]<i;)e++;return e>=r?[r,0,!0]:[e,(i-n[e])/(n[e+1]-n[e]),!1]}else{let e=Math.floor((t-1)*i);return[e,(i-e/r)*r,!1]}}setValue(e,t,n){if(this.relative)switch(t){case`pos`:e.pos=e.base.pos.add(n);break;case`angle`:e.angle=e.base.angle+n;break;case`scale`:e.scale=e.base.scale.scale(n);break;case`opacity`:e.opacity=e.base.opacity*n;break;default:e[t]=n}else e[t]=n}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!==`forward`&&(e.direction=this.direction),this.easing!=nr.linear&&(e.easing=this.easing.name),this.interpolation!==`linear`&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(e=>this.easing.name)),e}};function Po(e,t){return t.add(t.sub(e))}var Fo=class extends No{keys;constructor(e,t,n,r){super(e,n,r),this.keys=t}update(e,t){let[n,r,i]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(r==0||this.interpolation===`none`)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,c(this.keys[n],this.keys[n+1],t(r)))}return i}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},Io=class extends No{keys;curves;dcurves;constructor(e,t,n,r,i){if(super(e,n,r),this.keys=t,this.interpolation===`spline`){this.curves=[],i&&(this.dcurves=[]);for(let e=0;e<this.keys.length-1;e++){let t=this.keys[e],n=e+1,r=this.keys[n],a=e>0?this.keys[e-1]:Po(r,t),o=n<this.keys.length-1?this.keys[n+1]:Po(t,r);this.curves.push(Xe(a,t,r,o)),i&&this.dcurves?.push(Xe(a,t,r,o,$e))}}}update(e,t){let[n,r,i]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(r==0||this.interpolation===`none`)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;switch(this.interpolation){case`linear`:this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],t(r)));break;case`slerp`:this.setValue(e,this.name,this.keys[n].slerp(this.keys[n+1],t(r)));break;case`spline`:if(this.curves){this.setValue(e,this.name,this.curves[n](t(r))),this.dcurves&&this.setValue(e,`angle`,this.dcurves[n](t(r)).angle());break}}}return i}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(e=>[e.x,e.y])})}},Lo=class extends No{keys;constructor(e,t,n,r){super(e,n,r),this.keys=t}update(e,t){let[n,r,i]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(r==0||this.interpolation==`none`)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],t(r)))}return i}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function Ro(e={}){let t=[],i=0,a=!1;return{id:`animate`,require:e.followMotion?[`rotate`]:void 0,base:{pos:f(0,0),angle:0,scale:f(1,1),opacity:1},animation:{paused:!1,seek(e){i=n(e,0,this.duration),t.forEach(e=>{e.isFinished=!1}),a=!1},get duration(){return t.reduce((e,t)=>Math.max(t.duration,e),0)}},add(){e.relative&&(this.has(`pos`)&&(this.base.pos=this.pos.clone()),this.has(`rotate`)&&(this.base.angle=this.angle),this.has(`scale`)&&(this.base.scale=this.scale),this.has(`opacity`)&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let e=!0,n;i+=F();for(let r of t)n=r.update(this,i),n&&!r.isFinished&&(r.isFinished=!0,this.trigger(`animateChannelFinished`,r.name)),e&&=n;e&&!a&&(a=!0,this.trigger(`animateFinished`))},animate(n,i,o){a=!1,this.unanimate(n),typeof i[0]==`number`?t.push(new Fo(n,i,o,e.relative||!1)):i[0]instanceof d?t.push(new Io(n,i,o,e.relative||!1,n===`pos`&&(e.followMotion||!1))):i[0]instanceof r&&t.push(new Lo(n,i,o,e.relative||!1))},unanimate(e){let n=t.findIndex(t=>t.name===e);n>=0&&t.splice(n,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(e){return this.on(`animateFinished`,e)},onAnimateChannelFinished(e){return this.on(`animateChannelFinished`,e)},serializeAnimationChannels(){return t.reduce((e,t)=>(e[t.name]=t.serialize(),e),{})},serializeAnimationOptions(){let t={};return e.followMotion&&(t.followMotion=!0),e.relative&&(t.relative=!0),t}}}function zo(e,t){let n={name:e.name};return e.has(`animate`)&&(n.channels=e.serializeAnimationChannels(),Object.assign(n,e.serializeAnimationOptions())),e.children.length>0&&(n.children=e.children.filter(e=>e.has(`named`)).map(e=>zo(e,e.name))),n}function Bo(e=2,t=1){let n=0;return{require:[`scale`],update(){let r=Math.sin(n*e)*t;r<0&&this.destroy(),this.scale=f(r),n+=F()}}}function Vo(e,t){if(e==null)throw Error(`health() requires the initial amount of hp`);return{id:`health`,hurt(t=1){this.setHP(e-t),this.trigger(`hurt`,t)},heal(t=1){let n=e;this.setHP(e+t),this.trigger(`heal`,e-n)},hp(){return e},maxHP(){return t??null},setMaxHP(e){t=e},setHP(n){e=t?Math.min(t,n):n,e<=0&&this.trigger(`death`)},onHurt(e){return this.on(`hurt`,e)},onHeal(e){return this.on(`heal`,e)},onDeath(e){return this.on(`death`,e)},inspect(){return`health: ${e}`}}}function Ho(e,t={}){if(e==null)throw Error(`lifespan() requires time`);let n=t.fade??0;return{id:`lifespan`,require:[`opacity`],add(){R.game.root.wait(e,()=>{this.opacity=this.opacity??1,n>0?R.game.root.tween(this.opacity,0,n,e=>this.opacity=e,nr.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function Uo(e){return{id:`named`,name:e}}function Wo(e,t,n){if(!e)throw Error(`state() requires an initial state`);let r={};function i(e){r[e]||(r[e]={enter:new zt,end:new zt,update:new zt,draw:new zt})}function a(e,t,n){return i(t),r[t][e].add(n)}function o(e,t,...n){i(t),r[t][e].trigger(...n)}let s=!1;return{id:`state`,state:e,enterState(e,...r){if(s=!0,t&&!t.includes(e))throw Error(`State not found: ${e}`);let i=this.state;if(n){if(!n?.[i])return;let t=typeof n[i]==`string`?[n[i]]:n[i];if(!t.includes(e))throw Error(`Cannot transition state from "${i}" to "${e}". Available transitions: ${t.map(e=>`"${e}"`).join(`, `)}`)}o(`end`,i,...r),this.state=e,o(`enter`,e,...r),o(`enter`,`${i} -> ${e}`,...r)},onStateTransition(e,t,n){return a(`enter`,`${e} -> ${t}`,n)},onStateEnter(e,t){return a(`enter`,e,t)},onStateUpdate(e,t){return a(`update`,e,t)},onStateDraw(e,t){return a(`draw`,e,t)},onStateEnd(e,t){return a(`end`,e,t)},update(){s||=(o(`enter`,e),!0),o(`update`,this.state)},draw(){o(`draw`,this.state)},inspect(){return`state: ${this.state}`}}}function Go(e){return{id:`stay`,stay:!0,scenesToStay:e}}function Ko(e=!0,t){let n,r;return{id:`textInput`,hasFocus:e,require:[`text`],typedText:``,add(){let e=()=>{this.text=this.typedText.replace(/([\[\\])/g,`\\$1`)};n=R.k.onCharInput(n=>{this.hasFocus&&(!t||this.typedText.length<t)&&(R.k.isKeyDown(`shift`)?this.typedText+=n.toUpperCase():this.typedText+=n,e())}),r=R.k.onKeyPressRepeat(`backspace`,()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),e())})},destroy(){n.cancel(),r.cancel()}}}function qo(e=1e3){return{id:`timer`,maxLoopsPerFrame:e,loop(e,t,n=1/0,r=!1){let i=r?0:e,a=new zt,o=this.onUpdate(()=>{i+=R.app.state.dt;for(let r=0;i>=e&&r<this.maxLoopsPerFrame;r++)if(n--,t(),i-=e,n<=0){o.cancel(),a.trigger();return}});return{get paused(){return o.paused},set paused(e){o.paused=e},cancel:o.cancel,onEnd(e){a.add(e)},then(e){return a.add(e),this}}},wait(e,t){return this.loop(e,t??(()=>{}),1,!0)},tween(e,t,n,r,i=nr.linear){let a=0,o=[],s=this.onUpdate(()=>{a+=R.app.state.dt;let l=Math.min(a/n,1);r(c(e,t,i(l))),l===1&&(s.cancel(),r(t),o.forEach(e=>e()))});return{get paused(){return s.paused},set paused(e){s.paused=e},onEnd(e){o.push(e)},then(e){return this.onEnd(e),this},cancel(){s.cancel()},finish(){s.cancel(),r(t),o.forEach(e=>e())}}}}}var Jo=0;function Yo(){return Jo>0}function Xo(e={}){let t={},n=new Set,r=[];return{id:`area`,collisionIgnore:e.collisionIgnore??[],add(){Jo++,this.area.cursor&&r.push(this.onHover(()=>R.app.setCursor(this.area.cursor))),r.push(this.onCollideUpdate((e,r)=>{if(!e.id)throw Error(`area() requires the object to have an id`);t[e.id]||this.trigger(`collide`,e,r),r&&(t[e.id]=r,n.add(e.id))}))},destroy(){Jo--;for(let e of r)e.cancel()},fixedUpdate(){for(let e in t)n.has(Number(e))||(this.trigger(`collideEnd`,t[e].target),delete t[e]);n.clear()},drawInspect(){let e=this.localArea();pr(),I(this.area.offset);let t={outline:{width:4/br(),color:i(0,0,255)},anchor:this.anchor,fill:!1,fixed:Xi(this)};e instanceof N?Fi({...t,pos:e.pos,width:e.width*this.area.scale.x,height:e.height*this.area.scale.y}):e instanceof Le?mi({...t,pts:e.pts,scale:this.area.scale}):e instanceof Pe&&gi({...t,pos:e.center,radius:e.radius}),_r()},area:{shape:e.shape??null,scale:e.scale?f(e.scale):f(1),offset:e.offset??f(0),cursor:e.cursor??null},isClicked(){return R.app.isMousePressed()&&this.isHovering()},isHovering(){let e=Xi(this)?R.k.mousePos():R.k.toWorld(R.k.mousePos());return this.hasPoint(e)},checkCollision(e){if(!e.id)throw Error(`checkCollision() requires the object to have an id`);return t[e.id]??null},getCollisions(){return Object.values(t)},isColliding(e){if(!e.id)throw Error(`isColliding() requires the object to have an id`);return!!t[e.id]},isOverlapping(e){if(!e.id)throw Error(`isOverlapping() requires the object to have an id`);let n=t[e.id];return n&&n.hasOverlap()},onClick(e,t=`left`){let n=this.onMousePress(t,()=>{this.isHovering()&&e()});return r.push(n),n},onHover(e){let t=!1;return this.onUpdate(()=>{t?t=this.isHovering():this.isHovering()&&(t=!0,e())})},onHoverUpdate(e){return this.onUpdate(()=>{this.isHovering()&&e()})},onHoverEnd(e){let t=!1;return this.onUpdate(()=>{t?this.isHovering()||(t=!1,e()):t=this.isHovering()})},onCollide(e,t){if(typeof e==`function`&&t===void 0)return this.on(`collide`,e);if(typeof e==`string`)return this.onCollide((n,r)=>{n.is(e)&&t?.(n,r)});throw Error(`onCollide() requires either a function or a tag`)},onCollideUpdate(e,t){if(typeof e==`function`&&t===void 0)return this.on(`collideUpdate`,e);if(typeof e==`string`)return this.on(`collideUpdate`,(n,r)=>n.is(e)&&t?.(n,r));throw Error(`onCollideUpdate() requires either a function or a tag`)},onCollideEnd(e,t){if(typeof e==`function`&&t===void 0)return this.on(`collideEnd`,e);if(typeof e==`string`)return this.on(`collideEnd`,n=>n.is(e)&&t?.(n));throw Error(`onCollideEnd() requires either a function or a tag`)},hasPoint(e){return pe(this.worldArea(),e)},resolveCollision(e){let t=this.checkCollision(e);t&&!t.resolved&&(this.pos=this.pos.add(t.displacement),t.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let e=this.localArea();if(!(e instanceof Le||e instanceof N))throw Error(`Only support polygon and rect shapes for now`);let t=this.transform.clone().translate(this.area.offset).scale(f(this.area.scale??1));if(e instanceof N){let n=Jn(this.anchor||vt).add(1,1).scale(-.5).scale(e.width,e.height);t.translate(n)}return e.transform(t)},screenArea(){let e=this.worldArea();return Xi(this)?e:e.transform(R.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function Zo(e={}){let t=null,n=null,r=!1,i=f(0),a=null,o=null,s;return{id:`body`,require:[`pos`],vel:f(0),drag:e.drag??0,jumpForce:e.jumpForce??Pt,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),o=this.pos.clone(),s=this.pos.clone(),this.mass===0)throw Error(`Can't set body mass to 0`);this.has(`area`)&&(this.onCollideUpdate((e,t)=>{if(!t||!e.has(`body`)||t.resolved)return;this.trigger(`beforePhysicsResolve`,t);let n=t.reverse();if(e.trigger(`beforePhysicsResolve`,n),!(t.resolved||n.resolved)&&!(this.isStatic&&e.isStatic)){if(!this.isStatic&&!e.isStatic){let n=this.mass+e.mass;this.pos=this.pos.add(t.displacement.scale(e.mass/n)),e.pos=e.pos.add(t.displacement.scale(-this.mass/n)),this.transform=cr(this),e.transform=cr(e)}else{let n=!this.isStatic&&e.isStatic?t:t.reverse();n.source.pos=n.source.pos.add(n.displacement),n.source.transform=cr(n.source)}t.resolved=!0,this.trigger(`physicsResolve`,t),e.trigger(`physicsResolve`,t.reverse())}}),this.onPhysicsResolve(e=>{if(R.game.gravity)if(e.isBottom()&&this.isFalling()){this.vel=this.vel.reject(R.game.gravity.unit());let i=t;t=e.target,i!=t&&(n=e.target.pos),r?r=!1:i||(this.trigger(`ground`,t),e.target.trigger(`land`,this))}else e.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(R.game.gravity.unit()),this.trigger(`headbutt`,e.target),e.target.trigger(`headbutted`,this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has(`body`)&&(n&&!t.pos.eq(n)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(n)),n=t.pos);let r=Rn();r&&(this.pos.x==s.x&&(this.pos.x=c(a.x,o.x,r/Ln()),s.x=this.pos.x),this.pos.y==s.y&&(this.pos.y=c(a.y,o.y,r/Ln()),s.y=this.pos.y))},fixedUpdate(){if(a&&=(this.pos.x==s.x&&(this.pos.x=a.x),this.pos.y==s.y&&(this.pos.y=a.y),null),R.game.gravity&&!this.isStatic){r&&=(t=null,n=null,this.trigger(`fallOff`),!1),t&&(!this.isColliding(t)||!t.exists()||!t.has(`body`))&&(r=!0);let i=this.vel.clone();this.vel=this.vel.add(R.game.gravity.scale(this.gravityScale*F()));let a=e.maxVelocity??Ft;this.vel.slen()>a*a&&(this.vel=this.vel.unit().scale(a)),i.dot(R.game.gravity)<0&&this.vel.dot(R.game.gravity)>=0&&this.trigger(`fall`)}if(this.vel.x+=i.x*F(),this.vel.y+=i.y*F(),this.vel.x*=1-this.drag*F(),this.vel.y*=1-this.drag*F(),this.move(this.vel),Rn()){a=this.pos.clone();let e=this.vel.add(i.scale(F()));o=this.pos.add(e.scale(F())),s=this.pos.clone()}i.x=0,i.y=0},onPhysicsResolve(e){return this.on(`physicsResolve`,e)},onBeforePhysicsResolve(e){return this.on(`beforePhysicsResolve`,e)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(ro())>0},isJumping(){return this.vel.dot(ro())<0},applyImpulse(e){this.isStatic||(this.vel=this.vel.add(e))},addForce(e){this.isStatic||(i.x+=e.x/this.mass,i.y+=e.y/this.mass)},jump(e){this.isStatic||(t=null,n=null,this.vel=ro().scale(-e||-this.jumpForce))},onGround(e){return this.on(`ground`,e)},onFall(e){return this.on(`fall`,e)},onFallOff(e){return this.on(`fallOff`,e)},onHeadbutt(e){return this.on(`headbutt`,e)},onLand(e){return this.on(`land`,e)},onHeadbutted(e){return this.on(`headbutted`,e)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function Qo(e=2){let t=e;return{id:`doubleJump`,require:[`body`],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(e){t<=0||(t<this.numJumps&&this.trigger(`doubleJump`),t--,this.jump(e))},onDoubleJump(e){return this.on(`doubleJump`,e)},inspect(){return`jumpsLeft: ${t}`}}}function $o(e){return{id:`surfaceEffector`,require:[`area`],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate(`body`,(e,t)=>{let n=t?.normal.normal(),r=e.vel.project(n),i=n?.scale(this.speed)?.sub(r);e.addForce(i?.scale(e.mass*this.forceScale))})}}}function es(e){return{id:`areaEffector`,require:[`area`],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate(`body`,(e,t)=>{if(!e.has(`body`))return;let n=d.fromAngle(this.forceAngle).scale(this.forceMagnitude);e.addForce(n),this.linearDrag&&e.addForce(e.vel.scale(-this.linearDrag))})}}}function ts(e){return{id:`pointEffector`,require:[`area`,`pos`],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||`inverseLinear`,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate(`body`,(e,t)=>{let n=this.pos.sub(e.pos),r=n.len(),i=r*this.distanceScale/10,a=this.forceMode===`constant`?1:this.forceMode===`inverseLinear`?1/i:1/i**2,o=n.scale(this.forceMagnitude*a/r);e.addForce(o),this.linearDrag&&e.addForce(e.vel.scale(-this.linearDrag))})}}}function ns(e){return{id:`constantForce`,require:[`body`],force:e.force,update(){this.force&&this.addForce(this.force)}}}function rs(e){return{id:`platformEffector`,require:[`area`,`body`],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(e=>{let t=e.target.vel,n=ro().scale(-1).angleBetween(t);Math.abs(n)>this.surfaceArc/2&&e.preventResolution()})}}}function os(e){return{id:`buoyancyEffector`,require:[`area`],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate(`body`,(e,t)=>{let n=e,[r,i]=n.worldArea().cut(f(-100,this.surfaceLevel),f(100,this.surfaceLevel));r&&(this.applyBuoyancy(n,r),this.applyDrag(n,r)),this.flowMagnitude&&n.addForce(d.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(e,t){let n=this.density*t.area(),r=f(0,1).scale(-n);e.addForce(r)},applyDrag(e,t){let n=e.vel,r=this.density*this.linearDrag,i=n.scale(-r);e.addForce(i)}}}function ss(e){if(!e)throw Error(`Please define an anchor`);return{id:`anchor`,anchor:e,inspect(){return typeof this.anchor==`string`?`anchor: `+this.anchor:`anchor: `+this.anchor.toString()}}}function cs(){return{id:`fixed`,fixed:!0}}function ls(e,t){return{id:`follow`,require:[`pos`],follow:{obj:e,offset:t??f(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function us(e){let t=R.game.layers?.indexOf(e);return{id:`layer`,get layerIndex(){return t??null},get layer(){return t?R.game.layers?.[t]??null:null},set layer(e){if(t=R.game.layers?.indexOf(e),t==-1)throw Error(`Invalid layer name`)},inspect(){return`layer: ${this.layer}`}}}function ds(e,t){let n=typeof e==`number`?d.fromAngle(e):e.unit();return{id:`move`,require:[`pos`],update(){this.move(n.scale(t))}}}function fs(e={}){let t=!1,n=new N(f(0),L(),yr()),r=new N(f(0),0,0),i=n=>{n.isOffScreen()?(t||=(n.trigger(`exitView`),!0),e.hide&&(n.hidden=!0),e.pause&&(n.paused=!0),e.destroy&&n.destroy()):(t&&=(n.trigger(`enterView`),!1),e.hide&&(n.hidden=!1),e.pause&&(n.paused=!1))};return{id:`offscreen`,require:[`pos`],offscreenDistance:e.distance??Nt,isOffScreen(){let e=this.screenPos();if(!e)return!1;if(n.width=L(),n.height=yr(),!this.offscreenDistance&&this.width&&this.height)return r.width=this.width,r.height=this.height,r.pos=this.pos,r.collides(n);let t=this.offscreenDistance?this.offscreenDistance:Nt;return!oe(n,e)&&n.sdistToPoint(e)>t*t},onExitScreen(e){return this.on(`exitView`,e)},onEnterScreen(e){return this.on(`enterView`,e)},add(){e.pause&&e.unpause?ha(()=>i(this)):this.onUpdate(()=>i(this))}}}function ps(...e){return{id:`pos`,pos:f(...e),moveBy(...e){this.pos=this.pos.add(f(...e))},move(...e){this.moveBy(f(...e).scale(F()))},moveTo(...e){if(typeof e[0]==`number`&&typeof e[1]==`number`)return this.moveTo(f(e[0],e[1]),e[2]);let t=e[0],n=e[1];if(n===void 0){this.pos=f(t);return}let r=t.sub(this.pos);if(r.len()<=n*F()){this.pos=f(t);return}this.move(r.unit().scale(n))},worldPos(e=null){return e?(this.pos=this.pos.add(this.fromWorld(e)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(e){return this.parent?this.parent.transform.multVec2(this.pos.add(e)):this.pos.add(e)},fromWorld(e){return this.parent?this.parent.transform.invert().multVec2(e).sub(this.pos):e.sub(this.pos)},screenPos(e=null){if(e)return this.pos=this.pos.add(this.fromScreen(e)),null;{let e=this.worldPos();return e?Xi(this)?e:Ka(e):null}},toScreen(e){let t=this.toWorld(e);return Xi(this)?t:Ka(t)},fromScreen(e){return Xi(this)?this.fromWorld(e):this.fromWorld(qa(e))},toOther(e,t){return e.fromWorld(this.toWorld(t))},fromOther(e,t){return e.toOther(this,t)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){gi({color:i(255,0,0),radius:4/br()})}}}function ms(e){return{id:`rotate`,angle:e??0,rotateBy(e){this.angle+=e},rotateTo(e){this.angle=e},inspect(){return`angle: ${Math.round(this.angle)}`}}}function hs(...e){if(e.length===0)return hs(1);let t=f(...e);return{id:`scale`,set scale(e){if(!(e instanceof d))throw Error(`The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.`);t=f(e)},get scale(){return t},scaleTo(...e){t=f(...e)},scaleBy(...e){t=t.scale(f(...e))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function gs(e){return{id:`z`,z:e,inspect(){return`z: ${this.z}`}}}var _s=`data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABqxJREFUeJztnU1yFDkQRtMEB+AG7Fk6fBPO6ZsQLGc/N5gbMAtosJvqKv2kpPxS763A0W5XSXqVqZ+SngzgF58/fflx/7N///vnacW1gBkFD2Z2LOYNBF3Dx9UXAGs5kxLWwhNxU2qlJHrOhwLfkNZoiaBzIa3dCFJYLXgSboKXmETPeVDQyamR8vX55fe/v37/9vBzCDoH0tqktEpZ+t0IOh4KOBm16euZmETPtVDAiRgRLRF0HRRuEkrFrE1hzR4Lipxj+bD6AqCPz5++/Bgp5tXfdv1CeAdPPmFmSkn0nE+a0drdFm6XiOkdKWEuKRptTXqlLuqqFNaM6Dkb+T5nbb+npo8WjZVinqFantFJk9bWojaRThq7HzKN8wiPJ7aCoJHEZN5zHvJp7RE1DTV6SnZ1fa/PL1MjJtF5HmnT2tJF3GZ/BIj05I8ULUtR6ypER7ogjxpw61rRGxEal4KYjNyORzatbUlHSxr06tFcBTHPiN5NUEJWzlZKG/aKRqYk5tl1IKgPafucZ7w+vxSluLP6olHnL6MQQfYV6bpk/+BRZXm+cXHEiApSipZHlE6tRBDMkxmyysl5VsmtjXiFoJmiZU35ZWK0oNv1OY+omSv0GDDKJCaMI42cHg25dvFCi6QZxVS6ViVSpLUz38A4oiS9ySjlW2althGWKZrN6XNuOVpbwq0ReIzqZhfTrHwE/PZZuEYqcnqO0tZQGxVqRylprLGIEDXNkLOKEakbYsYiiphmiQaEZuD9BghixiKSmGYJIueqBt4TRZEyHtHENCNyNtMaRREzHhHFNBOKnKv7myVcVXKka4WfRBXTjMjpypl8iBmP6MsOmed0Bgk1UHjxXlpORIAWIqeybyGtha1QEdNMRM5s7wLCGpTENBORE6AXNTHNkBM2QFFMM4F5ToX5TYiLqphmRE7YmMhimiEnJEb9XBdJOUlp4Qp1Mc1E5QQ4I/qyvFJCy8n8JnijEjXNAi3fQ0TwIEM6e2OqnAgII8kkptkgOZEQZlN6BquZjqhVFxlBOkZq4Z6WASAFQQ8jZwQJ70FK8CTiaeb3fDSLJyMiwiwiS/q0SkwEBE+85jYjSTpcTiSE2WQRtVlOpAMVemVdtjXmlZxICFlQk/TJjHcmYS96JJ0p6KmcZggKeWmVdPopYwgKuxJVUuQE+EU0Sd99KYICxJH0ry9DUIA/rFy3WyWnGYLCnqyQ9PCXERTgmJmSPvwlBAU4p1bUWklPP1yytA9JYWdGRtLLDyEowDUjomiRwQgKUIZnJC3OgREUoByPSDpkDyEkBfhJj6RNQ7xEUYA6aiS9Cdo8SUoUBaijVtCuFQwICtBGiajdawARFKCNK0HdVtEjKUAd0+Q0q9v/FklhJ1rmP4e8JEoUBejfq2jYNgtEUdgJzwN7u6dSSkBQyMSME7O7FyHUQpoLCqw8rv5o+d6Uw3NvfzjagUkAZvOlLH1lLMyx8wCzWBEhW3ZDmLZ7NTsrwCpmyui5A1+IPidigjcjhZy14/vytBYxwRsPMVcf/2c2QU72wQUVIgj5lqFyIiZEJ5qQb1me1gLMJLKM93wY9cVETYiGkphmg+RETFhJljY2LHICQB/uchI1AXxwlRMxAfwgrYVtUHvxwk1OoiaAL8MjJ2ICtOEip1q6APnJEBS6VwiRzp4vtM5YBvf3m/EeI8DyvUZK33z4+v1bqsZ7dN+3n2W6zwgMO44hY0X1vIqkXh419x7lXh9ds8oyviFyRqmcXrxf2FUtF89ymFkG6nI2p7WZB4FGvUWfLcVt4ahsdy+TR7ifz6lc0F5v0GfalmXldpE3esrr6PrTR84sjNjS4kpQhQhaUi4lD6KR1xK9DHupfoKoR02vSFDy9FWNoKVivv1/lG7OfZkqR043OZUbWgmtFaomaGl51ZTHCnFv5bqNnFGjZvRtEFUEHSHmI1ZHWgVBXZ5+sxvX7ANlPChpjKsknSllKaPlRU4nZo0Yjq6wiIJGFPMML2mj3M8ZRRe4QkzF6FhCJEFbBn4i0iKswn11yenZiLLKeMRqQdWiZSmlkqrcV9d0gPfksAcqBW+2ZqAoq5gZGSrnTtGwlVmCIqUepxWxerj7iIyNZ7SgiKmJhJw7NJpRgiKmLuHl3KnReA4UIaU+y+WkcbzHQ1DEzMGQ9aJH0BDK6RE0y9wlTDp2HuppERQxc0FFBaZGUMTMB5UlQG/fHyk1odJEaBUUMXWh4oSoFRQxtaHyxMi2uBseQwUKciUoYuaAShTlkaCImQcqUph7QREzF/8DSS/2GZ2/N/sAAAAASUVORK5CYII=`,vs=`data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABdRJREFUeJzt3d3N3TYMgGG16ADdoAhyl7UyV9bqXRB0g2zQXgRGDcOWSIoUaX3vAwQBknMk/4gWLcnHrQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDEb9kb8FH99eeXf6Wf/efn35ynDyj1pEsb6G6NUxOYZ7sdB/QtPdnWRnn29gbKMYDUspPs0SgPb22cHANo/JG9AZF6wWBp3JLgeir36bvff3x9LOvzp2/dbSFA97bk5I4a9VMD7TXOUcP0uJ+d6emu5d6V1QvMs5nj8FZPx37X/b2TFpzShtnafeP0DipJMFnLnN3/w1OQ7tZgP+pA4VVKcHo0TG36KNULKGt5XsHZmi1APS5WM2Vqg0i7vbsG6YcIznN9vRTxXHavgdxtv6Tc3vc1pAHqdaG6ipwKYprpf1sFp6aH0gRTrxxLubPB2avHu+c/l3mICvqnsr//+Cq+qGrK1Xw/wzbBaRkNvSv3yew9cq+cu89L6nu6F/cMzCgzF1ftANlbe+Otp1IkDVxyVfbo6Z481f3507dhvXfbrk3HpdtjKTNqKuio8678c7mzF6ns6arfMyrVNoA75wMfNU2hKSeCx3Fq7dc+SPfDc39H9Vqn2CT//4bsYeT1PecOJyGSJdh6PZOlbElPZz2PHtlD1cUeS4LT4z5IOihwfNaD5ERm9qxH/dZ7Vmt9M999CtCZbdLUP/p3r2zFQ0paG8lr4Eb6+ZWBcSeq/qhyK6bXUfXOSgtO7/tOb9eT1NveqKttpYbiyXu/euV51JV16/T6e86zyF5TUp731V5Sp+Z7M71h9QvFNWWuvr0Sy4LzLfNvrel6zRX1e+hN2VzrnNlfaYD0xhCs++851lDh3vNV95xe6YvHgb8bwbNcuc+f09wbaUj2dzYgjz93//5kh94t0quCM8OKK6glKKuM0EYHfhUZWd8WwenZa0rLsp6s2YY66o0k9WUvS4NManBaGuo1eDIHgUZ1ePdkntsfFaCz5VZJdStsxyt7ziMNXHEAK5yk1mqmhrMPf1fcp57Vqe3SqZTMEduZhqAZyaywFne0DVHngHTZ11bznE88l/1lBZ9meP8851plWkBCO7drmQvWnL/sY/fKtFaqN3iy6iofsQxNktJnTMgfPXJUz3w3VaP5vOQ7Iyszvy2DczSi+aYFET2jINUEqFcAS4+rV480WlwRWXe07dLa0YGvfl9kmbTvPZJ1TXGvn4t4yuRp+2aMgk27wkm63DIztU3vOVfueC8wK4zKWtK0M+nvJXmOdlt65MgFFCva06qsKz044SvjIiN5TjLaaHxhtNyyouXBGZ1WSn66Ivt+M7pRZAWoZsDq+t2emeM1am/WtHxFG9runrO1/n1CxLK7CilxJM/H4bwuTJJBvWtgvm0gcNu01uvpd8la1soLE7xkpYDea4Ot6W3GOSzRc3o/qHw2M9qmXWA+uw+jbd0hyO9Yz0+vJ9QGcO/8ZV2YUqYVPN8dImXp3aJ/w1XTGGYfKZN+P7IXiXqO1uINLzFOm/Pz+BV4C03PNEqpZl//ELXP1ro8nhLyKLPHMyAiXyvh4cMFZ2uyAJXc62gzgJl1nhrSLMEzcLx+5qQnIhgqv6qhTHC2Zmus1tUuowCVDkRU6j0jgiJqhLPSSq2q7wMtMSBkdbcQWjNCq2nMlRrTnajAPP/t+c5Sj3K8VNueQ+pGzaa2MyOb2sZseW2dpL6ZnjMzfeQFt/Fe3XP2WIfGvRY6a569jCJ9TaIlcCS9KQE5p1TP2VrMbwLNDlZEvpE5AkGxh9f2nLO/QOetytIwAnMf6SfS2ns+jaZ6B4i2sWvSvF0HWOAj/aRGNFAaPXbw2rS2Rzr0T/ChshKNM3qd4135BCaqK9VAKy+lAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4DBC0k0jFtF9wAAAAASUVORK5CYII=`,ys=t.version,R={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},bs=(e={tagsAsComponents:!0})=>{R.k&&(console.warn(`KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!`),R.k.quit()),R.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width=`100%`,document.body.style.height=`100%`,document.body.style.margin=`0px`,document.documentElement.style.width=`100%`,document.documentElement.style.height=`100%`);let h=e.canvas??t.appendChild(document.createElement(`canvas`));R.canvas=h;let g=e.scale??1;R.gscale=g;let y=e.width&&e.height&&!e.stretch&&!e.letterbox;y?(h.width=e.width*g,h.height=e.height*g):(h.width=h.parentElement.offsetWidth,h.height=h.parentElement.offsetHeight);let b=[`outline: none`,`cursor: default`];if(y){let e=h.width,t=h.height;b.push(`width: ${e}px`),b.push(`height: ${t}px`)}else b.push(`width: 100%`),b.push(`height: 100%`);e.crisp&&(b.push(`image-rendering: pixelated`),b.push(`image-rendering: crisp-edges`)),h.style.cssText=b.join(`;`);let x=e.pixelDensity||1;R.pixelDensity=x,h.width*=x,h.height*=x,h.tabIndex=0;let C=document.createElement(`canvas`);C.width=256,C.height=256,R.fontCacheCanvas=C,R.fontCacheC2d=C.getContext(`2d`,{willReadFrequently:!0});let O=In({canvas:h,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});R.app=O;let se=[],k=O.canvas.getContext(`webgl`,{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!k)throw Error(`WebGL not supported`);let A=k,ue=Oi(A,{texFilter:e.texFilter}),j=Yi(e,ue);R.gfx=j;let fe=ao();R.audio=fe;let pe=Lr(ue,e.spriteAtlasPadding??0);R.assets=pe;let M=$a();R.game=M,M.root.use(qo());function me(e,t){let n=new Ti(ue,e,t);return{clear:()=>n.clear(),free:()=>n.free(),toDataURL:()=>n.toDataURL(),toImageData:()=>n.toImageData(),width:n.width,height:n.height,draw:e=>{vr(),n.bind(),e(),vr(),n.unbind()},get fb(){return n}}}function he(){A.clear(A.COLOR_BUFFER_BIT),j.frameBuffer.bind(),A.clear(A.COLOR_BUFFER_BIT),j.bgColor||Ii(()=>{Ni({width:L(),height:yr(),quad:new p(0,0,L()/64,yr()/64),tex:j.bgTex,fixed:!0})}),j.renderer.numDraws=0,j.fixed=!1,j.transformStack.length=0,j.transform=new _}function ge(e,t){j.postShader=e,j.postShaderUniform=t??null}function _e(){vr(),j.lastDrawCalls=j.renderer.numDraws,j.frameBuffer.unbind(),A.viewport(0,0,A.drawingBufferWidth,A.drawingBufferHeight);let e=j.width,t=j.height;j.width=A.drawingBufferWidth/x,j.height=A.drawingBufferHeight/x,Gi({flipY:!0,tex:j.frameBuffer.tex,pos:new d(j.viewport.x,j.viewport.y),width:j.viewport.width,height:j.viewport.height,shader:j.postShader,uniform:typeof j.postShaderUniform==`function`?j.postShaderUniform():j.postShaderUniform,fixed:!0}),vr(),j.width=e,j.height=t}let ve=!1,ye={inspect:!1,set timeScale(e){R.app.state.timeScale=e},get timeScale(){return R.app.state.timeScale},showLog:!0,fps:()=>O.fps(),numFrames:()=>O.numFrames(),stepFrame:nt,drawCalls:()=>j.lastDrawCalls,clearLog:()=>M.logs=[],log:(...t)=>{let n=e.logMax??8,r=t.length>1?t.concat(` `).join(` `):t[0];M.logs.unshift({msg:r,time:O.time()}),M.logs.length>n&&(M.logs=M.logs.slice(0,n))},error:e=>ye.log(Error(e.toString?e.toString():e)),curRecording:null,numObjects:()=>Oe(`*`,{recursive:!0}).length,get paused(){return ve},set paused(e){ve=e,e?fe.ctx.suspend():fe.ctx.resume()}};R.debug=ye;function be(e,t){try{return JSON.parse(window.localStorage[e])}catch{return t?(xe(e,t),t):null}}function xe(e,t){window.localStorage[e]=JSON.stringify(t)}function Se(t,...n){let r=t(pt),i;for(let t in i=typeof r==`function`?r(...n)(pt):r,i)pt[t]=i[t],e.global!==!1&&(window[t]=i[t]);return pt}function Ce(e){let t=O.canvas.captureStream(e),n=fe.ctx.createMediaStreamDestination();fe.masterNode.connect(n);let r=new MediaRecorder(t),i=[];return r.ondataavailable=e=>{e.data.size>0&&i.push(e.data)},r.onerror=()=>{fe.masterNode.disconnect(n),t.getTracks().forEach(e=>e.stop())},r.start(),{resume(){r.resume()},pause(){r.pause()},stop(){return r.stop(),fe.masterNode.disconnect(n),t.getTracks().forEach(e=>e.stop()),new Promise(e=>{r.onstop=()=>{e(new Blob(i,{type:`video/mp4`}))}})},download(e=`kaboom.mp4`){this.stop().then(t=>Xt(e,t))}}}function we(){return document.activeElement===O.canvas}let Te=M.root.add.bind(M.root),Ee=M.root.readd.bind(M.root),De=M.root.removeAll.bind(M.root),Oe=M.root.get.bind(M.root),ke=M.root.wait.bind(M.root),Ae=M.root.loop.bind(M.root),je=M.root.query.bind(M.root),Ie=M.root.tween.bind(M.root),$e=Hr(null,vs),et=Hr(null,_s);R.kaSprite=$e,R.boomSprite=et;function tt(){M.root.fixedUpdate()}function nt(){M.root.update()}class rt{source;target;normal;distance;resolved=!1;constructor(e,t,n,r,i=!1){this.source=e,this.target=t,this.normal=n,this.distance=r,this.resolved=i}get displacement(){return this.normal.scale(this.distance)}reverse(){return new rt(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(M.gravity||f(0,1))>0}isRight(){return this.displacement.cross(M.gravity||f(0,1))<0}isTop(){return this.displacement.dot(M.gravity||f(0,1))>0}isBottom(){return this.displacement.dot(M.gravity||f(0,1))<0}preventResolution(){this.resolved=!0}}function it(){if(!Yo())return;let t={},n=e.hashGridSize||64,r=new _,i=[];function a(e){if(i.push(r.clone()),e.pos&&r.translate(e.pos),e.scale&&r.scale(e.scale),e.angle&&r.rotate(e.angle),e.transform=r.clone(),e.c(`area`)&&!e.paused){let r=e,i=r.worldArea().bbox(),a=Math.floor(i.pos.x/n),o=Math.floor(i.pos.y/n),s=Math.ceil((i.pos.x+i.width)/n),c=Math.ceil((i.pos.y+i.height)/n),l=new Set;for(let e=a;e<=s;e++)for(let n=o;n<=c;n++)if(!t[e])t[e]={},t[e][n]=[r];else if(!t[e][n])t[e][n]=[r];else{let i=t[e][n];e:for(let e of i){if(e.paused||!e.exists()||l.has(e.id))continue;for(let t of r.collisionIgnore)if(e.is(t))continue e;for(let t of e.collisionIgnore)if(r.is(t))continue e;let t=ct(r.worldArea(),e.worldArea());if(t){let n=new rt(r,e,t.normal,t.distance);r.trigger(`collideUpdate`,e,n);let i=n.reverse();i.resolved=n.resolved,e.trigger(`collideUpdate`,r,i)}l.add(e.id)}i.push(r)}}e.children.forEach(a),r=i.pop()}a(M.root)}function lt(e){console.error(e),fe.ctx.suspend();let t=e.message??String(e)??`Unknown error, check console for more info`;O.run(()=>{},()=>{he(),Ii(()=>{let n=L(),r=yr(),a={size:36,width:n-64,letterSpacing:4,lineSpacing:4,font:bt,fixed:!0};Fi({width:n,height:r,color:i(0,0,255),fixed:!0});let o=Mi({...a,text:`Error`,pos:f(32),color:i(255,128,0),fixed:!0});Pi(o),Ji({...a,text:t,pos:f(32,32+o.height+16),fixed:!0}),_r(),M.events.trigger(`error`,e)}),_e()})}function ut(e){se.push(e)}function dt(){M.events.onOnce(`frameEnd`,()=>{O.quit(),A.clear(A.COLOR_BUFFER_BIT|A.DEPTH_BUFFER_BIT|A.STENCIL_BUFFER_BIT);let e=A.getParameter(A.MAX_TEXTURE_IMAGE_UNITS);for(let t=0;t<e;t++)A.activeTexture(A.TEXTURE0+t),A.bindTexture(A.TEXTURE_2D,null),A.bindTexture(A.TEXTURE_CUBE_MAP,null);A.bindBuffer(A.ARRAY_BUFFER,null),A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,null),A.bindRenderbuffer(A.RENDERBUFFER,null),A.bindFramebuffer(A.FRAMEBUFFER,null),ue.destroy(),se.forEach(e=>e())})}let ft=!0;O.run(()=>{try{pe.loaded&&(ye.paused||tt(),it())}catch(e){lt(e)}},(t,n)=>{try{t(),pe.loaded||Nr()===1&&!ft&&(pe.loaded=!0,Pr().forEach(e=>M.events.trigger(`loadError`,...e)),M.events.trigger(`load`)),!pe.loaded&&e.loadingScreen!==!1||ft?(he(),Hi(),_e()):(ye.paused||nt(),it(),he(),Vi(),e.debug!==!1&&zi(),_e()),ft&&=!1,M.events.trigger(`frameEnd`),n()}catch(e){lt(e)}}),Tn(),po();let pt={_k:R,VERSION:ys,loadRoot:Ar,loadProgress:Nr,loadSprite:Hr,loadSpriteAtlas:fi,loadSound:ui,loadMusic:di,loadBitmapFont:$r,loadFont:Xr,loadShader:ai,loadShaderURL:oi,loadAseprite:Kr,loadPedit:ei,loadBean:Gr,loadJSON:jr,load:Ir,getSound:li,getFont:Yr,getBitmapFont:Qr,getSprite:Vr,getShader:ii,getAsset:Fr,Asset:wr,SpriteData:zr,SoundData:si,width:L,height:yr,center:xr,dt:F,fixedDt:Ln,restDt:Rn,time:O.time,screenshot:O.screenshot,record:Ce,isFocused:we,setCursor:O.setCursor,getCursor:O.getCursor,setCursorLocked:O.setCursorLocked,isCursorLocked:O.isCursorLocked,setFullscreen:O.setFullscreen,isFullscreen:O.isFullscreen,isTouchscreen:O.isTouchscreen,onLoad:Pa,onLoadError:Fa,onLoading:ja,onResize:Ma,onGamepadConnect:O.onGamepadConnect,onGamepadDisconnect:O.onGamepadDisconnect,onError:Na,onCleanup:ut,flash:Ua,setCamPos:Ia,getCamPos:La,setCamRot:Ba,getCamRot:Va,setCamScale:Ra,getCamScale:za,getCamTransform:Ha,camPos:Ja,camScale:Ya,camFlash:Za,camRot:Xa,camTransform:Wa,shake:Ga,toScreen:Ka,toWorld:qa,setGravity:eo,getGravity:to,setGravityDirection:no,getGravityDirection:ro,setBackground:dr,getBackground:fr,getGamepads:O.getGamepads,getTreeRoot:bo,add:Te,make:Qa,destroy:yo,destroyAll:De,get:Oe,query:je,readd:Ee,pos:ps,scale:hs,rotate:ms,color:$i,opacity:ra,anchor:ss,area:Xo,sprite:To,text:Eo,polygon:sa,rect:la,circle:Qi,uvquad:Do,outline:ia,particles:oa,body:Zo,platformEffector:rs,surfaceEffector:$o,areaEffector:es,pointEffector:ts,buoyancyEffector:os,constantForce:ns,doubleJump:Qo,shader:ua,textInput:Ko,timer:qo,fixed:cs,stay:Go,health:Vo,lifespan:Ho,named:Uo,state:Wo,z:gs,layer:us,move:ds,offscreen:fs,follow:ls,fadeIn:ta,mask:na,drawon:ea,raycast:ca,tile:Mo,animate:Ro,serializeAnimation:zo,agent:Oo,sentry:jo,patrol:Ao,pathfinder:ko,trigger:pa,on:fa,onFixedUpdate:ma,onUpdate:ha,onDraw:ga,onAdd:_a,onDestroy:va,onTag:xa,onUntag:Sa,onUse:ya,onUnuse:ba,onClick:Da,onCollide:Ca,onCollideUpdate:wa,onCollideEnd:Ta,onHover:Oa,onHoverUpdate:ka,onHoverEnd:Aa,onKeyDown:O.onKeyDown,onKeyPress:O.onKeyPress,onKeyPressRepeat:O.onKeyPressRepeat,onKeyRelease:O.onKeyRelease,onMouseDown:O.onMouseDown,onMousePress:O.onMousePress,onMouseRelease:O.onMouseRelease,onMouseMove:O.onMouseMove,onCharInput:O.onCharInput,onTouchStart:O.onTouchStart,onTouchMove:O.onTouchMove,onTouchEnd:O.onTouchEnd,onScroll:O.onScroll,onHide:O.onHide,onShow:O.onShow,onGamepadButtonDown:O.onGamepadButtonDown,onGamepadButtonPress:O.onGamepadButtonPress,onGamepadButtonRelease:O.onGamepadButtonRelease,onGamepadStick:O.onGamepadStick,onButtonPress:O.onButtonPress,onButtonDown:O.onButtonDown,onButtonRelease:O.onButtonRelease,mousePos:O.mousePos,mouseDeltaPos:O.mouseDeltaPos,isKeyDown:O.isKeyDown,isKeyPressed:O.isKeyPressed,isKeyPressedRepeat:O.isKeyPressedRepeat,isKeyReleased:O.isKeyReleased,isMouseDown:O.isMouseDown,isMousePressed:O.isMousePressed,isMouseReleased:O.isMouseReleased,isMouseMoved:O.isMouseMoved,isGamepadButtonPressed:O.isGamepadButtonPressed,isGamepadButtonDown:O.isGamepadButtonDown,isGamepadButtonReleased:O.isGamepadButtonReleased,getGamepadStick:O.getGamepadStick,isButtonPressed:O.isButtonPressed,isButtonDown:O.isButtonDown,isButtonReleased:O.isButtonReleased,setButton:O.setButton,getButton:O.getButton,pressButton:O.pressButton,releaseButton:O.releaseButton,getLastInputDeviceType:O.getLastInputDeviceType,charInputted:O.charInputted,loop:Ae,wait:ke,play:so,setVolume:lo,getVolume:uo,volume:fo,burp:co,audioCtx:fe.ctx,Line:Ne,Rect:N,Circle:Pe,Ellipse:Fe,Point:Me,Polygon:Le,Vec2:d,Color:r,Mat4:_,Quad:p,RNG:S,rand:T,randi:E,randSeed:w,vec2:f,rgb:i,hsl2rgb:a,quad:m,choose:ne,chooseMultiple:te,shuffle:D,chance:ee,lerp:c,tween:Ie,easings:nr,map:l,mapc:u,wave:v,deg2rad:o,rad2deg:s,clamp:n,evaluateQuadratic:Re,evaluateQuadraticFirstDerivative:ze,evaluateQuadraticSecondDerivative:Be,evaluateBezier:Ve,evaluateBezierFirstDerivative:He,evaluateBezierSecondDerivative:Ue,evaluateCatmullRom:We,evaluateCatmullRomFirstDerivative:Ge,curveLengthApproximation:qe,normalizedCurve:Ke,hermite:Je,cardinal:Ye,catmullRom:Xe,bezier:Ze,kochanekBartels:Qe,easingSteps:st,easingLinear:at,easingCubicBezier:ot,testLineLine:ie,testRectRect:re,testRectLine:ae,testRectPoint:oe,testCirclePolygon:de,testLinePoint:ce,testLineCircle:le,isConvex:gt,triangulate:ht,NavMesh:sr,drawSprite:Ki,drawText:Ji,formatText:Mi,drawRect:Fi,drawLine:_i,drawLines:xi,drawTriangle:Ri,drawCircle:gi,drawEllipse:hi,drawUVQuad:Ni,drawPolygon:mi,drawCurve:Si,drawBezier:Ci,drawFormattedText:Pi,drawMasked:Wi,drawSubtracted:qi,pushTransform:pr,popTransform:_r,pushTranslate:I,pushScale:hr,pushRotate:gr,pushMatrix:mr,usePostEffect:ge,makeCanvas:me,debug:ye,scene:xo,getSceneName:wo,go:So,onSceneLeave:Co,layers:vo,getLayers:go,setLayers:ho,getDefaultLayer:_o,addLevel:da,getData:be,setData:xe,download:qt,downloadJSON:Yt,downloadText:Jt,downloadBlob:Xt,plug:Se,ASCII_CHARS:_t,canvas:O.canvas,addKaboom:mo,LEFT:d.LEFT,RIGHT:d.RIGHT,UP:d.UP,DOWN:d.DOWN,RED:r.RED,GREEN:r.GREEN,BLUE:r.BLUE,YELLOW:r.YELLOW,MAGENTA:r.MAGENTA,CYAN:r.CYAN,WHITE:r.WHITE,BLACK:r.BLACK,quit:dt,KEvent:zt,KEventHandler:Bt,KEventController:Rt,cancel:()=>It};R.k=pt;let mt=e.plugins;if(mt&&mt.forEach(Se),e.global!==!1)for(let e in pt)window[e]=pt[e];return e.focus!==!1&&O.canvas.focus(),pt};function xs(e){let t={};for(let n of e)t[n.itemName]=n;return t}function Ss(e,t,n,r){let i={};return r&&(i=xs(r)),{charName:e,level:1,hitPoints:t,maxHitPoints:t,experienceList:n,inventory:i,isDead:!1,characterID:`${Math.floor(Math.random()*1e6).toString().padStart(6,`0`)}`}}function Cs(e,t){e.inventory[t.itemName]=t}function ws(e){let t=[];for(let n in e)t.push(e[n]);return t}var Ts=()=>void 0,Es={NODE_CLIENT:!1,NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"},z=function(e,t){if(!e)throw Ds(t)},Ds=function(e){return Error(`Firebase Database (`+Es.SDK_VERSION+`) INTERNAL ASSERT FAILED: `+e)},Os=function(e){let t=[],n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=i&63|128):(i&64512)==55296&&r+1<e.length&&(e.charCodeAt(r+1)&64512)==56320?(i=65536+((i&1023)<<10)+(e.charCodeAt(++r)&1023),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=i&63|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=i&63|128)}return t},ks=function(e){let t=[],n=0,r=0;for(;n<e.length;){let i=e[n++];if(i<128)t[r++]=String.fromCharCode(i);else if(i>191&&i<224){let a=e[n++];t[r++]=String.fromCharCode((i&31)<<6|a&63)}else if(i>239&&i<365){let a=e[n++],o=e[n++],s=e[n++],c=((i&7)<<18|(a&63)<<12|(o&63)<<6|s&63)-65536;t[r++]=String.fromCharCode(55296+(c>>10)),t[r++]=String.fromCharCode(56320+(c&1023))}else{let a=e[n++],o=e[n++];t[r++]=String.fromCharCode((i&15)<<12|(a&63)<<6|o&63)}}return t.join(``)},As={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789`,get ENCODED_VALS(){return this.ENCODED_VALS_BASE+`+/=`},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+`-_.`},HAS_NATIVE_SUPPORT:typeof atob==`function`,encodeByteArray(e,t){if(!Array.isArray(e))throw Error(`encodeByteArray takes an array as a parameter`);this.init_();let n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let t=0;t<e.length;t+=3){let i=e[t],a=t+1<e.length,o=a?e[t+1]:0,s=t+2<e.length,c=s?e[t+2]:0,l=i>>2,u=(i&3)<<4|o>>4,d=(o&15)<<2|c>>6,f=c&63;s||(f=64,a||(d=64)),r.push(n[l],n[u],n[d],n[f])}return r.join(``)},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(Os(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):ks(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();let n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let t=0;t<e.length;){let i=n[e.charAt(t++)],a=t<e.length?n[e.charAt(t)]:0;++t;let o=t<e.length?n[e.charAt(t)]:64;++t;let s=t<e.length?n[e.charAt(t)]:64;if(++t,i==null||a==null||o==null||s==null)throw new js;let c=i<<2|a>>4;if(r.push(c),o!==64){let e=a<<4&240|o>>2;if(r.push(e),s!==64){let e=o<<6&192|s;r.push(e)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},js=class extends Error{constructor(){super(...arguments),this.name=`DecodeBase64StringError`}},Ms=function(e){let t=Os(e);return As.encodeByteArray(t,!0)},Ns=function(e){return Ms(e).replace(/\./g,``)},Ps=function(e){try{return As.decodeString(e,!0)}catch(e){console.error(`base64Decode failed: `,e)}return null};
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function Fs(e){return Is(void 0,e)}function Is(e,t){if(!(t instanceof Object))return t;switch(t.constructor){case Date:let n=t;return new Date(n.getTime());case Object:e===void 0&&(e={});break;case Array:e=[];break;default:return t}for(let n in t)!t.hasOwnProperty(n)||!Ls(n)||(e[n]=Is(e[n],t[n]));return e}function Ls(e){return e!==`__proto__`}
/**
* @license
* Copyright 2022 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function Rs(){if(typeof self<`u`)return self;if(typeof window<`u`)return window;if(typeof global<`u`)return global;throw Error(`Unable to locate global object.`)}
/**
* @license
* Copyright 2022 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var zs=()=>Rs().__FIREBASE_DEFAULTS__,Bs=()=>{if(typeof process>`u`)return;let e={}.__FIREBASE_DEFAULTS__;if(e)return JSON.parse(e)},Vs=()=>{if(typeof document>`u`)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}let t=e&&Ps(e[1]);return t&&JSON.parse(t)},Hs=()=>{try{return Ts()||zs()||Bs()||Vs()}catch(e){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`);return}},Us=e=>Hs()?.emulatorHosts?.[e],Ws=e=>{let t=Us(e);if(!t)return;let n=t.lastIndexOf(`:`);if(n<=0||n+1===t.length)throw Error(`Invalid host ${t} with no separate hostname and port!`);let r=parseInt(t.substring(n+1),10);return t[0]===`[`?[t.substring(1,n-1),r]:[t.substring(0,n),r]},Gs=()=>Hs()?.config,Ks=class{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,n)=>{t?this.reject(t):this.resolve(n),typeof e==`function`&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,n))}}};
/**
* @license
* Copyright 2025 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function qs(e){try{return(e.startsWith(`http://`)||e.startsWith(`https://`)?new URL(e).hostname:e).endsWith(`.cloudworkstations.dev`)}catch{return!1}}async function Js(e){return(await fetch(e,{credentials:`include`})).ok}
/**
* @license
* Copyright 2021 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function Ys(e,t){if(e.uid)throw Error(`The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.`);let n={alg:`none`,type:`JWT`},r=t||`demo-project`,i=e.iat||0,a=e.sub||e.user_id;if(!a)throw Error(`mockUserToken must contain 'sub' or 'user_id' field!`);let o={iss:`https://securetoken.google.com/${r}`,aud:r,iat:i,exp:i+3600,auth_time:i,sub:a,user_id:a,firebase:{sign_in_provider:`custom`,identities:{}},...e};return[Ns(JSON.stringify(n)),Ns(JSON.stringify(o)),``].join(`.`)}var Xs={};function Zs(){let e={prod:[],emulator:[]};for(let t of Object.keys(Xs))Xs[t]?e.emulator.push(t):e.prod.push(t);return e}function Qs(e){let t=document.getElementById(e),n=!1;return t||(t=document.createElement(`div`),t.setAttribute(`id`,e),n=!0),{created:n,element:t}}var $s=!1;function ec(e,t){if(typeof window>`u`||typeof document>`u`||!qs(window.location.host)||Xs[e]===t||Xs[e]||$s)return;Xs[e]=t;function n(e){return`__firebase__banner__${e}`}let r=`__firebase__banner`,i=Zs().prod.length>0;function a(){let e=document.getElementById(r);e&&e.remove()}function o(e){e.style.display=`flex`,e.style.background=`#7faaf0`,e.style.position=`fixed`,e.style.bottom=`5px`,e.style.left=`5px`,e.style.padding=`.5em`,e.style.borderRadius=`5px`,e.style.alignItems=`center`}function s(e,t){e.setAttribute(`width`,`24`),e.setAttribute(`id`,t),e.setAttribute(`height`,`24`),e.setAttribute(`viewBox`,`0 0 24 24`),e.setAttribute(`fill`,`none`),e.style.marginLeft=`-6px`}function c(){let e=document.createElement(`span`);return e.style.cursor=`pointer`,e.style.marginLeft=`16px`,e.style.fontSize=`24px`,e.innerHTML=` &times;`,e.onclick=()=>{$s=!0,a()},e}function l(e,t){e.setAttribute(`id`,t),e.innerText=`Learn more`,e.href=`https://firebase.google.com/docs/studio/preview-apps#preview-backend`,e.setAttribute(`target`,`__blank`),e.style.paddingLeft=`5px`,e.style.textDecoration=`underline`}function u(){let e=Qs(r),t=n(`text`),a=document.getElementById(t)||document.createElement(`span`),u=n(`learnmore`),d=document.getElementById(u)||document.createElement(`a`),f=n(`preprendIcon`),p=document.getElementById(f)||document.createElementNS(`http://www.w3.org/2000/svg`,`svg`);if(e.created){let t=e.element;o(t),l(d,u);let n=c();s(p,f),t.append(p,a,d,n),document.body.appendChild(t)}i?(a.innerText=`Preview backend disconnected.`,p.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(p.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,a.innerText=`Preview backend running in this workspace.`),a.setAttribute(`id`,t)}document.readyState===`loading`?window.addEventListener(`DOMContentLoaded`,u):u()}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function tc(){return typeof navigator<`u`&&typeof navigator.userAgent==`string`?navigator.userAgent:``}function nc(){return typeof window<`u`&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(tc())}function rc(){return typeof navigator==`object`&&navigator.product===`ReactNative`}function ic(){return Es.NODE_CLIENT===!0||Es.NODE_ADMIN===!0}function ac(){try{return typeof indexedDB==`object`}catch{return!1}}function oc(){return new Promise((e,t)=>{try{let n=!0,r=`validate-browser-context-for-indexeddb-analytics-module`,i=self.indexedDB.open(r);i.onsuccess=()=>{i.result.close(),n||self.indexedDB.deleteDatabase(r),e(!0)},i.onupgradeneeded=()=>{n=!1},i.onerror=()=>{t(i.error?.message||``)}}catch(e){t(e)}})}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var sc=`FirebaseError`,cc=class e extends Error{constructor(t,n,r){super(n),this.code=t,this.customData=r,this.name=sc,Object.setPrototypeOf(this,e.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,lc.prototype.create)}},lc=class{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){let n=t[0]||{},r=`${this.service}/${e}`,i=this.errors[e],a=i?uc(i,n):`Error`,o=`${this.serviceName}: ${a} (${r}).`;return new cc(r,o,n)}};function uc(e,t){return e.replace(dc,(e,n)=>{let r=t[n];return r==null?`<${n}?>`:String(r)})}var dc=/\{\$([^}]+)}/g;
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function fc(e){return JSON.parse(e)}function B(e){return JSON.stringify(e)}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var pc=function(e){let t={},n={},r={},i=``;try{let a=e.split(`.`);t=fc(Ps(a[0])||``),n=fc(Ps(a[1])||``),i=a[2],r=n.d||{},delete n.d}catch{}return{header:t,claims:n,data:r,signature:i}},mc=function(e){let t=pc(e).claims;return!!t&&typeof t==`object`&&t.hasOwnProperty(`iat`)},hc=function(e){let t=pc(e).claims;return typeof t==`object`&&t.admin===!0};
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function gc(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function _c(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]}function vc(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function yc(e,t,n){let r={};for(let i in e)Object.prototype.hasOwnProperty.call(e,i)&&(r[i]=t.call(n,e[i],i,e));return r}function bc(e,t){if(e===t)return!0;let n=Object.keys(e),r=Object.keys(t);for(let i of n){if(!r.includes(i))return!1;let n=e[i],a=t[i];if(xc(n)&&xc(a)){if(!bc(n,a))return!1}else if(n!==a)return!1}for(let e of r)if(!n.includes(e))return!1;return!0}function xc(e){return typeof e==`object`&&!!e}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function Sc(e){let t=[];for(let[n,r]of Object.entries(e))Array.isArray(r)?r.forEach(e=>{t.push(encodeURIComponent(n)+`=`+encodeURIComponent(e))}):t.push(encodeURIComponent(n)+`=`+encodeURIComponent(r));return t.length?`&`+t.join(`&`):``}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Cc=class{constructor(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=512/8,this.pad_[0]=128;for(let e=1;e<this.blockSize;++e)this.pad_[e]=0;this.reset()}reset(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0}compress_(e,t){t||=0;let n=this.W_;if(typeof e==`string`)for(let r=0;r<16;r++)n[r]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(let r=0;r<16;r++)n[r]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(let e=16;e<80;e++){let t=n[e-3]^n[e-8]^n[e-14]^n[e-16];n[e]=(t<<1|t>>>31)&4294967295}let r=this.chain_[0],i=this.chain_[1],a=this.chain_[2],o=this.chain_[3],s=this.chain_[4],c,l;for(let e=0;e<80;e++){e<40?e<20?(c=o^i&(a^o),l=1518500249):(c=i^a^o,l=1859775393):e<60?(c=i&a|o&(i|a),l=2400959708):(c=i^a^o,l=3395469782);let t=(r<<5|r>>>27)+c+s+l+n[e]&4294967295;s=o,o=a,a=(i<<30|i>>>2)&4294967295,i=r,r=t}this.chain_[0]=this.chain_[0]+r&4294967295,this.chain_[1]=this.chain_[1]+i&4294967295,this.chain_[2]=this.chain_[2]+a&4294967295,this.chain_[3]=this.chain_[3]+o&4294967295,this.chain_[4]=this.chain_[4]+s&4294967295}update(e,t){if(e==null)return;t===void 0&&(t=e.length);let n=t-this.blockSize,r=0,i=this.buf_,a=this.inbuf_;for(;r<t;){if(a===0)for(;r<=n;)this.compress_(e,r),r+=this.blockSize;if(typeof e==`string`){for(;r<t;)if(i[a]=e.charCodeAt(r),++a,++r,a===this.blockSize){this.compress_(i),a=0;break}}else for(;r<t;)if(i[a]=e[r],++a,++r,a===this.blockSize){this.compress_(i),a=0;break}}this.inbuf_=a,this.total_+=t}digest(){let e=[],t=this.total_*8;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(let e=this.blockSize-1;e>=56;e--)this.buf_[e]=t&255,t/=256;this.compress_(this.buf_);let n=0;for(let t=0;t<5;t++)for(let r=24;r>=0;r-=8)e[n]=this.chain_[t]>>r&255,++n;return e}};function wc(e,t){return`${e} failed: ${t} argument `}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Tc=function(e){let t=[],n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);if(i>=55296&&i<=56319){let t=i-55296;r++,z(r<e.length,`Surrogate pair missing trail surrogate.`);let n=e.charCodeAt(r)-56320;i=65536+(t<<10)+n}i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=i&63|128):i<65536?(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=i&63|128):(t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=i&63|128)}return t},Ec=function(e){let t=0;for(let n=0;n<e.length;n++){let r=e.charCodeAt(n);r<128?t++:r<2048?t+=2:r>=55296&&r<=56319?(t+=4,n++):t+=3}return t};
/**
* @license
* Copyright 2021 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function Dc(e){return e&&e._delegate?e._delegate:e}var Oc=class{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode=`LAZY`,this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}},kc=`[DEFAULT]`,Ac=class{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){let t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){let e=new Ks;if(this.instancesDeferred.set(t,e),this.isInitialized(t)||this.shouldAutoInitialize())try{let n=this.getOrInitializeService({instanceIdentifier:t});n&&e.resolve(n)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){let t=this.normalizeInstanceIdentifier(e?.identifier),n=e?.optional??!1;if(this.isInitialized(t)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:t})}catch(e){if(n)return null;throw e}else if(n)return null;else throw Error(`Service ${this.name} is not available`)}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(Mc(e))try{this.getOrInitializeService({instanceIdentifier:kc})}catch{}for(let[e,t]of this.instancesDeferred.entries()){let n=this.normalizeInstanceIdentifier(e);try{let e=this.getOrInitializeService({instanceIdentifier:n});t.resolve(e)}catch{}}}}clearInstance(e=kc){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){let e=Array.from(this.instances.values());await Promise.all([...e.filter(e=>`INTERNAL`in e).map(e=>e.INTERNAL.delete()),...e.filter(e=>`_delete`in e).map(e=>e._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=kc){return this.instances.has(e)}getOptions(e=kc){return this.instancesOptions.get(e)||{}}initialize(e={}){let{options:t={}}=e,n=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(n))throw Error(`${this.name}(${n}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);let r=this.getOrInitializeService({instanceIdentifier:n,options:t});for(let[e,t]of this.instancesDeferred.entries()){let i=this.normalizeInstanceIdentifier(e);n===i&&t.resolve(r)}return r}onInit(e,t){let n=this.normalizeInstanceIdentifier(t),r=this.onInitCallbacks.get(n)??new Set;r.add(e),this.onInitCallbacks.set(n,r);let i=this.instances.get(n);return i&&e(i,n),()=>{r.delete(e)}}invokeOnInitCallbacks(e,t){let n=this.onInitCallbacks.get(t);if(n)for(let r of n)try{r(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let n=this.instances.get(e);if(!n&&this.component&&(n=this.component.instanceFactory(this.container,{instanceIdentifier:jc(e),options:t}),this.instances.set(e,n),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(n,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,n)}catch{}return n||null}normalizeInstanceIdentifier(e=kc){return this.component?this.component.multipleInstances?e:kc:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!==`EXPLICIT`}};function jc(e){return e===kc?void 0:e}function Mc(e){return e.instantiationMode===`EAGER`}
/**
* @license
* Copyright 2019 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Nc=class{constructor(e){this.name=e,this.providers=new Map}addComponent(e){let t=this.getProvider(e.name);if(t.isComponentSet())throw Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);let t=new Ac(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}},Pc=[],V;(function(e){e[e.DEBUG=0]=`DEBUG`,e[e.VERBOSE=1]=`VERBOSE`,e[e.INFO=2]=`INFO`,e[e.WARN=3]=`WARN`,e[e.ERROR=4]=`ERROR`,e[e.SILENT=5]=`SILENT`})(V||={});var Fc={debug:V.DEBUG,verbose:V.VERBOSE,info:V.INFO,warn:V.WARN,error:V.ERROR,silent:V.SILENT},Ic=V.INFO,Lc={[V.DEBUG]:`log`,[V.VERBOSE]:`log`,[V.INFO]:`info`,[V.WARN]:`warn`,[V.ERROR]:`error`},Rc=(e,t,...n)=>{if(t<e.logLevel)return;let r=new Date().toISOString(),i=Lc[t];if(i)console[i](`[${r}]  ${e.name}:`,...n);else throw Error(`Attempted to log a message with an invalid logType (value: ${t})`)},zc=class{constructor(e){this.name=e,this._logLevel=Ic,this._logHandler=Rc,this._userLogHandler=null,Pc.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in V))throw TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e==`string`?Fc[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!=`function`)throw TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,V.DEBUG,...e),this._logHandler(this,V.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,V.VERBOSE,...e),this._logHandler(this,V.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,V.INFO,...e),this._logHandler(this,V.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,V.WARN,...e),this._logHandler(this,V.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,V.ERROR,...e),this._logHandler(this,V.ERROR,...e)}},Bc=(e,t)=>t.some(t=>e instanceof t),Vc,Hc;function Uc(){return Vc||=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]}function Wc(){return Hc||=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey]}var Gc=new WeakMap,Kc=new WeakMap,qc=new WeakMap,Jc=new WeakMap,Yc=new WeakMap;function Xc(e){let t=new Promise((t,n)=>{let r=()=>{e.removeEventListener(`success`,i),e.removeEventListener(`error`,a)},i=()=>{t(nl(e.result)),r()},a=()=>{n(e.error),r()};e.addEventListener(`success`,i),e.addEventListener(`error`,a)});return t.then(t=>{t instanceof IDBCursor&&Gc.set(t,e)}).catch(()=>{}),Yc.set(t,e),t}function Zc(e){if(Kc.has(e))return;let t=new Promise((t,n)=>{let r=()=>{e.removeEventListener(`complete`,i),e.removeEventListener(`error`,a),e.removeEventListener(`abort`,a)},i=()=>{t(),r()},a=()=>{n(e.error||new DOMException(`AbortError`,`AbortError`)),r()};e.addEventListener(`complete`,i),e.addEventListener(`error`,a),e.addEventListener(`abort`,a)});Kc.set(e,t)}var Qc={get(e,t,n){if(e instanceof IDBTransaction){if(t===`done`)return Kc.get(e);if(t===`objectStoreNames`)return e.objectStoreNames||qc.get(e);if(t===`store`)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return nl(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t===`done`||t===`store`)?!0:t in e}};function $c(e){Qc=e(Qc)}function el(e){return e===IDBDatabase.prototype.transaction&&!(`objectStoreNames`in IDBTransaction.prototype)?function(t,...n){let r=e.call(rl(this),t,...n);return qc.set(r,t.sort?t.sort():[t]),nl(r)}:Wc().includes(e)?function(...t){return e.apply(rl(this),t),nl(Gc.get(this))}:function(...t){return nl(e.apply(rl(this),t))}}function tl(e){return typeof e==`function`?el(e):(e instanceof IDBTransaction&&Zc(e),Bc(e,Uc())?new Proxy(e,Qc):e)}function nl(e){if(e instanceof IDBRequest)return Xc(e);if(Jc.has(e))return Jc.get(e);let t=tl(e);return t!==e&&(Jc.set(e,t),Yc.set(t,e)),t}var rl=e=>Yc.get(e);function il(e,t,{blocked:n,upgrade:r,blocking:i,terminated:a}={}){let o=indexedDB.open(e,t),s=nl(o);return r&&o.addEventListener(`upgradeneeded`,e=>{r(nl(o.result),e.oldVersion,e.newVersion,nl(o.transaction),e)}),n&&o.addEventListener(`blocked`,e=>n(e.oldVersion,e.newVersion,e)),s.then(e=>{a&&e.addEventListener(`close`,()=>a()),i&&e.addEventListener(`versionchange`,e=>i(e.oldVersion,e.newVersion,e))}).catch(()=>{}),s}var al=[`get`,`getKey`,`getAll`,`getAllKeys`,`count`],ol=[`put`,`add`,`delete`,`clear`],sl=new Map;function cl(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t==`string`))return;if(sl.get(t))return sl.get(t);let n=t.replace(/FromIndex$/,``),r=t!==n,i=ol.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(i||al.includes(n)))return;let a=async function(e,...t){let a=this.transaction(e,i?`readwrite`:`readonly`),o=a.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),i&&a.done]))[0]};return sl.set(t,a),a}$c(e=>({...e,get:(t,n,r)=>cl(t,n)||e.get(t,n,r),has:(t,n)=>!!cl(t,n)||e.has(t,n)}));
/**
* @license
* Copyright 2019 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var ll=class{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(e=>{if(ul(e)){let t=e.getImmediate();return`${t.library}/${t.version}`}else return null}).filter(e=>e).join(` `)}};function ul(e){return e.getComponent()?.type===`VERSION`}var dl=`@firebase/app`,fl=`0.14.4`,pl=new zc(`@firebase/app`),ml=`@firebase/app-compat`,hl=`@firebase/analytics-compat`,gl=`@firebase/analytics`,_l=`@firebase/app-check-compat`,vl=`@firebase/app-check`,yl=`@firebase/auth`,bl=`@firebase/auth-compat`,xl=`@firebase/database`,Sl=`@firebase/data-connect`,Cl=`@firebase/database-compat`,wl=`@firebase/functions`,Tl=`@firebase/functions-compat`,El=`@firebase/installations`,Dl=`@firebase/installations-compat`,Ol=`@firebase/messaging`,kl=`@firebase/messaging-compat`,Al=`@firebase/performance`,jl=`@firebase/performance-compat`,Ml=`@firebase/remote-config`,Nl=`@firebase/remote-config-compat`,Pl=`@firebase/storage`,Fl=`@firebase/storage-compat`,Il=`@firebase/firestore`,Ll=`@firebase/ai`,Rl=`@firebase/firestore-compat`,zl=`firebase`,Bl=`12.4.0`,Vl=`[DEFAULT]`,Hl={[dl]:`fire-core`,[ml]:`fire-core-compat`,[gl]:`fire-analytics`,[hl]:`fire-analytics-compat`,[vl]:`fire-app-check`,[_l]:`fire-app-check-compat`,[yl]:`fire-auth`,[bl]:`fire-auth-compat`,[xl]:`fire-rtdb`,[Sl]:`fire-data-connect`,[Cl]:`fire-rtdb-compat`,[wl]:`fire-fn`,[Tl]:`fire-fn-compat`,[El]:`fire-iid`,[Dl]:`fire-iid-compat`,[Ol]:`fire-fcm`,[kl]:`fire-fcm-compat`,[Al]:`fire-perf`,[jl]:`fire-perf-compat`,[Ml]:`fire-rc`,[Nl]:`fire-rc-compat`,[Pl]:`fire-gcs`,[Fl]:`fire-gcs-compat`,[Il]:`fire-fst`,[Rl]:`fire-fst-compat`,[Ll]:`fire-vertex`,"fire-js":`fire-js`,[zl]:`fire-js-all`},Ul=new Map,Wl=new Map,Gl=new Map;function Kl(e,t){try{e.container.addComponent(t)}catch(n){pl.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function ql(e){let t=e.name;if(Gl.has(t))return pl.debug(`There were multiple attempts to register component ${t}.`),!1;Gl.set(t,e);for(let t of Ul.values())Kl(t,e);for(let t of Wl.values())Kl(t,e);return!0}function Jl(e,t){let n=e.container.getProvider(`heartbeat`).getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}function Yl(e){return e==null?!1:e.settings!==void 0}var Xl=new lc(`app`,`Firebase`,{"no-app":`No Firebase App '{$appName}' has been created - call initializeApp() first`,"bad-app-name":`Illegal App name: '{$appName}'`,"duplicate-app":`Firebase App named '{$appName}' already exists with different options or config`,"app-deleted":`Firebase App named '{$appName}' already deleted`,"server-app-deleted":`Firebase Server App has been deleted`,"no-options":`Need to provide options, when not being deployed to hosting via source.`,"invalid-app-argument":`firebase.{$appName}() takes either no argument or a Firebase App instance.`,"invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":`Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.`,"idb-get":`Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.`,"idb-set":`Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.`,"idb-delete":`Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.`,"finalization-registry-not-supported":`FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.`,"invalid-server-app-environment":`FirebaseServerApp is not for use in browser environments.`}),Zl=class{constructor(e,t,n){this._isDeleted=!1,this._options={...e},this._config={...t},this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=n,this.container.addComponent(new Oc(`app`,()=>this,`PUBLIC`))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Xl.create(`app-deleted`,{appName:this._name})}},Ql=Bl;function $l(e,t={}){let n=e;typeof t!=`object`&&(t={name:t});let r={name:Vl,automaticDataCollectionEnabled:!0,...t},i=r.name;if(typeof i!=`string`||!i)throw Xl.create(`bad-app-name`,{appName:String(i)});if(n||=Gs(),!n)throw Xl.create(`no-options`);let a=Ul.get(i);if(a){if(bc(n,a.options)&&bc(r,a.config))return a;throw Xl.create(`duplicate-app`,{appName:i})}let o=new Nc(i);for(let e of Gl.values())o.addComponent(e);let s=new Zl(n,r,o);return Ul.set(i,s),s}function eu(e=Vl){let t=Ul.get(e);if(!t&&e===`[DEFAULT]`&&Gs())return $l();if(!t)throw Xl.create(`no-app`,{appName:e});return t}function tu(e,t,n){let r=Hl[e]??e;n&&(r+=`-${n}`);let i=r.match(/\s|\//),a=t.match(/\s|\//);if(i||a){let e=[`Unable to register library "${r}" with version "${t}":`];i&&e.push(`library name "${r}" contains illegal characters (whitespace or "/")`),i&&a&&e.push(`and`),a&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),pl.warn(e.join(` `));return}ql(new Oc(`${r}-version`,()=>({library:r,version:t}),`VERSION`))}
/**
* @license
* Copyright 2021 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var nu=`firebase-heartbeat-database`,ru=1,iu=`firebase-heartbeat-store`,au=null;function ou(){return au||=il(nu,ru,{upgrade:(e,t)=>{switch(t){case 0:try{e.createObjectStore(iu)}catch(e){console.warn(e)}}}}).catch(e=>{throw Xl.create(`idb-open`,{originalErrorMessage:e.message})}),au}async function su(e){try{let t=(await ou()).transaction(iu),n=await t.objectStore(iu).get(lu(e));return await t.done,n}catch(e){if(e instanceof cc)pl.warn(e.message);else{let t=Xl.create(`idb-get`,{originalErrorMessage:e?.message});pl.warn(t.message)}}}async function cu(e,t){try{let n=(await ou()).transaction(iu,`readwrite`);await n.objectStore(iu).put(t,lu(e)),await n.done}catch(e){if(e instanceof cc)pl.warn(e.message);else{let t=Xl.create(`idb-set`,{originalErrorMessage:e?.message});pl.warn(t.message)}}}function lu(e){return`${e.name}!${e.options.appId}`}
/**
* @license
* Copyright 2021 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var uu=1024,du=30,fu=class{constructor(e){this.container=e,this._heartbeatsCache=null;let t=this.container.getProvider(`app`).getImmediate();this._storage=new hu(t),this._heartbeatsCachePromise=this._storage.read().then(e=>(this._heartbeatsCache=e,e))}async triggerHeartbeat(){try{let e=this.container.getProvider(`platform-logger`).getImmediate().getPlatformInfoString(),t=pu();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===t||this._heartbeatsCache.heartbeats.some(e=>e.date===t))return;if(this._heartbeatsCache.heartbeats.push({date:t,agent:e}),this._heartbeatsCache.heartbeats.length>du){let e=_u(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(e,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(e){pl.warn(e)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return``;let e=pu(),{heartbeatsToSend:t,unsentEntries:n}=mu(this._heartbeatsCache.heartbeats),r=Ns(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}catch(e){return pl.warn(e),``}}};function pu(){return new Date().toISOString().substring(0,10)}function mu(e,t=uu){let n=[],r=e.slice();for(let i of e){let e=n.find(e=>e.agent===i.agent);if(e){if(e.dates.push(i.date),gu(n)>t){e.dates.pop();break}}else if(n.push({agent:i.agent,dates:[i.date]}),gu(n)>t){n.pop();break}r=r.slice(1)}return{heartbeatsToSend:n,unsentEntries:r}}var hu=class{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return ac()?oc().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){let e=await su(this.app);return e?.heartbeats?e:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){if(await this._canUseIndexedDBPromise){let t=await this.read();return cu(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??t.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){if(await this._canUseIndexedDBPromise){let t=await this.read();return cu(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??t.lastSentHeartbeatDate,heartbeats:[...t.heartbeats,...e.heartbeats]})}else return}};function gu(e){return Ns(JSON.stringify({version:2,heartbeats:e})).length}function _u(e){if(e.length===0)return-1;let t=0,n=e[0].date;for(let r=1;r<e.length;r++)e[r].date<n&&(n=e[r].date,t=r);return t}
/**
* @license
* Copyright 2019 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function vu(e){ql(new Oc(`platform-logger`,e=>new ll(e),`PRIVATE`)),ql(new Oc(`heartbeat`,e=>new fu(e),`PRIVATE`)),tu(dl,fl,e),tu(dl,fl,`esm2020`),tu(`fire-js`,``)}
/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
vu(``),tu(`firebase`,`12.4.0`,`app`);var yu=`@firebase/database`,bu=`1.1.0`,xu=``;function Su(e){xu=e}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Cu=class{constructor(e){this.domStorage_=e,this.prefix_=`firebase:`}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),B(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:fc(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}},wu=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return gc(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}},Tu=function(e){try{if(typeof window<`u`&&window[e]!==void 0){let t=window[e];return t.setItem(`firebase:sentinel`,`cache`),t.removeItem(`firebase:sentinel`),new Cu(t)}}catch{}return new wu},Eu=Tu(`localStorage`),Du=Tu(`sessionStorage`),Ou=new zc(`@firebase/database`),ku=(function(){let e=1;return function(){return e++}})(),Au=function(e){let t=Tc(e),n=new Cc;n.update(t);let r=n.digest();return As.encodeByteArray(r)},ju=function(...e){let t=``;for(let n=0;n<e.length;n++){let r=e[n];Array.isArray(r)||r&&typeof r==`object`&&typeof r.length==`number`?t+=ju.apply(null,r):typeof r==`object`?t+=B(r):t+=r,t+=` `}return t},Mu=null,Nu=!0,Pu=function(e,t){z(!t||e===!0||e===!1,`Can't turn on custom loggers persistently.`),e===!0?(Ou.logLevel=V.VERBOSE,Mu=Ou.log.bind(Ou),t&&Du.set(`logging_enabled`,!0)):typeof e==`function`?Mu=e:(Mu=null,Du.remove(`logging_enabled`))},H=function(...e){if(Nu===!0&&(Nu=!1,Mu===null&&Du.get(`logging_enabled`)===!0&&Pu(!0)),Mu){let t=ju.apply(null,e);Mu(t)}},Fu=function(e){return function(...t){H(e,...t)}},Iu=function(...e){let t=`FIREBASE INTERNAL ERROR: `+ju(...e);Ou.error(t)},Lu=function(...e){let t=`FIREBASE FATAL ERROR: ${ju(...e)}`;throw Ou.error(t),Error(t)},Ru=function(...e){let t=`FIREBASE WARNING: `+ju(...e);Ou.warn(t)},zu=function(){typeof window<`u`&&window.location&&window.location.protocol&&window.location.protocol.indexOf(`https:`)!==-1&&Ru(`Insecure Firebase access from a secure page. Please use https in calls to new Firebase().`)},Bu=function(e){return typeof e==`number`&&(e!==e||e===1/0||e===-1/0)},Vu=function(e){if(ic()||document.readyState===`complete`)e();else{let t=!1,n=function(){if(!document.body){setTimeout(n,10);return}t||(t=!0,e())};document.addEventListener?(document.addEventListener(`DOMContentLoaded`,n,!1),window.addEventListener(`load`,n,!1)):document.attachEvent&&(document.attachEvent(`onreadystatechange`,()=>{document.readyState===`complete`&&n()}),window.attachEvent(`onload`,n))}},Hu=`[MIN_NAME]`,Uu=`[MAX_NAME]`,Wu=function(e,t){if(e===t)return 0;if(e===Hu||t===Uu)return-1;if(t===Hu||e===Uu)return 1;{let n=rd(e),r=rd(t);return n===null?r===null&&e<t?-1:1:r===null?-1:n-r===0?e.length-t.length:n-r}},Gu=function(e,t){return e===t?0:e<t?-1:1},Ku=function(e,t){if(t&&e in t)return t[e];throw Error(`Missing required key (`+e+`) in object: `+B(t))},qu=function(e){if(typeof e!=`object`||!e)return B(e);let t=[];for(let n in e)t.push(n);t.sort();let n=`{`;for(let r=0;r<t.length;r++)r!==0&&(n+=`,`),n+=B(t[r]),n+=`:`,n+=qu(e[t[r]]);return n+=`}`,n},Ju=function(e,t){let n=e.length;if(n<=t)return[e];let r=[];for(let i=0;i<n;i+=t)i+t>n?r.push(e.substring(i,n)):r.push(e.substring(i,i+t));return r};function Yu(e,t){for(let n in e)e.hasOwnProperty(n)&&t(n,e[n])}var Xu=function(e){z(!Bu(e),`Invalid JSON number`);let t=1023,n,r,i,a,o;e===0?(r=0,i=0,n=1/e==-1/0?1:0):(n=e<0,e=Math.abs(e),e>=2**(1-t)?(a=Math.min(Math.floor(Math.log(e)/Math.LN2),t),r=a+t,i=Math.round(e*2**(52-a)-2**52)):(r=0,i=Math.round(e/2**(1-t-52))));let s=[];for(o=52;o;--o)s.push(i%2?1:0),i=Math.floor(i/2);for(o=11;o;--o)s.push(r%2?1:0),r=Math.floor(r/2);s.push(n?1:0),s.reverse();let c=s.join(``),l=``;for(o=0;o<64;o+=8){let e=parseInt(c.substr(o,8),2).toString(16);e.length===1&&(e=`0`+e),l+=e}return l.toLowerCase()},Zu=function(){return!!(typeof window==`object`&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},Qu=function(){return typeof Windows==`object`&&typeof Windows.UI==`object`};function $u(e,t){let n=`Unknown Error`;e===`too_big`?n=`The data requested exceeds the maximum size that can be accessed with a single request.`:e===`permission_denied`?n=`Client doesn't have permission to access the desired data.`:e===`unavailable`&&(n=`The service is unavailable`);let r=Error(e+` at `+t._path.toString()+`: `+n);return r.code=e.toUpperCase(),r}var ed=RegExp(`^-?(0*)\\d{1,10}$`),td=-2147483648,nd=2147483647,rd=function(e){if(ed.test(e)){let t=Number(e);if(t>=td&&t<=nd)return t}return null},id=function(e){try{e()}catch(e){setTimeout(()=>{let t=e.stack||``;throw Ru(`Exception was thrown by user callback.`,t),e},0)}},ad=function(){return(typeof window==`object`&&window.navigator&&window.navigator.userAgent||``).search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},od=function(e,t){let n=setTimeout(e,t);return typeof n==`number`&&typeof Deno<`u`&&Deno.unrefTimer?Deno.unrefTimer(n):typeof n==`object`&&n.unref&&n.unref(),n},sd=class{constructor(e,t){this.appCheckProvider=t,this.appName=e.name,Yl(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(e=>this.appCheck=e)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((t,n)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,n):t(null)},0)})}addTokenChangeListener(e){this.appCheckProvider?.get().then(t=>t.addTokenListener(e))}notifyForInvalidToken(){Ru(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}},cd=class{constructor(e,t,n){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=n,this.auth_=null,this.auth_=n.getImmediate({optional:!0}),this.auth_||n.onInit(e=>this.auth_=e)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(e=>e&&e.code===`auth/token-not-initialized`?(H(`Got auth/token-not-initialized error.  Treating as null token.`),null):Promise.reject(e)):new Promise((t,n)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,n):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e=`Provided authentication credentials for the app named "`+this.appName_+`" are invalid. This usually indicates your app was not initialized correctly. `;`credential`in this.firebaseOptions_?e+=`Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.`:`serviceAccount`in this.firebaseOptions_?e+=`Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.`:e+=`Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.`,Ru(e)}},ld=class{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}};ld.OWNER=`owner`;
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var ud=`5`,dd=`v`,fd=`s`,pd=`r`,md=`f`,hd=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,gd=`ls`,_d=`p`,vd=`ac`,yd=`websocket`,bd=`long_polling`,xd=class{constructor(e,t,n,r,i=!1,a=``,o=!1,s=!1,c=null){this.secure=t,this.namespace=n,this.webSocketOnly=r,this.nodeAdmin=i,this.persistenceKey=a,this.includeNamespaceInQueryParams=o,this.isUsingEmulator=s,this.emulatorOptions=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(`.`)+1),this.internalHost=Eu.get(`host:`+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)===`s-`}isCustomHost(){return this._domain!==`firebaseio.com`&&this._domain!==`firebaseio-demo.com`}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&Eu.set(`host:`+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+=`<`+this.persistenceKey+`>`),e}toURLString(){let e=this.secure?`https://`:`http://`,t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:``;return`${e}${this.host}/${t}`}};function Sd(e){return e.host!==e.internalHost||e.isCustomHost()||e.includeNamespaceInQueryParams}function Cd(e,t,n){z(typeof t==`string`,`typeof type must == string`),z(typeof n==`object`,`typeof params must == object`);let r;if(t===yd)r=(e.secure?`wss://`:`ws://`)+e.internalHost+`/.ws?`;else if(t===bd)r=(e.secure?`https://`:`http://`)+e.internalHost+`/.lp?`;else throw Error(`Unknown connection type: `+t);Sd(e)&&(n.ns=e.namespace);let i=[];return Yu(n,(e,t)=>{i.push(e+`=`+t)}),r+i.join(`&`)}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var wd=class{constructor(){this.counters_={}}incrementCounter(e,t=1){gc(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return Fs(this.counters_)}},Td={},Ed={};function Dd(e){let t=e.toString();return Td[t]||(Td[t]=new wd),Td[t]}function Od(e,t){let n=e.toString();return Ed[n]||(Ed[n]=t()),Ed[n]}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var kd=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let e=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let t=0;t<e.length;++t)e[t]&&id(()=>{this.onMessage_(e[t])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&=(this.onClose(),null);break}this.currentResponseNum++}}},Ad=`start`,jd=`close`,Md=`pLPCommand`,Nd=`pRTLPCB`,Pd=`id`,Fd=`pw`,Id=`ser`,Ld=`cb`,Rd=`dframe`,zd=1870,Bd=30,Vd=zd-Bd,Hd=25e3,Ud=3e4,Wd=class e{constructor(e,t,n,r,i,a,o){this.connId=e,this.repoInfo=t,this.applicationId=n,this.appCheckToken=r,this.authToken=i,this.transportSessionId=a,this.lastSessionId=o,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=Fu(e),this.stats_=Dd(t),this.urlFn=e=>(this.appCheckToken&&(e[vd]=this.appCheckToken),Cd(t,bd,e))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new kd(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_(`Timed out trying to connect.`),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(Ud)),Vu(()=>{if(this.isClosed_)return;this.scriptTagHolder=new Gd((...e)=>{let[t,n,r,i,a]=e;if(this.incrementIncomingBytes_(e),this.scriptTagHolder)if(this.connectTimeoutTimer_&&=(clearTimeout(this.connectTimeoutTimer_),null),this.everConnected_=!0,t===Ad)this.id=n,this.password=r;else if(t===jd)n?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(n,()=>{this.onClosed_()})):this.onClosed_();else throw Error(`Unrecognized command received: `+t)},(...e)=>{let[t,n]=e;this.incrementIncomingBytes_(e),this.myPacketOrderer.handleResponse(t,n)},()=>{this.onClosed_()},this.urlFn);let e={};e[Ad]=`t`,e[Id]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(e[Ld]=this.scriptTagHolder.uniqueCallbackIdentifier),e[dd]=ud,this.transportSessionId&&(e[fd]=this.transportSessionId),this.lastSessionId&&(e[gd]=this.lastSessionId),this.applicationId&&(e[_d]=this.applicationId),this.appCheckToken&&(e[vd]=this.appCheckToken),typeof location<`u`&&location.hostname&&hd.test(location.hostname)&&(e[pd]=md);let t=this.urlFn(e);this.log_(`Connecting via long-poll to `+t),this.scriptTagHolder.addTag(t,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){e.forceAllow_=!0}static forceDisallow(){e.forceDisallow_=!0}static isAvailable(){return ic()?!1:e.forceAllow_?!0:!e.forceDisallow_&&typeof document<`u`&&document.createElement!=null&&!Zu()&&!Qu()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&=(this.scriptTagHolder.close(),null),this.myDisconnFrame&&=(document.body.removeChild(this.myDisconnFrame),null),this.connectTimeoutTimer_&&=(clearTimeout(this.connectTimeoutTimer_),null)}onClosed_(){this.isClosed_||(this.log_(`Longpoll is closing itself`),this.shutdown_(),this.onDisconnect_&&=(this.onDisconnect_(this.everConnected_),null))}close(){this.isClosed_||(this.log_(`Longpoll is being closed.`),this.shutdown_())}send(e){let t=B(e);this.bytesSent+=t.length,this.stats_.incrementCounter(`bytes_sent`,t.length);let n=Ms(t),r=Ju(n,Vd);for(let e=0;e<r.length;e++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,r.length,r[e]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(ic())return;this.myDisconnFrame=document.createElement(`iframe`);let n={};n[Rd]=`t`,n[Pd]=e,n[Fd]=t,this.myDisconnFrame.src=this.urlFn(n),this.myDisconnFrame.style.display=`none`,document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=B(e).length;this.bytesReceived+=t,this.stats_.incrementCounter(`bytes_received`,t)}},Gd=class e{constructor(t,n,r,i){if(this.onDisconnect=r,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,ic())this.commandCB=t,this.onMessageCB=n;else{this.uniqueCallbackIdentifier=ku(),window[Md+this.uniqueCallbackIdentifier]=t,window[Nd+this.uniqueCallbackIdentifier]=n,this.myIFrame=e.createIFrame_();let r=``;this.myIFrame.src&&this.myIFrame.src.substr(0,11)===`javascript:`&&(r=`<script>document.domain="`+document.domain+`";<\/script>`);let i=`<html><body>`+r+`</body></html>`;try{this.myIFrame.doc.open(),this.myIFrame.doc.write(i),this.myIFrame.doc.close()}catch(e){H(`frame writing exception`),e.stack&&H(e.stack),H(e)}}}static createIFrame_(){let e=document.createElement(`iframe`);if(e.style.display=`none`,document.body){document.body.appendChild(e);try{e.contentWindow.document||H(`No IE domain setting required`)}catch{e.src=`javascript:void((function(){document.open();document.domain='`+document.domain+`';document.close();})())`}}else throw`Document body has not initialized. Wait to initialize Firebase until after the document is ready.`;return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent=``,setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},0));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[Pd]=this.myID,e[Fd]=this.myPW,e[Id]=this.currentSerial;let t=this.urlFn(e),n=``,r=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+Bd+n.length<=zd;){let e=this.pendingSegs.shift();n=n+`&seg`+r+`=`+e.seg+`&ts`+r+`=`+e.ts+`&d`+r+`=`+e.d,r++}return t+=n,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,n){this.pendingSegs.push({seg:e,ts:t,d:n}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let n=()=>{this.outstandingRequests.delete(t),this.newRequest_()},r=setTimeout(n,Math.floor(Hd));this.addTag(e,()=>{clearTimeout(r),n()})}addTag(e,t){ic()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let n=this.myIFrame.doc.createElement(`script`);n.type=`text/javascript`,n.async=!0,n.src=e,n.onload=n.onreadystatechange=function(){let e=n.readyState;(!e||e===`loaded`||e===`complete`)&&(n.onload=n.onreadystatechange=null,n.parentNode&&n.parentNode.removeChild(n),t())},n.onerror=()=>{H(`Long-poll script failed to load: `+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(n)}catch{}},1)}},Kd=16384,qd=45e3,Jd=null;typeof MozWebSocket<`u`?Jd=MozWebSocket:typeof WebSocket<`u`&&(Jd=WebSocket);var Yd=class e{constructor(t,n,r,i,a,o,s){this.connId=t,this.applicationId=r,this.appCheckToken=i,this.authToken=a,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=Fu(this.connId),this.stats_=Dd(n),this.connURL=e.connectionURL_(n,o,s,i,r),this.nodeAdmin=n.nodeAdmin}static connectionURL_(e,t,n,r,i){let a={};return a[dd]=ud,!ic()&&typeof location<`u`&&location.hostname&&hd.test(location.hostname)&&(a[pd]=md),t&&(a[fd]=t),n&&(a[gd]=n),r&&(a[vd]=r),i&&(a[_d]=i),Cd(e,yd,a)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_(`Websocket connecting to `+this.connURL),this.everConnected_=!1,Eu.set(`previous_websocket_failure`,!0);try{let e;if(ic()){let t=this.nodeAdmin?`AdminNode`:`Node`;e={headers:{"User-Agent":`Firebase/${ud}/${xu}/${process.platform}/${t}`,"X-Firebase-GMPID":this.applicationId||``}},this.authToken&&(e.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(e.headers[`X-Firebase-AppCheck`]=this.appCheckToken);let n={},r=this.connURL.indexOf(`wss://`)===0?n.HTTPS_PROXY||n.https_proxy:n.HTTP_PROXY||n.http_proxy;r&&(e.proxy={origin:r})}this.mySock=new Jd(this.connURL,[],e)}catch(e){this.log_(`Error instantiating WebSocket.`);let t=e.message||e.data;t&&this.log_(t),this.onClosed_();return}this.mySock.onopen=()=>{this.log_(`Websocket connected.`),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_(`Websocket connection was disconnected.`),this.mySock=null,this.onClosed_()},this.mySock.onmessage=e=>{this.handleIncomingFrame(e)},this.mySock.onerror=e=>{this.log_(`WebSocket error.  Closing connection.`);let t=e.message||e.data;t&&this.log_(t),this.onClosed_()}}start(){}static forceDisallow(){e.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<`u`&&navigator.userAgent){let e=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);e&&e.length>1&&parseFloat(e[1])<4.4&&(t=!0)}return!t&&Jd!==null&&!e.forceDisallow_}static previouslyFailed(){return Eu.isInMemoryStorage||Eu.get(`previous_websocket_failure`)===!0}markConnectionHealthy(){Eu.remove(`previous_websocket_failure`)}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){let e=this.frames.join(``);this.frames=null;let t=fc(e);this.onMessage(t)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if(z(this.frames===null,`We already have a frame buffer`),e.length<=6){let t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(this.mySock===null)return;let t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter(`bytes_received`,t.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(t);else{let e=this.extractFrameCount_(t);e!==null&&this.appendFrame_(e)}}send(e){this.resetKeepAlive();let t=B(e);this.bytesSent+=t.length,this.stats_.incrementCounter(`bytes_sent`,t.length);let n=Ju(t,Kd);n.length>1&&this.sendString_(String(n.length));for(let e=0;e<n.length;e++)this.sendString_(n[e])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&=(clearInterval(this.keepaliveTimer),null),this.mySock&&=(this.mySock.close(),null)}onClosed_(){this.isClosed_||(this.log_(`WebSocket is closing itself`),this.shutdown_(),this.onDisconnect&&=(this.onDisconnect(this.everConnected_),null))}close(){this.isClosed_||(this.log_(`WebSocket is being closed`),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_(`0`),this.resetKeepAlive()},Math.floor(qd))}sendString_(e){try{this.mySock.send(e)}catch(e){this.log_(`Exception thrown from WebSocket.send():`,e.message||e.data,`Closing connection.`),setTimeout(this.onClosed_.bind(this),0)}}};Yd.responsesRequiredToBeHealthy=2,Yd.healthyTimeout=3e4;
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Xd=class e{static get ALL_TRANSPORTS(){return[Wd,Yd]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(e){this.initTransports_(e)}initTransports_(t){let n=Yd&&Yd.isAvailable(),r=n&&!Yd.previouslyFailed();if(t.webSocketOnly&&(n||Ru(`wss:// URL used, but browser isn't known to support websockets.  Trying anyway.`),r=!0),r)this.transports_=[Yd];else{let t=this.transports_=[];for(let n of e.ALL_TRANSPORTS)n&&n.isAvailable()&&t.push(n);e.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw Error(`No transports available`)}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}};Xd.globalTransportInitialized_=!1;
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Zd=6e4,Qd=5e3,$d=10*1024,ef=100*1024,tf=`t`,nf=`d`,rf=`s`,af=`r`,sf=`e`,cf=`o`,lf=`a`,uf=`n`,df=`p`,ff=`h`,pf=class{constructor(e,t,n,r,i,a,o,s,c,l){this.id=e,this.repoInfo_=t,this.applicationId_=n,this.appCheckToken_=r,this.authToken_=i,this.onMessage_=a,this.onReady_=o,this.onDisconnect_=s,this.onKill_=c,this.lastSessionId=l,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=Fu(`c:`+this.id+`:`),this.transportManager_=new Xd(t),this.log_(`Connection created`),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),n=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,n)},0);let r=e.healthyTimeout||0;r>0&&(this.healthyTimeout_=od(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>ef?(this.log_(`Connection exceeded healthy timeout but has received `+this.conn_.bytesReceived+` bytes.  Marking connection healthy.`),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>$d?this.log_(`Connection exceeded healthy timeout but has sent `+this.conn_.bytesSent+` bytes.  Leaving connection alive.`):(this.log_(`Closing unhealthy connection after timeout.`),this.close()))},Math.floor(r)))}nextTransportId_(){return`c:`+this.id+`:`+ this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_(`Secondary connection lost.`),this.onSecondaryConnectionLost_()):this.log_(`closing an old connection`)}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_(`message on old connection`))}}sendRequest(e){let t={t:`d`,d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_(`cleaning up and promoting a connection: `+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(tf in e){let t=e[tf];t===lf?this.upgradeIfSecondaryHealthy_():t===af?(this.log_(`Got a reset on secondary, closing it`),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===cf&&(this.log_(`got pong on secondary.`),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=Ku(`t`,e),n=Ku(`d`,e);if(t===`c`)this.onSecondaryControl_(n);else if(t===`d`)this.pendingDataMessages.push(n);else throw Error(`Unknown protocol layer: `+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_(`Secondary connection is healthy.`),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_(`sending ping on secondary.`),this.secondaryConn_.send({t:`c`,d:{t:df,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_(`sending client ack on secondary`),this.secondaryConn_.send({t:`c`,d:{t:lf,d:{}}}),this.log_(`Ending transmission on primary`),this.conn_.send({t:`c`,d:{t:uf,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=Ku(`t`,e),n=Ku(`d`,e);t===`c`?this.onControl_(n):t===`d`&&this.onDataMessage_(n)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_(`Primary connection is healthy.`),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=Ku(tf,e);if(nf in e){let n=e[nf];if(t===ff){let e={...n};this.repoInfo_.isUsingEmulator&&(e.h=this.repoInfo_.host),this.onHandshake_(e)}else if(t===uf){this.log_(`recvd end transmission on primary`),this.rx_=this.secondaryConn_;for(let e=0;e<this.pendingDataMessages.length;++e)this.onDataMessage_(this.pendingDataMessages[e]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===rf?this.onConnectionShutdown_(n):t===af?this.onReset_(n):t===sf?Iu(`Server Error: `+n):t===cf?(this.log_(`got pong on primary.`),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Iu(`Unknown control packet command: `+t)}}onHandshake_(e){let t=e.ts,n=e.v,r=e.h;this.sessionId=e.s,this.repoInfo_.host=r,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),ud!==n&&Ru(`Protocol version mismatch detected`),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),n=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,n),od(()=>{this.secondaryConn_&&(this.log_(`Timed out trying to upgrade.`),this.secondaryConn_.close())},Math.floor(Zd))}onReset_(e){this.log_(`Reset packet received.  New host: `+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_(`Realtime connection established.`),this.conn_=e,this.state_=1,this.onReady_&&=(this.onReady_(t,this.sessionId),null),this.primaryResponsesRequired_===0?(this.log_(`Primary connection is healthy.`),this.isHealthy_=!0):od(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(Qd))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_(`sending ping on primary.`),this.sendData_({t:`c`,d:{t:df,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_(`Realtime connection failed.`),this.repoInfo_.isCacheableHost()&&(Eu.remove(`host:`+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_(`Realtime connection lost.`),this.close()}onConnectionShutdown_(e){this.log_(`Connection shutdown command received. Shutting down...`),this.onKill_&&=(this.onKill_(e),null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw`Connection is not connected`;this.tx_.send(e)}close(){this.state_!==2&&(this.log_(`Closing realtime connection.`),this.state_=2,this.closeConnections_(),this.onDisconnect_&&=(this.onDisconnect_(),null))}closeConnections_(){this.log_(`Shutting down all connections`),this.conn_&&=(this.conn_.close(),null),this.secondaryConn_&&=(this.secondaryConn_.close(),null),this.healthyTimeout_&&=(clearTimeout(this.healthyTimeout_),null)}},mf=class{put(e,t,n,r){}merge(e,t,n,r){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,n){}onDisconnectMerge(e,t,n){}onDisconnectCancel(e,t){}reportStats(e){}},hf=class{constructor(e){this.allowedEvents_=e,this.listeners_={},z(Array.isArray(e)&&e.length>0,`Requires a non-empty array`)}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let n=[...this.listeners_[e]];for(let e=0;e<n.length;e++)n[e].callback.apply(n[e].context,t)}}on(e,t,n){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:n});let r=this.getInitialEvent(e);r&&t.apply(n,r)}off(e,t,n){this.validateEventType_(e);let r=this.listeners_[e]||[];for(let e=0;e<r.length;e++)if(r[e].callback===t&&(!n||n===r[e].context)){r.splice(e,1);return}}validateEventType_(e){z(this.allowedEvents_.find(t=>t===e),`Unknown event: `+e)}},gf=class e extends hf{static getInstance(){return new e}constructor(){super([`online`]),this.online_=!0,typeof window<`u`&&window.addEventListener!==void 0&&!nc()&&(window.addEventListener(`online`,()=>{this.online_||(this.online_=!0,this.trigger(`online`,!0))},!1),window.addEventListener(`offline`,()=>{this.online_&&(this.online_=!1,this.trigger(`online`,!1))},!1))}getInitialEvent(e){return z(e===`online`,`Unknown event type: `+e),[this.online_]}currentlyOnline(){return this.online_}},_f=32,vf=768,U=class{constructor(e,t){if(t===void 0){this.pieces_=e.split(`/`);let t=0;for(let e=0;e<this.pieces_.length;e++)this.pieces_[e].length>0&&(this.pieces_[t]=this.pieces_[e],t++);this.pieces_.length=t,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e=``;for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==``&&(e+=`/`+this.pieces_[t]);return e||`/`}};function W(){return new U(``)}function G(e){return e.pieceNum_>=e.pieces_.length?null:e.pieces_[e.pieceNum_]}function yf(e){return e.pieces_.length-e.pieceNum_}function K(e){let t=e.pieceNum_;return t<e.pieces_.length&&t++,new U(e.pieces_,t)}function bf(e){return e.pieceNum_<e.pieces_.length?e.pieces_[e.pieces_.length-1]:null}function xf(e){let t=``;for(let n=e.pieceNum_;n<e.pieces_.length;n++)e.pieces_[n]!==``&&(t+=`/`+encodeURIComponent(String(e.pieces_[n])));return t||`/`}function Sf(e,t=0){return e.pieces_.slice(e.pieceNum_+t)}function Cf(e){if(e.pieceNum_>=e.pieces_.length)return null;let t=[];for(let n=e.pieceNum_;n<e.pieces_.length-1;n++)t.push(e.pieces_[n]);return new U(t,0)}function q(e,t){let n=[];for(let t=e.pieceNum_;t<e.pieces_.length;t++)n.push(e.pieces_[t]);if(t instanceof U)for(let e=t.pieceNum_;e<t.pieces_.length;e++)n.push(t.pieces_[e]);else{let e=t.split(`/`);for(let t=0;t<e.length;t++)e[t].length>0&&n.push(e[t])}return new U(n,0)}function J(e){return e.pieceNum_>=e.pieces_.length}function wf(e,t){let n=G(e),r=G(t);if(n===null)return t;if(n===r)return wf(K(e),K(t));throw Error(`INTERNAL ERROR: innerPath (`+t+`) is not within outerPath (`+e+`)`)}function Tf(e,t){if(yf(e)!==yf(t))return!1;for(let n=e.pieceNum_,r=t.pieceNum_;n<=e.pieces_.length;n++,r++)if(e.pieces_[n]!==t.pieces_[r])return!1;return!0}function Ef(e,t){let n=e.pieceNum_,r=t.pieceNum_;if(yf(e)>yf(t))return!1;for(;n<e.pieces_.length;){if(e.pieces_[n]!==t.pieces_[r])return!1;++n,++r}return!0}var Df=class{constructor(e,t){this.errorPrefix_=t,this.parts_=Sf(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let e=0;e<this.parts_.length;e++)this.byteLength_+=Ec(this.parts_[e]);Af(this)}};function Of(e,t){e.parts_.length>0&&(e.byteLength_+=1),e.parts_.push(t),e.byteLength_+=Ec(t),Af(e)}function kf(e){let t=e.parts_.pop();e.byteLength_-=Ec(t),e.parts_.length>0&&--e.byteLength_}function Af(e){if(e.byteLength_>vf)throw Error(e.errorPrefix_+`has a key path longer than 768 bytes (`+e.byteLength_+`).`);if(e.parts_.length>_f)throw Error(e.errorPrefix_+`path specified exceeds the maximum depth that can be written (32) or object contains a cycle `+jf(e))}function jf(e){return e.parts_.length===0?``:`in property '`+e.parts_.join(`.`)+`'`}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Mf=class e extends hf{static getInstance(){return new e}constructor(){super([`visible`]);let e,t;typeof document<`u`&&document.addEventListener!==void 0&&(document.hidden===void 0?document.mozHidden===void 0?document.msHidden===void 0?document.webkitHidden!==void 0&&(t=`webkitvisibilitychange`,e=`webkitHidden`):(t=`msvisibilitychange`,e=`msHidden`):(t=`mozvisibilitychange`,e=`mozHidden`):(t=`visibilitychange`,e=`hidden`)),this.visible_=!0,t&&document.addEventListener(t,()=>{let t=!document[e];t!==this.visible_&&(this.visible_=t,this.trigger(`visible`,t))},!1)}getInitialEvent(e){return z(e===`visible`,`Unknown event type: `+e),[this.visible_]}},Nf=1e3,Pf=300*1e3,Ff=30*1e3,If=1.3,Lf=3e4,Rf=`server_kill`,zf=3,Bf=class e extends mf{constructor(t,n,r,i,a,o,s,c){if(super(),this.repoInfo_=t,this.applicationId_=n,this.onDataUpdate_=r,this.onConnectStatus_=i,this.onServerInfoUpdate_=a,this.authTokenProvider_=o,this.appCheckTokenProvider_=s,this.authOverride_=c,this.id=e.nextPersistentConnectionId_++,this.log_=Fu(`p:`+this.id+`:`),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Nf,this.maxReconnectDelay_=Pf,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!ic())throw Error(`Auth override specified in options, but not supported on non Node.js platforms`);Mf.getInstance().on(`visible`,this.onVisible_,this),t.host.indexOf(`fblocal`)===-1&&gf.getInstance().on(`online`,this.onOnline_,this)}sendRequest(e,t,n){let r=++this.requestNumber_,i={r,a:e,b:t};this.log_(B(i)),z(this.connected_,`sendRequest call when we're not connected not allowed.`),this.realtime_.sendRequest(i),n&&(this.requestCBHash_[r]=n)}get(e){this.initConnection_();let t=new Ks,n={action:`g`,request:{p:e._path.toString(),q:e._queryObject},onComplete:e=>{let n=e.d;e.s===`ok`?t.resolve(n):t.reject(n)}};this.outstandingGets_.push(n),this.outstandingGetCount_++;let r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,n,r){this.initConnection_();let i=e._queryIdentifier,a=e._path.toString();this.log_(`Listen called for `+a+` `+i),this.listens.has(a)||this.listens.set(a,new Map),z(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),`listen() called for non-default but complete query`),z(!this.listens.get(a).has(i),`listen() called twice for same path/queryId.`);let o={onComplete:r,hashFn:t,query:e,tag:n};this.listens.get(a).set(i,o),this.connected_&&this.sendListen_(o)}sendGet_(e){let t=this.outstandingGets_[e];this.sendRequest(`g`,t.request,n=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(n)})}sendListen_(t){let n=t.query,r=n._path.toString(),i=n._queryIdentifier;this.log_(`Listen on `+r+` for `+i);let a={p:r};t.tag&&(a.q=n._queryObject,a.t=t.tag),a.h=t.hashFn(),this.sendRequest(`q`,a,a=>{let o=a.d,s=a.s;e.warnOnListenWarnings_(o,n),(this.listens.get(r)&&this.listens.get(r).get(i))===t&&(this.log_(`listen response`,a),s!==`ok`&&this.removeListen_(r,i),t.onComplete&&t.onComplete(s,o))})}static warnOnListenWarnings_(e,t){if(e&&typeof e==`object`&&gc(e,`w`)){let n=_c(e,`w`);if(Array.isArray(n)&&~n.indexOf(`no_index`)){let e=`".indexOn": "`+t._queryParams.getIndex().toString()+`"`,n=t._path.toString();Ru(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${e} at ${n} to your security rules for better performance.`)}}}refreshAuthToken(e){this.authToken_=e,this.log_(`Auth token refreshed`),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest(`unauth`,{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){(e&&e.length===40||hc(e))&&(this.log_(`Admin auth credential detected.  Reducing max reconnect time.`),this.maxReconnectDelay_=Ff)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_(`App check token refreshed`),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest(`unappeck`,{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let e=this.authToken_,t=mc(e)?`auth`:`gauth`,n={cred:e};this.authOverride_===null?n.noauth=!0:typeof this.authOverride_==`object`&&(n.authvar=this.authOverride_),this.sendRequest(t,n,t=>{let n=t.s,r=t.d||`error`;this.authToken_===e&&(n===`ok`?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(n,r))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest(`appcheck`,{token:this.appCheckToken_},e=>{let t=e.s,n=e.d||`error`;t===`ok`?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,n)})}unlisten(e,t){let n=e._path.toString(),r=e._queryIdentifier;this.log_(`Unlisten called for `+n+` `+r),z(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),`unlisten() called for non-default but complete query`),this.removeListen_(n,r)&&this.connected_&&this.sendUnlisten_(n,r,e._queryObject,t)}sendUnlisten_(e,t,n,r){this.log_(`Unlisten on `+e+` for `+t);let i={p:e};r&&(i.q=n,i.t=r),this.sendRequest(`n`,i)}onDisconnectPut(e,t,n){this.initConnection_(),this.connected_?this.sendOnDisconnect_(`o`,e,t,n):this.onDisconnectRequestQueue_.push({pathString:e,action:`o`,data:t,onComplete:n})}onDisconnectMerge(e,t,n){this.initConnection_(),this.connected_?this.sendOnDisconnect_(`om`,e,t,n):this.onDisconnectRequestQueue_.push({pathString:e,action:`om`,data:t,onComplete:n})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_(`oc`,e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:`oc`,data:null,onComplete:t})}sendOnDisconnect_(e,t,n,r){let i={p:t,d:n};this.log_(`onDisconnect `+e,i),this.sendRequest(e,i,e=>{r&&setTimeout(()=>{r(e.s,e.d)},0)})}put(e,t,n,r){this.putInternal(`p`,e,t,n,r)}merge(e,t,n,r){this.putInternal(`m`,e,t,n,r)}putInternal(e,t,n,r,i){this.initConnection_();let a={p:t,d:n};i!==void 0&&(a.h=i),this.outstandingPuts_.push({action:e,request:a,onComplete:r}),this.outstandingPutCount_++;let o=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(o):this.log_(`Buffering put: `+t)}sendPut_(e){let t=this.outstandingPuts_[e].action,n=this.outstandingPuts_[e].request,r=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,n,n=>{this.log_(t+` response`,n),delete this.outstandingPuts_[e],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),r&&r(n.s,n.d)})}reportStats(e){if(this.connected_){let t={c:e};this.log_(`reportStats`,t),this.sendRequest(`s`,t,e=>{if(e.s!==`ok`){let t=e.d;this.log_(`reportStats`,`Error sending stats: `+t)}})}}onDataMessage_(e){if(`r`in e){this.log_(`from server: `+B(e));let t=e.r,n=this.requestCBHash_[t];n&&(delete this.requestCBHash_[t],n(e.b))}else if(`error`in e)throw`A server-side error has occurred: `+e.error;else `a`in e&&this.onDataPush_(e.a,e.b)}onDataPush_(e,t){this.log_(`handleServerMessage`,e,t),e===`d`?this.onDataUpdate_(t.p,t.d,!1,t.t):e===`m`?this.onDataUpdate_(t.p,t.d,!0,t.t):e===`c`?this.onListenRevoked_(t.p,t.q):e===`ac`?this.onAuthRevoked_(t.s,t.d):e===`apc`?this.onAppCheckRevoked_(t.s,t.d):e===`sd`?this.onSecurityDebugPacket_(t):Iu(`Unrecognized action received from server: `+B(e)+`
Are you using the latest client?`)}onReady_(e,t){this.log_(`connection ready`),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){z(!this.realtime_,`Scheduling a connect when we're already connected/ing?`),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_(`Window became visible.  Reducing delay.`),this.reconnectDelay_=Nf,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_(`Browser went online.`),this.reconnectDelay_=Nf,this.realtime_||this.scheduleConnect_(0)):(this.log_(`Browser went offline.  Killing connection.`),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_(`data client disconnected`),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&=(new Date().getTime()-this.lastConnectionEstablishedTime_>Lf&&(this.reconnectDelay_=Nf),null):(this.log_(`Window isn't visible.  Delaying reconnect.`),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let e=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_),t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_(`Trying to reconnect in `+t+`ms`),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*If)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_(`Making a connection attempt`),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),n=this.onReady_.bind(this),r=this.onRealtimeDisconnect_.bind(this),i=this.id+`:`+ e.nextConnectionId_++,a=this.lastSessionId,o=!1,s=null,c=function(){s?s.close():(o=!0,r())};this.realtime_={close:c,sendRequest:function(e){z(s,`sendRequest call when we're not connected not allowed.`),s.sendRequest(e)}};let l=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[e,c]=await Promise.all([this.authTokenProvider_.getToken(l),this.appCheckTokenProvider_.getToken(l)]);o?H(`getToken() completed but was canceled`):(H(`getToken() completed. Creating connection.`),this.authToken_=e&&e.accessToken,this.appCheckToken_=c&&c.token,s=new pf(i,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,n,r,e=>{Ru(e+` (`+this.repoInfo_.toString()+`)`),this.interrupt(Rf)},a))}catch(e){this.log_(`Failed to get token: `+e),o||(this.repoInfo_.nodeAdmin&&Ru(e),c())}}}interrupt(e){H(`Interrupting connection for reason: `+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&=(clearTimeout(this.establishConnectionTimer_),null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){H(`Resuming connection for reason: `+e),delete this.interruptReasons_[e],vc(this.interruptReasons_)&&(this.reconnectDelay_=Nf,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){let t=e-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){let t=this.outstandingPuts_[e];t&&`h`in t.request&&t.queued&&(t.onComplete&&t.onComplete(`disconnect`),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let n;n=t?t.map(e=>qu(e)).join(`$`):`default`;let r=this.removeListen_(e,n);r&&r.onComplete&&r.onComplete(`permission_denied`)}removeListen_(e,t){let n=new U(e).toString(),r;if(this.listens.has(n)){let e=this.listens.get(n);r=e.get(t),e.delete(t),e.size===0&&this.listens.delete(n)}else r=void 0;return r}onAuthRevoked_(e,t){H(`Auth token revoked: `+e+`/`+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(e===`invalid_token`||e===`permission_denied`)&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=zf&&(this.reconnectDelay_=Ff,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){H(`App check token revoked: `+e+`/`+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(e===`invalid_token`||e===`permission_denied`)&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=zf&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):`msg`in e&&console.log(`FIREBASE: `+e.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let e of this.listens.values())for(let t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){let e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){let e={},t=`js`;ic()&&(t=this.repoInfo_.nodeAdmin?`admin_node`:`node`),e[`sdk.`+t+`.`+xu.replace(/\./g,`-`)]=1,nc()?e[`framework.cordova`]=1:rc()&&(e[`framework.reactnative`]=1),this.reportStats(e)}shouldReconnect_(){let e=gf.getInstance().currentlyOnline();return vc(this.interruptReasons_)&&e}};Bf.nextPersistentConnectionId_=0,Bf.nextConnectionId_=0;
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Y=class e{constructor(e,t){this.name=e,this.node=t}static Wrap(t,n){return new e(t,n)}},Vf=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let n=new Y(Hu,e),r=new Y(Hu,t);return this.compare(n,r)!==0}minPost(){return Y.MIN}},Hf,Uf=class extends Vf{static get __EMPTY_NODE(){return Hf}static set __EMPTY_NODE(e){Hf=e}compare(e,t){return Wu(e.name,t.name)}isDefinedOn(e){throw Ds(`KeyIndex.isDefinedOn not expected to be called.`)}indexedValueChanged(e,t){return!1}minPost(){return Y.MIN}maxPost(){return new Y(Uu,Hf)}makePost(e,t){return z(typeof e==`string`,`KeyIndex indexValue must always be a string.`),new Y(e,Hf)}toString(){return`.key`}},Wf=new Uf,Gf=class{constructor(e,t,n,r,i=null){this.isReverse_=r,this.resultGenerator_=i,this.nodeStack_=[];let a=1;for(;!e.isEmpty();)if(e=e,a=t?n(e.key,t):1,r&&(a*=-1),a<0)e=this.isReverse_?e.left:e.right;else if(a===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),e=this.isReverse_?e.right:e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(t=this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},Kf=class e{constructor(t,n,r,i,a){this.key=t,this.value=n,this.color=r??e.RED,this.left=i??Jf.EMPTY_NODE,this.right=a??Jf.EMPTY_NODE}copy(t,n,r,i,a){return new e(t??this.key,n??this.value,r??this.color,i??this.left,a??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):i===0?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp_()}removeMin_(){if(this.left.isEmpty())return Jf.EMPTY_NODE;let e=this;return!e.left.isRed_()&&!e.left.left.isRed_()&&(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let n,r;if(n=this,t(e,n.key)<0)!n.left.isEmpty()&&!n.left.isRed_()&&!n.left.left.isRed_()&&(n=n.moveRedLeft_()),n=n.copy(null,null,null,n.left.remove(e,t),null);else{if(n.left.isRed_()&&(n=n.rotateRight_()),!n.right.isEmpty()&&!n.right.isRed_()&&!n.right.left.isRed_()&&(n=n.moveRedRight_()),t(e,n.key)===0){if(n.right.isEmpty())return Jf.EMPTY_NODE;r=n.right.min_(),n=n.copy(r.key,r.value,null,null,n.right.removeMin_())}n=n.copy(null,null,null,null,n.right.remove(e,t))}return n.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){let t=this.copy(null,null,e.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,e.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){return 2**this.check_()<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw Error(`Red node has red child(`+this.key+`,`+this.value+`)`);if(this.right.isRed_())throw Error(`Right child of (`+this.key+`,`+this.value+`) is red`);let e=this.left.check_();if(e!==this.right.check_())throw Error(`Black depths differ`);return e+(this.isRed_()?0:1)}};Kf.RED=!0,Kf.BLACK=!1;var qf=class{copy(e,t,n,r,i){return this}insert(e,t,n){return new Kf(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},Jf=class e{constructor(t,n=e.EMPTY_NODE){this.comparator_=t,this.root_=n}insert(t,n){return new e(this.comparator_,this.root_.insert(t,n,this.comparator_).copy(null,null,Kf.BLACK,null,null))}remove(t){return new e(this.comparator_,this.root_.remove(t,this.comparator_).copy(null,null,Kf.BLACK,null,null))}get(e){let t,n=this.root_;for(;!n.isEmpty();){if(t=this.comparator_(e,n.key),t===0)return n.value;t<0?n=n.left:t>0&&(n=n.right)}return null}getPredecessorKey(e){let t,n=this.root_,r=null;for(;!n.isEmpty();)if(t=this.comparator_(e,n.key),t===0){if(n.left.isEmpty())return r?r.key:null;for(n=n.left;!n.right.isEmpty();)n=n.right;return n.key}else t<0?n=n.left:t>0&&(r=n,n=n.right);throw Error(`Attempted to find predecessor key for a nonexistent key.  What gives?`)}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Gf(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Gf(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Gf(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Gf(this.root_,null,this.comparator_,!0,e)}};Jf.EMPTY_NODE=new qf;
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function Yf(e,t){return Wu(e.name,t.name)}function Xf(e,t){return Wu(e,t)}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Zf;function Qf(e){Zf=e}var $f=function(e){return typeof e==`number`?`number:`+Xu(e):`string:`+e},ep=function(e){if(e.isLeafNode()){let t=e.val();z(typeof t==`string`||typeof t==`number`||typeof t==`object`&&gc(t,`.sv`),`Priority must be a string or number.`)}else z(e===Zf||e.isEmpty(),`priority of unexpected type.`);z(e===Zf||e.getPriority().isEmpty(),`Priority nodes can't have a priority of their own.`)},tp,np=class e{static set __childrenNodeConstructor(e){tp=e}static get __childrenNodeConstructor(){return tp}constructor(t,n=e.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=n,this.lazyHash_=null,z(this.value_!==void 0&&this.value_!==null,`LeafNode shouldn't be created with null/undefined value.`),ep(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new e(this.value_,t)}getImmediateChild(t){return t===`.priority`?this.priorityNode_:e.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return J(t)?this:G(t)===`.priority`?this.priorityNode_:e.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(t,n){return t===`.priority`?this.updatePriority(n):n.isEmpty()&&t!==`.priority`?this:e.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,n).updatePriority(this.priorityNode_)}updateChild(t,n){let r=G(t);return r===null?n:n.isEmpty()&&r!==`.priority`?this:(z(r!==`.priority`||yf(t)===1,`.priority must be the last token in a path`),this.updateImmediateChild(r,e.__childrenNodeConstructor.EMPTY_NODE.updateChild(K(t),n)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let e=``;this.priorityNode_.isEmpty()||(e+=`priority:`+$f(this.priorityNode_.val())+`:`);let t=typeof this.value_;e+=t+`:`,t===`number`?e+=Xu(this.value_):e+=this.value_,this.lazyHash_=Au(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===e.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof e.__childrenNodeConstructor?-1:(z(t.isLeafNode(),`Unknown node type`),this.compareToLeafNode_(t))}compareToLeafNode_(t){let n=typeof t.value_,r=typeof this.value_,i=e.VALUE_TYPE_ORDER.indexOf(n),a=e.VALUE_TYPE_ORDER.indexOf(r);return z(i>=0,`Unknown leaf type: `+n),z(a>=0,`Unknown leaf type: `+r),i===a?r===`object`?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:a-i}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){let t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}else return!1}};np.VALUE_TYPE_ORDER=[`object`,`boolean`,`number`,`string`];
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var rp,ip;function ap(e){rp=e}function op(e){ip=e}var X=new class extends Vf{compare(e,t){let n=e.node.getPriority(),r=t.node.getPriority(),i=n.compareTo(r);return i===0?Wu(e.name,t.name):i}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return Y.MIN}maxPost(){return new Y(Uu,new np(`[PRIORITY-POST]`,ip))}makePost(e,t){let n=rp(e);return new Y(t,new np(`[PRIORITY-POST]`,n))}toString(){return`.priority`}},sp=Math.log(2),cp=class{constructor(e){let t=e=>parseInt(Math.log(e)/sp,10),n=e=>parseInt(Array(e+1).join(`1`),2);this.count=t(e+1),this.current_=this.count-1;let r=n(this.count);this.bits_=e+1&r}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},lp=function(e,t,n,r){e.sort(t);let i=function(t,r){let a=r-t,o,s;if(a===0)return null;if(a===1)return o=e[t],s=n?n(o):o,new Kf(s,o.node,Kf.BLACK,null,null);{let c=parseInt(a/2,10)+t,l=i(t,c),u=i(c+1,r);return o=e[c],s=n?n(o):o,new Kf(s,o.node,Kf.BLACK,l,u)}},a=function(t){let r=null,a=null,o=e.length,s=function(t,r){let a=o-t,s=o;o-=t;let l=i(a+1,s),u=e[a],d=n?n(u):u;c(new Kf(d,u.node,r,null,l))},c=function(e){r?(r.left=e,r=e):(a=e,r=e)};for(let e=0;e<t.count;++e){let n=t.nextBitIsOne(),r=2**(t.count-(e+1));n?s(r,Kf.BLACK):(s(r,Kf.BLACK),s(r,Kf.RED))}return a},o=new cp(e.length),s=a(o);return new Jf(r||t,s)},up,dp={},fp=class e{static get Default(){return z(dp&&X,`ChildrenNode.ts has not been loaded`),up||=new e({".priority":dp},{".priority":X}),up}constructor(e,t){this.indexes_=e,this.indexSet_=t}get(e){let t=_c(this.indexes_,e);if(!t)throw Error(`No index defined for `+e);return t instanceof Jf?t:null}hasIndex(e){return gc(this.indexSet_,e.toString())}addIndex(t,n){z(t!==Wf,`KeyIndex always exists and isn't meant to be added to the IndexMap.`);let r=[],i=!1,a=n.getIterator(Y.Wrap),o=a.getNext();for(;o;)i||=t.isDefinedOn(o.node),r.push(o),o=a.getNext();let s;s=i?lp(r,t.getCompare()):dp;let c=t.toString(),l={...this.indexSet_};l[c]=t;let u={...this.indexes_};return u[c]=s,new e(u,l)}addToIndexes(t,n){let r=yc(this.indexes_,(e,r)=>{let i=_c(this.indexSet_,r);if(z(i,`Missing index implementation for `+r),e===dp)if(i.isDefinedOn(t.node)){let e=[],r=n.getIterator(Y.Wrap),a=r.getNext();for(;a;)a.name!==t.name&&e.push(a),a=r.getNext();return e.push(t),lp(e,i.getCompare())}else return dp;else{let r=n.get(t.name),i=e;return r&&(i=i.remove(new Y(t.name,r))),i.insert(t,t.node)}});return new e(r,this.indexSet_)}removeFromIndexes(t,n){let r=yc(this.indexes_,e=>{if(e===dp)return e;{let r=n.get(t.name);return r?e.remove(new Y(t.name,r)):e}});return new e(r,this.indexSet_)}},pp,Z=class e{static get EMPTY_NODE(){return pp||=new e(new Jf(Xf),null,fp.Default)}constructor(e,t,n){this.children_=e,this.priorityNode_=t,this.indexMap_=n,this.lazyHash_=null,this.priorityNode_&&ep(this.priorityNode_),this.children_.isEmpty()&&z(!this.priorityNode_||this.priorityNode_.isEmpty(),`An empty node cannot have a priority`)}isLeafNode(){return!1}getPriority(){return this.priorityNode_||pp}updatePriority(t){return this.children_.isEmpty()?this:new e(this.children_,t,this.indexMap_)}getImmediateChild(e){if(e===`.priority`)return this.getPriority();{let t=this.children_.get(e);return t===null?pp:t}}getChild(e){let t=G(e);return t===null?this:this.getImmediateChild(t).getChild(K(e))}hasChild(e){return this.children_.get(e)!==null}updateImmediateChild(t,n){if(z(n,`We should always be passing snapshot nodes`),t===`.priority`)return this.updatePriority(n);{let r=new Y(t,n),i,a;n.isEmpty()?(i=this.children_.remove(t),a=this.indexMap_.removeFromIndexes(r,this.children_)):(i=this.children_.insert(t,n),a=this.indexMap_.addToIndexes(r,this.children_));let o=i.isEmpty()?pp:this.priorityNode_;return new e(i,o,a)}}updateChild(e,t){let n=G(e);if(n===null)return t;{z(G(e)!==`.priority`||yf(e)===1,`.priority must be the last token in a path`);let r=this.getImmediateChild(n).updateChild(K(e),t);return this.updateImmediateChild(n,r)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let n={},r=0,i=0,a=!0;if(this.forEachChild(X,(o,s)=>{n[o]=s.val(t),r++,a&&e.INTEGER_REGEXP_.test(o)?i=Math.max(i,Number(o)):a=!1}),!t&&a&&i<2*r){let e=[];for(let t in n)e[t]=n[t];return e}else return t&&!this.getPriority().isEmpty()&&(n[`.priority`]=this.getPriority().val()),n}hash(){if(this.lazyHash_===null){let e=``;this.getPriority().isEmpty()||(e+=`priority:`+$f(this.getPriority().val())+`:`),this.forEachChild(X,(t,n)=>{let r=n.hash();r!==``&&(e+=`:`+t+`:`+r)}),this.lazyHash_=e===``?``:Au(e)}return this.lazyHash_}getPredecessorChildName(e,t,n){let r=this.resolveIndex_(n);if(r){let n=r.getPredecessorKey(new Y(e,t));return n?n.name:null}else return this.children_.getPredecessorKey(e)}getFirstChildName(e){let t=this.resolveIndex_(e);if(t){let e=t.minKey();return e&&e.name}else return this.children_.minKey()}getFirstChild(e){let t=this.getFirstChildName(e);return t?new Y(t,this.children_.get(t)):null}getLastChildName(e){let t=this.resolveIndex_(e);if(t){let e=t.maxKey();return e&&e.name}else return this.children_.maxKey()}getLastChild(e){let t=this.getLastChildName(e);return t?new Y(t,this.children_.get(t)):null}forEachChild(e,t){let n=this.resolveIndex_(e);return n?n.inorderTraversal(e=>t(e.name,e.node)):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){let n=this.resolveIndex_(t);if(n)return n.getIteratorFrom(e,e=>e);{let n=this.children_.getIteratorFrom(e.name,Y.Wrap),r=n.peek();for(;r!=null&&t.compare(r,e)<0;)n.getNext(),r=n.peek();return n}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){let n=this.resolveIndex_(t);if(n)return n.getReverseIteratorFrom(e,e=>e);{let n=this.children_.getReverseIteratorFrom(e.name,Y.Wrap),r=n.peek();for(;r!=null&&t.compare(r,e)>0;)n.getNext(),r=n.peek();return n}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===mp?-1:0}withIndex(t){if(t===Wf||this.indexMap_.hasIndex(t))return this;{let n=this.indexMap_.addIndex(t,this.children_);return new e(this.children_,this.priorityNode_,n)}}isIndexed(e){return e===Wf||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{let t=e;if(this.getPriority().equals(t.getPriority()))if(this.children_.count()===t.children_.count()){let e=this.getIterator(X),n=t.getIterator(X),r=e.getNext(),i=n.getNext();for(;r&&i;){if(r.name!==i.name||!r.node.equals(i.node))return!1;r=e.getNext(),i=n.getNext()}return r===null&&i===null}else return!1;else return!1}}resolveIndex_(e){return e===Wf?null:this.indexMap_.get(e.toString())}};Z.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;var mp=new class extends Z{constructor(){super(new Jf(Xf),Z.EMPTY_NODE,fp.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return Z.EMPTY_NODE}isEmpty(){return!1}};Object.defineProperties(Y,{MIN:{value:new Y(Hu,Z.EMPTY_NODE)},MAX:{value:new Y(Uu,mp)}}),Uf.__EMPTY_NODE=Z.EMPTY_NODE,np.__childrenNodeConstructor=Z,Qf(mp),op(mp);
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var hp=!0;function Q(e,t=null){if(e===null)return Z.EMPTY_NODE;if(typeof e==`object`&&`.priority`in e&&(t=e[`.priority`]),z(t===null||typeof t==`string`||typeof t==`number`||typeof t==`object`&&`.sv`in t,`Invalid priority type found: `+typeof t),typeof e==`object`&&`.value`in e&&e[`.value`]!==null&&(e=e[`.value`]),typeof e!=`object`||`.sv`in e)return new np(e,Q(t));if(!(e instanceof Array)&&hp){let n=[],r=!1;if(Yu(e,(e,t)=>{if(e.substring(0,1)!==`.`){let i=Q(t);i.isEmpty()||(r||=!i.getPriority().isEmpty(),n.push(new Y(e,i)))}}),n.length===0)return Z.EMPTY_NODE;let i=lp(n,Yf,e=>e.name,Xf);if(r){let e=lp(n,X.getCompare());return new Z(i,Q(t),new fp({".priority":e},{".priority":X}))}else return new Z(i,Q(t),fp.Default)}else{let n=Z.EMPTY_NODE;return Yu(e,(t,r)=>{if(gc(e,t)&&t.substring(0,1)!==`.`){let e=Q(r);(e.isLeafNode()||!e.isEmpty())&&(n=n.updateImmediateChild(t,e))}}),n.updatePriority(Q(t))}}ap(Q);
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var gp=class extends Vf{constructor(e){super(),this.indexPath_=e,z(!J(e)&&G(e)!==`.priority`,`Can't create PathIndex with empty path or .priority key`)}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let n=this.extractChild(e.node),r=this.extractChild(t.node),i=n.compareTo(r);return i===0?Wu(e.name,t.name):i}makePost(e,t){let n=Q(e),r=Z.EMPTY_NODE.updateChild(this.indexPath_,n);return new Y(t,r)}maxPost(){let e=Z.EMPTY_NODE.updateChild(this.indexPath_,mp);return new Y(Uu,e)}toString(){return Sf(this.indexPath_,0).join(`/`)}},_p=new class extends Vf{compare(e,t){let n=e.node.compareTo(t.node);return n===0?Wu(e.name,t.name):n}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return Y.MIN}maxPost(){return Y.MAX}makePost(e,t){let n=Q(e);return new Y(t,n)}toString(){return`.value`}};
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function vp(e){return{type:`value`,snapshotNode:e}}function yp(e,t){return{type:`child_added`,snapshotNode:t,childName:e}}function bp(e,t){return{type:`child_removed`,snapshotNode:t,childName:e}}function xp(e,t,n){return{type:`child_changed`,snapshotNode:t,childName:e,oldSnap:n}}function Sp(e,t){return{type:`child_moved`,snapshotNode:t,childName:e}}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Cp=class{constructor(e){this.index_=e}updateChild(e,t,n,r,i,a){z(e.isIndexed(this.index_),`A node must be indexed if only a child is updated`);let o=e.getImmediateChild(t);return o.getChild(r).equals(n.getChild(r))&&o.isEmpty()===n.isEmpty()||(a!=null&&(n.isEmpty()?e.hasChild(t)?a.trackChildChange(bp(t,o)):z(e.isLeafNode(),`A child remove without an old child only makes sense on a leaf node`):o.isEmpty()?a.trackChildChange(yp(t,n)):a.trackChildChange(xp(t,n,o))),e.isLeafNode()&&n.isEmpty())?e:e.updateImmediateChild(t,n).withIndex(this.index_)}updateFullNode(e,t,n){return n!=null&&(e.isLeafNode()||e.forEachChild(X,(e,r)=>{t.hasChild(e)||n.trackChildChange(bp(e,r))}),t.isLeafNode()||t.forEachChild(X,(t,r)=>{if(e.hasChild(t)){let i=e.getImmediateChild(t);i.equals(r)||n.trackChildChange(xp(t,r,i))}else n.trackChildChange(yp(t,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?Z.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}},wp=class e{constructor(t){this.indexedFilter_=new Cp(t.getIndex()),this.index_=t.getIndex(),this.startPost_=e.getStartPost_(t),this.endPost_=e.getEndPost_(t),this.startIsInclusive_=!t.startAfterSet_,this.endIsInclusive_=!t.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,n=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&n}updateChild(e,t,n,r,i,a){return this.matches(new Y(t,n))||(n=Z.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,n,r,i,a)}updateFullNode(e,t,n){t.isLeafNode()&&(t=Z.EMPTY_NODE);let r=t.withIndex(this.index_);r=r.updatePriority(Z.EMPTY_NODE);let i=this;return t.forEachChild(X,(e,t)=>{i.matches(new Y(e,t))||(r=r.updateImmediateChild(e,Z.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,r,n)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}},Tp=class{constructor(e){this.withinDirectionalStart=e=>this.reverse_?this.withinEndPost(e):this.withinStartPost(e),this.withinDirectionalEnd=e=>this.reverse_?this.withinStartPost(e):this.withinEndPost(e),this.withinStartPost=e=>{let t=this.index_.compare(this.rangedFilter_.getStartPost(),e);return this.startIsInclusive_?t<=0:t<0},this.withinEndPost=e=>{let t=this.index_.compare(e,this.rangedFilter_.getEndPost());return this.endIsInclusive_?t<=0:t<0},this.rangedFilter_=new wp(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,n,r,i,a){return this.rangedFilter_.matches(new Y(t,n))||(n=Z.EMPTY_NODE),e.getImmediateChild(t).equals(n)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,n,r,i,a):this.fullLimitUpdateChild_(e,t,n,i,a)}updateFullNode(e,t,n){let r;if(t.isLeafNode()||t.isEmpty())r=Z.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){r=Z.EMPTY_NODE.withIndex(this.index_);let e;e=this.reverse_?t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let n=0;for(;e.hasNext()&&n<this.limit_;){let t=e.getNext();if(this.withinDirectionalStart(t))if(this.withinDirectionalEnd(t))r=r.updateImmediateChild(t.name,t.node),n++;else break;else continue}}else{r=t.withIndex(this.index_),r=r.updatePriority(Z.EMPTY_NODE);let e;e=this.reverse_?r.getReverseIterator(this.index_):r.getIterator(this.index_);let n=0;for(;e.hasNext();){let t=e.getNext();n<this.limit_&&this.withinDirectionalStart(t)&&this.withinDirectionalEnd(t)?n++:r=r.updateImmediateChild(t.name,Z.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,r,n)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,n,r,i){let a;if(this.reverse_){let e=this.index_.getCompare();a=(t,n)=>e(n,t)}else a=this.index_.getCompare();let o=e;z(o.numChildren()===this.limit_,``);let s=new Y(t,n),c=this.reverse_?o.getFirstChild(this.index_):o.getLastChild(this.index_),l=this.rangedFilter_.matches(s);if(o.hasChild(t)){let e=o.getImmediateChild(t),u=r.getChildAfterChild(this.index_,c,this.reverse_);for(;u!=null&&(u.name===t||o.hasChild(u.name));)u=r.getChildAfterChild(this.index_,u,this.reverse_);let d=u==null?1:a(u,s);if(l&&!n.isEmpty()&&d>=0)return i?.trackChildChange(xp(t,n,e)),o.updateImmediateChild(t,n);{i?.trackChildChange(bp(t,e));let n=o.updateImmediateChild(t,Z.EMPTY_NODE);return u!=null&&this.rangedFilter_.matches(u)?(i?.trackChildChange(yp(u.name,u.node)),n.updateImmediateChild(u.name,u.node)):n}}else if(n.isEmpty())return e;else if(l)return a(c,s)>=0?(i!=null&&(i.trackChildChange(bp(c.name,c.node)),i.trackChildChange(yp(t,n))),o.updateImmediateChild(t,n).updateImmediateChild(c.name,Z.EMPTY_NODE)):e;else return e}},Ep=class e{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_=``,this.indexStartValue_=null,this.indexStartName_=``,this.indexEndValue_=null,this.indexEndName_=``,this.index_=X}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===``?this.startSet_:this.viewFrom_===`l`}getIndexStartValue(){return z(this.startSet_,`Only valid if start has been set`),this.indexStartValue_}getIndexStartName(){return z(this.startSet_,`Only valid if start has been set`),this.startNameSet_?this.indexStartName_:Hu}hasEnd(){return this.endSet_}getIndexEndValue(){return z(this.endSet_,`Only valid if end has been set`),this.indexEndValue_}getIndexEndName(){return z(this.endSet_,`Only valid if end has been set`),this.endNameSet_?this.indexEndName_:Uu}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==``}getLimit(){return z(this.limitSet_,`Only valid if limit has been set`),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===X}copy(){let t=new e;return t.limitSet_=this.limitSet_,t.limit_=this.limit_,t.startSet_=this.startSet_,t.startAfterSet_=this.startAfterSet_,t.indexStartValue_=this.indexStartValue_,t.startNameSet_=this.startNameSet_,t.indexStartName_=this.indexStartName_,t.endSet_=this.endSet_,t.endBeforeSet_=this.endBeforeSet_,t.indexEndValue_=this.indexEndValue_,t.endNameSet_=this.endNameSet_,t.indexEndName_=this.indexEndName_,t.index_=this.index_,t.viewFrom_=this.viewFrom_,t}};function Dp(e){return e.loadsAllData()?new Cp(e.getIndex()):e.hasLimit()?new Tp(e):new wp(e)}function Op(e){let t={};if(e.isDefault())return t;let n;if(e.index_===X?n=`$priority`:e.index_===_p?n=`$value`:e.index_===Wf?n=`$key`:(z(e.index_ instanceof gp,`Unrecognized index type!`),n=e.index_.toString()),t.orderBy=B(n),e.startSet_){let n=e.startAfterSet_?`startAfter`:`startAt`;t[n]=B(e.indexStartValue_),e.startNameSet_&&(t[n]+=`,`+B(e.indexStartName_))}if(e.endSet_){let n=e.endBeforeSet_?`endBefore`:`endAt`;t[n]=B(e.indexEndValue_),e.endNameSet_&&(t[n]+=`,`+B(e.indexEndName_))}return e.limitSet_&&(e.isViewFromLeft()?t.limitToFirst=e.limit_:t.limitToLast=e.limit_),t}function kp(e){let t={};if(e.startSet_&&(t.sp=e.indexStartValue_,e.startNameSet_&&(t.sn=e.indexStartName_),t.sin=!e.startAfterSet_),e.endSet_&&(t.ep=e.indexEndValue_,e.endNameSet_&&(t.en=e.indexEndName_),t.ein=!e.endBeforeSet_),e.limitSet_){t.l=e.limit_;let n=e.viewFrom_;n===``&&(n=e.isViewFromLeft()?`l`:`r`),t.vf=n}return e.index_!==X&&(t.i=e.index_.toString()),t}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Ap=class e extends mf{reportStats(e){throw Error(`Method not implemented.`)}static getListenId_(e,t){return t===void 0?(z(e._queryParams.isDefault(),`should have a tag if it's not a default query.`),e._path.toString()):`tag$`+t}constructor(e,t,n,r){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=n,this.appCheckTokenProvider_=r,this.log_=Fu(`p:rest:`),this.listens_={}}listen(t,n,r,i){let a=t._path.toString();this.log_(`Listen called for `+a+` `+t._queryIdentifier);let o=e.getListenId_(t,r),s={};this.listens_[o]=s;let c=Op(t._queryParams);this.restRequest_(a+`.json`,c,(e,t)=>{let n=t;if(e===404&&(n=null,e=null),e===null&&this.onDataUpdate_(a,n,!1,r),_c(this.listens_,o)===s){let t;t=e?e===401?`permission_denied`:`rest_error:`+e:`ok`,i(t,null)}})}unlisten(t,n){let r=e.getListenId_(t,n);delete this.listens_[r]}get(e){let t=Op(e._queryParams),n=e._path.toString(),r=new Ks;return this.restRequest_(n+`.json`,t,(e,t)=>{let i=t;e===404&&(i=null,e=null),e===null?(this.onDataUpdate_(n,i,!1,null),r.resolve(i)):r.reject(Error(i))}),r.promise}refreshAuthToken(e){}restRequest_(e,t={},n){return t.format=`export`,Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([r,i])=>{r&&r.accessToken&&(t.auth=r.accessToken),i&&i.token&&(t.ac=i.token);let a=(this.repoInfo_.secure?`https://`:`http://`)+this.repoInfo_.host+e+`?ns=`+this.repoInfo_.namespace+Sc(t);this.log_(`Sending REST request for `+a);let o=new XMLHttpRequest;o.onreadystatechange=()=>{if(n&&o.readyState===4){this.log_(`REST Response for `+a+` received. status:`,o.status,`response:`,o.responseText);let e=null;if(o.status>=200&&o.status<300){try{e=fc(o.responseText)}catch{Ru(`Failed to parse JSON response for `+a+`: `+o.responseText)}n(null,e)}else o.status!==401&&o.status!==404&&Ru(`Got unsuccessful REST response for `+a+` Status: `+o.status),n(o.status);n=null}},o.open(`GET`,a,!0),o.send()})}},jp=class{constructor(){this.rootNode_=Z.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function Mp(){return{value:null,children:new Map}}function Np(e,t,n){if(J(t))e.value=n,e.children.clear();else if(e.value!==null)e.value=e.value.updateChild(t,n);else{let r=G(t);e.children.has(r)||e.children.set(r,Mp());let i=e.children.get(r);t=K(t),Np(i,t,n)}}function Pp(e,t,n){e.value===null?Fp(e,(e,r)=>{let i=new U(t.toString()+`/`+e);Pp(r,i,n)}):n(t,e.value)}function Fp(e,t){e.children.forEach((e,n)=>{t(n,e)})}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Ip=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t={...e};return this.last_&&Yu(this.last_,(e,n)=>{t[e]=t[e]-n}),this.last_=e,t}},Lp=10*1e3,Rp=30*1e3,zp=300*1e3,Bp=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new Ip(e);let n=Lp+(Rp-Lp)*Math.random();od(this.reportStats_.bind(this),Math.floor(n))}reportStats_(){let e=this.statsListener_.get(),t={},n=!1;Yu(e,(e,r)=>{r>0&&gc(this.statsToReport_,e)&&(t[e]=r,n=!0)}),n&&this.server_.reportStats(t),od(this.reportStats_.bind(this),Math.floor(Math.random()*2*zp))}},Vp;(function(e){e[e.OVERWRITE=0]=`OVERWRITE`,e[e.MERGE=1]=`MERGE`,e[e.ACK_USER_WRITE=2]=`ACK_USER_WRITE`,e[e.LISTEN_COMPLETE=3]=`LISTEN_COMPLETE`})(Vp||={});function Hp(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function Up(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function Wp(e){return{fromUser:!1,fromServer:!0,queryId:e,tagged:!0}}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Gp=class e{constructor(e,t,n){this.path=e,this.affectedTree=t,this.revert=n,this.type=Vp.ACK_USER_WRITE,this.source=Hp()}operationForChild(t){if(J(this.path)){if(this.affectedTree.value!=null)return z(this.affectedTree.children.isEmpty(),`affectedTree should not have overlapping affected paths.`),this;{let n=this.affectedTree.subtree(new U(t));return new e(W(),n,this.revert)}}else return z(G(this.path)===t,`operationForChild called for unrelated child.`),new e(K(this.path),this.affectedTree,this.revert)}},Kp=class e{constructor(e,t){this.source=e,this.path=t,this.type=Vp.LISTEN_COMPLETE}operationForChild(t){return J(this.path)?new e(this.source,W()):new e(this.source,K(this.path))}},qp=class e{constructor(e,t,n){this.source=e,this.path=t,this.snap=n,this.type=Vp.OVERWRITE}operationForChild(t){return J(this.path)?new e(this.source,W(),this.snap.getImmediateChild(t)):new e(this.source,K(this.path),this.snap)}},Jp=class e{constructor(e,t,n){this.source=e,this.path=t,this.children=n,this.type=Vp.MERGE}operationForChild(t){if(J(this.path)){let n=this.children.subtree(new U(t));return n.isEmpty()?null:n.value?new qp(this.source,W(),n.value):new e(this.source,W(),n)}else return z(G(this.path)===t,`Can't get a merge for a child not on the path of the operation`),new e(this.source,K(this.path),this.children)}toString(){return`Operation(`+this.path+`: `+this.source.toString()+` merge: `+this.children.toString()+`)`}},Yp=class{constructor(e,t,n){this.node_=e,this.fullyInitialized_=t,this.filtered_=n}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(J(e))return this.isFullyInitialized()&&!this.filtered_;let t=G(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}},Xp=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function Zp(e,t,n,r){let i=[],a=[];return t.forEach(t=>{t.type===`child_changed`&&e.index_.indexedValueChanged(t.oldSnap,t.snapshotNode)&&a.push(Sp(t.childName,t.snapshotNode))}),Qp(e,i,`child_removed`,t,r,n),Qp(e,i,`child_added`,t,r,n),Qp(e,i,`child_moved`,a,r,n),Qp(e,i,`child_changed`,t,r,n),Qp(e,i,`value`,t,r,n),i}function Qp(e,t,n,r,i,a){let o=r.filter(e=>e.type===n);o.sort((t,n)=>em(e,t,n)),o.forEach(n=>{let r=$p(e,n,a);i.forEach(i=>{i.respondsTo(n.type)&&t.push(i.createEvent(r,e.query_))})})}function $p(e,t,n){return t.type===`value`||t.type===`child_removed`||(t.prevName=n.getPredecessorChildName(t.childName,t.snapshotNode,e.index_)),t}function em(e,t,n){if(t.childName==null||n.childName==null)throw Ds(`Should only compare child_ events.`);let r=new Y(t.childName,t.snapshotNode),i=new Y(n.childName,n.snapshotNode);return e.index_.compare(r,i)}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function tm(e,t){return{eventCache:e,serverCache:t}}function nm(e,t,n,r){return tm(new Yp(t,n,r),e.serverCache)}function rm(e,t,n,r){return tm(e.eventCache,new Yp(t,n,r))}function im(e){return e.eventCache.isFullyInitialized()?e.eventCache.getNode():null}function am(e){return e.serverCache.isFullyInitialized()?e.serverCache.getNode():null}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var om,sm=()=>(om||=new Jf(Gu),om),cm=class e{static fromObject(t){let n=new e(null);return Yu(t,(e,t)=>{n=n.set(new U(e),t)}),n}constructor(e,t=sm()){this.value=e,this.children=t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:W(),value:this.value};if(J(e))return null;{let n=G(e),r=this.children.get(n);if(r!==null){let i=r.findRootMostMatchingPathAndValue(K(e),t);return i==null?null:{path:q(new U(n),i.path),value:i.value}}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(t){if(J(t))return this;{let n=G(t),r=this.children.get(n);return r===null?new e(null):r.subtree(K(t))}}set(t,n){if(J(t))return new e(n,this.children);{let r=G(t),i=(this.children.get(r)||new e(null)).set(K(t),n),a=this.children.insert(r,i);return new e(this.value,a)}}remove(t){if(J(t))return this.children.isEmpty()?new e(null):new e(null,this.children);{let n=G(t),r=this.children.get(n);if(r){let i=r.remove(K(t)),a;return a=i.isEmpty()?this.children.remove(n):this.children.insert(n,i),this.value===null&&a.isEmpty()?new e(null):new e(this.value,a)}else return this}}get(e){if(J(e))return this.value;{let t=G(e),n=this.children.get(t);return n?n.get(K(e)):null}}setTree(t,n){if(J(t))return n;{let r=G(t),i=(this.children.get(r)||new e(null)).setTree(K(t),n),a;return a=i.isEmpty()?this.children.remove(r):this.children.insert(r,i),new e(this.value,a)}}fold(e){return this.fold_(W(),e)}fold_(e,t){let n={};return this.children.inorderTraversal((r,i)=>{n[r]=i.fold_(q(e,r),t)}),t(e,this.value,n)}findOnPath(e,t){return this.findOnPath_(e,W(),t)}findOnPath_(e,t,n){let r=this.value?n(t,this.value):!1;if(r)return r;if(J(e))return null;{let r=G(e),i=this.children.get(r);return i?i.findOnPath_(K(e),q(t,r),n):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,W(),t)}foreachOnPath_(t,n,r){if(J(t))return this;{this.value&&r(n,this.value);let i=G(t),a=this.children.get(i);return a?a.foreachOnPath_(K(t),q(n,i),r):new e(null)}}foreach(e){this.foreach_(W(),e)}foreach_(e,t){this.children.inorderTraversal((n,r)=>{r.foreach_(q(e,n),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,n)=>{n.value&&e(t,n.value)})}},lm=class e{constructor(e){this.writeTree_=e}static empty(){return new e(new cm(null))}};function um(e,t,n){if(J(t))return new lm(new cm(n));{let r=e.writeTree_.findRootMostValueAndPath(t);if(r!=null){let i=r.path,a=r.value,o=wf(i,t);return a=a.updateChild(o,n),new lm(e.writeTree_.set(i,a))}else{let r=new cm(n),i=e.writeTree_.setTree(t,r);return new lm(i)}}}function dm(e,t,n){let r=e;return Yu(n,(e,n)=>{r=um(r,q(t,e),n)}),r}function fm(e,t){if(J(t))return lm.empty();{let n=e.writeTree_.setTree(t,new cm(null));return new lm(n)}}function pm(e,t){return mm(e,t)!=null}function mm(e,t){let n=e.writeTree_.findRootMostValueAndPath(t);return n==null?null:e.writeTree_.get(n.path).getChild(wf(n.path,t))}function hm(e){let t=[],n=e.writeTree_.value;return n==null?e.writeTree_.children.inorderTraversal((e,n)=>{n.value!=null&&t.push(new Y(e,n.value))}):n.isLeafNode()||n.forEachChild(X,(e,n)=>{t.push(new Y(e,n))}),t}function gm(e,t){if(J(t))return e;{let n=mm(e,t);return n==null?new lm(e.writeTree_.subtree(t)):new lm(new cm(n))}}function _m(e){return e.writeTree_.isEmpty()}function vm(e,t){return ym(W(),e.writeTree_,t)}function ym(e,t,n){if(t.value!=null)return n.updateChild(e,t.value);{let r=null;return t.children.inorderTraversal((t,i)=>{t===`.priority`?(z(i.value!==null,`Priority writes must always be leaf nodes`),r=i.value):n=ym(q(e,t),i,n)}),!n.getChild(e).isEmpty()&&r!==null&&(n=n.updateChild(q(e,`.priority`),r)),n}}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function bm(e,t){return Hm(t,e)}function xm(e,t,n,r,i){z(r>e.lastWriteId,`Stacking an older write on top of newer ones`),i===void 0&&(i=!0),e.allWrites.push({path:t,snap:n,writeId:r,visible:i}),i&&(e.visibleWrites=um(e.visibleWrites,t,n)),e.lastWriteId=r}function Sm(e,t){for(let n=0;n<e.allWrites.length;n++){let r=e.allWrites[n];if(r.writeId===t)return r}return null}function Cm(e,t){let n=e.allWrites.findIndex(e=>e.writeId===t);z(n>=0,`removeWrite called with nonexistent writeId.`);let r=e.allWrites[n];e.allWrites.splice(n,1);let i=r.visible,a=!1,o=e.allWrites.length-1;for(;i&&o>=0;){let t=e.allWrites[o];t.visible&&(o>=n&&wm(t,r.path)?i=!1:Ef(r.path,t.path)&&(a=!0)),o--}if(i){if(a)return Tm(e),!0;if(r.snap)e.visibleWrites=fm(e.visibleWrites,r.path);else{let t=r.children;Yu(t,t=>{e.visibleWrites=fm(e.visibleWrites,q(r.path,t))})}return!0}else return!1}function wm(e,t){if(e.snap)return Ef(e.path,t);for(let n in e.children)if(e.children.hasOwnProperty(n)&&Ef(q(e.path,n),t))return!0;return!1}function Tm(e){e.visibleWrites=Dm(e.allWrites,Em,W()),e.allWrites.length>0?e.lastWriteId=e.allWrites[e.allWrites.length-1].writeId:e.lastWriteId=-1}function Em(e){return e.visible}function Dm(e,t,n){let r=lm.empty();for(let i=0;i<e.length;++i){let a=e[i];if(t(a)){let e=a.path,t;if(a.snap)Ef(n,e)?(t=wf(n,e),r=um(r,t,a.snap)):Ef(e,n)&&(t=wf(e,n),r=um(r,W(),a.snap.getChild(t)));else if(a.children){if(Ef(n,e))t=wf(n,e),r=dm(r,t,a.children);else if(Ef(e,n))if(t=wf(e,n),J(t))r=dm(r,W(),a.children);else{let e=_c(a.children,G(t));if(e){let n=e.getChild(K(t));r=um(r,W(),n)}}}else throw Ds(`WriteRecord should have .snap or .children`)}}return r}function Om(e,t,n,r,i){if(!r&&!i){let r=mm(e.visibleWrites,t);if(r!=null)return r;{let r=gm(e.visibleWrites,t);if(_m(r))return n;if(n==null&&!pm(r,W()))return null;{let e=n||Z.EMPTY_NODE;return vm(r,e)}}}else{let a=gm(e.visibleWrites,t);if(!i&&_m(a))return n;if(!i&&n==null&&!pm(a,W()))return null;{let a=Dm(e.allWrites,function(e){return(e.visible||i)&&(!r||!~r.indexOf(e.writeId))&&(Ef(e.path,t)||Ef(t,e.path))},t),o=n||Z.EMPTY_NODE;return vm(a,o)}}}function km(e,t,n){let r=Z.EMPTY_NODE,i=mm(e.visibleWrites,t);if(i)return i.isLeafNode()||i.forEachChild(X,(e,t)=>{r=r.updateImmediateChild(e,t)}),r;if(n){let i=gm(e.visibleWrites,t);return n.forEachChild(X,(e,t)=>{let n=vm(gm(i,new U(e)),t);r=r.updateImmediateChild(e,n)}),hm(i).forEach(e=>{r=r.updateImmediateChild(e.name,e.node)}),r}else{let n=gm(e.visibleWrites,t);return hm(n).forEach(e=>{r=r.updateImmediateChild(e.name,e.node)}),r}}function Am(e,t,n,r,i){z(r||i,`Either existingEventSnap or existingServerSnap must exist`);let a=q(t,n);if(pm(e.visibleWrites,a))return null;{let t=gm(e.visibleWrites,a);return _m(t)?i.getChild(n):vm(t,i.getChild(n))}}function jm(e,t,n,r){let i=q(t,n),a=mm(e.visibleWrites,i);if(a!=null)return a;if(r.isCompleteForChild(n)){let t=gm(e.visibleWrites,i);return vm(t,r.getNode().getImmediateChild(n))}else return null}function Mm(e,t){return mm(e.visibleWrites,t)}function Nm(e,t,n,r,i,a,o){let s,c=gm(e.visibleWrites,t),l=mm(c,W());if(l!=null)s=l;else if(n!=null)s=vm(c,n);else return[];if(s=s.withIndex(o),!s.isEmpty()&&!s.isLeafNode()){let e=[],t=o.getCompare(),n=a?s.getReverseIteratorFrom(r,o):s.getIteratorFrom(r,o),c=n.getNext();for(;c&&e.length<i;)t(c,r)!==0&&e.push(c),c=n.getNext();return e}else return[]}function Pm(){return{visibleWrites:lm.empty(),allWrites:[],lastWriteId:-1}}function Fm(e,t,n,r){return Om(e.writeTree,e.treePath,t,n,r)}function Im(e,t){return km(e.writeTree,e.treePath,t)}function Lm(e,t,n,r){return Am(e.writeTree,e.treePath,t,n,r)}function Rm(e,t){return Mm(e.writeTree,q(e.treePath,t))}function zm(e,t,n,r,i,a){return Nm(e.writeTree,e.treePath,t,n,r,i,a)}function Bm(e,t,n){return jm(e.writeTree,e.treePath,t,n)}function Vm(e,t){return Hm(q(e.treePath,t),e.writeTree)}function Hm(e,t){return{treePath:e,writeTree:t}}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Um=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,n=e.childName;z(t===`child_added`||t===`child_changed`||t===`child_removed`,`Only child changes supported for tracking`),z(n!==`.priority`,`Only non-priority child changes can be tracked.`);let r=this.changeMap.get(n);if(r){let i=r.type;if(t===`child_added`&&i===`child_removed`)this.changeMap.set(n,xp(n,e.snapshotNode,r.snapshotNode));else if(t===`child_removed`&&i===`child_added`)this.changeMap.delete(n);else if(t===`child_removed`&&i===`child_changed`)this.changeMap.set(n,bp(n,r.oldSnap));else if(t===`child_changed`&&i===`child_added`)this.changeMap.set(n,yp(n,e.snapshotNode));else if(t===`child_changed`&&i===`child_changed`)this.changeMap.set(n,xp(n,e.snapshotNode,r.oldSnap));else throw Ds(`Illegal combination of changes: `+e+` occurred after `+r)}else this.changeMap.set(n,e)}getChanges(){return Array.from(this.changeMap.values())}},Wm=new class{getCompleteChild(e){return null}getChildAfterChild(e,t,n){return null}},Gm=class{constructor(e,t,n=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=n}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let t=this.optCompleteServerCache_==null?this.viewCache_.serverCache:new Yp(this.optCompleteServerCache_,!0,!1);return Bm(this.writes_,e,t)}}getChildAfterChild(e,t,n){let r=this.optCompleteServerCache_==null?am(this.viewCache_):this.optCompleteServerCache_,i=zm(this.writes_,r,t,1,n,e);return i.length===0?null:i[0]}};
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function Km(e){return{filter:e}}function qm(e,t){z(t.eventCache.getNode().isIndexed(e.filter.getIndex()),`Event snap not indexed`),z(t.serverCache.getNode().isIndexed(e.filter.getIndex()),`Server snap not indexed`)}function Jm(e,t,n,r,i){let a=new Um,o,s;if(n.type===Vp.OVERWRITE){let c=n;c.source.fromUser?o=Qm(e,t,c.path,c.snap,r,i,a):(z(c.source.fromServer,`Unknown source.`),s=c.source.tagged||t.serverCache.isFiltered()&&!J(c.path),o=Zm(e,t,c.path,c.snap,r,i,s,a))}else if(n.type===Vp.MERGE){let c=n;c.source.fromUser?o=eh(e,t,c.path,c.children,r,i,a):(z(c.source.fromServer,`Unknown source.`),s=c.source.tagged||t.serverCache.isFiltered(),o=nh(e,t,c.path,c.children,r,i,s,a))}else if(n.type===Vp.ACK_USER_WRITE){let s=n;o=s.revert?ah(e,t,s.path,r,i,a):rh(e,t,s.path,s.affectedTree,r,i,a)}else if(n.type===Vp.LISTEN_COMPLETE)o=ih(e,t,n.path,r,a);else throw Ds(`Unknown operation type: `+n.type);let c=a.getChanges();return Ym(t,o,c),{viewCache:o,changes:c}}function Ym(e,t,n){let r=t.eventCache;if(r.isFullyInitialized()){let i=r.getNode().isLeafNode()||r.getNode().isEmpty(),a=im(e);(n.length>0||!e.eventCache.isFullyInitialized()||i&&!r.getNode().equals(a)||!r.getNode().getPriority().equals(a.getPriority()))&&n.push(vp(im(t)))}}function Xm(e,t,n,r,i,a){let o=t.eventCache;if(Rm(r,n)!=null)return t;{let s,c;if(J(n))if(z(t.serverCache.isFullyInitialized(),`If change path is empty, we must have complete server data`),t.serverCache.isFiltered()){let n=am(t),i=n instanceof Z?n:Z.EMPTY_NODE,o=Im(r,i);s=e.filter.updateFullNode(t.eventCache.getNode(),o,a)}else{let n=Fm(r,am(t));s=e.filter.updateFullNode(t.eventCache.getNode(),n,a)}else{let l=G(n);if(l===`.priority`){z(yf(n)===1,`Can't have a priority with additional path components`);let i=o.getNode();c=t.serverCache.getNode();let a=Lm(r,n,i,c);s=a==null?o.getNode():e.filter.updatePriority(i,a)}else{let u=K(n),d;if(o.isCompleteForChild(l)){c=t.serverCache.getNode();let e=Lm(r,n,o.getNode(),c);d=e==null?o.getNode().getImmediateChild(l):o.getNode().getImmediateChild(l).updateChild(u,e)}else d=Bm(r,l,t.serverCache);s=d==null?o.getNode():e.filter.updateChild(o.getNode(),l,d,u,i,a)}}return nm(t,s,o.isFullyInitialized()||J(n),e.filter.filtersNodes())}}function Zm(e,t,n,r,i,a,o,s){let c=t.serverCache,l,u=o?e.filter:e.filter.getIndexedFilter();if(J(n))l=u.updateFullNode(c.getNode(),r,null);else if(u.filtersNodes()&&!c.isFiltered()){let e=c.getNode().updateChild(n,r);l=u.updateFullNode(c.getNode(),e,null)}else{let e=G(n);if(!c.isCompleteForPath(n)&&yf(n)>1)return t;let i=K(n),a=c.getNode().getImmediateChild(e).updateChild(i,r);l=e===`.priority`?u.updatePriority(c.getNode(),a):u.updateChild(c.getNode(),e,a,i,Wm,null)}let d=rm(t,l,c.isFullyInitialized()||J(n),u.filtersNodes()),f=new Gm(i,d,a);return Xm(e,d,n,i,f,s)}function Qm(e,t,n,r,i,a,o){let s=t.eventCache,c,l,u=new Gm(i,t,a);if(J(n))l=e.filter.updateFullNode(t.eventCache.getNode(),r,o),c=nm(t,l,!0,e.filter.filtersNodes());else{let i=G(n);if(i===`.priority`)l=e.filter.updatePriority(t.eventCache.getNode(),r),c=nm(t,l,s.isFullyInitialized(),s.isFiltered());else{let a=K(n),l=s.getNode().getImmediateChild(i),d;if(J(a))d=r;else{let e=u.getCompleteChild(i);d=e==null?Z.EMPTY_NODE:bf(a)===`.priority`&&e.getChild(Cf(a)).isEmpty()?e:e.updateChild(a,r)}if(l.equals(d))c=t;else{let n=e.filter.updateChild(s.getNode(),i,d,a,u,o);c=nm(t,n,s.isFullyInitialized(),e.filter.filtersNodes())}}}return c}function $m(e,t){return e.eventCache.isCompleteForChild(t)}function eh(e,t,n,r,i,a,o){let s=t;return r.foreach((r,c)=>{let l=q(n,r);$m(t,G(l))&&(s=Qm(e,s,l,c,i,a,o))}),r.foreach((r,c)=>{let l=q(n,r);$m(t,G(l))||(s=Qm(e,s,l,c,i,a,o))}),s}function th(e,t,n){return n.foreach((e,n)=>{t=t.updateChild(e,n)}),t}function nh(e,t,n,r,i,a,o,s){if(t.serverCache.getNode().isEmpty()&&!t.serverCache.isFullyInitialized())return t;let c=t,l;l=J(n)?r:new cm(null).setTree(n,r);let u=t.serverCache.getNode();return l.children.inorderTraversal((n,r)=>{if(u.hasChild(n)){let l=t.serverCache.getNode().getImmediateChild(n),u=th(e,l,r);c=Zm(e,c,new U(n),u,i,a,o,s)}}),l.children.inorderTraversal((n,r)=>{let l=!t.serverCache.isCompleteForChild(n)&&r.value===null;if(!u.hasChild(n)&&!l){let l=t.serverCache.getNode().getImmediateChild(n),u=th(e,l,r);c=Zm(e,c,new U(n),u,i,a,o,s)}}),c}function rh(e,t,n,r,i,a,o){if(Rm(i,n)!=null)return t;let s=t.serverCache.isFiltered(),c=t.serverCache;if(r.value!=null){if(J(n)&&c.isFullyInitialized()||c.isCompleteForPath(n))return Zm(e,t,n,c.getNode().getChild(n),i,a,s,o);if(J(n)){let r=new cm(null);return c.getNode().forEachChild(Wf,(e,t)=>{r=r.set(new U(e),t)}),nh(e,t,n,r,i,a,s,o)}else return t}else{let l=new cm(null);return r.foreach((e,t)=>{let r=q(n,e);c.isCompleteForPath(r)&&(l=l.set(e,c.getNode().getChild(r)))}),nh(e,t,n,l,i,a,s,o)}}function ih(e,t,n,r,i){let a=t.serverCache,o=rm(t,a.getNode(),a.isFullyInitialized()||J(n),a.isFiltered());return Xm(e,o,n,r,Wm,i)}function ah(e,t,n,r,i,a){let o;if(Rm(r,n)!=null)return t;{let s=new Gm(r,t,i),c=t.eventCache.getNode(),l;if(J(n)||G(n)===`.priority`){let n;if(t.serverCache.isFullyInitialized())n=Fm(r,am(t));else{let e=t.serverCache.getNode();z(e instanceof Z,`serverChildren would be complete if leaf node`),n=Im(r,e)}n=n,l=e.filter.updateFullNode(c,n,a)}else{let i=G(n),u=Bm(r,i,t.serverCache);u==null&&t.serverCache.isCompleteForChild(i)&&(u=c.getImmediateChild(i)),l=u==null?t.eventCache.getNode().hasChild(i)?e.filter.updateChild(c,i,Z.EMPTY_NODE,K(n),s,a):c:e.filter.updateChild(c,i,u,K(n),s,a),l.isEmpty()&&t.serverCache.isFullyInitialized()&&(o=Fm(r,am(t)),o.isLeafNode()&&(l=e.filter.updateFullNode(l,o,a)))}return o=t.serverCache.isFullyInitialized()||Rm(r,W())!=null,nm(t,l,o,e.filter.filtersNodes())}}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var oh=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let n=this.query_._queryParams,r=new Cp(n.getIndex()),i=Dp(n);this.processor_=Km(i);let a=t.serverCache,o=t.eventCache,s=r.updateFullNode(Z.EMPTY_NODE,a.getNode(),null),c=i.updateFullNode(Z.EMPTY_NODE,o.getNode(),null),l=new Yp(s,a.isFullyInitialized(),r.filtersNodes()),u=new Yp(c,o.isFullyInitialized(),i.filtersNodes());this.viewCache_=tm(u,l),this.eventGenerator_=new Xp(this.query_)}get query(){return this.query_}};function sh(e){return e.viewCache_.serverCache.getNode()}function ch(e){return im(e.viewCache_)}function lh(e,t){let n=am(e.viewCache_);return n&&(e.query._queryParams.loadsAllData()||!J(t)&&!n.getImmediateChild(G(t)).isEmpty())?n.getChild(t):null}function uh(e){return e.eventRegistrations_.length===0}function dh(e,t){e.eventRegistrations_.push(t)}function fh(e,t,n){let r=[];if(n){z(t==null,`A cancel should cancel all event registrations.`);let i=e.query._path;e.eventRegistrations_.forEach(e=>{let t=e.createCancelEvent(n,i);t&&r.push(t)})}if(t){let n=[];for(let r=0;r<e.eventRegistrations_.length;++r){let i=e.eventRegistrations_[r];if(!i.matches(t))n.push(i);else if(t.hasAnyCallback()){n=n.concat(e.eventRegistrations_.slice(r+1));break}}e.eventRegistrations_=n}else e.eventRegistrations_=[];return r}function ph(e,t,n,r){t.type===Vp.MERGE&&t.source.queryId!==null&&(z(am(e.viewCache_),`We should always have a full cache before handling merges`),z(im(e.viewCache_),`Missing event cache, even though we have a server cache`));let i=e.viewCache_,a=Jm(e.processor_,i,t,n,r);return qm(e.processor_,a.viewCache),z(a.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),`Once a server snap is complete, it should never go back`),e.viewCache_=a.viewCache,hh(e,a.changes,a.viewCache.eventCache.getNode(),null)}function mh(e,t){let n=e.viewCache_.eventCache,r=[];return n.getNode().isLeafNode()||n.getNode().forEachChild(X,(e,t)=>{r.push(yp(e,t))}),n.isFullyInitialized()&&r.push(vp(n.getNode())),hh(e,r,n.getNode(),t)}function hh(e,t,n,r){let i=r?[r]:e.eventRegistrations_;return Zp(e.eventGenerator_,t,n,i)}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var gh,_h=class{constructor(){this.views=new Map}};function vh(e){z(!gh,`__referenceConstructor has already been defined`),gh=e}function yh(){return z(gh,`Reference.ts has not been loaded`),gh}function bh(e){return e.views.size===0}function xh(e,t,n,r){let i=t.source.queryId;if(i!==null){let a=e.views.get(i);return z(a!=null,`SyncTree gave us an op for an invalid query.`),ph(a,t,n,r)}else{let i=[];for(let a of e.views.values())i=i.concat(ph(a,t,n,r));return i}}function Sh(e,t,n,r,i){let a=t._queryIdentifier,o=e.views.get(a);if(!o){let e=Fm(n,i?r:null),a=!1;e?a=!0:r instanceof Z?(e=Im(n,r),a=!1):(e=Z.EMPTY_NODE,a=!1);let o=tm(new Yp(e,a,!1),new Yp(r,i,!1));return new oh(t,o)}return o}function Ch(e,t,n,r,i,a){let o=Sh(e,t,r,i,a);return e.views.has(t._queryIdentifier)||e.views.set(t._queryIdentifier,o),dh(o,n),mh(o,n)}function wh(e,t,n,r){let i=t._queryIdentifier,a=[],o=[],s=kh(e);if(i===`default`)for(let[t,i]of e.views.entries())o=o.concat(fh(i,n,r)),uh(i)&&(e.views.delete(t),i.query._queryParams.loadsAllData()||a.push(i.query));else{let t=e.views.get(i);t&&(o=o.concat(fh(t,n,r)),uh(t)&&(e.views.delete(i),t.query._queryParams.loadsAllData()||a.push(t.query)))}return s&&!kh(e)&&a.push(new(yh())(t._repo,t._path)),{removed:a,events:o}}function Th(e){let t=[];for(let n of e.views.values())n.query._queryParams.loadsAllData()||t.push(n);return t}function Eh(e,t){let n=null;for(let r of e.views.values())n||=lh(r,t);return n}function Dh(e,t){if(t._queryParams.loadsAllData())return Ah(e);{let n=t._queryIdentifier;return e.views.get(n)}}function Oh(e,t){return Dh(e,t)!=null}function kh(e){return Ah(e)!=null}function Ah(e){for(let t of e.views.values())if(t.query._queryParams.loadsAllData())return t;return null}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var jh;function Mh(e){z(!jh,`__referenceConstructor has already been defined`),jh=e}function Nh(){return z(jh,`Reference.ts has not been loaded`),jh}var Ph=1,Fh=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new cm(null),this.pendingWriteTree_=Pm(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function Ih(e,t,n,r,i){return xm(e.pendingWriteTree_,t,n,r,i),i?Jh(e,new qp(Hp(),t,n)):[]}function Lh(e,t,n=!1){let r=Sm(e.pendingWriteTree_,t);if(Cm(e.pendingWriteTree_,t)){let t=new cm(null);return r.snap==null?Yu(r.children,e=>{t=t.set(new U(e),!0)}):t=t.set(W(),!0),Jh(e,new Gp(r.path,t,n))}else return[]}function Rh(e,t,n){return Jh(e,new qp(Up(),t,n))}function zh(e,t,n){let r=cm.fromObject(n);return Jh(e,new Jp(Up(),t,r))}function Bh(e,t){return Jh(e,new Kp(Up(),t))}function Vh(e,t,n){let r=eg(e,n);if(r){let n=tg(r),i=n.path,a=n.queryId,o=wf(i,t),s=new Kp(Wp(a),o);return ng(e,i,s)}else return[]}function Hh(e,t,n,r,i=!1){let a=t._path,o=e.syncPointTree_.get(a),s=[];if(o&&(t._queryIdentifier===`default`||Oh(o,t))){let c=wh(o,t,n,r);bh(o)&&(e.syncPointTree_=e.syncPointTree_.remove(a));let l=c.removed;if(s=c.events,!i){let n=l.findIndex(e=>e._queryParams.loadsAllData())!==-1,i=e.syncPointTree_.findOnPath(a,(e,t)=>kh(t));if(n&&!i){let t=e.syncPointTree_.subtree(a);if(!t.isEmpty()){let n=rg(t);for(let t=0;t<n.length;++t){let r=n[t],i=r.query,a=Zh(e,r);e.listenProvider_.startListening(ig(i),Qh(e,i),a.hashFn,a.onComplete)}}}!i&&l.length>0&&!r&&(n?e.listenProvider_.stopListening(ig(t),null):l.forEach(t=>{let n=e.queryToTagMap.get($h(t));e.listenProvider_.stopListening(ig(t),n)}))}ag(e,l)}return s}function Uh(e,t,n,r){let i=eg(e,r);if(i!=null){let r=tg(i),a=r.path,o=r.queryId,s=wf(a,t),c=new qp(Wp(o),s,n);return ng(e,a,c)}else return[]}function Wh(e,t,n,r){let i=eg(e,r);if(i){let r=tg(i),a=r.path,o=r.queryId,s=wf(a,t),c=cm.fromObject(n),l=new Jp(Wp(o),s,c);return ng(e,a,l)}else return[]}function Gh(e,t,n,r=!1){let i=t._path,a=null,o=!1;e.syncPointTree_.foreachOnPath(i,(e,t)=>{let n=wf(e,i);a||=Eh(t,n),o||=kh(t)});let s=e.syncPointTree_.get(i);s?(o||=kh(s),a||=Eh(s,W())):(s=new _h,e.syncPointTree_=e.syncPointTree_.set(i,s));let c;a==null?(c=!1,a=Z.EMPTY_NODE,e.syncPointTree_.subtree(i).foreachChild((e,t)=>{let n=Eh(t,W());n&&(a=a.updateImmediateChild(e,n))})):c=!0;let l=Oh(s,t);if(!l&&!t._queryParams.loadsAllData()){let n=$h(t);z(!e.queryToTagMap.has(n),`View does not exist, but we have a tag`);let r=og();e.queryToTagMap.set(n,r),e.tagToQueryMap.set(r,n)}let u=bm(e.pendingWriteTree_,i),d=Ch(s,t,n,u,a,c);if(!l&&!o&&!r){let n=Dh(s,t);d=d.concat(sg(e,t,n))}return d}function Kh(e,t,n){let r=e.pendingWriteTree_,i=e.syncPointTree_.findOnPath(t,(e,n)=>{let r=wf(e,t),i=Eh(n,r);if(i)return i});return Om(r,t,i,n,!0)}function qh(e,t){let n=t._path,r=null;e.syncPointTree_.foreachOnPath(n,(e,t)=>{let i=wf(e,n);r||=Eh(t,i)});let i=e.syncPointTree_.get(n);i?r||=Eh(i,W()):(i=new _h,e.syncPointTree_=e.syncPointTree_.set(n,i));let a=r!=null,o=a?new Yp(r,!0,!1):null,s=bm(e.pendingWriteTree_,t._path),c=Sh(i,t,s,a?o.getNode():Z.EMPTY_NODE,a);return ch(c)}function Jh(e,t){return Yh(t,e.syncPointTree_,null,bm(e.pendingWriteTree_,W()))}function Yh(e,t,n,r){if(J(e.path))return Xh(e,t,n,r);{let i=t.get(W());n==null&&i!=null&&(n=Eh(i,W()));let a=[],o=G(e.path),s=e.operationForChild(o),c=t.children.get(o);if(c&&s){let e=n?n.getImmediateChild(o):null,t=Vm(r,o);a=a.concat(Yh(s,c,e,t))}return i&&(a=a.concat(xh(i,e,r,n))),a}}function Xh(e,t,n,r){let i=t.get(W());n==null&&i!=null&&(n=Eh(i,W()));let a=[];return t.children.inorderTraversal((t,i)=>{let o=n?n.getImmediateChild(t):null,s=Vm(r,t),c=e.operationForChild(t);c&&(a=a.concat(Xh(c,i,o,s)))}),i&&(a=a.concat(xh(i,e,r,n))),a}function Zh(e,t){let n=t.query,r=Qh(e,n);return{hashFn:()=>(sh(t)||Z.EMPTY_NODE).hash(),onComplete:t=>{if(t===`ok`)return r?Vh(e,n._path,r):Bh(e,n._path);{let r=$u(t,n);return Hh(e,n,null,r)}}}}function Qh(e,t){let n=$h(t);return e.queryToTagMap.get(n)}function $h(e){return e._path.toString()+`$`+e._queryIdentifier}function eg(e,t){return e.tagToQueryMap.get(t)}function tg(e){let t=e.indexOf(`$`);return z(t!==-1&&t<e.length-1,`Bad queryKey.`),{queryId:e.substr(t+1),path:new U(e.substr(0,t))}}function ng(e,t,n){let r=e.syncPointTree_.get(t);z(r,`Missing sync point for query tag that we're tracking`);let i=bm(e.pendingWriteTree_,t);return xh(r,n,i,null)}function rg(e){return e.fold((e,t,n)=>{if(t&&kh(t))return[Ah(t)];{let e=[];return t&&(e=Th(t)),Yu(n,(t,n)=>{e=e.concat(n)}),e}})}function ig(e){return e._queryParams.loadsAllData()&&!e._queryParams.isDefault()?new(Nh())(e._repo,e._path):e}function ag(e,t){for(let n=0;n<t.length;++n){let r=t[n];if(!r._queryParams.loadsAllData()){let t=$h(r),n=e.queryToTagMap.get(t);e.queryToTagMap.delete(t),e.tagToQueryMap.delete(n)}}}function og(){return Ph++}function sg(e,t,n){let r=t._path,i=Qh(e,t),a=Zh(e,n),o=e.listenProvider_.startListening(ig(t),i,a.hashFn,a.onComplete),s=e.syncPointTree_.subtree(r);if(i)z(!kh(s.value),`If we're adding a query, it shouldn't be shadowed`);else{let t=s.fold((e,t,n)=>{if(!J(e)&&t&&kh(t))return[Ah(t).query];{let e=[];return t&&(e=e.concat(Th(t).map(e=>e.query))),Yu(n,(t,n)=>{e=e.concat(n)}),e}});for(let n=0;n<t.length;++n){let r=t[n];e.listenProvider_.stopListening(ig(r),Qh(e,r))}}return o}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var cg=class e{constructor(e){this.node_=e}getImmediateChild(t){let n=this.node_.getImmediateChild(t);return new e(n)}node(){return this.node_}},lg=class e{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(t){let n=q(this.path_,t);return new e(this.syncTree_,n)}node(){return Kh(this.syncTree_,this.path_)}},ug=function(e){return e||={},e.timestamp=e.timestamp||new Date().getTime(),e},dg=function(e,t,n){if(!e||typeof e!=`object`)return e;if(z(`.sv`in e,`Unexpected leaf node or priority contents`),typeof e[`.sv`]==`string`)return fg(e[`.sv`],t,n);if(typeof e[`.sv`]==`object`)return pg(e[`.sv`],t);z(!1,`Unexpected server value: `+JSON.stringify(e,null,2))},fg=function(e,t,n){switch(e){case`timestamp`:return n.timestamp;default:z(!1,`Unexpected server value: `+e)}},pg=function(e,t,n){e.hasOwnProperty(`increment`)||z(!1,`Unexpected server value: `+JSON.stringify(e,null,2));let r=e.increment;typeof r!=`number`&&z(!1,`Unexpected increment value: `+r);let i=t.node();if(z(i!=null,`Expected ChildrenNode.EMPTY_NODE for nulls`),!i.isLeafNode())return r;let a=i.getValue();return typeof a==`number`?a+r:r},mg=function(e,t,n,r){return gg(t,new lg(n,e),r)},hg=function(e,t,n){return gg(e,new cg(t),n)};function gg(e,t,n){let r=e.getPriority().val(),i=dg(r,t.getImmediateChild(`.priority`),n),a;if(e.isLeafNode()){let r=e,a=dg(r.getValue(),t,n);return a!==r.getValue()||i!==r.getPriority().val()?new np(a,Q(i)):e}else{let r=e;return a=r,i!==r.getPriority().val()&&(a=a.updatePriority(new np(i))),r.forEachChild(X,(e,r)=>{let i=gg(r,t.getImmediateChild(e),n);i!==r&&(a=a.updateImmediateChild(e,i))}),a}}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var _g=class{constructor(e=``,t=null,n={children:{},childCount:0}){this.name=e,this.parent=t,this.node=n}};function vg(e,t){let n=t instanceof U?t:new U(t),r=e,i=G(n);for(;i!==null;){let e=_c(r.node.children,i)||{children:{},childCount:0};r=new _g(i,r,e),n=K(n),i=G(n)}return r}function yg(e){return e.node.value}function bg(e,t){e.node.value=t,Dg(e)}function xg(e){return e.node.childCount>0}function Sg(e){return yg(e)===void 0&&!xg(e)}function Cg(e,t){Yu(e.node.children,(n,r)=>{t(new _g(n,e,r))})}function wg(e,t,n,r){n&&!r&&t(e),Cg(e,e=>{wg(e,t,!0,r)}),n&&r&&t(e)}function Tg(e,t,n){let r=n?e:e.parent;for(;r!==null;){if(t(r))return!0;r=r.parent}return!1}function Eg(e){return new U(e.parent===null?e.name:Eg(e.parent)+`/`+e.name)}function Dg(e){e.parent!==null&&Og(e.parent,e.name,e)}function Og(e,t,n){let r=Sg(n),i=gc(e.node.children,t);r&&i?(delete e.node.children[t],e.node.childCount--,Dg(e)):!r&&!i&&(e.node.children[t]=n.node,e.node.childCount++,Dg(e))}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var kg=/[\[\].#$\/\u0000-\u001F\u007F]/,Ag=/[\[\].#$\u0000-\u001F\u007F]/,jg=10*1024*1024,Mg=function(e){return typeof e==`string`&&e.length!==0&&!kg.test(e)},Ng=function(e){return typeof e==`string`&&e.length!==0&&!Ag.test(e)},Pg=function(e){return e&&=e.replace(/^\/*\.info(\/|$)/,`/`),Ng(e)},Fg=function(e,t,n,r){r&&t===void 0||Ig(wc(e,`value`),t,n)},Ig=function(e,t,n){let r=n instanceof U?new Df(n,e):n;if(t===void 0)throw Error(e+`contains undefined `+jf(r));if(typeof t==`function`)throw Error(e+`contains a function `+jf(r)+` with contents = `+t.toString());if(Bu(t))throw Error(e+`contains `+t.toString()+` `+jf(r));if(typeof t==`string`&&t.length>jg/3&&Ec(t)>jg)throw Error(e+`contains a string greater than 10485760 utf8 bytes `+jf(r)+` ('`+t.substring(0,50)+`...')`);if(t&&typeof t==`object`){let n=!1,i=!1;if(Yu(t,(t,a)=>{if(t===`.value`)n=!0;else if(t!==`.priority`&&t!==`.sv`&&(i=!0,!Mg(t)))throw Error(e+` contains an invalid key (`+t+`) `+jf(r)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);Of(r,t),Ig(e,a,r),kf(r)}),n&&i)throw Error(e+` contains ".value" child `+jf(r)+` in addition to actual children.`)}},Lg=function(e,t,n,r){if(!(r&&n===void 0)&&!Ng(n))throw Error(wc(e,t)+`was an invalid path = "`+n+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},Rg=function(e,t,n,r){n&&=n.replace(/^\/*\.info(\/|$)/,`/`),Lg(e,t,n,r)},zg=function(e,t){if(G(t)===`.info`)throw Error(e+` failed = Can't modify data under /.info/`)},Bg=function(e,t){let n=t.path.toString();if(typeof t.repoInfo.host!=`string`||t.repoInfo.host.length===0||!Mg(t.repoInfo.namespace)&&t.repoInfo.host.split(`:`)[0]!==`localhost`||n.length!==0&&!Pg(n))throw Error(wc(e,`url`)+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)},Vg=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function Hg(e,t){let n=null;for(let r=0;r<t.length;r++){let i=t[r],a=i.getPath();n!==null&&!Tf(a,n.path)&&(e.eventLists_.push(n),n=null),n===null&&(n={events:[],path:a}),n.events.push(i)}n&&e.eventLists_.push(n)}function Ug(e,t,n){Hg(e,n),Wg(e,e=>Ef(e,t)||Ef(t,e))}function Wg(e,t){e.recursionDepth_++;let n=!0;for(let r=0;r<e.eventLists_.length;r++){let i=e.eventLists_[r];if(i){let a=i.path;t(a)?(Gg(e.eventLists_[r]),e.eventLists_[r]=null):n=!1}}n&&(e.eventLists_=[]),e.recursionDepth_--}function Gg(e){for(let t=0;t<e.events.length;t++){let n=e.events[t];if(n!==null){e.events[t]=null;let r=n.getEventRunner();Mu&&H(`event: `+n.toString()),id(r)}}}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var Kg=`repo_interrupt`,qg=25,Jg=class{constructor(e,t,n,r){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=n,this.appCheckProvider_=r,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Vg,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Mp(),this.transactionQueueTree_=new _g,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?`https://`:`http://`)+this.repoInfo_.host}};function Yg(e,t,n){if(e.stats_=Dd(e.repoInfo_),e.forceRestClient_||ad())e.server_=new Ap(e.repoInfo_,(t,n,r,i)=>{Qg(e,t,n,r,i)},e.authTokenProvider_,e.appCheckProvider_),setTimeout(()=>$g(e,!0),0);else{if(n!=null){if(typeof n!=`object`)throw Error(`Only objects are supported for option databaseAuthVariableOverride`);try{B(n)}catch(e){throw Error(`Invalid authOverride provided: `+e)}}e.persistentConnection_=new Bf(e.repoInfo_,t,(t,n,r,i)=>{Qg(e,t,n,r,i)},t=>{$g(e,t)},t=>{e_(e,t)},e.authTokenProvider_,e.appCheckProvider_,n),e.server_=e.persistentConnection_}e.authTokenProvider_.addTokenChangeListener(t=>{e.server_.refreshAuthToken(t)}),e.appCheckProvider_.addTokenChangeListener(t=>{e.server_.refreshAppCheckToken(t.token)}),e.statsReporter_=Od(e.repoInfo_,()=>new Bp(e.stats_,e.server_)),e.infoData_=new jp,e.infoSyncTree_=new Fh({startListening:(t,n,r,i)=>{let a=[],o=e.infoData_.getNode(t._path);return o.isEmpty()||(a=Rh(e.infoSyncTree_,t._path,o),setTimeout(()=>{i(`ok`)},0)),a},stopListening:()=>{}}),t_(e,`connected`,!1),e.serverSyncTree_=new Fh({startListening:(t,n,r,i)=>(e.server_.listen(t,r,n,(n,r)=>{let a=i(n,r);Ug(e.eventQueue_,t._path,a)}),[]),stopListening:(t,n)=>{e.server_.unlisten(t,n)}})}function Xg(e){let t=e.infoData_.getNode(new U(`.info/serverTimeOffset`)).val()||0;return new Date().getTime()+t}function Zg(e){return ug({timestamp:Xg(e)})}function Qg(e,t,n,r,i){e.dataUpdateCount++;let a=new U(t);n=e.interceptServerDataCallback_?e.interceptServerDataCallback_(t,n):n;let o=[];if(i)if(r){let t=yc(n,e=>Q(e));o=Wh(e.serverSyncTree_,a,t,i)}else{let t=Q(n);o=Uh(e.serverSyncTree_,a,t,i)}else if(r){let t=yc(n,e=>Q(e));o=zh(e.serverSyncTree_,a,t)}else{let t=Q(n);o=Rh(e.serverSyncTree_,a,t)}let s=a;o.length>0&&(s=f_(e,a)),Ug(e.eventQueue_,s,o)}function $g(e,t){t_(e,`connected`,t),t===!1&&a_(e)}function e_(e,t){Yu(t,(t,n)=>{t_(e,t,n)})}function t_(e,t,n){let r=new U(`/.info/`+t),i=Q(n);e.infoData_.updateSnapshot(r,i);let a=Rh(e.infoSyncTree_,r,i);Ug(e.eventQueue_,r,a)}function n_(e){return e.nextWriteId_++}function r_(e,t,n){let r=qh(e.serverSyncTree_,t);return r==null?e.server_.get(t).then(r=>{let i=Q(r).withIndex(t._queryParams.getIndex());Gh(e.serverSyncTree_,t,n,!0);let a;if(t._queryParams.loadsAllData())a=Rh(e.serverSyncTree_,t._path,i);else{let n=Qh(e.serverSyncTree_,t);a=Uh(e.serverSyncTree_,t._path,i,n)}return Ug(e.eventQueue_,t._path,a),Hh(e.serverSyncTree_,t,n,null,!0),i},n=>(s_(e,`get for query `+B(t)+` failed: `+n),Promise.reject(Error(n)))):Promise.resolve(r)}function i_(e,t,n,r,i){s_(e,`set`,{path:t.toString(),value:n,priority:r});let a=Zg(e),o=Q(n,r),s=Kh(e.serverSyncTree_,t),c=hg(o,s,a),l=n_(e),u=Ih(e.serverSyncTree_,t,c,l,!0);Hg(e.eventQueue_,u),e.server_.put(t.toString(),o.val(!0),(n,r)=>{let a=n===`ok`;a||Ru(`set at `+t+` failed: `+n);let o=Lh(e.serverSyncTree_,l,!a);Ug(e.eventQueue_,t,o),c_(e,i,n,r)});let d=v_(e,t);f_(e,d),Ug(e.eventQueue_,d,[])}function a_(e){s_(e,`onDisconnectEvents`);let t=Zg(e),n=Mp();Pp(e.onDisconnect_,W(),(r,i)=>{let a=mg(r,i,e.serverSyncTree_,t);Np(n,r,a)});let r=[];Pp(n,W(),(t,n)=>{r=r.concat(Rh(e.serverSyncTree_,t,n));let i=v_(e,t);f_(e,i)}),e.onDisconnect_=Mp(),Ug(e.eventQueue_,W(),r)}function o_(e){e.persistentConnection_&&e.persistentConnection_.interrupt(Kg)}function s_(e,...t){let n=``;e.persistentConnection_&&(n=e.persistentConnection_.id+`:`),H(n,...t)}function c_(e,t,n,r){t&&id(()=>{if(n===`ok`)t(null);else{let e=(n||`error`).toUpperCase(),i=e;r&&(i+=`: `+r);let a=Error(i);a.code=e,t(a)}})}function l_(e,t,n){return Kh(e.serverSyncTree_,t,n)||Z.EMPTY_NODE}function u_(e,t=e.transactionQueueTree_){if(t||__(e,t),yg(t)){let n=h_(e,t);z(n.length>0,`Sending zero length transaction queue`),n.every(e=>e.status===0)&&d_(e,Eg(t),n)}else xg(t)&&Cg(t,t=>{u_(e,t)})}function d_(e,t,n){let r=n.map(e=>e.currentWriteId),i=l_(e,t,r),a=i,o=i.hash();for(let e=0;e<n.length;e++){let r=n[e];z(r.status===0,`tryToSendTransactionQueue_: items in queue should all be run.`),r.status=1,r.retryCount++;let i=wf(t,r.path);a=a.updateChild(i,r.currentOutputSnapshotRaw)}let s=a.val(!0),c=t;e.server_.put(c.toString(),s,r=>{s_(e,`transaction put response`,{path:c.toString(),status:r});let i=[];if(r===`ok`){let r=[];for(let t=0;t<n.length;t++)n[t].status=2,i=i.concat(Lh(e.serverSyncTree_,n[t].currentWriteId)),n[t].onComplete&&r.push(()=>n[t].onComplete(null,!0,n[t].currentOutputSnapshotResolved)),n[t].unwatcher();__(e,vg(e.transactionQueueTree_,t)),u_(e,e.transactionQueueTree_),Ug(e.eventQueue_,t,i);for(let e=0;e<r.length;e++)id(r[e])}else{if(r===`datastale`)for(let e=0;e<n.length;e++)n[e].status===3?n[e].status=4:n[e].status=0;else{Ru(`transaction at `+c.toString()+` failed: `+r);for(let e=0;e<n.length;e++)n[e].status=4,n[e].abortReason=r}f_(e,t)}},o)}function f_(e,t){let n=m_(e,t),r=Eg(n),i=h_(e,n);return p_(e,i,r),r}function p_(e,t,n){if(t.length===0)return;let r=[],i=[],a=t.filter(e=>e.status===0).map(e=>e.currentWriteId);for(let o=0;o<t.length;o++){let s=t[o],c=wf(n,s.path),l=!1,u;if(z(c!==null,`rerunTransactionsUnderNode_: relativePath should not be null.`),s.status===4)l=!0,u=s.abortReason,i=i.concat(Lh(e.serverSyncTree_,s.currentWriteId,!0));else if(s.status===0)if(s.retryCount>=qg)l=!0,u=`maxretry`,i=i.concat(Lh(e.serverSyncTree_,s.currentWriteId,!0));else{let n=l_(e,s.path,a);s.currentInputSnapshot=n;let r=t[o].update(n.val());if(r!==void 0){Ig(`transaction failed: Data returned `,r,s.path);let t=Q(r);typeof r==`object`&&r&&gc(r,`.priority`)||(t=t.updatePriority(n.getPriority()));let o=s.currentWriteId,c=Zg(e),l=hg(t,n,c);s.currentOutputSnapshotRaw=t,s.currentOutputSnapshotResolved=l,s.currentWriteId=n_(e),a.splice(a.indexOf(o),1),i=i.concat(Ih(e.serverSyncTree_,s.path,l,s.currentWriteId,s.applyLocally)),i=i.concat(Lh(e.serverSyncTree_,o,!0))}else l=!0,u=`nodata`,i=i.concat(Lh(e.serverSyncTree_,s.currentWriteId,!0))}Ug(e.eventQueue_,n,i),i=[],l&&(t[o].status=2,(function(e){setTimeout(e,0)})(t[o].unwatcher),t[o].onComplete&&(u===`nodata`?r.push(()=>t[o].onComplete(null,!1,t[o].currentInputSnapshot)):r.push(()=>t[o].onComplete(Error(u),!1,null))))}__(e,e.transactionQueueTree_);for(let e=0;e<r.length;e++)id(r[e]);u_(e,e.transactionQueueTree_)}function m_(e,t){let n,r=e.transactionQueueTree_;for(n=G(t);n!==null&&yg(r)===void 0;)r=vg(r,n),t=K(t),n=G(t);return r}function h_(e,t){let n=[];return g_(e,t,n),n.sort((e,t)=>e.order-t.order),n}function g_(e,t,n){let r=yg(t);if(r)for(let e=0;e<r.length;e++)n.push(r[e]);Cg(t,t=>{g_(e,t,n)})}function __(e,t){let n=yg(t);if(n){let e=0;for(let t=0;t<n.length;t++)n[t].status!==2&&(n[e]=n[t],e++);n.length=e,bg(t,n.length>0?n:void 0)}Cg(t,t=>{__(e,t)})}function v_(e,t){let n=Eg(m_(e,t)),r=vg(e.transactionQueueTree_,t);return Tg(r,t=>{y_(e,t)}),y_(e,r),wg(r,t=>{y_(e,t)}),n}function y_(e,t){let n=yg(t);if(n){let r=[],i=[],a=-1;for(let t=0;t<n.length;t++)n[t].status===3||(n[t].status===1?(z(a===t-1,`All SENT items should be at beginning of queue.`),a=t,n[t].status=3,n[t].abortReason=`set`):(z(n[t].status===0,`Unexpected transaction status in abort`),n[t].unwatcher(),i=i.concat(Lh(e.serverSyncTree_,n[t].currentWriteId,!0)),n[t].onComplete&&r.push(n[t].onComplete.bind(null,Error(`set`),!1,null))));a===-1?bg(t,void 0):n.length=a+1,Ug(e.eventQueue_,Eg(t),i);for(let e=0;e<r.length;e++)id(r[e])}}
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function b_(e){let t=``,n=e.split(`/`);for(let e=0;e<n.length;e++)if(n[e].length>0){let r=n[e];try{r=decodeURIComponent(r.replace(/\+/g,` `))}catch{}t+=`/`+r}return t}function x_(e){let t={};e.charAt(0)===`?`&&(e=e.substring(1));for(let n of e.split(`&`)){if(n.length===0)continue;let r=n.split(`=`);r.length===2?t[decodeURIComponent(r[0])]=decodeURIComponent(r[1]):Ru(`Invalid query segment '${n}' in query '${e}'`)}return t}var S_=function(e,t){let n=C_(e),r=n.namespace;n.domain===`firebase.com`&&Lu(n.host+` is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead`),(!r||r===`undefined`)&&n.domain!==`localhost`&&Lu(`Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com`),n.secure||zu();let i=n.scheme===`ws`||n.scheme===`wss`;return{repoInfo:new xd(n.host,n.secure,r,i,t,``,r!==n.subdomain),path:new U(n.pathString)}},C_=function(e){let t=``,n=``,r=``,i=``,a=``,o=!0,s=`https`,c=443;if(typeof e==`string`){let l=e.indexOf(`//`);l>=0&&(s=e.substring(0,l-1),e=e.substring(l+2));let u=e.indexOf(`/`);u===-1&&(u=e.length);let d=e.indexOf(`?`);d===-1&&(d=e.length),t=e.substring(0,Math.min(u,d)),u<d&&(i=b_(e.substring(u,d)));let f=x_(e.substring(Math.min(e.length,d)));l=t.indexOf(`:`),l>=0?(o=s===`https`||s===`wss`,c=parseInt(t.substring(l+1),10)):l=t.length;let p=t.slice(0,l);if(p.toLowerCase()===`localhost`)n=`localhost`;else if(p.split(`.`).length<=2)n=p;else{let e=t.indexOf(`.`);r=t.substring(0,e).toLowerCase(),n=t.substring(e+1),a=r}`ns`in f&&(a=f.ns)}return{host:t,port:c,domain:n,subdomain:r,secure:o,scheme:s,pathString:i,namespace:a}},w_=`-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz`;(function(){let e=0,t=[];return function(n){let r=n===e;e=n;let i,a=Array(8);for(i=7;i>=0;i--)a[i]=w_.charAt(n%64),n=Math.floor(n/64);z(n===0,`Cannot push at time == 0`);let o=a.join(``);if(r){for(i=11;i>=0&&t[i]===63;i--)t[i]=0;t[i]++}else for(i=0;i<12;i++)t[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=w_.charAt(t[i]);return z(o.length===20,`nextPushId: Length should be 20.`),o}})();
/**
* @license
* Copyright 2017 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var T_=class{constructor(e,t,n,r){this.eventType=e,this.eventRegistration=t,this.snapshot=n,this.prevName=r}getPath(){let e=this.snapshot.ref;return this.eventType===`value`?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+`:`+this.eventType+`:`+B(this.snapshot.exportVal())}},E_=class{constructor(e,t,n){this.eventRegistration=e,this.error=t,this.path=n}getPath(){return this.path}getEventType(){return`cancel`}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+`:cancel`}},D_=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return z(this.hasCancelCallback,`Raising a cancel event on a listener with no cancel callback`),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}},O_=class e{constructor(e,t,n,r){this._repo=e,this._path=t,this._queryParams=n,this._orderByCalled=r}get key(){return J(this._path)?null:bf(this._path)}get ref(){return new k_(this._repo,this._path)}get _queryIdentifier(){let e=kp(this._queryParams),t=qu(e);return t===`{}`?`default`:t}get _queryObject(){return kp(this._queryParams)}isEqual(t){if(t=Dc(t),!(t instanceof e))return!1;let n=this._repo===t._repo,r=Tf(this._path,t._path),i=this._queryIdentifier===t._queryIdentifier;return n&&r&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+xf(this._path)}},k_=class e extends O_{constructor(e,t){super(e,t,new Ep,!1)}get parent(){let t=Cf(this._path);return t===null?null:new e(this._repo,t)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},A_=class e{constructor(e,t,n){this._node=e,this.ref=t,this._index=n}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(t){let n=new U(t),r=M_(this.ref,t);return new e(this._node.getChild(n),r,X)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(t){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(n,r)=>t(new e(r,M_(this.ref,n),X)))}hasChild(e){let t=new U(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function j_(e,t){return e=Dc(e),e._checkNotDeleted(`ref`),t===void 0?e._root:M_(e._root,t)}function M_(e,t){return e=Dc(e),G(e._path)===null?Rg(`child`,`path`,t,!1):Lg(`child`,`path`,t,!1),new k_(e._repo,q(e._path,t))}function N_(e,t){e=Dc(e),zg(`set`,e._path),Fg(`set`,t,e._path,!1);let n=new Ks;return i_(e._repo,e._path,t,null,n.wrapCallback(()=>{})),n.promise}function P_(e){e=Dc(e);let t=new D_(()=>{}),n=new F_(t);return r_(e._repo,e,n).then(t=>new A_(t,new k_(e._repo,e._path),e._queryParams.getIndex()))}var F_=class e{constructor(e){this.callbackContext=e}respondsTo(e){return e===`value`}createEvent(e,t){let n=t._queryParams.getIndex();return new T_(`value`,this,new A_(e.snapshotNode,new k_(t._repo,t._path),n))}getEventRunner(e){return e.getEventType()===`cancel`?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new E_(this,e,t):null}matches(t){return t instanceof e?!t.callbackContext||!this.callbackContext?!0:t.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}};vh(k_),Mh(k_);
/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var I_=`FIREBASE_DATABASE_EMULATOR_HOST`,L_={},R_=!1;function z_(e,t,n,r){let i=t.lastIndexOf(`:`),a=t.substring(0,i),o=qs(a);e.repoInfo_=new xd(t,o,e.repoInfo_.namespace,e.repoInfo_.webSocketOnly,e.repoInfo_.nodeAdmin,e.repoInfo_.persistenceKey,e.repoInfo_.includeNamespaceInQueryParams,!0,n),r&&(e.authTokenProvider_=r)}function B_(e,t,n,r,i){let a=r||e.options.databaseURL;a===void 0&&(e.options.projectId||Lu(`Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp().`),H(`Using default host for project `,e.options.projectId),a=`${e.options.projectId}-default-rtdb.firebaseio.com`);let o=S_(a,i),s=o.repoInfo,c,l;typeof process<`u`&&(l={}[I_]),l?(c=!0,a=`http://${l}?ns=${s.namespace}`,o=S_(a,i),s=o.repoInfo):c=!o.repoInfo.secure;let u=i&&c?new ld(ld.OWNER):new cd(e.name,e.options,t);Bg(`Invalid Firebase Database URL`,o),J(o.path)||Lu(`Database URL must point to the root of a Firebase Database (not including a child path).`);let d=H_(s,e,u,new sd(e,n));return new U_(d,e)}function V_(e,t){let n=L_[t];(!n||n[e.key]!==e)&&Lu(`Database ${t}(${e.repoInfo_}) has already been deleted.`),o_(e),delete n[e.key]}function H_(e,t,n,r){let i=L_[t.name];i||(i={},L_[t.name]=i);let a=i[e.toURLString()];return a&&Lu(`Database initialized multiple times. Please make sure the format of the database URL matches with each database() call.`),a=new Jg(e,R_,n,r),i[e.toURLString()]=a,a}var U_=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type=`database`,this._instanceStarted=!1}get _repo(){return this._instanceStarted||=(Yg(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),!0),this._repoInternal}get _root(){return this._rootInternal||=new k_(this._repo,W()),this._rootInternal}_delete(){return this._rootInternal!==null&&(V_(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&Lu(`Cannot call `+e+` on a deleted database.`)}};function W_(e=eu(),t){let n=Jl(e,`database`).getImmediate({identifier:t});if(!n._instanceStarted){let e=Ws(`database`);e&&G_(n,...e)}return n}function G_(e,t,n,r={}){e=Dc(e),e._checkNotDeleted(`useEmulator`);let i=`${t}:${n}`,a=e._repoInternal;if(e._instanceStarted){if(i===e._repoInternal.repoInfo_.host&&bc(r,a.repoInfo_.emulatorOptions))return;Lu(`connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.`)}let o;if(a.repoInfo_.nodeAdmin)r.mockUserToken&&Lu(`mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".`),o=new ld(ld.OWNER);else if(r.mockUserToken){let t=typeof r.mockUserToken==`string`?r.mockUserToken:Ys(r.mockUserToken,e.app.options.projectId);o=new ld(t)}qs(t)&&(Js(t),ec(`Database`,!0)),z_(a,i,r,o)}
/**
* @license
* Copyright 2021 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function K_(e){Su(Ql),ql(new Oc(`database`,(e,{instanceIdentifier:t})=>{let n=e.getProvider(`app`).getImmediate(),r=e.getProvider(`auth-internal`),i=e.getProvider(`app-check-internal`);return B_(n,r,i,t)},`PUBLIC`).setMultipleInstances(!0)),tu(yu,bu,e),tu(yu,bu,`esm2020`)}Bf.prototype.simpleListen=function(e,t){this.sendRequest(`q`,{p:e},t)},Bf.prototype.echo=function(e,t){this.sendRequest(`echo`,{d:e},t)},K_();var q_=$l({apiKey:`AIzaSyDjHqv2w-hnUwgDCjxu_5-bf2qqWEeQcgk`,authDomain:`gfallacy-e38ac.firebaseapp.com`,databaseURL:`https://gfallacy-e38ac-default-rtdb.firebaseio.com`,projectId:`gfallacy-e38ac`,storageBucket:`gfallacy-e38ac.firebasestorage.app`,messagingSenderId:`522353542057`,appId:`1:522353542057:web:52a9b600d2b4b878967ab8`}),J_=W_(q_);function Y_(e,t){N_(j_(J_,e),t)}function X_(e,t,n){let r=`players/${e}`;P_(j_(J_,r)).then(e=>{if(e.exists()){let n=e.val();t&&t(n)}else n&&n()}).catch(e=>{console.error(`Error loading character data:`,e),n&&n()})}const Z_=window.innerWidth,Q_=window.innerHeight;var $_=Ss(`Player, Destroyer of the worlds and ancients`,1,[],[]);let ev=!1;function $(){return $_}function tv(e){X_(e,e=>{$_=e,console.log(`Player data loaded:`,$_),ev=!0})}var nv=bs({width:Z_,height:Q_,letterbox:!0,debug:!0,touchToMouse:!0,background:[5,5,5],global:!1,pixelDensity:window.devicePixelRatio,canvas:document.getElementById(`gameCanvas`),crisp:!0});function rv(e){e.loadSprite(`spr_dice`,`art/spr_dice.png`),e.loadBitmapFont(`monogram`,`font/monogram-bitmap.png`,6,12)}function iv(e,t,n,r){let i=e.add([e.rect(e.width()-60,100,{radius:10}),e.pos(e.center()),e.anchor(`center`),e.scale(1),e.color(e.rgb(56,90,153)),e.area()]),a=n?n.add([e.rect(n.width-20,100,{radius:10}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(50,50,50)),e.outline(5,e.rgb(150,150,150)),e.scale(1),e.area()]):i;n&&i.destroy(),a.add([e.text(`Lv`+t.level.toString(),{size:18,font:`monogram`,width:a.width*.2,align:`center`}),e.pos(-a.width/2+20,0),e.anchor(`left`),e.color(e.rgb(200,200,200))]);let o=a.add([e.rect(5,a.height),e.pos(-a.width/2+a.width*.25,0),e.anchor(`center`),e.color(e.rgb(150,150,150))]);a.add([e.text(t.name,{size:18,font:`monogram`,width:a.width*.6-10,align:`left`}),e.pos(o.pos.x+10,0),e.anchor(`left`),e.color(e.rgb(200,200,200))]),a.height=e.formatText({text:t.name,size:18,width:a.width*.6-10}).height+20,o.height=a.height;let s=!1;return a.onMousePress(()=>{a.hasPoint(e.mousePos())&&(s=!0,e.tween(a.scale,e.vec2(1.05),.1,e=>{a.scale=e}))}),a.onMouseRelease(()=>{s&&(e.tween(a.scale,e.vec2(1),.1,e=>{a.scale=e}),r&&e.wait(.1,()=>{r(t)})),s=!1}),a}function av(e,t,n,r){let i=e.add([e.rect(e.width()-60,100,{radius:10}),e.pos(e.center()),e.anchor(`center`),e.scale(1),e.color(e.rgb(56,90,153)),e.area()]),a=n?n.add([e.rect(n.width-20,50,{radius:10}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(50,50,50)),e.outline(5,e.rgb(150,150,150)),e.scale(1),e.area()]):i;n&&i.destroy(),a.add([e.text(t.itemName,{size:18,font:`monogram`,width:a.width*.6-10,align:`left`}),e.pos(-a.width/2+25,0),e.anchor(`left`),e.color(e.rgb(200,200,200))]),a.add([e.text(`Uses: (${t.usagePool}, ${t.usageCap})`,{size:18,font:`monogram`,width:a.width*.3-10,align:`right`}),e.pos(a.width/2-20,0),e.anchor(`right`),e.color(e.rgb(200,200,200))]);let o=!1;a.onMousePress(()=>{a.hasPoint(e.mousePos())&&(o=!0,e.tween(a.scale,e.vec2(1.05),.1,e=>{a.scale=e}))}),a.onMouseRelease(()=>{o&&(e.tween(a.scale,e.vec2(1),.1,e=>{a.scale=e}),r&&e.wait(.1,()=>{r(t)})),o=!1});let s=e.formatText({text:t.itemName,size:18,width:a.width*.6-10});return a.height=Math.max(s.height+20,50),a}function ov(e){e.scene(`mainMenu`,()=>{let t=e.add([e.rect(e.width()-20,e.height()-20,{fill:!1,radius:16}),e.anchor(`center`),e.pos(e.width()/2,e.height()/2),e.outline(5,e.rgb(200,200,200))]);t.add([e.text(`Gamblers Fallacy RPG`,{size:48,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+70),e.anchor(`center`),e.color(e.rgb(200,200,200))]),t.add([e.text(`By Sai Mangipudi`,{size:24,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+150),e.anchor(`center`),e.color(e.rgb(150,150,150))]);let n=t.add([e.rect(250,200,{fill:!1,radius:12}),e.pos(0,0),e.anchor(`center`),e.outline(5,e.rgb(200,200,200))]),r=n.add([e.rect(200,60,{fill:!0,radius:8}),e.pos(0,-40),e.anchor(`center`),e.color(e.rgb(50,150,50)),e.outline(3,e.rgb(150,250,150)),e.area(),e.scale(1)]);r.add([e.text(`Player Mode`,{size:32,font:`monogram`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(150,250,150)),e.area(),e.scale(1)]);let i=n.add([e.rect(200,60,{fill:!0,radius:8}),e.pos(0,40),e.anchor(`center`),e.color(e.rgb(50,50,150)),e.outline(3,e.rgb(150,150,250)),e.area(),e.scale(1)]);i.add([e.text(`GM Mode`,{size:32,font:`monogram`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(150,150,250)),e.area(),e.scale(1)]);let a=!1;r.onMousePress(()=>{r.hasPoint(e.mousePos())&&(a=!0,e.tween(r.scale,e.vec2(1.1),.1,e=>{r.scale=e}))}),r.onMouseRelease(()=>{a&&(e.tween(r.scale,e.vec2(1),.1,e=>{r.scale=e}),e.wait(.1,()=>{e.go(`pLoadCreateChar`)}))});let o=!1;i.onMouseDown(()=>{i.hasPoint(e.mousePos())&&(o=!0,e.tween(i.scale,e.vec2(1.1),.1,e=>{i.scale=e}))}),i.onMouseRelease(()=>{o&&(e.tween(i.scale,e.vec2(1),.1,e=>{i.scale=e}),e.wait(.1,()=>{e.debug.log(`Switching to GM Mode...`)}))})})}function sv(e){e.scene(`pLoadCreateChar`,()=>{let t=e.add([e.rect(e.width()-20,e.height()-20,{radius:10,fill:!1}),e.anchor(`center`),e.pos(e.center()),e.outline(5,e.rgb(94,150,255))]);t.add([e.text(`Load or Create New Character`,{size:48,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+90),e.anchor(`center`),e.color(e.rgb(94,150,255))]);let n=t.add([e.rect(e.width()-100,300,{radius:10}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(56,90,153))]),r=n.add([e.rect(n.width,5),e.pos(0,-n.height/2+100),e.anchor(`center`),e.color(e.getBackground()??e.rgb(5,5,5))]),i=n.add([e.rect(n.width-40,60,{radius:10}),e.pos(0,-n.height/2+50),e.anchor(`center`),e.color(e.getBackground()??e.rgb(5,5,5)),e.outline(5,e.rgb(181,205,255)),e.area(),e.scale(1),e.rotate(0)]);i.add([e.text(`Create A New Character`,{size:24,font:`monogram`,width:i.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(181,205,255)),e.area(),e.scale(1)]);let a=!1;i.onMousePress(()=>{i.hasPoint(e.mousePos())&&(a=!0,e.tween(i.scale,e.vec2(1.1),.1,e=>{i.scale=e}))}),i.onMouseRelease(()=>{a&&(e.tween(i.scale,e.vec2(1),.1,e=>{i.scale=e}),e.wait(.1,()=>{e.go(`newPlayerName`)}))});let o=n.add([e.rect(n.width-40,50,{radius:10}),e.pos(0,r.pos.y+70),e.anchor(`center`),e.color(e.rgb(56,90,153))]);o.add([e.text(`Character ID:`,{size:24,font:`monogram`,width:o.width-20,align:`left`}),e.pos(0,-40),e.anchor(`center`),e.color(e.rgb(181,205,255))]);let s=n.add([e.rect(n.width-40,60,{radius:10}),e.pos(0,r.pos.y+150),e.anchor(`center`),e.color(e.getBackground()??e.rgb(5,5,5)),e.outline(5,e.rgb(181,205,255)),e.area(),e.scale(1),e.rotate(0)]);s.add([e.text(`Load Previous Character`,{size:24,font:`monogram`,width:s.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(181,205,255)),e.area(),e.scale(1)]);let c=!1;s.onMousePress(()=>{s.hasPoint(e.mousePos())&&(c=!0,e.tween(s.scale,e.vec2(1.1),.1,e=>{s.scale=e}))}),s.onMouseRelease(()=>{if(c&&s.hasPoint(e.mousePos())){if(l.value.trim()===``){e.debug.log(`Please enter a Character ID to load a character.`);return}e.tween(s.scale,e.vec2(1),.1,e=>{s.scale=e}),e.wait(.1,()=>{tv(l.value.trim()),e.go(`loadingCharData`)})}c=!1});let l=document.getElementById(`loadPlayerInput`);l.style.display=`block`,l.style.top=e.center().y+n.pos.y+r.pos.y+70-o.height/2-5+`px`,l.style.width=o.width-20+`px`,l.style.height=o.height-15+`px`,e.onSceneLeave(()=>{l.style.display=`none`})})}function cv(e){e.scene(`loadingCharData`,()=>{e.add([e.rect(e.width()-20,e.height()-20,{radius:10,fill:!1}),e.anchor(`center`),e.pos(e.center()),e.outline(5,e.rgb(94,150,255))]).add([e.text(`Loading Character Data...`,{size:36,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(94,150,255))]),e.onUpdate(()=>{ev&&e.go(`charSheet`)}),e.wait(5,()=>{e.go(`cantLoadCharData`)})}),e.scene(`cantLoadCharData`,()=>{let t=e.add([e.rect(e.width()-20,e.height()-20,{radius:10,fill:!1}),e.anchor(`center`),e.pos(e.center()),e.outline(5,e.rgb(255,94,94))]);t.add([e.text(`Error: Unable to Load Character Data.`,{size:36,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-20),e.anchor(`center`),e.color(e.rgb(255,94,94))]),t.add([e.text(`Tap the screen to retry.`,{size:24,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,50),e.anchor(`center`),e.color(e.rgb(255,150,150))]),e.onMousePress(()=>{e.go(`mainMenu`)})})}function lv(e){e.scene(`newPlayerName`,()=>{let t=e.add([e.rect(e.width()-20,e.height()-20,{radius:10,fill:!1}),e.anchor(`center`),e.pos(e.center()),e.outline(5,e.rgb(200,200,200))]);t.add([e.text(`Create A New Character`,{size:36,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+60),e.anchor(`center`),e.color(e.rgb(200,200,200))]),t.add([e.text(`Enter Your Character's Name`,{size:18,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+120),e.anchor(`center`),e.color(e.rgb(150,150,150))]);let n=e.add([e.rect(300,50,{radius:10}),e.pos(e.center().x,e.center().y-20),e.anchor(`center`),e.color(e.rgb(200,200,200))]),r=t.add([e.rect(150,50,{radius:10}),e.pos(0,t.height/2-80),e.anchor(`center`),e.color(e.rgb(94,150,255)),e.outline(3,e.rgb(150,200,255)),e.area(),e.scale(1)]);r.add([e.text(`Proceed`,{size:20,font:`monogram`,width:r.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5))]);let i=document.getElementById(`playerNameInput`);i.style.position=`absolute`,i.style.display=`block`,i.style.width=`280px`,i.style.height=`40px`,i.style.fontSize=`24px`,i.style.borderRadius=`10px`,i.style.textAlign=`center`,i.style.left=`${n.pos.x}px`,i.style.top=`${n.pos.y-30}px`,i.value=``;let a=!1;r.onMousePress(()=>{r.hasPoint(e.mousePos())&&(a=!0,e.tween(r.scale,e.vec2(1.1),.1,e=>{r.scale=e}))}),e.onSceneLeave(()=>{i.style.display=`none`}),r.onMouseRelease(()=>{a&&(e.tween(r.scale,e.vec2(1),.1,e=>{r.scale=e}),e.wait(.1,()=>{$().charName=i.value||`Unnamed Hero`,e.go(`charHPSelect`)})),a=!1})})}function uv(e){e.scene(`charHPSelect`,()=>{let t=e.add([e.rect(e.width()-20,e.height()-20,{radius:10,fill:!1}),e.anchor(`center`),e.pos(e.center()),e.outline(5,e.rgb(200,200,200))]);t.add([e.text(`Set Character Hit Points`,{size:36,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+60),e.anchor(`center`),e.color(e.rgb(200,200,200))]),t.add([e.text(`Roll a d6 (or multiple d6 if your Dealer allows it) and add the results together.`,{size:18,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+120),e.anchor(`center`),e.color(e.rgb(150,150,150))]);let n=e.add([e.rect(300,50,{radius:10}),e.pos(e.center().x,e.center().y-20),e.anchor(`center`),e.color(e.rgb(5,5,5))]),r=t.add([e.rect(150,50,{radius:10}),e.pos(0,t.height/2-80),e.anchor(`center`),e.color(e.rgb(94,150,255)),e.outline(3,e.rgb(150,200,255)),e.area(),e.scale(1)]);r.add([e.text(`Proceed`,{size:20,font:`monogram`,width:r.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5))]);let i=document.getElementById(`actualHPInput`);i.value=`10`,i.type=`number`,i.style.position=`absolute`,i.style.display=`block`,i.style.top=`${n.pos.y-45}px`,i.style.left=`${n.pos.x}px`,i.style.width=`280px`,i.style.height=`40px`,i.style.fontSize=`48px`,i.style.borderRadius=`10px`,i.style.textAlign=`center`,i.style.left=`${n.pos.x}px`;let a=!1;r.onMousePress(()=>{r.hasPoint(e.mousePos())&&(a=!0,e.tween(r.scale,e.vec2(1.1),.1,e=>{r.scale=e}))}),r.onMouseRelease(()=>{a&&(e.tween(r.scale,e.vec2(1),.1,e=>{r.scale=e}),e.wait(.1,()=>{$().maxHitPoints=parseInt(i.value)||10,$().hitPoints=$().maxHitPoints,i.style.display=`none`,e.go(`newCharExp`)}))}),e.onSceneLeave(()=>{i.style.display=`none`})})}function dv(e){e.scene(`newCharExp`,()=>{let t=e.add([e.rect(e.width()-20,e.height()-20,{radius:10,fill:!1}),e.anchor(`center`),e.pos(e.center()),e.outline(5,e.rgb(94,150,255))]);t.add([e.text(`Create A New Character`,{size:36,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+60),e.anchor(`center`),e.color(e.rgb(94,150,255))]),t.add([e.text(`Add Experiences to Your Character`,{size:18,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+120),e.anchor(`center`),e.color(e.rgb(150,200,255))]);let n=t.add([e.rect(t.width-40,150,{radius:10}),e.pos(0,-t.height/2+200),e.anchor(`center`),e.color(e.rgb(56,90,153))]),r=e.add([e.rect(150,50,{radius:10}),e.pos(e.center().x,e.center().y+n.pos.y-30),e.anchor(`center`),e.color(e.rgb(200,200,200))]),i=n.add([e.rect(150,50,{radius:10}),e.pos(0,n.height/2-40),e.anchor(`center`),e.color(e.rgb(94,150,255)),e.outline(3,e.rgb(181,205,255)),e.area(),e.scale(1)]);i.add([e.text(`Add Experience`,{size:20,font:`monogram`,width:i.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5))]);let a=!1;i.onMousePress(()=>{i.hasPoint(e.mousePos())&&(a=!0,e.tween(i.scale,e.vec2(1.1),.1,e=>{i.scale=e}))});function o(){let t=p.value.trim();t!==``&&($().experienceList.push({name:t,level:1}),p.value=``,e.go(`newCharExp`))}i.onMouseRelease(()=>{a&&(e.tween(i.scale,e.vec2(1),.1,e=>{i.scale=e}),e.wait(.1,()=>{o()})),a=!1});let s=t.add([e.rect(t.width-40,t.height-360,{radius:10}),e.pos(0,t.height/2-(t.height-255)/2-25),e.anchor(`center`),e.color(e.rgb(56,90,153)),e.mask(`intersect`),e.area()]),c=s.add([e.rect(s.width,s.height,{fill:!0,radius:10}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(56,90,153))]),l=t.add([e.rect(200,50,{radius:10}),e.pos(0,t.height/2-40),e.anchor(`center`),e.color(e.rgb(94,150,255)),e.outline(3,e.rgb(181,205,255)),e.area(),e.scale(1)]);l.add([e.text(`Continue`,{size:24,font:`monogram`,width:l.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5))]);let u=!1;l.onMousePress(()=>{l.hasPoint(e.mousePos())&&(u=!0,e.tween(l.scale,e.vec2(1.1),.1,e=>{l.scale=e}))}),l.onMouseRelease(()=>{u&&(e.tween(l.scale,e.vec2(1),.1,e=>{l.scale=e}),e.wait(.1,()=>{e.go(`newCharInv`)})),u=!1});function d(t){$().experienceList=$().experienceList.filter(e=>e!==t),e.go(`newCharExp`)}let f=-(s.height/2-20);for(let t of $().experienceList){let n=iv(e,t,s,d);n.pos.y=f+n.height/2,n.pos.x-=20,f+=n.height+10,n.width=s.width-70}let p=document.getElementById(`hitPointsInput`);p&&(p.value=`Enter Experience Here`,p.style.position=`absolute`,p.style.top=r.pos.y-30+`px`,p.style.left=r.pos.x+`px`,p.style.width=s.width-50+`px`,p.style.height=`30px`,p.style.fontSize=`20px`,p.style.textAlign=`center`,p.style.display=`block`),e.onSceneLeave(()=>{p.style.display=`none`});let m=!1,h=0;e.onMousePress(()=>{s.hasPoint(e.mousePos())&&(m=!0,h=e.mousePos().y)}),e.onMouseMove(()=>{if(m){let t=e.mousePos().y-h;for(let e of s.children)e!==c&&(e.pos.y+=t);h=e.mousePos().y}}),e.onMouseRelease(()=>{m=!1})})}function fv(e){e.scene(`newCharInv`,()=>{let t=e.add([e.rect(e.width()-20,e.height()-20,{radius:10,fill:!1}),e.anchor(`center`),e.pos(e.center()),e.outline(5,e.rgb(94,150,255))]);t.add([e.text(`Create A New Character`,{size:36,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+60),e.anchor(`center`),e.color(e.rgb(94,150,255))]),t.add([e.text(`Add Items to Your Character`,{size:18,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+120),e.anchor(`center`),e.color(e.rgb(150,200,255))]);let n=t.add([e.rect(t.width-40,150,{radius:10}),e.pos(0,-t.height/2+200),e.anchor(`center`),e.color(e.rgb(56,90,153))]),r=n.add([e.rect(150,50,{radius:10}),e.pos(0,n.height/2-25),e.anchor(`center`),e.color(e.rgb(94,150,255)),e.outline(3,e.rgb(181,205,255)),e.area(),e.scale(.75)]);r.add([e.text(`Add Item`,{size:20,font:`monogram`,width:r.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5))]);let i=e.add([e.rect(n.width-20,40,{radius:10}),e.pos(e.center().x,e.center().y+n.pos.y-45),e.anchor(`center`),e.color(e.rgb(200,200,200))]),a=e.add([e.rect((n.width-20)/2.2,40,{radius:10}),e.pos(e.center().x-(n.width-20)/4,e.center().y+n.pos.y+5),e.anchor(`center`),e.color(e.rgb(200,200,200))]),o=e.add([e.rect((n.width-20)/2.2,40,{radius:10}),e.pos(e.center().x+(n.width-20)/4,e.center().y+n.pos.y+5),e.anchor(`center`),e.color(e.rgb(200,200,200))]),s=t.add([e.rect(t.width-40,50,{radius:10}),e.pos(0,t.height/2-40),e.anchor(`center`),e.color(e.rgb(200,50,50)),e.area()]),c=t.add([e.rect(t.width-40,t.height-360,{radius:10}),e.pos(0,t.height/2-(t.height-255)/2-25),e.anchor(`center`),e.color(e.rgb(56,90,153)),e.area(),e.mask(`intersect`)]),l=c.add([e.rect(c.width,c.height,{fill:!0,radius:10}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(56,90,153))]),u=t.add([e.rect(200,50,{radius:10}),e.pos(0,t.height/2-40),e.anchor(`center`),e.color(e.rgb(94,150,255)),e.outline(3,e.rgb(181,205,255)),e.area(),e.scale(1),e.z(100)]);u.add([e.text(`Continue`,{size:24,font:`monogram`,width:u.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5))]);let d=null,f=t.add([e.rect(300,200,{radius:10}),e.pos(0,100),e.anchor(`center`),e.color(e.rgb(5,5,5)),e.area(),e.outline(5,e.rgb(94,150,255))]),p=f.add([e.text(`Item: None`,{size:24,font:`monogram`,width:f.width-20,align:`center`}),e.pos(0,-70),e.anchor(`center`),e.color(e.rgb(94,150,255))]),m=f.add([e.text(`Usage: 0 / 0`,{size:20,font:`monogram`,width:f.width-20,align:`center`}),e.pos(0,-45),e.anchor(`center`),e.color(e.rgb(150,200,255))]),h=f.add([e.rect(f.width-40,50,{radius:10}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(94,150,255)),e.outline(3,e.rgb(181,205,255)),e.area(),e.scale(1)]);h.add([e.text(`Use Item`,{size:20,font:`monogram`,width:h.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5))]);let g=f.add([e.rect(f.width-40,50,{radius:10}),e.pos(0,60),e.anchor(`center`),e.color(e.rgb(94,150,255)),e.outline(3,e.rgb(181,205,255)),e.area(),e.scale(1)]);g.add([e.text(`Repair Item`,{size:20,font:`monogram`,width:g.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5))]);let _=!1;h.onMousePress(()=>{h.hasPoint(e.mousePos())&&(_=!0,e.tween(h.scale,e.vec2(1.1),.1,e=>{h.scale=e}))}),h.onMouseRelease(()=>{_&&(e.tween(h.scale,e.vec2(1),.1,e=>{h.scale=e}),e.debug.log(`Used item:`,d),d&&d.usagePool>0&&(d.usagePool--,m.text=`Usage: ${d.usagePool} / ${d.usageCap}`,x())),_=!1});let v=!1;g.onMousePress(()=>{g.hasPoint(e.mousePos())&&(v=!0,e.tween(g.scale,e.vec2(1.1),.1,e=>{g.scale=e}))}),g.onMouseRelease(()=>{v&&(e.tween(g.scale,e.vec2(1),.1,e=>{g.scale=e}),e.debug.log(`Repaired item:`,d),d&&(d.usagePool++,m.text=`Usage: ${d.usagePool} / ${d.usageCap}`,x())),v=!1}),f.pos.y=500;let y=!1;u.onMousePress(()=>{u.hasPoint(e.mousePos())&&(y=!0,e.tween(u.scale,e.vec2(1.1),.1,e=>{u.scale=e}))}),u.onMouseRelease(()=>{y&&(e.tween(u.scale,e.vec2(1),.1,e=>{u.scale=e}),e.wait(.1,()=>{e.go(`charSheet`)})),y=!1}),f.onMousePress(()=>{f.hasPoint(e.mousePos())||e.tween(f.pos.y,500,.2,e=>{f.pos.y=e})});function b(t){f.pos.y<500||(d=t,p.text=`Item: ${d.itemName}`,m.text=`Usage: ${`${d.usagePool} / ${d.usageCap}`}`,e.tween(f.pos.y,100,.2,e=>{f.pos.y=e}))}function x(){let t=-(c.height/2-20),n=ws($().inventory);for(let r of n){let n=av(e,r,c,b);n.pos.y=t+n.height/2,n.pos.x-=20,t+=n.height+10,n.width=c.width-50}}x();let S=document.getElementById(`itemNameInput`),C=document.getElementById(`itemUsagePoolInput`),w=document.getElementById(`itemUsageCapInput`);S.style.display=`block`,C.style.display=`block`,w.style.display=`block`,S.style.fontSize=`18px`,S.style.top=i.pos.y-20+`px`,S.style.width=i.width-30+`px`,S.style.height=i.height-25+`px`,C.style.fontSize=`18px`,C.style.top=a.pos.y-22+`px`,C.style.left=a.pos.x+`px`,C.style.width=a.width-30+`px`,C.style.height=a.height-25+`px`,w.style.fontSize=`18px`,w.style.top=o.pos.y-22+`px`,w.style.left=o.pos.x+`px`,w.style.width=o.width-30+`px`,w.style.height=o.height-25+`px`,S.value=`Item Name`,C.value=`Usage Pool`,w.value=`Usage Cap`;let T=s.add([e.text(`Invalid input`,{size:20,font:`monogram`,width:s.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5)),e.z(-500)]);s.pos.y=-400;function E(n){T.text=n,e.tween(s.pos.y,-t.height/2+40,.2,e=>{s.pos.y=e}),e.wait(3).then(()=>{e.tween(s.pos.y,-400,.5,e=>{s.pos.y=e})})}function ee(e,t,n){let r=e.trim(),i=parseInt(t),a=parseInt(n);return!r||isNaN(i)||isNaN(a)?(E(`Please fill out all fields correctly.`),null):{itemName:r,usagePool:i,usageCap:a}}let D=!1;r.onMousePress(()=>{r.hasPoint(e.mousePos())&&(D=!0,e.tween(r.scale,e.vec2(.8),.1,e=>{r.scale=e}))}),r.onMouseRelease(()=>{D&&r.hasPoint(e.mousePos())&&(D=!1,e.tween(r.scale,e.vec2(.75),.1,e=>{r.scale=e}),e.wait(.1,()=>{let t=ee(S.value,C.value,w.value);t&&(Cs($(),t),S.value=``,C.value=``,w.value=``,e.go(`newCharInv`))}))});let te=!1,ne=0;e.onMousePress(()=>{c.hasPoint(e.mousePos())&&(te=!0,ne=e.mousePos().y)}),e.onMouseRelease(()=>{te=!1}),e.onMouseMove(()=>{if(te){let t=e.mousePos().y-ne;for(let e of c.children)e!==l&&(e.pos.y+=t);ne=e.mousePos().y}}),e.onSceneLeave(()=>{Y_(`players/`+$().characterID,$()),S.style.display=`none`,C.style.display=`none`,w.style.display=`none`})})}function pv(e){e.scene(`charSheet`,()=>{console.log(`CharData in CharSheetScene: ${$()}`);let t=e.add([e.rect(e.width()-20,e.height()-20,{radius:10,fill:!1}),e.anchor(`center`),e.pos(e.center()),e.outline(5,e.rgb(200,200,200))]),n=t.add([e.text(`${$().charName}`,{size:20,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+50),e.anchor(`center`),e.color(e.rgb(150,200,255))]),r=e.formatText({text:`${$().charName}`,size:20,width:e.width()-40,align:`center`});n.pos.y=-e.height()/2+r.height/2+20;let i=t.add([e.text(`Level: ${$().level} + CharID: ${$().characterID}`,{size:18,font:`monogram`,width:e.width()-40,align:`center`}),e.pos(0,-e.height()/2+50),e.anchor(`center`),e.color(e.rgb(150,150,150))]);i.pos.y=n.pos.y+r.height/2+10+i.height/2;let a=t.add([e.text(`HP: ${$().hitPoints} / ${$().maxHitPoints}`,{size:24,font:`monogram`,width:e.width()-40,align:`left`}),e.pos(0,-e.height()/2+r.height+i.height+70),e.anchor(`center`),e.color(e.rgb(150,150,150))]),o=t.add([e.rect(150,40,{radius:10}),e.pos(t.width/2-85,a.pos.y),e.anchor(`center`),e.color(e.rgb(94,150,255)),e.outline(3,e.rgb(150,200,255)),e.area(),e.scale(1)]);o.add([e.text(`Change HP`,{size:18,font:`monogram`,width:o.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5))]);let s=t.add([e.rect(t.width-20,t.height/4,{radius:10}),e.pos(0,o.pos.y+100),e.anchor(`center`),e.color(e.rgb(56,90,153)),e.mask(`intersect`),e.area()]),c=s.add([e.rect(s.width,s.height,{fill:!0,radius:10}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(56,90,153))]),l=t.add([e.rect(t.width-20,t.height/3,{radius:10}),e.pos(0,t.height/2-t.height/3/2-60),e.anchor(`center`),e.color(e.rgb(56,90,153)),e.mask(`intersect`),e.area()]),u=l.add([e.rect(l.width,l.height,{fill:!0,radius:10}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(56,90,153))]),d=t.add([e.rect(150,40,{radius:10}),e.pos(0,t.height/2-30),e.anchor(`center`),e.color(e.rgb(200,200,50)),e.outline(3,e.rgb(250,250,150)),e.area(),e.scale(1)]);d.add([e.text(`Level Up`,{size:18,font:`monogram`,width:d.width-20,align:`center`}),e.pos(0,0),e.anchor(`center`),e.color(e.rgb(5,5,5))]);function f(t){g||e.debug.log(`Clicked on item: ${t.itemName}`)}function p(){e.debug.log(`Change HP Clicked`)}function m(){e.debug.log(`Level Up Clicked`)}function h(){a.text=`HP: ${$().hitPoints} / ${$().maxHitPoints}`,$().hitPoints<=$().maxHitPoints*.3?a.color=e.rgb(255,50,50):a.color=e.rgb(150,150,150),i.text=`Level: ${$().level} | CharID: ${$().characterID}`;let t=-(s.height/2-10);$().experienceList.forEach(n=>{let r=iv(e,n,s,()=>{});r.pos.y=t+r.height/2,t+=r.height+10,r.width=s.width-50,r.pos.x=-15});let n=-(l.height/2-10);ws($().inventory).forEach(t=>{let r=av(e,t,l,f);r.pos.y=n+r.height/2,n+=r.height+10,r.width=l.width-50,r.pos.x=-15})}h();let g=!1;e.onUpdate(()=>{l.hasPoint(e.mousePos()),g=s.hasPoint(e.mousePos())});let _=!1,v=!1,y=!1,b=!1,x=0,S=0;e.onMousePress(()=>{o.hasPoint(e.mousePos())&&(_=!0,e.tween(o.scale,e.vec2(1.1),.1,e=>{o.scale=e})),s.hasPoint(e.mousePos())?(y=!0,x=e.mousePos().y):l.hasPoint(e.mousePos())?(b=!0,S=e.mousePos().y):d.hasPoint(e.mousePos())&&(v=!0,e.tween(d.scale,e.vec2(1.1),.1,e=>{d.scale=e}))}),e.onMouseMove(()=>{if(y){let t=e.mousePos().y-x;s.children.forEach(e=>{e!==c&&(e.pos.y+=t)}),x=e.mousePos().y}if(b){let t=e.mousePos().y-S;l.children.forEach(e=>{e!==u&&(e.pos.y+=t)}),S=e.mousePos().y}}),e.onMouseRelease(()=>{y=!1,b=!1,_&&(e.tween(o.scale,e.vec2(1),.1,e=>{o.scale=e}),_=!1,p()),v&&(e.tween(d.scale,e.vec2(1),.1,e=>{d.scale=e}),v=!1,m())})})}rv(nv),ov(nv),sv(nv),cv(nv),lv(nv),uv(nv),dv(nv),fv(nv),pv(nv),nv.go(`mainMenu`);